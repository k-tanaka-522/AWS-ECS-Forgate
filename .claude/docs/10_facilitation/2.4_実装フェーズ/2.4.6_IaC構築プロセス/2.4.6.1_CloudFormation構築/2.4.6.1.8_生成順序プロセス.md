# 2.4.6.1.8 CloudFormation 生成順序プロセス

## 目的

CloudFormation のテンプレートとデプロイスクリプトを正しい順序で生成します。

**重要**: テンプレートを生成してから、デプロイスクリプトを生成します（順序厳守）。

---

## 📋 生成順序（厳守）⭐⭐⭐

### ステップ1: ディレクトリ構造作成

**生成するディレクトリ**:
```
infra/cloudformation/
├── platform/              # Platform Account用テンプレート
│   ├── network.yaml
│   └── parameters/
│       ├── dev.json
│       └── prd.json
├── service/               # Service Account用テンプレート
│   ├── network.yaml
│   ├── compute.yaml
│   ├── database.yaml
│   └── parameters/
│       ├── dev.json
│       └── prd.json
└── README.md              # デプロイ手順
```

**ユーザーへの宣言**:
```
CloudFormation 実装を開始します。

生成順序:
1. ✅ ディレクトリ構造作成
2. ⏭️ Platform Account テンプレート生成
3. ⏭️ Service Account テンプレート生成
4. ⏭️ Parameters ファイル生成
5. ⏭️ デプロイスクリプト生成
6. ⏭️ README.md 生成

各ステップの完了後、進捗を報告します。
```

---

### ステップ2: Platform Account テンプレート生成

**生成順序**:

#### 2-1. network.yaml（Platform Account）

**`infra/cloudformation/platform/network.yaml`**:

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Platform Account - Network Infrastructure (Transit Gateway, VPN)'

Parameters:
  Environment:
    Type: String
    AllowedValues: [dev, prd]
  ProjectName:
    Type: String

Resources:
  # ==============================================================================
  # Transit Gateway
  # ==============================================================================
  TransitGateway:
    Type: AWS::EC2::TransitGateway
    Properties:
      Description: !Sub ${ProjectName}-${Environment}-tgw
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-tgw

  # ==============================================================================
  # VPN Gateway
  # ==============================================================================
  VPNGateway:
    Type: AWS::EC2::VPNGateway
    Properties:
      Type: ipsec.1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-vgw

  VPNGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref PlatformVPC
      VpnGatewayId: !Ref VPNGateway

  # ==============================================================================
  # Resource Access Manager (RAM) - Transit Gateway共有
  # ==============================================================================
  TransitGatewayRAMShare:
    Type: AWS::RAM::ResourceShare
    Properties:
      Name: !Sub ${ProjectName}-${Environment}-tgw-share
      Principals:
        - !Sub 'arn:aws:iam::${ServiceAccountId}:root'
      ResourceArns:
        - !GetAtt TransitGateway.Arn

Outputs:
  TransitGatewayId:
    Value: !Ref TransitGateway
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TransitGatewayId
```

**進捗報告**:
```
✅ platform/network.yaml を生成しました

含まれるリソース:
- Transit Gateway
- VPN Gateway
- Resource Access Manager (RAM Share)

次: Service Account テンプレート生成
```

---

### ステップ3: Service Account テンプレート生成

**生成順序**:

#### 3-1. network.yaml（Service Account）

**`infra/cloudformation/service/network.yaml`**:

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Service Account - Network Infrastructure (VPC, Subnets, Security Groups)'

Parameters:
  Environment:
    Type: String
    AllowedValues: [dev, prd]
  ProjectName:
    Type: String
  VpcCidr:
    Type: String
    Default: 10.1.0.0/16

Resources:
  # ==============================================================================
  # VPC
  # ==============================================================================
  ServiceVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-vpc

  # ==============================================================================
  # Internet Gateway
  # ==============================================================================
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref ServiceVPC
      InternetGatewayId: !Ref InternetGateway

  # ==============================================================================
  # Public Subnets
  # ==============================================================================
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: 10.1.0.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-1a

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: 10.1.1.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-1c

  # ==============================================================================
  # Private Subnets (ECS)
  # ==============================================================================
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: 10.1.10.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-private-1a

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: 10.1.11.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-private-1c

  # ==============================================================================
  # DB Subnets
  # ==============================================================================
  DBSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: 10.1.20.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-db-1a

  DBSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: 10.1.21.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-db-1c

  # ==============================================================================
  # NAT Gateways
  # ==============================================================================
  NATGatewayEIP1:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NATGateway1:
    Type: AWS::EC2::NATGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP1.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-nat-1a

  NATGatewayEIP2:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NATGateway2:
    Type: AWS::EC2::NATGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP2.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-nat-1c

  # ==============================================================================
  # Transit Gateway Attachment
  # ==============================================================================
  TransitGatewayAttachment:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !ImportValue
        Fn::Sub: ${ProjectName}-${Environment}-TransitGatewayId
      VpcId: !Ref ServiceVPC
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-tgw-attachment

Outputs:
  VpcId:
    Value: !Ref ServiceVPC
    Export:
      Name: !Sub ${ProjectName}-${Environment}-ServiceVpcId

  PrivateSubnetIds:
    Value: !Join [",", [!Ref PrivateSubnet1, !Ref PrivateSubnet2]]
    Export:
      Name: !Sub ${ProjectName}-${Environment}-PrivateSubnetIds

  DBSubnetIds:
    Value: !Join [",", [!Ref DBSubnet1, !Ref DBSubnet2]]
    Export:
      Name: !Sub ${ProjectName}-${Environment}-DBSubnetIds
```

**進捗報告**:
```
✅ service/network.yaml を生成しました（1/3）

含まれるリソース:
- VPC
- Internet Gateway
- Subnets (Public × 2, Private × 2, DB × 2)
- NAT Gateways × 2
- Transit Gateway Attachment

次: service/compute.yaml 生成
```

#### 3-2. compute.yaml（Service Account）

**短縮版 - 実際には完全なテンプレートを生成**:

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Service Account - Compute Infrastructure (ECS, ALB)'

# (省略: ECR, ECS Cluster, ECS Task Definition, ECS Service, ALB等)
```

**進捗報告**:
```
✅ service/compute.yaml を生成しました（2/3）

含まれるリソース:
- ECR Repositories × 3
- ECS Cluster
- ECS Task Definitions × 3
- ECS Services × 3
- ALB + Target Groups + Listeners

次: service/database.yaml 生成
```

#### 3-3. database.yaml（Service Account）

**進捗報告**:
```
✅ service/database.yaml を生成しました（3/3）

含まれるリソース:
- RDS PostgreSQL (Multi-AZ)
- RDS Security Group
- Secrets Manager (DB Password)

Service Account テンプレート完了
次: Parameters ファイル生成
```

---

### ステップ4: Parameters ファイル生成

**生成順序**:

#### 4-1. platform/parameters/dev.json

```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "ProjectName",
    "ParameterValue": "aws-multi-account-sample"
  },
  {
    "ParameterKey": "ServiceAccountId",
    "ParameterValue": "210987654321"
  }
]
```

#### 4-2. service/parameters/dev.json

```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "ProjectName",
    "ParameterValue": "aws-multi-account-sample"
  },
  {
    "ParameterKey": "VpcCidr",
    "ParameterValue": "10.1.0.0/16"
  },
  {
    "ParameterKey": "DBInstanceClass",
    "ParameterValue": "db.t4g.micro"
  }
]
```

**進捗報告**:
```
✅ Parameters ファイル生成完了

生成したファイル:
- platform/parameters/dev.json
- platform/parameters/prd.json
- service/parameters/dev.json
- service/parameters/prd.json

次: デプロイスクリプト生成
```

---

### ステップ5: デプロイスクリプト生成 ⭐⭐⭐

**生成順序** (`.claude/docs/40_standards/45_cloudformation.md` 準拠):

1. `scripts/create-changeset.sh`
2. `scripts/describe-changeset.sh`
3. `scripts/execute-changeset.sh`
4. `scripts/rollback.sh`
5. `scripts/validate.sh` (推奨)

**進捗報告**:
```
✅ デプロイスクリプト生成完了

生成したスクリプト:
- scripts/create-changeset.sh
- scripts/describe-changeset.sh
- scripts/execute-changeset.sh
- scripts/rollback.sh
- scripts/validate.sh

次: README.md 生成
```

---

### ステップ6: README.md 生成

**生成するファイル**:

1. `infra/cloudformation/README.md` - 全体デプロイ手順
2. `infra/cloudformation/platform/README.md`
3. `infra/cloudformation/service/README.md`

**`infra/cloudformation/README.md` の内容**:

```markdown
# CloudFormation Templates

## デプロイ順序

### 1. Platform Account（最初）

```bash
cd infra/cloudformation/platform
./../../scripts/create-changeset.sh dev platform network
./../../scripts/describe-changeset.sh dev platform network
./../../scripts/execute-changeset.sh dev platform network
```

### 2. Service Account（Platform完了後）

**Network Stack**:
```bash
cd infra/cloudformation/service
./../../scripts/create-changeset.sh dev service network
./../../scripts/describe-changeset.sh dev service network
./../../scripts/execute-changeset.sh dev service network
```

**Database Stack**:
```bash
./../../scripts/create-changeset.sh dev service database
./../../scripts/describe-changeset.sh dev service database
./../../scripts/execute-changeset.sh dev service database
```

**Compute Stack**:
```bash
./../../scripts/create-changeset.sh dev service compute
./../../scripts/describe-changeset.sh dev service compute
./../../scripts/execute-changeset.sh dev service compute
```

## ロールバック

```bash
./scripts/rollback.sh dev service compute
```
```

**進捗報告**:
```
✅ README.md 生成完了

生成したファイル:
- infra/cloudformation/README.md
- infra/cloudformation/platform/README.md
- infra/cloudformation/service/README.md

次: 完了確認
```

---

### ステップ7: 完了確認 ⭐⭐⭐

**チェックリスト**:
- [ ] Platform Account テンプレート（1ファイル）
- [ ] Service Account テンプレート（3ファイル）
- [ ] Parameters ファイル（dev/prd × 2アカウント）
- [ ] デプロイスクリプト（4-5ファイル）
- [ ] README.md（3ファイル）

**自動確認スクリプト**（Claudeが実行）:
```bash
ls -la infra/cloudformation/platform/*.yaml | wc -l
# 期待値: 1ファイル

ls -la infra/cloudformation/service/*.yaml | wc -l
# 期待値: 3ファイル

ls -la scripts/*.sh | wc -l
# 期待値: 4-5ファイル
```

**ユーザーへの最終報告**:
```
==================================
CloudFormation 実装完了
==================================

生成したテンプレート:
✅ platform/network.yaml
✅ service/network.yaml
✅ service/compute.yaml
✅ service/database.yaml

生成したParameters:
✅ platform/parameters/dev.json
✅ platform/parameters/prd.json
✅ service/parameters/dev.json
✅ service/parameters/prd.json

生成したスクリプト:
✅ scripts/create-changeset.sh
✅ scripts/describe-changeset.sh
✅ scripts/execute-changeset.sh
✅ scripts/rollback.sh
✅ scripts/validate.sh

生成したドキュメント:
✅ infra/cloudformation/README.md
✅ infra/cloudformation/platform/README.md
✅ infra/cloudformation/service/README.md

次のステップ: テンプレート検証
  cd infra/cloudformation
  ../../scripts/validate.sh
==================================
```

---

## 🚨 省略防止策

### 対策1: テンプレート生成を優先

**順序を厳守**:
1. **テンプレート生成**（最優先）
2. Parameters生成
3. スクリプト生成
4. README.md生成

**理由**: スクリプトだけ生成してテンプレートを忘れる事故を防ぐ

### 対策2: 各ステップで進捗報告

**テンプレート**:
```
✅ [ファイル名] を生成しました（[N]/[合計]）

次: [次のファイル名] 生成
```

### 対策3: 最後に自動確認スクリプト実行

**ファイル数確認**:
```bash
ls -la infra/cloudformation/platform/*.yaml | wc -l
ls -la infra/cloudformation/service/*.yaml | wc -l
ls -la scripts/*.sh | wc -l
```

---

**作成日**: 2025-10-24
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須（Round 2で最優先）
