# 01_制約事項・前提条件

> AWS Multi-Account Sample Application - 制約事項・前提条件

**作成日**: 2025-10-24 (Round 3)
**バージョン**: 3.0

---

## 1. 技術的制約

### 1.1 AWS サービス制約

| 項目 | 制約内容 | 理由 | 影響範囲 |
|------|---------|------|----------|
| リージョン | ap-northeast-1 のみ | 検証用 | 全リソース |
| CloudFormation | 必須使用 | IaC 標準 | インフラ構築 |
| ECS 実行タイプ | Fargate のみ | サーバーレス | コンテナ実行 |
| データベース | PostgreSQL のみ | 技術標準 | RDS |
| ネットワーク | VPC, Transit Gateway | Multi-Account 構成 | 全ネットワーク |

### 1.2 CloudFormation 制約

#### 1.2.1 CloudFormation 3 Principles (⭐⭐⭐必須遵守)

**参照**: `.claude/docs/40_standards/45_cloudformation.md`

**原則1: 責任分離原則**
- Platform Account と Service Account を明確に分離
- 共通基盤とアプリケーション基盤を分離

**原則2: スタック分割原則**
- Network, Database, Compute, Monitoring ごとにスタック分割
- 各スタックは単一責務を持つ

**原則3: 段階的デプロイ原則** (⭐⭐⭐ Round 3 重点)
- **Change Set 必須使用**
- dry-run で変更内容を事前確認
- ユーザー承認後に実行
- ロールバック機能実装

#### 1.2.2 スタック分割構成

**Platform Account**:
```
platform-network (VPC, Subnets, IGW, NAT GW)
  ↓
platform-tgw (Transit Gateway, RAM Share)
```

**Service Account**:
```
service-network (VPC, Subnets, NAT GW, TGW Attachment)
  ↓
service-database (RDS PostgreSQL Multi-AZ)
  ↓
service-compute (ECS Cluster, Task Definition, Service, ALB)
  ↓
service-monitoring (CloudWatch Alarms, Dashboard)
```

**依存関係管理**:
- Cross-Stack References (`!ImportValue`) 使用
- 削除は逆順 (monitoring → compute → database → network)

### 1.3 Node.js 制約

| 項目 | 制約内容 | 理由 |
|------|---------|------|
| バージョン | 20 LTS | 長期サポート |
| パッケージマネージャー | npm | 標準ツール |
| モノレポ | npm workspaces | 3サービス管理 |

### 1.4 ネットワーク制約

| 項目 | 制約内容 | 備考 |
|------|---------|------|
| Platform VPC CIDR | 10.0.0.0/16 | 固定 |
| Service VPC CIDR | 10.1.0.0/16 | 固定 |
| Transit Gateway ASN | 64512 | AWS 推奨 |
| Multi-AZ 構成 | ap-northeast-1a, 1c | 必須 |

---

## 2. ビジネス的制約

### 2.1 予算制約

| 項目 | 制約内容 | 備考 |
|------|---------|------|
| 月額予算 | ~¥30,000 | 検証用最小構成 |
| 無料枠活用 | 可能な限り活用 | RDS, ECS, NAT GW 等 |
| リソース停止 | 不要時停止 | コスト削減 |

### 2.2 スコープ制約

| 項目 | 対象範囲 | 対象外 |
|------|---------|--------|
| セキュリティ | 基本的な対策のみ | WAF, Shield, GuardDuty |
| 可用性 | 99% (Multi-AZ) | 99.99% (マルチリージョン) |
| DR | なし | バックアップのみ |
| CI/CD | 基本的なパイプラインのみ | 高度な Blue-Green デプロイ |

### 2.3 期間制約

| 項目 | 制約内容 | 備考 |
|------|---------|------|
| 納期 | 設定なし | 技術検証優先 |
| マイルストーン | フェーズごと | 企画→要件→設計→実装→テスト |

---

## 3. 組織的制約

### 3.1 人員制約

| 役割 | 人数 | 備考 |
|------|------|------|
| 開発者 | 1名 | フルスタック |
| レビュアー | 社内エンジニア | 任意レビュー |
| 運用担当 | 開発者兼任 | 検証用 |

### 3.2 技術レベル制約

| 項目 | 前提知識レベル | 備考 |
|------|--------------|------|
| AWS | 中級以上 | VPC, ECS, RDS の基礎知識 |
| CloudFormation | 初級〜中級 | テンプレート作成経験 |
| Node.js | 中級以上 | REST API 実装経験 |
| Docker | 初級〜中級 | Dockerfile 作成経験 |

---

## 4. 法的・規制上の制約

### 4.1 データ保護

| 項目 | 制約内容 | 備考 |
|------|---------|------|
| 個人情報 | 使用しない | 検証用ダミーデータのみ |
| 機密情報 | 使用しない | 社内技術デモ用 |
| コンプライアンス | 該当なし | 検証・デモ用 |

---

## 5. 前提条件

### 5.1 AWSアカウント

#### 5.1.1 必要なアカウント

| アカウント | 用途 | AWS Account ID | 備考 |
|-----------|------|----------------|------|
| Platform Account | 共通ネットワーク基盤 | (任意) | Transit Gateway, VPN |
| Service Account | アプリケーション基盤 | (任意) | ECS, RDS, ALB |

#### 5.1.2 IAM 権限

**必要な権限**:
- CloudFormation (フルアクセス)
- VPC, Transit Gateway (フルアクセス)
- ECS, RDS, ALB (フルアクセス)
- CloudWatch (フルアクセス)
- IAM (PassRole, CreateServiceLinkedRole)
- RAM (Resource Access Manager - Transit Gateway 共有用)

**推奨**: AdministratorAccess (検証用)

### 5.2 ローカル環境

#### 5.2.1 必須ツール

| ツール | バージョン | 用途 | インストールコマンド |
|-------|-----------|------|-------------------|
| AWS CLI | v2 | CloudFormation デプロイ | `aws --version` |
| Node.js | 20 LTS | アプリケーション開発 | `node --version` |
| Docker | 最新版 | コンテナビルド | `docker --version` |
| Git | 最新版 | バージョン管理 | `git --version` |

#### 5.2.2 AWS CLI 設定

**プロファイル設定**:
```bash
# Platform Account
[profile platform]
region = ap-northeast-1
output = json

# Service Account
[profile service]
region = ap-northeast-1
output = json
```

**環境変数**:
```bash
export AWS_PROFILE=platform  # Platform Account デプロイ時
export AWS_PROFILE=service   # Service Account デプロイ時
```

### 5.3 ネットワーク前提条件

#### 5.3.1 CIDR ブロック

| VPC | CIDR | 用途 | 備考 |
|-----|------|------|------|
| Platform VPC | 10.0.0.0/16 | 共通基盤 | 65,536 IP アドレス |
| Service VPC | 10.1.0.0/16 | アプリケーション | 65,536 IP アドレス |

**CIDR 重複チェック**:
- 既存 VPC との CIDR 重複がないこと
- オンプレミス拠点との CIDR 重複がないこと

#### 5.3.2 サブネット設計

**Platform VPC**:
| サブネット | CIDR | AZ | タイプ | 用途 |
|-----------|------|----|--------|------|
| Public-A | 10.0.1.0/24 | ap-northeast-1a | Public | NAT GW, VPN |
| Public-C | 10.0.2.0/24 | ap-northeast-1c | Public | NAT GW |
| Private-A | 10.0.11.0/24 | ap-northeast-1a | Private | 将来拡張用 |
| Private-C | 10.0.12.0/24 | ap-northeast-1c | Private | 将来拡張用 |

**Service VPC**:
| サブネット | CIDR | AZ | タイプ | 用途 |
|-----------|------|----|--------|------|
| Public-A | 10.1.1.0/24 | ap-northeast-1a | Public | ALB |
| Public-C | 10.1.2.0/24 | ap-northeast-1c | Public | ALB |
| Private-A | 10.1.11.0/24 | ap-northeast-1a | Private | ECS, RDS |
| Private-C | 10.1.12.0/24 | ap-northeast-1c | Private | ECS, RDS |

### 5.4 セキュリティ前提条件

#### 5.4.1 TLS 証明書

**ALB 用 TLS 証明書**:
- AWS Certificate Manager (ACM) で発行
- ドメイン検証 (DNS または Email)
- 自己署名証明書は検証用のみ使用可

**注意**: 本番環境では正式な証明書を使用すること

#### 5.4.2 VPN クライアント証明書

**Client VPN 用証明書**:
- サーバー証明書 (ACM)
- クライアント証明書 (OpenVPN または ACM)
- 相互認証 (mutual authentication)

### 5.5 データベース前提条件

#### 5.5.1 RDS PostgreSQL

| 項目 | 前提条件 | 備考 |
|------|---------|------|
| エンジン | PostgreSQL 15 | 最新安定版 |
| インスタンスクラス | db.t3.medium | 検証用最小構成 |
| Multi-AZ | 有効 | 高可用性必須 |
| 暗号化 | 有効 (AES-256) | セキュリティ要件 |
| バックアップ | 7日間保持 | 自動バックアップ |

### 5.6 モニタリング前提条件

#### 5.6.1 CloudWatch

| 項目 | 前提条件 | 備考 |
|------|---------|------|
| Logs 保持期間 | 30日間 | コスト考慮 |
| Alarms | 全リソース監視 | ECS, RDS, ALB |
| Dashboard | 統合ビュー | 全体可視化 |
| SNS Topic | 通知先設定 | アラート通知 |

#### 5.6.2 アラート通知先

**SNS Topic**:
| Topic 名 | 用途 | サブスクリプション |
|---------|------|------------------|
| CriticalAlerts | 即時対応必要 | Email (管理者) |
| WarningAlerts | 監視・傾向分析 | Email (運用担当) |

---

## 6. 環境差分管理

### 6.1 パラメータファイル

**Platform Account**:
```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "VpcCidr",
    "ParameterValue": "10.0.0.0/16"
  }
]
```

**Service Account**:
```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "VpcCidr",
    "ParameterValue": "10.1.0.0/16"
  },
  {
    "ParameterKey": "TransitGatewayId",
    "ParameterValue": "tgw-xxxxxxxxxxxxxxxxx"
  }
]
```

### 6.2 環境別設定

| 環境 | Platform VPC | Service VPC | RDS インスタンス | 用途 |
|------|-------------|------------|-----------------|------|
| dev | 10.0.0.0/16 | 10.1.0.0/16 | db.t3.medium | 検証 |
| staging | (想定外) | (想定外) | (想定外) | - |
| production | (想定外) | (想定外) | (想定外) | - |

**注意**: 本プロジェクトは検証用のため dev 環境のみ

---

## 7. Change Set デプロイ前提条件 (⭐⭐⭐ Round 3 重点)

### 7.1 Change Set 使用必須化

**CloudFormation 3 Principles 原則3: 段階的デプロイ原則**

**必須要件**:
- すべてのスタック更新時に Change Set を使用
- 直接 `aws cloudformation deploy` は禁止
- dry-run → 確認 → 実行 の3ステップ必須

### 7.2 デプロイスクリプト前提条件

**必要なスクリプト** (⭐⭐⭐Round 3 で生成):
1. `scripts/create-changeset.sh` - Change Set 作成
2. `scripts/describe-changeset.sh` - 変更内容確認
3. `scripts/execute-changeset.sh` - ユーザー承認後に実行
4. `scripts/rollback.sh` - ロールバック処理

**詳細**: [09_インフラ設計・コスト設計.md](./09_インフラ設計・コスト設計.md)

### 7.3 Change Set 命名規則

**形式**: `{スタック名}-changeset-{タイムスタンプ}`

**例**:
```bash
platform-network-changeset-20251024-120000
service-database-changeset-20251024-130000
```

### 7.4 ロールバック前提条件

**ロールバック可能条件**:
- Change Set が Execute 前であること
- スタック更新が進行中であること
- 前のスタック状態が正常であること

**ロールバック方法**:
1. Change Set 削除 (Execute 前)
2. `aws cloudformation cancel-update-stack` (Execute 後)

---

## 8. 前提となる技術標準

### 8.1 CloudFormation 標準

**参照**: `.claude/docs/40_standards/45_cloudformation.md`

**準拠項目**:
- CloudFormation 3 Principles
- スタック分割パターン
- Change Sets 運用フロー
- dry-run 必須手順

### 8.2 Python 標準

**参照**: `.claude/docs/40_standards/47_python.md`

**準拠項目**:
- PEP 8 コーディング規約
- Type Hints 使用
- Docstring 記述

**注意**: 本プロジェクトは Node.js 使用のため、スクリプト作成時のみ参照

### 8.3 セキュリティ・運用標準

**参照**: `.claude/docs/40_standards/49_security.md`

**準拠項目**:
- セキュリティグループ設計
- ログ設計
- 監視設計
- バックアップ設計

**詳細**: [06_セキュリティ設計.md](./06_セキュリティ設計.md)

---

## 9. 制約事項まとめ

### 9.1 絶対的制約 (変更不可)

| 項目 | 制約内容 |
|------|---------|
| リージョン | ap-northeast-1 のみ |
| IaC ツール | CloudFormation のみ |
| ECS 実行タイプ | Fargate のみ |
| DB エンジン | PostgreSQL のみ |
| Change Set | **必須使用** ⭐⭐⭐ |

### 9.2 推奨制約 (可能な限り遵守)

| 項目 | 制約内容 |
|------|---------|
| Node.js バージョン | 20 LTS |
| Multi-AZ 構成 | 必須 |
| CloudWatch 監視 | 全リソース |
| ログ保持期間 | 30日間 |

### 9.3 柔軟な制約 (状況に応じて変更可)

| 項目 | 制約内容 |
|------|---------|
| 予算 | ~¥30,000/月 |
| 納期 | 設定なし |
| セキュリティレベル | 基本的な対策のみ |

---

**前章**: [00_概要.md](./00_概要.md)
**次章**: [02_アーキテクチャ設計.md](./02_アーキテクチャ設計.md)
