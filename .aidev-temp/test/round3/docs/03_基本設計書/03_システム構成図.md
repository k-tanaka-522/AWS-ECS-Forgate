# 03_ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

> AWS Multi-Account Sample Application - ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

**ä½œæˆæ—¥**: 2025-10-24 (Round 3)
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.0

---

## 1. Multi-Account å…¨ä½“æ§‹æˆå›³

### 1.1 ç‰©ç†æ§‹æˆå›³

```mermaid
graph TB
    subgraph "Internet"
        Users[ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/>ğŸŒ]
        Admin[ç®¡ç†è€…<br/>ğŸ‘¤]
    end

    subgraph "Platform Account (111111111111)"
        subgraph "Shared VPC<br/>10.0.0.0/16"
            subgraph "Public Subnet"
                VPN[Client VPN<br/>Endpoint<br/>cvpn-xxxxx]
                NATGW_P[NAT Gateway<br/>Ã—2]
            end

            subgraph "Private Subnet"
                TGW[Transit Gateway<br/>tgw-xxxxx<br/>ASN: 64512]
            end

            IGW_P[Internet<br/>Gateway]
        end

        RAM[AWS RAM<br/>Resource Share]
    end

    subgraph "Service Account (222222222222)"
        subgraph "Service VPC<br/>10.1.0.0/16"
            subgraph "Public Subnet<br/>10.1.1.0/24, 10.1.2.0/24"
                ALB_Public[ALB<br/>Public Web<br/>internet-facing]
                ALB_Admin[ALB<br/>Admin<br/>internal]
                NATGW_S[NAT Gateway<br/>Ã—2]
            end

            subgraph "Private Subnet<br/>10.1.11.0/24, 10.1.12.0/24"
                subgraph "ECS Fargate Cluster"
                    ECS_Public[Public Web<br/>Service<br/>0.25vCPU/0.5GB<br/>Ã—2ã‚¿ã‚¹ã‚¯]
                    ECS_Admin[Admin<br/>Service<br/>0.25vCPU/0.5GB<br/>Ã—1ã‚¿ã‚¹ã‚¯]
                    ECS_Batch[Batch<br/>Processing<br/>0.25vCPU/0.5GB<br/>Scheduled]
                end

                subgraph "RDS Multi-AZ"
                    RDS_Primary[(RDS PostgreSQL<br/>Primary<br/>AZ: 1a<br/>db.t3.medium)]
                    RDS_Standby[(RDS PostgreSQL<br/>Standby<br/>AZ: 1c<br/>db.t3.medium)]
                end
            end

            IGW_S[Internet<br/>Gateway]
        end

        TGW_Attach[Transit Gateway<br/>Attachment<br/>tgw-attach-xxxxx]
    end

    subgraph "Monitoring"
        CW[CloudWatch<br/>Alarms + Dashboard]
        SNS[SNS Topics<br/>Critical/Warning]
    end

    Users -->|HTTPS:443| ALB_Public
    Admin -->|OpenVPN:1194| VPN
    VPN -->|é–‰åŸŸæ¥ç¶š| TGW

    TGW <-->|10.0.0.0/16<br/>â†”<br/>10.1.0.0/16| TGW_Attach
    TGW_Attach --> ALB_Admin

    ALB_Public --> ECS_Public
    ALB_Admin --> ECS_Admin

    ECS_Public --> RDS_Primary
    ECS_Admin --> RDS_Primary
    ECS_Batch --> RDS_Primary

    RDS_Primary -.åŒæœŸãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³.- RDS_Standby

    TGW -.RAM Share.- RAM

    IGW_P --> NATGW_P
    IGW_S --> NATGW_S

    ECS_Public -.ãƒ¡ãƒˆãƒªã‚¯ã‚¹.- CW
    ECS_Admin -.ãƒ¡ãƒˆãƒªã‚¯ã‚¹.- CW
    RDS_Primary -.ãƒ¡ãƒˆãƒªã‚¯ã‚¹.- CW
    ALB_Public -.ãƒ¡ãƒˆãƒªã‚¯ã‚¹.- CW
    ALB_Admin -.ãƒ¡ãƒˆãƒªã‚¯ã‚¹.- CW

    CW -.ã‚¢ãƒ©ãƒ¼ãƒˆ.- SNS

    style TGW fill:#ff9999
    style VPN fill:#ff9999
    style RDS_Primary fill:#99ccff
    style RDS_Standby fill:#cce5ff
    style ECS_Public fill:#99ff99
    style ECS_Admin fill:#ffcc99
    style ECS_Batch fill:#ffff99
    style TGW_Attach fill:#ff9999
```

---

## 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è©³ç´°æ§‹æˆå›³

### 2.1 VPC æ§‹æˆå›³

```mermaid
graph TB
    subgraph "Platform VPC<br/>10.0.0.0/16"
        subgraph "AZ: ap-northeast-1a"
            PubSub_P_1a[Public Subnet<br/>10.0.1.0/24<br/>256 IPs]
            PrivSub_P_1a[Private Subnet<br/>10.0.11.0/24<br/>256 IPs]
        end

        subgraph "AZ: ap-northeast-1c"
            PubSub_P_1c[Public Subnet<br/>10.0.2.0/24<br/>256 IPs]
            PrivSub_P_1c[Private Subnet<br/>10.0.12.0/24<br/>256 IPs]
        end

        IGW_Platform[Internet Gateway<br/>igw-platform-xxxxx]
        NAT_P_1a[NAT Gateway<br/>nat-platform-1a<br/>EIP: xx.xx.xx.xx]
        NAT_P_1c[NAT Gateway<br/>nat-platform-1c<br/>EIP: yy.yy.yy.yy]

        VPN_Endpoint[Client VPN Endpoint<br/>cvpn-endpoint-xxxxx<br/>10.0.0.0/22]

        TGW_Hub[Transit Gateway<br/>tgw-xxxxx]
    end

    subgraph "Service VPC<br/>10.1.0.0/16"
        subgraph "AZ: ap-northeast-1a"
            PubSub_S_1a[Public Subnet<br/>10.1.1.0/24<br/>256 IPs]
            PrivSub_S_1a[Private Subnet<br/>10.1.11.0/24<br/>256 IPs]
        end

        subgraph "AZ: ap-northeast-1c"
            PubSub_S_1c[Public Subnet<br/>10.1.2.0/24<br/>256 IPs]
            PrivSub_S_1c[Private Subnet<br/>10.1.12.0/24<br/>256 IPs]
        end

        IGW_Service[Internet Gateway<br/>igw-service-xxxxx]
        NAT_S_1a[NAT Gateway<br/>nat-service-1a<br/>EIP: zz.zz.zz.zz]
        NAT_S_1c[NAT Gateway<br/>nat-service-1c<br/>EIP: ww.ww.ww.ww]

        TGW_Attach_Service[TGW Attachment<br/>tgw-attach-service]
    end

    Internet[Internet<br/>ğŸŒ]

    Internet <--> IGW_Platform
    Internet <--> IGW_Service

    IGW_Platform --> PubSub_P_1a
    IGW_Platform --> PubSub_P_1c

    IGW_Service --> PubSub_S_1a
    IGW_Service --> PubSub_S_1c

    PubSub_P_1a --> NAT_P_1a
    PubSub_P_1c --> NAT_P_1c

    PubSub_S_1a --> NAT_S_1a
    PubSub_S_1c --> NAT_S_1c

    NAT_P_1a --> PrivSub_P_1a
    NAT_P_1c --> PrivSub_P_1c

    NAT_S_1a --> PrivSub_S_1a
    NAT_S_1c --> PrivSub_S_1c

    PrivSub_P_1a --> TGW_Hub
    PrivSub_P_1c --> TGW_Hub

    PrivSub_S_1a --> TGW_Attach_Service
    PrivSub_S_1c --> TGW_Attach_Service

    TGW_Hub <-.é–‰åŸŸæ¥ç¶š.- TGW_Attach_Service

    VPN_Endpoint --> PrivSub_P_1a
    VPN_Endpoint --> PrivSub_P_1c

    style TGW_Hub fill:#ff9999
    style TGW_Attach_Service fill:#ff9999
    style VPN_Endpoint fill:#ff9999
```

---

## 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—æ§‹æˆå›³

### 3.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—é–¢ä¿‚å›³

```mermaid
graph LR
    Internet[Internet<br/>0.0.0.0/0]
    VPN_Clients[VPN Clients<br/>10.0.0.0/16]

    subgraph "Security Groups"
        SG_ALB_Public[alb-public-sg<br/>ğŸ“‹]
        SG_ALB_Admin[alb-admin-sg<br/>ğŸ“‹]
        SG_ECS_Public[ecs-public-sg<br/>ğŸ³]
        SG_ECS_Admin[ecs-admin-sg<br/>ğŸ³]
        SG_ECS_Batch[ecs-batch-sg<br/>ğŸ³]
        SG_RDS[rds-sg<br/>ğŸ’¾]
    end

    subgraph "Resources"
        ALB_Pub[ALB Public<br/>internet-facing]
        ALB_Adm[ALB Admin<br/>internal]
        ECS_Pub[ECS Public<br/>Task]
        ECS_Adm[ECS Admin<br/>Task]
        ECS_Bat[ECS Batch<br/>Task]
        RDS[RDS PostgreSQL<br/>Multi-AZ]
    end

    Internet -->|HTTPS:443| SG_ALB_Public
    VPN_Clients -->|HTTPS:443| SG_ALB_Admin

    SG_ALB_Public --> ALB_Pub
    SG_ALB_Admin --> ALB_Adm

    SG_ALB_Public -->|3000| SG_ECS_Public
    SG_ALB_Admin -->|3001| SG_ECS_Admin

    SG_ECS_Public --> ECS_Pub
    SG_ECS_Admin --> ECS_Adm
    SG_ECS_Batch --> ECS_Bat

    SG_ECS_Public -->|5432| SG_RDS
    SG_ECS_Admin -->|5432| SG_RDS
    SG_ECS_Batch -->|5432| SG_RDS

    SG_RDS --> RDS

    style SG_ALB_Public fill:#ffcccc
    style SG_ALB_Admin fill:#ffcccc
    style SG_ECS_Public fill:#ccffcc
    style SG_ECS_Admin fill:#ccffcc
    style SG_ECS_Batch fill:#ccffcc
    style SG_RDS fill:#ccccff
```

### 3.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«è©³ç´°

#### 3.2.1 alb-public-sg

**Inbound**:
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | ã‚½ãƒ¼ã‚¹ | ç”¨é€” |
|----------|--------|--------|------|
| TCP | 443 | 0.0.0.0/0 | HTTPS (Public Web) |

**Outbound**:
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | å®›å…ˆ | ç”¨é€” |
|----------|--------|------|------|
| TCP | 3000 | ecs-public-sg | ECS Public ã¸ |

#### 3.2.2 alb-admin-sg

**Inbound**:
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | ã‚½ãƒ¼ã‚¹ | ç”¨é€” |
|----------|--------|--------|------|
| TCP | 443 | 10.0.0.0/16 | HTTPS (Adminã€VPNçµŒç”±ã®ã¿) |

**Outbound**:
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | å®›å…ˆ | ç”¨é€” |
|----------|--------|------|------|
| TCP | 3001 | ecs-admin-sg | ECS Admin ã¸ |

#### 3.2.3 ecs-public-sg, ecs-admin-sg, ecs-batch-sg

**Inbound**:
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | ã‚½ãƒ¼ã‚¹ | ç”¨é€” |
|----------|--------|--------|------|
| TCP | 3000 | alb-public-sg | ALB Public ã‹ã‚‰ (Public ã®ã¿) |
| TCP | 3001 | alb-admin-sg | ALB Admin ã‹ã‚‰ (Admin ã®ã¿) |

**Outbound**:
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | å®›å…ˆ | ç”¨é€” |
|----------|--------|------|------|
| TCP | 5432 | rds-sg | RDS PostgreSQL ã¸ |
| TCP | 443 | 0.0.0.0/0 | ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ (npm installç­‰) |

#### 3.2.4 rds-sg

**Inbound**:
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆ | ã‚½ãƒ¼ã‚¹ | ç”¨é€” |
|----------|--------|--------|------|
| TCP | 5432 | ecs-public-sg | ECS Public ã‹ã‚‰ |
| TCP | 5432 | ecs-admin-sg | ECS Admin ã‹ã‚‰ |
| TCP | 5432 | ecs-batch-sg | ECS Batch ã‹ã‚‰ |

**Outbound**: ãªã— (RDS ã‹ã‚‰ã® Outbound ä¸è¦)

---

## 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼å›³

### 4.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ (Public Web)

```mermaid
sequenceDiagram
    participant User as ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/>ğŸŒ
    participant ALB as ALB Public<br/>(internet-facing)
    participant ECS as ECS Fargate<br/>Public Web
    participant RDS as RDS PostgreSQL<br/>(Multi-AZ)

    User->>ALB: 1. HTTPS GET /api/v1/products<br/>(443)
    Note over ALB: SSLçµ‚ç«¯<br/>TLS 1.2+

    ALB->>ECS: 2. HTTP GET /api/v1/products<br/>(3000)
    Note over ECS: Node.js 20<br/>Express App

    ECS->>RDS: 3. SQL SELECT<br/>FROM products<br/>(5432)
    Note over RDS: PostgreSQL 15<br/>db.t3.medium

    RDS-->>ECS: 4. Result Set<br/>(å•†å“ä¸€è¦§ãƒ‡ãƒ¼ã‚¿)

    ECS-->>ALB: 5. HTTP 200 OK<br/>JSON Response

    ALB-->>User: 6. HTTPS 200 OK<br/>å•†å“ä¸€è¦§è¡¨ç¤º

    Note over User,RDS: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ç›®æ¨™: 2ç§’ä»¥å†…
```

### 4.2 ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼ (Admin Dashboard)

```mermaid
sequenceDiagram
    participant Admin as ç®¡ç†è€…<br/>ğŸ‘¤
    participant VPN as Client VPN<br/>Endpoint
    participant TGW as Transit Gateway<br/>(é–‰åŸŸæ¥ç¶š)
    participant ALB as ALB Admin<br/>(internal)
    participant ECS as ECS Fargate<br/>Admin Service
    participant RDS as RDS PostgreSQL<br/>(Multi-AZ)

    Admin->>VPN: 1. VPNæ¥ç¶š<br/>OpenVPN (1194)
    Note over VPN: ç›¸äº’èªè¨¼<br/>(è¨¼æ˜æ›¸ãƒ™ãƒ¼ã‚¹)

    VPN-->>Admin: 2. VPNæ¥ç¶šç¢ºç«‹<br/>IPå‰²å½“: 10.0.0.x

    Admin->>VPN: 3. HTTPS GET /admin/dashboard<br/>(443, via VPN)

    VPN->>TGW: 4. é–‰åŸŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°<br/>10.0.0.0/16 â†’ 10.1.0.0/16

    TGW->>ALB: 5. HTTPSåˆ°é”<br/>Service VPC Private Subnet

    ALB->>ECS: 6. HTTP GET /admin/dashboard<br/>(3001)

    ECS->>RDS: 7. SQL SELECT<br/>FROM orders, users<br/>(5432)

    RDS-->>ECS: 8. Result Set<br/>(ç®¡ç†ãƒ‡ãƒ¼ã‚¿)

    ECS-->>ALB: 9. HTTP 200 OK<br/>JSON Response

    ALB-->>TGW: 10. HTTPS Response

    TGW-->>VPN: 11. é–‰åŸŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°<br/>10.1.0.0/16 â†’ 10.0.0.0/16

    VPN-->>Admin: 12. HTTPS 200 OK<br/>ç®¡ç†ç”»é¢è¡¨ç¤º

    Note over Admin,RDS: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: VPNçµŒç”±ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½<br/>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
```

### 4.3 ãƒãƒƒãƒå‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant EB as EventBridge<br/>(CloudWatch Events)
    participant ECS as ECS Fargate<br/>Batch Processing
    participant RDS as RDS PostgreSQL<br/>(Multi-AZ)
    participant CW as CloudWatch Logs

    Note over EB: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«<br/>cron(0 1 * * ? *)<br/>(æ¯æ—¥æ·±å¤œ1æ™‚)

    EB->>ECS: 1. ECS Taskèµ·å‹•<br/>Scheduled Task

    ECS->>RDS: 2. SQL SELECT<br/>FROM orders<br/>WHERE order_date = CURRENT_DATE - 1
    Note over ECS: ãƒ‡ãƒ¼ã‚¿é›†è¨ˆå‡¦ç†<br/>ãƒ»æ—¥æ¬¡å£²ä¸Šé›†è¨ˆ<br/>ãƒ»åœ¨åº«æ›´æ–°<br/>ãƒ»ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

    RDS-->>ECS: 3. Result Set<br/>(å‰æ—¥æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿)

    ECS->>ECS: 4. ãƒ‡ãƒ¼ã‚¿å‡¦ç†<br/>é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ

    ECS->>RDS: 5. SQL INSERT<br/>INTO daily_reports<br/>(é›†è¨ˆçµæœä¿å­˜)

    RDS-->>ECS: 6. INSERT Success

    ECS->>CW: 7. ãƒ­ã‚°å‡ºåŠ›<br/>/aws/ecs/batch

    Note over CW: ãƒ­ã‚°å†…å®¹:<br/>ãƒ»å‡¦ç†ä»¶æ•°<br/>ãƒ»å‡¦ç†æ™‚é–“<br/>ãƒ»ã‚¨ãƒ©ãƒ¼æœ‰ç„¡

    ECS-->>EB: 8. Taskçµ‚äº† (SUCCESS)

    Note over EB,CW: å®Ÿè¡Œå±¥æ­´: CloudWatch Logs<br/>ä¿æŒæœŸé–“: 30æ—¥
```

---

## 5. Multi-AZ å¯ç”¨æ€§æ§‹æˆå›³

### 5.1 å¯ç”¨æ€§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph TB
    subgraph "Internet"
        Users[ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/>ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯]
    end

    subgraph "Service VPC - AZ: ap-northeast-1a"
        subgraph "Public Subnet 1a"
            ALB_1a[ALB<br/>Public Web<br/>(Primary)]
        end

        subgraph "Private Subnet 1a"
            ECS_1a[ECS Fargate<br/>Task 1<br/>(Active)]
            RDS_Primary[(RDS PostgreSQL<br/>Primary<br/>(Read/Write))]
        end
    end

    subgraph "Service VPC - AZ: ap-northeast-1c"
        subgraph "Public Subnet 1c"
            ALB_1c[ALB<br/>Public Web<br/>(Standby)]
        end

        subgraph "Private Subnet 1c"
            ECS_1c[ECS Fargate<br/>Task 2<br/>(Active)]
            RDS_Standby[(RDS PostgreSQL<br/>Standby<br/>(Read Only))]
        end
    end

    Users --> ALB_1a
    Users --> ALB_1c

    ALB_1a --> ECS_1a
    ALB_1c --> ECS_1c

    ECS_1a --> RDS_Primary
    ECS_1c --> RDS_Primary

    RDS_Primary -.åŒæœŸãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³<br/>(Synchronous).- RDS_Standby

    Note_AZ1a[éšœå®³æ™‚:<br/>1. ALB ãŒè‡ªå‹•ã§ 1c ã¸<br/>2. ECS Task 1 åœæ­¢<br/>3. RDS Standby ãŒ Primary ã«æ˜‡æ ¼]
    Note_AZ1c[æ­£å¸¸æ™‚:<br/>1. ALB ãŒä¸¡ AZ ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°<br/>2. ECS Task ãŒä¸¡ AZ ã§ç¨¼åƒ<br/>3. RDS Primary ãŒ Read/Write]

    style RDS_Primary fill:#99ccff
    style RDS_Standby fill:#cce5ff
    style ECS_1a fill:#99ff99
    style ECS_1c fill:#99ff99
```

### 5.2 éšœå®³å¾©æ—§ãƒ•ãƒ­ãƒ¼

**AZ éšœå®³ç™ºç”Ÿæ™‚**:
1. ALB ãŒç•°å¸¸ AZ ã‚’è‡ªå‹•æ¤œå‡º (ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—)
2. ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æ­£å¸¸ AZ ã¸è‡ªå‹•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
3. RDS Multi-AZ ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ (60-120ç§’)
4. ECS Service ãŒæ­£å¸¸ AZ ã§æ–°è¦ Task èµ·å‹•

**RTO (Recovery Time Objective)**: 2åˆ†ä»¥å†…
**RPO (Recovery Point Objective)**: 0 (åŒæœŸãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)

---

## 6. CloudFormation ã‚¹ã‚¿ãƒƒã‚¯æ§‹æˆå›³

### 6.1 ã‚¹ã‚¿ãƒƒã‚¯ä¾å­˜é–¢ä¿‚å›³

```mermaid
graph TD
    subgraph "Platform Account"
        P_Network[platform-network<br/>VPC, Subnets, NAT GW]
        P_TGW[platform-tgw<br/>Transit Gateway<br/>RAM Share]
    end

    subgraph "Service Account"
        S_Network[service-network<br/>VPC, Subnets, NAT GW<br/>TGW Attachment]
        S_Database[service-database<br/>RDS PostgreSQL<br/>Multi-AZ]
        S_Compute[service-compute<br/>ECS Cluster<br/>Task Definition<br/>Service, ALB]
        S_Monitoring[service-monitoring<br/>CloudWatch Alarms<br/>Dashboard, SNS]
    end

    P_Network --> P_TGW
    P_TGW -.Cross-Account<br/>RAM Share.- S_Network
    S_Network --> S_Database
    S_Database --> S_Compute
    S_Compute --> S_Monitoring

    Note_Deploy[ãƒ‡ãƒ—ãƒ­ã‚¤é †åº:<br/>1. platform-network<br/>2. platform-tgw<br/>3. service-network<br/>4. service-database<br/>5. service-compute<br/>6. service-monitoring]

    Note_Rollback[å‰Šé™¤é †åº (é€†é †):<br/>6. service-monitoring<br/>5. service-compute<br/>4. service-database<br/>3. service-network<br/>2. platform-tgw<br/>1. platform-network]

    style P_Network fill:#ffcccc
    style P_TGW fill:#ffcccc
    style S_Network fill:#ccffcc
    style S_Database fill:#ccccff
    style S_Compute fill:#ffffcc
    style S_Monitoring fill:#ffccff
```

### 6.2 Change Set ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ (â­â­â­ Round 3 é‡ç‚¹)

```mermaid
sequenceDiagram
    participant Dev as é–‹ç™ºè€…<br/>ğŸ‘¤
    participant Create as create-changeset.sh
    participant Describe as describe-changeset.sh
    participant Execute as execute-changeset.sh
    participant CFN as CloudFormation
    participant AWS as AWS Resources

    Dev->>Create: 1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ<br/>./create-changeset.sh platform-network
    Create->>CFN: aws cloudformation create-change-set<br/>--stack-name platform-network<br/>--change-set-name platform-network-changeset-{timestamp}
    CFN-->>Create: Change Set ID: cs-xxxxx
    Create-->>Dev: Change Setä½œæˆå®Œäº†<br/>ID: cs-xxxxx

    Dev->>Describe: 2. å¤‰æ›´å†…å®¹ç¢ºèª<br/>./describe-changeset.sh platform-network
    Describe->>CFN: aws cloudformation describe-change-set<br/>--change-set-name cs-xxxxx
    CFN-->>Describe: å¤‰æ›´å†…å®¹è©³ç´°<br/>ãƒ»è¿½åŠ : VPC<br/>ãƒ»å¤‰æ›´: Subnet CIDR<br/>ãƒ»å‰Šé™¤: ãªã—
    Describe-->>Dev: å¤‰æ›´å†…å®¹è¡¨ç¤º<br/>(dry-run çµæœ)

    Note over Dev: å¤‰æ›´å†…å®¹ã‚’ç¢ºèª<br/>å•é¡Œãªã‘ã‚Œã°å®Ÿè¡Œ

    Dev->>Execute: 3. å®Ÿè¡Œç¢ºèª<br/>./execute-changeset.sh platform-network
    Execute->>Dev: "Execute change set? (yes/no):"
    Dev-->>Execute: yes

    Execute->>CFN: aws cloudformation execute-change-set<br/>--change-set-name cs-xxxxx
    CFN->>AWS: ãƒªã‚½ãƒ¼ã‚¹å¤‰æ›´å®Ÿè¡Œ<br/>VPCä½œæˆã€Subnetå¤‰æ›´
    AWS-->>CFN: å¤‰æ›´å®Œäº†é€šçŸ¥
    CFN-->>Execute: ã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°å®Œäº†<br/>Status: UPDATE_COMPLETE
    Execute-->>Dev: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

    Note over Dev,AWS: Change Set ã«ã‚ˆã‚Šå®‰å…¨ãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿç¾<br/>äº‹å‰ç¢ºèª â†’ æ‰¿èª â†’ å®Ÿè¡Œ
```

**è©³ç´°**: [09_ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆãƒ»ã‚³ã‚¹ãƒˆè¨­è¨ˆ.md](./09_ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆãƒ»ã‚³ã‚¹ãƒˆè¨­è¨ˆ.md)

---

## 7. ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ§‹æˆå›³

### 7.1 CloudWatch Dashboard ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```mermaid
graph TB
    subgraph "CloudWatch Dashboard: AWS Multi-Account Sample"
        subgraph "Row 1: ECS ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
            ECS_CPU[ECS CPU ä½¿ç”¨ç‡<br/>Public/Admin/Batch]
            ECS_Mem[ECS Memory ä½¿ç”¨ç‡<br/>Public/Admin/Batch]
            ECS_Task[ECS Task æ•°<br/>Running/Pending/Stopped]
        end

        subgraph "Row 2: RDS ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
            RDS_CPU[RDS CPU ä½¿ç”¨ç‡<br/>Primary/Standby]
            RDS_Conn[RDS æ¥ç¶šæ•°<br/>Active Connections]
            RDS_Lag[ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚°<br/>(Multi-AZ)]
        end

        subgraph "Row 3: ALB ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
            ALB_Req[ALB ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°<br/>Public/Admin]
            ALB_Error[ALB ã‚¨ãƒ©ãƒ¼ç‡<br/>4xx/5xx]
            ALB_Latency[ALB ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ <br/>Target Response Time]
        end

        subgraph "Row 4: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
            TGW_Packets[TGW ãƒ‘ã‚±ãƒƒãƒˆæ•°<br/>Sent/Received]
            VPN_Conn[VPN æ¥ç¶šæ•°<br/>Active Connections]
            NAT_Traffic[NAT GW ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯<br/>Bytes Out]
        end
    end

    subgraph "CloudWatch Alarms"
        Alarm_Critical[Critical Alarms<br/>ãƒ»ECS Task 0<br/>ãƒ»RDS æ¥ç¶šä¸å¯<br/>ãƒ»ALB ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç•°å¸¸]
        Alarm_Warning[Warning Alarms<br/>ãƒ»CPU 80%<br/>ãƒ»Memory 80%<br/>ãƒ»5xx 5%]
    end

    subgraph "SNS Topics"
        SNS_Critical[SNS: CriticalAlerts<br/>â†’ Email (ç®¡ç†è€…)]
        SNS_Warning[SNS: WarningAlerts<br/>â†’ Email (é‹ç”¨æ‹…å½“)]
    end

    Alarm_Critical --> SNS_Critical
    Alarm_Warning --> SNS_Warning

    style ECS_CPU fill:#99ff99
    style RDS_CPU fill:#99ccff
    style ALB_Req fill:#ffcc99
    style Alarm_Critical fill:#ff9999
    style Alarm_Warning fill:#ffff99
```

---

## 8. ãƒªã‚½ãƒ¼ã‚¹é…ç½®ãƒãƒƒãƒ—

### 8.1 Platform Account ãƒªã‚½ãƒ¼ã‚¹é…ç½®

| ãƒªã‚½ãƒ¼ã‚¹ | AZ | Subnet | CIDR | IPç¯„å›² |
|---------|----|----|------|--------|
| NAT GW (1a) | ap-northeast-1a | platform-public-1a | 10.0.1.0/24 | 10.0.1.0 - 10.0.1.255 |
| NAT GW (1c) | ap-northeast-1c | platform-public-1c | 10.0.2.0/24 | 10.0.2.0 - 10.0.2.255 |
| VPN Endpoint | Multi-AZ | platform-private-* | 10.0.11.0/24, 10.0.12.0/24 | 10.0.11.0 - 10.0.12.255 |
| Transit Gateway | Multi-AZ | platform-private-* | - | - |

### 8.2 Service Account ãƒªã‚½ãƒ¼ã‚¹é…ç½®

| ãƒªã‚½ãƒ¼ã‚¹ | AZ | Subnet | CIDR | IPç¯„å›² |
|---------|----|----|------|--------|
| ALB Public | Multi-AZ | service-public-* | 10.1.1.0/24, 10.1.2.0/24 | 10.1.1.0 - 10.1.2.255 |
| ALB Admin | Multi-AZ | service-private-* | 10.1.11.0/24, 10.1.12.0/24 | 10.1.11.0 - 10.1.12.255 |
| ECS Public (Task 1) | ap-northeast-1a | service-private-1a | 10.1.11.0/24 | 10.1.11.x |
| ECS Public (Task 2) | ap-northeast-1c | service-private-1c | 10.1.12.0/24 | 10.1.12.x |
| ECS Admin | ap-northeast-1a | service-private-1a | 10.1.11.0/24 | 10.1.11.y |
| ECS Batch | ap-northeast-1a | service-private-1a | 10.1.11.0/24 | 10.1.11.z |
| RDS Primary | ap-northeast-1a | service-private-1a | 10.1.11.0/24 | 10.1.11.10 |
| RDS Standby | ap-northeast-1c | service-private-1c | 10.1.12.0/24 | 10.1.12.10 |
| NAT GW (1a) | ap-northeast-1a | service-public-1a | 10.1.1.0/24 | 10.1.1.x |
| NAT GW (1c) | ap-northeast-1c | service-public-1c | 10.1.2.0/24 | 10.1.2.x |

---

## 9. æ§‹æˆå›³ã¾ã¨ã‚

### 9.1 ç”Ÿæˆã—ãŸ Mermaid å›³ä¸€è¦§

| # | å›³å | å†…å®¹ | é‡è¦åº¦ |
|---|------|------|--------|
| 1 | Multi-Account å…¨ä½“æ§‹æˆå›³ | Platform/Service Account ã®ç‰©ç†æ§‹æˆ | â­â­â­ |
| 2 | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è©³ç´°æ§‹æˆå›³ | VPC, Subnet, NAT GW, TGW æ§‹æˆ | â­â­â­ |
| 3 | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—æ§‹æˆå›³ | SG é–“ã®ä¾å­˜é–¢ä¿‚ | â­â­ |
| 4 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ | Public Web ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ | â­â­ |
| 5 | ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼ | VPN çµŒç”±ã®é–‰åŸŸã‚¢ã‚¯ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼ | â­â­â­ |
| 6 | ãƒãƒƒãƒå‡¦ç†ãƒ•ãƒ­ãƒ¼ | Scheduled Task ã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ | â­ |
| 7 | Multi-AZ å¯ç”¨æ€§æ§‹æˆå›³ | éšœå®³å¾©æ—§ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | â­â­â­ |
| 8 | CloudFormation ã‚¹ã‚¿ãƒƒã‚¯æ§‹æˆå›³ | ã‚¹ã‚¿ãƒƒã‚¯ä¾å­˜é–¢ä¿‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤é †åº | â­â­â­ |
| 9 | Change Set ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ | Change Set ã«ã‚ˆã‚‹æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ | â­â­â­ (Round 3 é‡ç‚¹) |
| 10 | ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ§‹æˆå›³ | CloudWatch Dashboard ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ | â­â­ |

**åˆè¨ˆ**: 10å€‹ã® Mermaid å›³ âœ… (ç›®æ¨™5å€‹ä»¥ä¸Šé”æˆ)

### 9.2 Round 3 é‡ç‚¹é …ç›®

**Change Set ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼å›³** (å›³9):
- create-changeset.sh â†’ describe-changeset.sh â†’ execute-changeset.sh ã®æµã‚Œã‚’å¯è¦–åŒ–
- dry-run â†’ ç¢ºèª â†’ å®Ÿè¡Œ ã®3ã‚¹ãƒ†ãƒƒãƒ—ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ˜ç¤º
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ã‚’å«ã‚€

**è©³ç´°**: [09_ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆãƒ»ã‚³ã‚¹ãƒˆè¨­è¨ˆ.md](./09_ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆãƒ»ã‚³ã‚¹ãƒˆè¨­è¨ˆ.md)

---

**å‰ç« **: [02_ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ.md](./02_ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ.md)
**æ¬¡ç« **: [04_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ.md](./04_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ.md)
