# 03_システム構成図

> AWS Multi-Account Sample Application - システム構成図

**作成日**: 2025-10-24 (Round 3)
**バージョン**: 3.0

---

## 1. Multi-Account 全体構成図

### 1.1 物理構成図

```mermaid
graph TB
    subgraph "Internet"
        Users[一般ユーザー<br/>🌐]
        Admin[管理者<br/>👤]
    end

    subgraph "Platform Account (111111111111)"
        subgraph "Shared VPC<br/>10.0.0.0/16"
            subgraph "Public Subnet"
                VPN[Client VPN<br/>Endpoint<br/>cvpn-xxxxx]
                NATGW_P[NAT Gateway<br/>×2]
            end

            subgraph "Private Subnet"
                TGW[Transit Gateway<br/>tgw-xxxxx<br/>ASN: 64512]
            end

            IGW_P[Internet<br/>Gateway]
        end

        RAM[AWS RAM<br/>Resource Share]
    end

    subgraph "Service Account (222222222222)"
        subgraph "Service VPC<br/>10.1.0.0/16"
            subgraph "Public Subnet<br/>10.1.1.0/24, 10.1.2.0/24"
                ALB_Public[ALB<br/>Public Web<br/>internet-facing]
                ALB_Admin[ALB<br/>Admin<br/>internal]
                NATGW_S[NAT Gateway<br/>×2]
            end

            subgraph "Private Subnet<br/>10.1.11.0/24, 10.1.12.0/24"
                subgraph "ECS Fargate Cluster"
                    ECS_Public[Public Web<br/>Service<br/>0.25vCPU/0.5GB<br/>×2タスク]
                    ECS_Admin[Admin<br/>Service<br/>0.25vCPU/0.5GB<br/>×1タスク]
                    ECS_Batch[Batch<br/>Processing<br/>0.25vCPU/0.5GB<br/>Scheduled]
                end

                subgraph "RDS Multi-AZ"
                    RDS_Primary[(RDS PostgreSQL<br/>Primary<br/>AZ: 1a<br/>db.t3.medium)]
                    RDS_Standby[(RDS PostgreSQL<br/>Standby<br/>AZ: 1c<br/>db.t3.medium)]
                end
            end

            IGW_S[Internet<br/>Gateway]
        end

        TGW_Attach[Transit Gateway<br/>Attachment<br/>tgw-attach-xxxxx]
    end

    subgraph "Monitoring"
        CW[CloudWatch<br/>Alarms + Dashboard]
        SNS[SNS Topics<br/>Critical/Warning]
    end

    Users -->|HTTPS:443| ALB_Public
    Admin -->|OpenVPN:1194| VPN
    VPN -->|閉域接続| TGW

    TGW <-->|10.0.0.0/16<br/>↔<br/>10.1.0.0/16| TGW_Attach
    TGW_Attach --> ALB_Admin

    ALB_Public --> ECS_Public
    ALB_Admin --> ECS_Admin

    ECS_Public --> RDS_Primary
    ECS_Admin --> RDS_Primary
    ECS_Batch --> RDS_Primary

    RDS_Primary -.同期レプリケーション.- RDS_Standby

    TGW -.RAM Share.- RAM

    IGW_P --> NATGW_P
    IGW_S --> NATGW_S

    ECS_Public -.メトリクス.- CW
    ECS_Admin -.メトリクス.- CW
    RDS_Primary -.メトリクス.- CW
    ALB_Public -.メトリクス.- CW
    ALB_Admin -.メトリクス.- CW

    CW -.アラート.- SNS

    style TGW fill:#ff9999
    style VPN fill:#ff9999
    style RDS_Primary fill:#99ccff
    style RDS_Standby fill:#cce5ff
    style ECS_Public fill:#99ff99
    style ECS_Admin fill:#ffcc99
    style ECS_Batch fill:#ffff99
    style TGW_Attach fill:#ff9999
```

---

## 2. ネットワーク詳細構成図

### 2.1 VPC 構成図

```mermaid
graph TB
    subgraph "Platform VPC<br/>10.0.0.0/16"
        subgraph "AZ: ap-northeast-1a"
            PubSub_P_1a[Public Subnet<br/>10.0.1.0/24<br/>256 IPs]
            PrivSub_P_1a[Private Subnet<br/>10.0.11.0/24<br/>256 IPs]
        end

        subgraph "AZ: ap-northeast-1c"
            PubSub_P_1c[Public Subnet<br/>10.0.2.0/24<br/>256 IPs]
            PrivSub_P_1c[Private Subnet<br/>10.0.12.0/24<br/>256 IPs]
        end

        IGW_Platform[Internet Gateway<br/>igw-platform-xxxxx]
        NAT_P_1a[NAT Gateway<br/>nat-platform-1a<br/>EIP: xx.xx.xx.xx]
        NAT_P_1c[NAT Gateway<br/>nat-platform-1c<br/>EIP: yy.yy.yy.yy]

        VPN_Endpoint[Client VPN Endpoint<br/>cvpn-endpoint-xxxxx<br/>10.0.0.0/22]

        TGW_Hub[Transit Gateway<br/>tgw-xxxxx]
    end

    subgraph "Service VPC<br/>10.1.0.0/16"
        subgraph "AZ: ap-northeast-1a"
            PubSub_S_1a[Public Subnet<br/>10.1.1.0/24<br/>256 IPs]
            PrivSub_S_1a[Private Subnet<br/>10.1.11.0/24<br/>256 IPs]
        end

        subgraph "AZ: ap-northeast-1c"
            PubSub_S_1c[Public Subnet<br/>10.1.2.0/24<br/>256 IPs]
            PrivSub_S_1c[Private Subnet<br/>10.1.12.0/24<br/>256 IPs]
        end

        IGW_Service[Internet Gateway<br/>igw-service-xxxxx]
        NAT_S_1a[NAT Gateway<br/>nat-service-1a<br/>EIP: zz.zz.zz.zz]
        NAT_S_1c[NAT Gateway<br/>nat-service-1c<br/>EIP: ww.ww.ww.ww]

        TGW_Attach_Service[TGW Attachment<br/>tgw-attach-service]
    end

    Internet[Internet<br/>🌐]

    Internet <--> IGW_Platform
    Internet <--> IGW_Service

    IGW_Platform --> PubSub_P_1a
    IGW_Platform --> PubSub_P_1c

    IGW_Service --> PubSub_S_1a
    IGW_Service --> PubSub_S_1c

    PubSub_P_1a --> NAT_P_1a
    PubSub_P_1c --> NAT_P_1c

    PubSub_S_1a --> NAT_S_1a
    PubSub_S_1c --> NAT_S_1c

    NAT_P_1a --> PrivSub_P_1a
    NAT_P_1c --> PrivSub_P_1c

    NAT_S_1a --> PrivSub_S_1a
    NAT_S_1c --> PrivSub_S_1c

    PrivSub_P_1a --> TGW_Hub
    PrivSub_P_1c --> TGW_Hub

    PrivSub_S_1a --> TGW_Attach_Service
    PrivSub_S_1c --> TGW_Attach_Service

    TGW_Hub <-.閉域接続.- TGW_Attach_Service

    VPN_Endpoint --> PrivSub_P_1a
    VPN_Endpoint --> PrivSub_P_1c

    style TGW_Hub fill:#ff9999
    style TGW_Attach_Service fill:#ff9999
    style VPN_Endpoint fill:#ff9999
```

---

## 3. セキュリティグループ構成図

### 3.1 セキュリティグループ関係図

```mermaid
graph LR
    Internet[Internet<br/>0.0.0.0/0]
    VPN_Clients[VPN Clients<br/>10.0.0.0/16]

    subgraph "Security Groups"
        SG_ALB_Public[alb-public-sg<br/>📋]
        SG_ALB_Admin[alb-admin-sg<br/>📋]
        SG_ECS_Public[ecs-public-sg<br/>🐳]
        SG_ECS_Admin[ecs-admin-sg<br/>🐳]
        SG_ECS_Batch[ecs-batch-sg<br/>🐳]
        SG_RDS[rds-sg<br/>💾]
    end

    subgraph "Resources"
        ALB_Pub[ALB Public<br/>internet-facing]
        ALB_Adm[ALB Admin<br/>internal]
        ECS_Pub[ECS Public<br/>Task]
        ECS_Adm[ECS Admin<br/>Task]
        ECS_Bat[ECS Batch<br/>Task]
        RDS[RDS PostgreSQL<br/>Multi-AZ]
    end

    Internet -->|HTTPS:443| SG_ALB_Public
    VPN_Clients -->|HTTPS:443| SG_ALB_Admin

    SG_ALB_Public --> ALB_Pub
    SG_ALB_Admin --> ALB_Adm

    SG_ALB_Public -->|3000| SG_ECS_Public
    SG_ALB_Admin -->|3001| SG_ECS_Admin

    SG_ECS_Public --> ECS_Pub
    SG_ECS_Admin --> ECS_Adm
    SG_ECS_Batch --> ECS_Bat

    SG_ECS_Public -->|5432| SG_RDS
    SG_ECS_Admin -->|5432| SG_RDS
    SG_ECS_Batch -->|5432| SG_RDS

    SG_RDS --> RDS

    style SG_ALB_Public fill:#ffcccc
    style SG_ALB_Admin fill:#ffcccc
    style SG_ECS_Public fill:#ccffcc
    style SG_ECS_Admin fill:#ccffcc
    style SG_ECS_Batch fill:#ccffcc
    style SG_RDS fill:#ccccff
```

### 3.2 セキュリティグループルール詳細

#### 3.2.1 alb-public-sg

**Inbound**:
| プロトコル | ポート | ソース | 用途 |
|----------|--------|--------|------|
| TCP | 443 | 0.0.0.0/0 | HTTPS (Public Web) |

**Outbound**:
| プロトコル | ポート | 宛先 | 用途 |
|----------|--------|------|------|
| TCP | 3000 | ecs-public-sg | ECS Public へ |

#### 3.2.2 alb-admin-sg

**Inbound**:
| プロトコル | ポート | ソース | 用途 |
|----------|--------|--------|------|
| TCP | 443 | 10.0.0.0/16 | HTTPS (Admin、VPN経由のみ) |

**Outbound**:
| プロトコル | ポート | 宛先 | 用途 |
|----------|--------|------|------|
| TCP | 3001 | ecs-admin-sg | ECS Admin へ |

#### 3.2.3 ecs-public-sg, ecs-admin-sg, ecs-batch-sg

**Inbound**:
| プロトコル | ポート | ソース | 用途 |
|----------|--------|--------|------|
| TCP | 3000 | alb-public-sg | ALB Public から (Public のみ) |
| TCP | 3001 | alb-admin-sg | ALB Admin から (Admin のみ) |

**Outbound**:
| プロトコル | ポート | 宛先 | 用途 |
|----------|--------|------|------|
| TCP | 5432 | rds-sg | RDS PostgreSQL へ |
| TCP | 443 | 0.0.0.0/0 | インターネット (npm install等) |

#### 3.2.4 rds-sg

**Inbound**:
| プロトコル | ポート | ソース | 用途 |
|----------|--------|--------|------|
| TCP | 5432 | ecs-public-sg | ECS Public から |
| TCP | 5432 | ecs-admin-sg | ECS Admin から |
| TCP | 5432 | ecs-batch-sg | ECS Batch から |

**Outbound**: なし (RDS からの Outbound 不要)

---

## 4. アプリケーションフロー図

### 4.1 ユーザーリクエストフロー (Public Web)

```mermaid
sequenceDiagram
    participant User as 一般ユーザー<br/>🌐
    participant ALB as ALB Public<br/>(internet-facing)
    participant ECS as ECS Fargate<br/>Public Web
    participant RDS as RDS PostgreSQL<br/>(Multi-AZ)

    User->>ALB: 1. HTTPS GET /api/v1/products<br/>(443)
    Note over ALB: SSL終端<br/>TLS 1.2+

    ALB->>ECS: 2. HTTP GET /api/v1/products<br/>(3000)
    Note over ECS: Node.js 20<br/>Express App

    ECS->>RDS: 3. SQL SELECT<br/>FROM products<br/>(5432)
    Note over RDS: PostgreSQL 15<br/>db.t3.medium

    RDS-->>ECS: 4. Result Set<br/>(商品一覧データ)

    ECS-->>ALB: 5. HTTP 200 OK<br/>JSON Response

    ALB-->>User: 6. HTTPS 200 OK<br/>商品一覧表示

    Note over User,RDS: レスポンスタイム目標: 2秒以内
```

### 4.2 管理者アクセスフロー (Admin Dashboard)

```mermaid
sequenceDiagram
    participant Admin as 管理者<br/>👤
    participant VPN as Client VPN<br/>Endpoint
    participant TGW as Transit Gateway<br/>(閉域接続)
    participant ALB as ALB Admin<br/>(internal)
    participant ECS as ECS Fargate<br/>Admin Service
    participant RDS as RDS PostgreSQL<br/>(Multi-AZ)

    Admin->>VPN: 1. VPN接続<br/>OpenVPN (1194)
    Note over VPN: 相互認証<br/>(証明書ベース)

    VPN-->>Admin: 2. VPN接続確立<br/>IP割当: 10.0.0.x

    Admin->>VPN: 3. HTTPS GET /admin/dashboard<br/>(443, via VPN)

    VPN->>TGW: 4. 閉域ルーティング<br/>10.0.0.0/16 → 10.1.0.0/16

    TGW->>ALB: 5. HTTPS到達<br/>Service VPC Private Subnet

    ALB->>ECS: 6. HTTP GET /admin/dashboard<br/>(3001)

    ECS->>RDS: 7. SQL SELECT<br/>FROM orders, users<br/>(5432)

    RDS-->>ECS: 8. Result Set<br/>(管理データ)

    ECS-->>ALB: 9. HTTP 200 OK<br/>JSON Response

    ALB-->>TGW: 10. HTTPS Response

    TGW-->>VPN: 11. 閉域ルーティング<br/>10.1.0.0/16 → 10.0.0.0/16

    VPN-->>Admin: 12. HTTPS 200 OK<br/>管理画面表示

    Note over Admin,RDS: セキュリティ: VPN経由のみアクセス可能<br/>インターネット直接アクセス不可
```

### 4.3 バッチ処理フロー

```mermaid
sequenceDiagram
    participant EB as EventBridge<br/>(CloudWatch Events)
    participant ECS as ECS Fargate<br/>Batch Processing
    participant RDS as RDS PostgreSQL<br/>(Multi-AZ)
    participant CW as CloudWatch Logs

    Note over EB: スケジュール<br/>cron(0 1 * * ? *)<br/>(毎日深夜1時)

    EB->>ECS: 1. ECS Task起動<br/>Scheduled Task

    ECS->>RDS: 2. SQL SELECT<br/>FROM orders<br/>WHERE order_date = CURRENT_DATE - 1
    Note over ECS: データ集計処理<br/>・日次売上集計<br/>・在庫更新<br/>・レポート生成

    RDS-->>ECS: 3. Result Set<br/>(前日注文データ)

    ECS->>ECS: 4. データ処理<br/>集計ロジック実行

    ECS->>RDS: 5. SQL INSERT<br/>INTO daily_reports<br/>(集計結果保存)

    RDS-->>ECS: 6. INSERT Success

    ECS->>CW: 7. ログ出力<br/>/aws/ecs/batch

    Note over CW: ログ内容:<br/>・処理件数<br/>・処理時間<br/>・エラー有無

    ECS-->>EB: 8. Task終了 (SUCCESS)

    Note over EB,CW: 実行履歴: CloudWatch Logs<br/>保持期間: 30日
```

---

## 5. Multi-AZ 可用性構成図

### 5.1 可用性アーキテクチャ

```mermaid
graph TB
    subgraph "Internet"
        Users[ユーザー<br/>トラフィック]
    end

    subgraph "Service VPC - AZ: ap-northeast-1a"
        subgraph "Public Subnet 1a"
            ALB_1a[ALB<br/>Public Web<br/>(Primary)]
        end

        subgraph "Private Subnet 1a"
            ECS_1a[ECS Fargate<br/>Task 1<br/>(Active)]
            RDS_Primary[(RDS PostgreSQL<br/>Primary<br/>(Read/Write))]
        end
    end

    subgraph "Service VPC - AZ: ap-northeast-1c"
        subgraph "Public Subnet 1c"
            ALB_1c[ALB<br/>Public Web<br/>(Standby)]
        end

        subgraph "Private Subnet 1c"
            ECS_1c[ECS Fargate<br/>Task 2<br/>(Active)]
            RDS_Standby[(RDS PostgreSQL<br/>Standby<br/>(Read Only))]
        end
    end

    Users --> ALB_1a
    Users --> ALB_1c

    ALB_1a --> ECS_1a
    ALB_1c --> ECS_1c

    ECS_1a --> RDS_Primary
    ECS_1c --> RDS_Primary

    RDS_Primary -.同期レプリケーション<br/>(Synchronous).- RDS_Standby

    Note_AZ1a[障害時:<br/>1. ALB が自動で 1c へ<br/>2. ECS Task 1 停止<br/>3. RDS Standby が Primary に昇格]
    Note_AZ1c[正常時:<br/>1. ALB が両 AZ にルーティング<br/>2. ECS Task が両 AZ で稼働<br/>3. RDS Primary が Read/Write]

    style RDS_Primary fill:#99ccff
    style RDS_Standby fill:#cce5ff
    style ECS_1a fill:#99ff99
    style ECS_1c fill:#99ff99
```

### 5.2 障害復旧フロー

**AZ 障害発生時**:
1. ALB が異常 AZ を自動検出 (ヘルスチェック失敗)
2. トラフィックを正常 AZ へ自動ルーティング
3. RDS Multi-AZ フェイルオーバー (60-120秒)
4. ECS Service が正常 AZ で新規 Task 起動

**RTO (Recovery Time Objective)**: 2分以内
**RPO (Recovery Point Objective)**: 0 (同期レプリケーション)

---

## 6. CloudFormation スタック構成図

### 6.1 スタック依存関係図

```mermaid
graph TD
    subgraph "Platform Account"
        P_Network[platform-network<br/>VPC, Subnets, NAT GW]
        P_TGW[platform-tgw<br/>Transit Gateway<br/>RAM Share]
    end

    subgraph "Service Account"
        S_Network[service-network<br/>VPC, Subnets, NAT GW<br/>TGW Attachment]
        S_Database[service-database<br/>RDS PostgreSQL<br/>Multi-AZ]
        S_Compute[service-compute<br/>ECS Cluster<br/>Task Definition<br/>Service, ALB]
        S_Monitoring[service-monitoring<br/>CloudWatch Alarms<br/>Dashboard, SNS]
    end

    P_Network --> P_TGW
    P_TGW -.Cross-Account<br/>RAM Share.- S_Network
    S_Network --> S_Database
    S_Database --> S_Compute
    S_Compute --> S_Monitoring

    Note_Deploy[デプロイ順序:<br/>1. platform-network<br/>2. platform-tgw<br/>3. service-network<br/>4. service-database<br/>5. service-compute<br/>6. service-monitoring]

    Note_Rollback[削除順序 (逆順):<br/>6. service-monitoring<br/>5. service-compute<br/>4. service-database<br/>3. service-network<br/>2. platform-tgw<br/>1. platform-network]

    style P_Network fill:#ffcccc
    style P_TGW fill:#ffcccc
    style S_Network fill:#ccffcc
    style S_Database fill:#ccccff
    style S_Compute fill:#ffffcc
    style S_Monitoring fill:#ffccff
```

### 6.2 Change Set デプロイフロー (⭐⭐⭐ Round 3 重点)

```mermaid
sequenceDiagram
    participant Dev as 開発者<br/>👤
    participant Create as create-changeset.sh
    participant Describe as describe-changeset.sh
    participant Execute as execute-changeset.sh
    participant CFN as CloudFormation
    participant AWS as AWS Resources

    Dev->>Create: 1. スクリプト実行<br/>./create-changeset.sh platform-network
    Create->>CFN: aws cloudformation create-change-set<br/>--stack-name platform-network<br/>--change-set-name platform-network-changeset-{timestamp}
    CFN-->>Create: Change Set ID: cs-xxxxx
    Create-->>Dev: Change Set作成完了<br/>ID: cs-xxxxx

    Dev->>Describe: 2. 変更内容確認<br/>./describe-changeset.sh platform-network
    Describe->>CFN: aws cloudformation describe-change-set<br/>--change-set-name cs-xxxxx
    CFN-->>Describe: 変更内容詳細<br/>・追加: VPC<br/>・変更: Subnet CIDR<br/>・削除: なし
    Describe-->>Dev: 変更内容表示<br/>(dry-run 結果)

    Note over Dev: 変更内容を確認<br/>問題なければ実行

    Dev->>Execute: 3. 実行確認<br/>./execute-changeset.sh platform-network
    Execute->>Dev: "Execute change set? (yes/no):"
    Dev-->>Execute: yes

    Execute->>CFN: aws cloudformation execute-change-set<br/>--change-set-name cs-xxxxx
    CFN->>AWS: リソース変更実行<br/>VPC作成、Subnet変更
    AWS-->>CFN: 変更完了通知
    CFN-->>Execute: スタック更新完了<br/>Status: UPDATE_COMPLETE
    Execute-->>Dev: デプロイ完了

    Note over Dev,AWS: Change Set により安全なデプロイを実現<br/>事前確認 → 承認 → 実行
```

**詳細**: [09_インフラ設計・コスト設計.md](./09_インフラ設計・コスト設計.md)

---

## 7. 監視ダッシュボード構成図

### 7.1 CloudWatch Dashboard レイアウト

```mermaid
graph TB
    subgraph "CloudWatch Dashboard: AWS Multi-Account Sample"
        subgraph "Row 1: ECS メトリクス"
            ECS_CPU[ECS CPU 使用率<br/>Public/Admin/Batch]
            ECS_Mem[ECS Memory 使用率<br/>Public/Admin/Batch]
            ECS_Task[ECS Task 数<br/>Running/Pending/Stopped]
        end

        subgraph "Row 2: RDS メトリクス"
            RDS_CPU[RDS CPU 使用率<br/>Primary/Standby]
            RDS_Conn[RDS 接続数<br/>Active Connections]
            RDS_Lag[レプリケーションラグ<br/>(Multi-AZ)]
        end

        subgraph "Row 3: ALB メトリクス"
            ALB_Req[ALB リクエスト数<br/>Public/Admin]
            ALB_Error[ALB エラー率<br/>4xx/5xx]
            ALB_Latency[ALB レスポンスタイム<br/>Target Response Time]
        end

        subgraph "Row 4: ネットワークメトリクス"
            TGW_Packets[TGW パケット数<br/>Sent/Received]
            VPN_Conn[VPN 接続数<br/>Active Connections]
            NAT_Traffic[NAT GW トラフィック<br/>Bytes Out]
        end
    end

    subgraph "CloudWatch Alarms"
        Alarm_Critical[Critical Alarms<br/>・ECS Task 0<br/>・RDS 接続不可<br/>・ALB ターゲット異常]
        Alarm_Warning[Warning Alarms<br/>・CPU 80%<br/>・Memory 80%<br/>・5xx 5%]
    end

    subgraph "SNS Topics"
        SNS_Critical[SNS: CriticalAlerts<br/>→ Email (管理者)]
        SNS_Warning[SNS: WarningAlerts<br/>→ Email (運用担当)]
    end

    Alarm_Critical --> SNS_Critical
    Alarm_Warning --> SNS_Warning

    style ECS_CPU fill:#99ff99
    style RDS_CPU fill:#99ccff
    style ALB_Req fill:#ffcc99
    style Alarm_Critical fill:#ff9999
    style Alarm_Warning fill:#ffff99
```

---

## 8. リソース配置マップ

### 8.1 Platform Account リソース配置

| リソース | AZ | Subnet | CIDR | IP範囲 |
|---------|----|----|------|--------|
| NAT GW (1a) | ap-northeast-1a | platform-public-1a | 10.0.1.0/24 | 10.0.1.0 - 10.0.1.255 |
| NAT GW (1c) | ap-northeast-1c | platform-public-1c | 10.0.2.0/24 | 10.0.2.0 - 10.0.2.255 |
| VPN Endpoint | Multi-AZ | platform-private-* | 10.0.11.0/24, 10.0.12.0/24 | 10.0.11.0 - 10.0.12.255 |
| Transit Gateway | Multi-AZ | platform-private-* | - | - |

### 8.2 Service Account リソース配置

| リソース | AZ | Subnet | CIDR | IP範囲 |
|---------|----|----|------|--------|
| ALB Public | Multi-AZ | service-public-* | 10.1.1.0/24, 10.1.2.0/24 | 10.1.1.0 - 10.1.2.255 |
| ALB Admin | Multi-AZ | service-private-* | 10.1.11.0/24, 10.1.12.0/24 | 10.1.11.0 - 10.1.12.255 |
| ECS Public (Task 1) | ap-northeast-1a | service-private-1a | 10.1.11.0/24 | 10.1.11.x |
| ECS Public (Task 2) | ap-northeast-1c | service-private-1c | 10.1.12.0/24 | 10.1.12.x |
| ECS Admin | ap-northeast-1a | service-private-1a | 10.1.11.0/24 | 10.1.11.y |
| ECS Batch | ap-northeast-1a | service-private-1a | 10.1.11.0/24 | 10.1.11.z |
| RDS Primary | ap-northeast-1a | service-private-1a | 10.1.11.0/24 | 10.1.11.10 |
| RDS Standby | ap-northeast-1c | service-private-1c | 10.1.12.0/24 | 10.1.12.10 |
| NAT GW (1a) | ap-northeast-1a | service-public-1a | 10.1.1.0/24 | 10.1.1.x |
| NAT GW (1c) | ap-northeast-1c | service-public-1c | 10.1.2.0/24 | 10.1.2.x |

---

## 9. 構成図まとめ

### 9.1 生成した Mermaid 図一覧

| # | 図名 | 内容 | 重要度 |
|---|------|------|--------|
| 1 | Multi-Account 全体構成図 | Platform/Service Account の物理構成 | ⭐⭐⭐ |
| 2 | ネットワーク詳細構成図 | VPC, Subnet, NAT GW, TGW 構成 | ⭐⭐⭐ |
| 3 | セキュリティグループ構成図 | SG 間の依存関係 | ⭐⭐ |
| 4 | ユーザーリクエストフロー | Public Web のリクエストフロー | ⭐⭐ |
| 5 | 管理者アクセスフロー | VPN 経由の閉域アクセスフロー | ⭐⭐⭐ |
| 6 | バッチ処理フロー | Scheduled Task の実行フロー | ⭐ |
| 7 | Multi-AZ 可用性構成図 | 障害復旧アーキテクチャ | ⭐⭐⭐ |
| 8 | CloudFormation スタック構成図 | スタック依存関係、デプロイ順序 | ⭐⭐⭐ |
| 9 | Change Set デプロイフロー | Change Set による段階的デプロイ | ⭐⭐⭐ (Round 3 重点) |
| 10 | 監視ダッシュボード構成図 | CloudWatch Dashboard レイアウト | ⭐⭐ |

**合計**: 10個の Mermaid 図 ✅ (目標5個以上達成)

### 9.2 Round 3 重点項目

**Change Set デプロイフロー図** (図9):
- create-changeset.sh → describe-changeset.sh → execute-changeset.sh の流れを可視化
- dry-run → 確認 → 実行 の3ステッププロセスを明示
- ユーザー承認プロセスを含む

**詳細**: [09_インフラ設計・コスト設計.md](./09_インフラ設計・コスト設計.md)

---

**前章**: [02_アーキテクチャ設計.md](./02_アーキテクチャ設計.md)
**次章**: [04_データベース設計.md](./04_データベース設計.md)
