# 09_インフラ設計・コスト設計

> AWS Multi-Account Sample Application - インフラ設計・コスト設計

**作成日**: 2025-10-24 (Round 3)
**バージョン**: 3.0

---

## ⭐⭐⭐ Round 3 重点項目: Change Set デプロイフロー設計

本章では、CloudFormation Change Set を使った段階的デプロイフローの詳細設計を記載します。

---

## 1. CloudFormation スタック設計

### 1.1 スタック分割戦略

**CloudFormation 3 Principles 準拠**:
1. **責任分離原則**: Platform / Service Account 分離
2. **スタック分割原則**: Network / Database / Compute / Monitoring 分離
3. **段階的デプロイ原則**: Change Set 使用 (⭐⭐⭐Round 3 重点)

### 1.2 スタック一覧

#### 1.2.1 Platform Account スタック

| スタック名 | テンプレートファイル | 主要リソース | 依存関係 |
|----------|------------------|------------|---------|
| platform-network | infra/cloudformation/platform/platform-network.yaml | VPC, Subnets, IGW, NAT GW | - |
| platform-tgw | infra/cloudformation/platform/platform-tgw.yaml | Transit Gateway, RAM Share | platform-network |

#### 1.2.2 Service Account スタック

| スタック名 | テンプレートファイル | 主要リソース | 依存関係 |
|----------|------------------|------------|---------|
| service-network | infra/cloudformation/service/service-network.yaml | VPC, Subnets, NAT GW, TGW Attachment | platform-tgw (Cross-Account) |
| service-database | infra/cloudformation/service/service-database.yaml | RDS PostgreSQL (Multi-AZ) | service-network |
| service-compute | infra/cloudformation/service/service-compute.yaml | ECS Cluster, Task Definition, Service, ALB | service-database |
| service-monitoring | infra/cloudformation/service/service-monitoring.yaml | CloudWatch Alarms, Dashboard | service-compute |

---

## 2. Change Set デプロイフロー設計 (⭐⭐⭐Round 3 最重要)

### 2.1 Change Set デプロイ 3ステッププロセス

**CloudFormation 3 Principles - 原則3: 段階的デプロイ原則**

```mermaid
sequenceDiagram
    participant Dev as 開発者
    participant Create as create-changeset.sh
    participant Describe as describe-changeset.sh
    participant Execute as execute-changeset.sh
    participant CFN as CloudFormation
    participant AWS as AWS Resources

    Note over Dev,AWS: ステップ1: Change Set 作成 (dry-run)

    Dev->>Create: ./create-changeset.sh <stack-name>
    Create->>CFN: aws cloudformation create-change-set
    CFN-->>Create: Change Set ID: cs-xxxxx
    Create-->>Dev: ✅ Change Set 作成完了

    Note over Dev,AWS: ステップ2: 変更内容確認

    Dev->>Describe: ./describe-changeset.sh <stack-name>
    Describe->>CFN: aws cloudformation describe-change-set
    CFN-->>Describe: 変更内容詳細 (JSON)
    Describe-->>Dev: ✅ 変更内容表示<br/>・追加: VPC<br/>・変更: Subnet CIDR<br/>・削除: なし

    Note over Dev: 変更内容レビュー<br/>問題なければ実行

    Note over Dev,AWS: ステップ3: 承認・実行

    Dev->>Execute: ./execute-changeset.sh <stack-name>
    Execute->>Dev: "Execute change set? (yes/no):"
    Dev-->>Execute: yes
    Execute->>CFN: aws cloudformation execute-change-set
    CFN->>AWS: リソース変更実行
    AWS-->>CFN: 変更完了
    CFN-->>Execute: Status: UPDATE_COMPLETE
    Execute-->>Dev: ✅ デプロイ完了
```

### 2.2 デプロイスクリプト仕様

#### 2.2.1 create-changeset.sh (Change Set 作成)

**用途**: Change Set を作成し、dry-run を実行

**引数**:
```bash
./scripts/create-changeset.sh <stack-name> [environment] [template-file]
```

**処理内容**:
1. スタック名、環境、テンプレートファイルのバリデーション
2. Change Set 名生成 (タイムスタンプ付き)
3. `aws cloudformation create-change-set` 実行
4. Change Set ID を保存 (`.changeset-id` ファイル)
5. 成功/失敗メッセージ出力

**実装例**:
```bash
#!/bin/bash
set -e

# 引数チェック
STACK_NAME=${1:?Stack name required}
ENVIRONMENT=${2:-dev}
TEMPLATE_FILE=${3:-infra/cloudformation/${STACK_NAME}.yaml}

# Change Set 名生成
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
CHANGESET_NAME="${STACK_NAME}-changeset-${TIMESTAMP}"

# Parameters ファイル
PARAMS_FILE="infra/cloudformation/parameters/${STACK_NAME}-${ENVIRONMENT}.json"

echo "📋 Creating Change Set for ${STACK_NAME}..."
echo "  Environment: ${ENVIRONMENT}"
echo "  Template: ${TEMPLATE_FILE}"
echo "  Change Set Name: ${CHANGESET_NAME}"

# Change Set 作成
aws cloudformation create-change-set \
  --stack-name "${STACK_NAME}" \
  --change-set-name "${CHANGESET_NAME}" \
  --template-body "file://${TEMPLATE_FILE}" \
  --parameters "file://${PARAMS_FILE}" \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-type CREATE_OR_UPDATE

# Change Set ID を保存
echo "${CHANGESET_NAME}" > .changeset-id

echo "✅ Change Set created: ${CHANGESET_NAME}"
echo "   Run './describe-changeset.sh ${STACK_NAME}' to review changes"
```

**エラーハンドリング**:
- スタック名未指定 → エラーメッセージ出力、exit 1
- テンプレートファイル不存在 → エラーメッセージ出力、exit 1
- AWS CLI エラー → エラーメッセージ表示、exit 1

---

#### 2.2.2 describe-changeset.sh (変更内容確認)

**用途**: Change Set の変更内容を表示 (dry-run 結果確認)

**引数**:
```bash
./scripts/describe-changeset.sh <stack-name>
```

**処理内容**:
1. `.changeset-id` から Change Set 名を取得
2. `aws cloudformation describe-change-set` 実行
3. 変更内容を整形して表示:
   - 追加されるリソース (Action: Add)
   - 変更されるリソース (Action: Modify)
   - 削除されるリソース (Action: Remove)
   - 置換されるリソース (Replacement: True)

**実装例**:
```bash
#!/bin/bash
set -e

STACK_NAME=${1:?Stack name required}

# Change Set ID 取得
if [ ! -f .changeset-id ]; then
  echo "❌ No change set found. Run create-changeset.sh first."
  exit 1
fi

CHANGESET_NAME=$(cat .changeset-id)

echo "🔍 Describing Change Set: ${CHANGESET_NAME}"

# Change Set 詳細取得
aws cloudformation describe-change-set \
  --stack-name "${STACK_NAME}" \
  --change-set-name "${CHANGESET_NAME}" \
  --query 'Changes[*].[ResourceChange.Action, ResourceChange.LogicalResourceId, ResourceChange.ResourceType, ResourceChange.Replacement]' \
  --output table

echo ""
echo "📊 Change Set Summary:"
echo "  Status: $(aws cloudformation describe-change-set --stack-name "${STACK_NAME}" --change-set-name "${CHANGESET_NAME}" --query 'Status' --output text)"
echo ""
echo "✅ Review completed."
echo "   Run './execute-changeset.sh ${STACK_NAME}' to execute changes"
```

**出力例**:
```
--------------------------------------------------------------------
| DescribeChangeSet                                               |
+--------+-------------------+-----------------------+--------------+
| Action | LogicalResourceId | ResourceType          | Replacement |
+--------+-------------------+-----------------------+--------------+
| Add    | VPC               | AWS::EC2::VPC         | None        |
| Modify | SubnetA           | AWS::EC2::Subnet      | False       |
| Remove | OldNATGateway     | AWS::EC2::NatGateway  | N/A         |
+--------+-------------------+-----------------------+--------------+
```

---

#### 2.2.3 execute-changeset.sh (承認・実行)

**用途**: ユーザー承認後に Change Set を実行

**引数**:
```bash
./scripts/execute-changeset.sh <stack-name>
```

**処理内容**:
1. `.changeset-id` から Change Set 名を取得
2. **ユーザー確認プロンプト**: "Execute change set? (yes/no):"
3. yes 入力時のみ `aws cloudformation execute-change-set` 実行
4. スタック更新完了まで待機 (`wait stack-update-complete`)
5. 完了メッセージ出力

**実装例**:
```bash
#!/bin/bash
set -e

STACK_NAME=${1:?Stack name required}

# Change Set ID 取得
if [ ! -f .changeset-id ]; then
  echo "❌ No change set found. Run create-changeset.sh first."
  exit 1
fi

CHANGESET_NAME=$(cat .changeset-id)

echo "⚠️  Executing Change Set: ${CHANGESET_NAME}"
echo "   This will modify your AWS resources."
echo ""

# ユーザー確認
read -p "Execute change set? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
  echo "❌ Execution cancelled."
  exit 0
fi

echo "🚀 Executing Change Set..."

# Change Set 実行
aws cloudformation execute-change-set \
  --stack-name "${STACK_NAME}" \
  --change-set-name "${CHANGESET_NAME}"

echo "⏳ Waiting for stack update to complete..."

# スタック更新完了待機
aws cloudformation wait stack-update-complete \
  --stack-name "${STACK_NAME}"

echo "✅ Stack update completed: ${STACK_NAME}"

# .changeset-id ファイル削除
rm -f .changeset-id
```

**ユーザー承認プロセス**:
- "yes" 以外の入力 → キャンセル、exit 0
- "yes" 入力 → Change Set 実行

---

#### 2.2.4 rollback.sh (ロールバック)

**用途**: Change Set 実行前後のロールバック

**引数**:
```bash
./scripts/rollback.sh <stack-name>
```

**処理内容**:
1. スタック状態確認
2. **Change Set 実行前** → Change Set 削除
3. **Change Set 実行中/失敗** → `aws cloudformation cancel-update-stack`
4. ロールバック完了確認

**実装例**:
```bash
#!/bin/bash
set -e

STACK_NAME=${1:?Stack name required}

echo "🔄 Rollback: ${STACK_NAME}"

# スタック状態取得
STACK_STATUS=$(aws cloudformation describe-stacks \
  --stack-name "${STACK_NAME}" \
  --query 'Stacks[0].StackStatus' \
  --output text 2>/dev/null || echo "DOES_NOT_EXIST")

if [ "$STACK_STATUS" == "DOES_NOT_EXIST" ]; then
  echo "❌ Stack does not exist: ${STACK_NAME}"
  exit 1
fi

# Change Set 実行前 → Change Set 削除
if [ -f .changeset-id ]; then
  CHANGESET_NAME=$(cat .changeset-id)
  echo "🗑️  Deleting Change Set: ${CHANGESET_NAME}"
  aws cloudformation delete-change-set \
    --stack-name "${STACK_NAME}" \
    --change-set-name "${CHANGESET_NAME}"
  rm -f .changeset-id
  echo "✅ Change Set deleted."
  exit 0
fi

# Change Set 実行中/失敗 → cancel-update-stack
if [[ "$STACK_STATUS" == *"IN_PROGRESS"* || "$STACK_STATUS" == *"FAILED"* ]]; then
  echo "⚠️  Cancelling stack update..."
  aws cloudformation cancel-update-stack --stack-name "${STACK_NAME}"
  echo "⏳ Waiting for rollback to complete..."
  aws cloudformation wait stack-update-rollback-complete --stack-name "${STACK_NAME}"
  echo "✅ Rollback completed."
  exit 0
fi

echo "ℹ️  Stack is in stable state: ${STACK_STATUS}"
echo "   No rollback needed."
```

**ロールバック条件**:
- Change Set 作成後、Execute 前 → Change Set 削除
- Execute 中 → cancel-update-stack
- Execute 失敗 → 自動ロールバック (CloudFormation の仕組み)

---

### 2.3 デプロイ順序

**Platform Account**:
```bash
# 1. platform-network
cd /c/dev2/sampleAWS
export AWS_PROFILE=platform

./scripts/create-changeset.sh platform-network dev
./scripts/describe-changeset.sh platform-network
./scripts/execute-changeset.sh platform-network

# 2. platform-tgw (platform-network 完了後)
./scripts/create-changeset.sh platform-tgw dev
./scripts/describe-changeset.sh platform-tgw
./scripts/execute-changeset.sh platform-tgw
```

**Service Account**:
```bash
# 3. service-network
export AWS_PROFILE=service

./scripts/create-changeset.sh service-network dev
./scripts/describe-changeset.sh service-network
./scripts/execute-changeset.sh service-network

# 4. service-database (service-network 完了後)
./scripts/create-changeset.sh service-database dev
./scripts/describe-changeset.sh service-database
./scripts/execute-changeset.sh service-database

# 5. service-compute (service-database 完了後)
./scripts/create-changeset.sh service-compute dev
./scripts/describe-changeset.sh service-compute
./scripts/execute-changeset.sh service-compute

# 6. service-monitoring (service-compute 完了後)
./scripts/create-changeset.sh service-monitoring dev
./scripts/describe-changeset.sh service-monitoring
./scripts/execute-changeset.sh service-monitoring
```

---

### 2.4 削除順序 (逆順)

**ロールバック時の削除順序**:
```bash
# Service Account (逆順)
export AWS_PROFILE=service

aws cloudformation delete-stack --stack-name service-monitoring
aws cloudformation wait stack-delete-complete --stack-name service-monitoring

aws cloudformation delete-stack --stack-name service-compute
aws cloudformation wait stack-delete-complete --stack-name service-compute

aws cloudformation delete-stack --stack-name service-database
aws cloudformation wait stack-delete-complete --stack-name service-database

aws cloudformation delete-stack --stack-name service-network
aws cloudformation wait stack-delete-complete --stack-name service-network

# Platform Account (逆順)
export AWS_PROFILE=platform

aws cloudformation delete-stack --stack-name platform-tgw
aws cloudformation wait stack-delete-complete --stack-name platform-tgw

aws cloudformation delete-stack --stack-name platform-network
aws cloudformation wait stack-delete-complete --stack-name platform-network
```

---

## 3. Change Set のメリット

### 3.1 安全性向上

| 項目 | Direct Deploy | Change Set Deploy | メリット |
|------|--------------|-------------------|---------|
| 事前確認 | なし | dry-run で変更内容確認可能 | 意図しない削除防止 |
| 承認プロセス | なし | ユーザー確認必須 | ヒューマンエラー防止 |
| ロールバック | 手動 (スタック削除) | Change Set 削除で即座に復旧 | 安全性向上 |

### 3.2 変更内容の可視化

**describe-changeset.sh の出力例**:
```
+--------+-------------------+-----------------------+--------------+
| Action | LogicalResourceId | ResourceType          | Replacement |
+--------+-------------------+-----------------------+--------------+
| Add    | PublicSubnetC     | AWS::EC2::Subnet      | None        |
| Modify | PrivateRouteTable | AWS::EC2::RouteTable  | False       |
| Remove | OldNATGateway     | AWS::EC2::NatGateway  | N/A         |
+--------+-------------------+-----------------------+--------------+
```

**メリット**:
- 追加・変更・削除が一目瞭然
- Replacement (リソース置換) の有無が確認可能
  - True → 新規リソース作成後、旧リソース削除 (ダウンタイム発生可能性)
  - False → インプレース変更 (ダウンタイムなし)

---

## 4. パラメータファイル設計

### 4.1 環境別パラメータ

**ディレクトリ構造**:
```
infra/cloudformation/parameters/
├── platform-network-dev.json
├── platform-tgw-dev.json
├── service-network-dev.json
├── service-database-dev.json
├── service-compute-dev.json
└── service-monitoring-dev.json
```

**例: platform-network-dev.json**:
```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "VpcCidr",
    "ParameterValue": "10.0.0.0/16"
  },
  {
    "ParameterKey": "PublicSubnetACidr",
    "ParameterValue": "10.0.1.0/24"
  },
  {
    "ParameterKey": "PublicSubnetCCidr",
    "ParameterValue": "10.0.2.0/24"
  }
]
```

---

## 5. コスト設計

### 5.1 月額コスト見積もり (ap-northeast-1)

| カテゴリ | リソース | 数量 | 単価 | 月額 (USD) | 月額 (JPY) |
|---------|---------|------|------|----------|----------|
| **ネットワーク** | Transit Gateway | 1 | $36/月 | $36 | ¥5,400 |
| | TGW Attachment | 2 | $36/月 | $72 | ¥10,800 |
| | NAT Gateway | 4 | $32/月 | $128 | ¥19,200 |
| | Client VPN | 1 | $73/月 | $73 | ¥10,950 |
| **コンピュート** | ECS Fargate (0.25vCPU, 0.5GB) | 3タスク | $9/月 | $27 | ¥4,050 |
| **データベース** | RDS PostgreSQL (db.t3.medium, Multi-AZ) | 1 | $99/月 | $99 | ¥14,850 |
| **ストレージ** | RDS ストレージ (gp3, 50GB) | 50GB | $0.15/GB | $7.5 | ¥1,125 |
| | CloudWatch Logs | 5GB/月 | $0.50/GB | $2.5 | ¥375 |
| **ロードバランサー** | ALB | 2 | $22/月 | $44 | ¥6,600 |
| **合計** | | | | **$489** | **¥73,350** |

**注**: 為替レート 1USD = 150JPY で計算

### 5.2 コスト削減策

| 施策 | 削減額 (月額) | 備考 |
|-----|------------|------|
| 不要時の ECS Task 停止 | $27 | 検証時のみ起動 |
| RDS 停止 (検証時のみ起動) | $99 | 7日間まで停止可能 |
| Client VPN 削除 (検証後) | $73 | 必要時のみ構築 |
| **合計削減可能額** | **$199** | - |

**実質月額コスト** (検証時のみ起動):
- 通常時: $290/月 (約¥43,500)
- 検証時のみ: $489/月 (約¥73,350)

---

## 6. Change Set デプロイ手順書

### 6.1 初回デプロイ手順

**Platform Account**:
```bash
# 1. AWS プロファイル設定
export AWS_PROFILE=platform

# 2. platform-network デプロイ
cd /c/dev2/sampleAWS
./scripts/create-changeset.sh platform-network dev
./scripts/describe-changeset.sh platform-network
# 変更内容を確認
./scripts/execute-changeset.sh platform-network
# "yes" 入力

# 3. platform-tgw デプロイ
./scripts/create-changeset.sh platform-tgw dev
./scripts/describe-changeset.sh platform-tgw
./scripts/execute-changeset.sh platform-tgw
```

**Service Account**:
```bash
# 4. AWS プロファイル変更
export AWS_PROFILE=service

# 5. service-network デプロイ
./scripts/create-changeset.sh service-network dev
./scripts/describe-changeset.sh service-network
./scripts/execute-changeset.sh service-network

# 6-8. 残りのスタックも同様
# service-database → service-compute → service-monitoring
```

### 6.2 更新デプロイ手順

**例: service-database のパラメータ変更**:
```bash
# 1. パラメータファイル編集
vim infra/cloudformation/parameters/service-database-dev.json

# 2. Change Set 作成
./scripts/create-changeset.sh service-database dev

# 3. 変更内容確認 (dry-run)
./scripts/describe-changeset.sh service-database

# 出力例:
# | Modify | DBInstance | AWS::RDS::DBInstance | False |
#   → db.t3.medium から db.t3.large への変更

# 4. 実行 (ユーザー承認)
./scripts/execute-changeset.sh service-database
# "yes" 入力
```

### 6.3 ロールバック手順

**パターン1: Change Set 実行前 (dry-run 後に問題発見)**:
```bash
# Change Set 削除
./scripts/rollback.sh service-database
```

**パターン2: Change Set 実行中/失敗**:
```bash
# スタック更新キャンセル
./scripts/rollback.sh service-database
```

---

## 7. Change Set 対応まとめ (⭐⭐⭐Round 3 成果)

### 7.1 生成すべきスクリプト

| # | スクリプト名 | 用途 | 重要度 |
|---|------------|------|--------|
| 1 | create-changeset.sh | Change Set 作成 (dry-run) | ⭐⭐⭐ |
| 2 | describe-changeset.sh | 変更内容確認 | ⭐⭐⭐ |
| 3 | execute-changeset.sh | ユーザー承認 + 実行 | ⭐⭐⭐ |
| 4 | rollback.sh | ロールバック | ⭐⭐⭐ |

**すべて Round 3 で生成** ✅

### 7.2 CloudFormation 3 Principles 達成状況

| 原則 | 内容 | 達成状況 |
|------|------|---------|
| 原則1: 責任分離 | Platform / Service Account 分離 | ✅ 達成 |
| 原則2: スタック分割 | Network / Database / Compute / Monitoring 分離 | ✅ 達成 |
| 原則3: 段階的デプロイ | **Change Set 使用** | ✅ **Round 3 で達成** ⭐⭐⭐ |

**参照**: `.claude/docs/40_standards/45_cloudformation.md`

---

**前章**: [08_運用設計.md](./08_運用設計.md)
**次章**: [10_開発環境・CI_CD設計.md](./10_開発環境・CI_CD設計.md)
