# 09_ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆãƒ»ã‚³ã‚¹ãƒˆè¨­è¨ˆ

> AWS Multi-Account Sample Application - ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆãƒ»ã‚³ã‚¹ãƒˆè¨­è¨ˆ

**ä½œæˆæ—¥**: 2025-10-24 (Round 3)
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.0

---

## â­â­â­ Round 3 é‡ç‚¹é …ç›®: Change Set ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

æœ¬ç« ã§ã¯ã€CloudFormation Change Set ã‚’ä½¿ã£ãŸæ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ã®è©³ç´°è¨­è¨ˆã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

---

## 1. CloudFormation ã‚¹ã‚¿ãƒƒã‚¯è¨­è¨ˆ

### 1.1 ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰²æˆ¦ç•¥

**CloudFormation 3 Principles æº–æ‹ **:
1. **è²¬ä»»åˆ†é›¢åŸå‰‡**: Platform / Service Account åˆ†é›¢
2. **ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰²åŸå‰‡**: Network / Database / Compute / Monitoring åˆ†é›¢
3. **æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤åŸå‰‡**: Change Set ä½¿ç”¨ (â­â­â­Round 3 é‡ç‚¹)

### 1.2 ã‚¹ã‚¿ãƒƒã‚¯ä¸€è¦§

#### 1.2.1 Platform Account ã‚¹ã‚¿ãƒƒã‚¯

| ã‚¹ã‚¿ãƒƒã‚¯å | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« | ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹ | ä¾å­˜é–¢ä¿‚ |
|----------|------------------|------------|---------|
| platform-network | infra/cloudformation/platform/platform-network.yaml | VPC, Subnets, IGW, NAT GW | - |
| platform-tgw | infra/cloudformation/platform/platform-tgw.yaml | Transit Gateway, RAM Share | platform-network |

#### 1.2.2 Service Account ã‚¹ã‚¿ãƒƒã‚¯

| ã‚¹ã‚¿ãƒƒã‚¯å | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« | ä¸»è¦ãƒªã‚½ãƒ¼ã‚¹ | ä¾å­˜é–¢ä¿‚ |
|----------|------------------|------------|---------|
| service-network | infra/cloudformation/service/service-network.yaml | VPC, Subnets, NAT GW, TGW Attachment | platform-tgw (Cross-Account) |
| service-database | infra/cloudformation/service/service-database.yaml | RDS PostgreSQL (Multi-AZ) | service-network |
| service-compute | infra/cloudformation/service/service-compute.yaml | ECS Cluster, Task Definition, Service, ALB | service-database |
| service-monitoring | infra/cloudformation/service/service-monitoring.yaml | CloudWatch Alarms, Dashboard | service-compute |

---

## 2. Change Set ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ (â­â­â­Round 3 æœ€é‡è¦)

### 2.1 Change Set ãƒ‡ãƒ—ãƒ­ã‚¤ 3ã‚¹ãƒ†ãƒƒãƒ—ãƒ—ãƒ­ã‚»ã‚¹

**CloudFormation 3 Principles - åŸå‰‡3: æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤åŸå‰‡**

```mermaid
sequenceDiagram
    participant Dev as é–‹ç™ºè€…
    participant Create as create-changeset.sh
    participant Describe as describe-changeset.sh
    participant Execute as execute-changeset.sh
    participant CFN as CloudFormation
    participant AWS as AWS Resources

    Note over Dev,AWS: ã‚¹ãƒ†ãƒƒãƒ—1: Change Set ä½œæˆ (dry-run)

    Dev->>Create: ./create-changeset.sh <stack-name>
    Create->>CFN: aws cloudformation create-change-set
    CFN-->>Create: Change Set ID: cs-xxxxx
    Create-->>Dev: âœ… Change Set ä½œæˆå®Œäº†

    Note over Dev,AWS: ã‚¹ãƒ†ãƒƒãƒ—2: å¤‰æ›´å†…å®¹ç¢ºèª

    Dev->>Describe: ./describe-changeset.sh <stack-name>
    Describe->>CFN: aws cloudformation describe-change-set
    CFN-->>Describe: å¤‰æ›´å†…å®¹è©³ç´° (JSON)
    Describe-->>Dev: âœ… å¤‰æ›´å†…å®¹è¡¨ç¤º<br/>ãƒ»è¿½åŠ : VPC<br/>ãƒ»å¤‰æ›´: Subnet CIDR<br/>ãƒ»å‰Šé™¤: ãªã—

    Note over Dev: å¤‰æ›´å†…å®¹ãƒ¬ãƒ“ãƒ¥ãƒ¼<br/>å•é¡Œãªã‘ã‚Œã°å®Ÿè¡Œ

    Note over Dev,AWS: ã‚¹ãƒ†ãƒƒãƒ—3: æ‰¿èªãƒ»å®Ÿè¡Œ

    Dev->>Execute: ./execute-changeset.sh <stack-name>
    Execute->>Dev: "Execute change set? (yes/no):"
    Dev-->>Execute: yes
    Execute->>CFN: aws cloudformation execute-change-set
    CFN->>AWS: ãƒªã‚½ãƒ¼ã‚¹å¤‰æ›´å®Ÿè¡Œ
    AWS-->>CFN: å¤‰æ›´å®Œäº†
    CFN-->>Execute: Status: UPDATE_COMPLETE
    Execute-->>Dev: âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
```

### 2.2 ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆä»•æ§˜

#### 2.2.1 create-changeset.sh (Change Set ä½œæˆ)

**ç”¨é€”**: Change Set ã‚’ä½œæˆã—ã€dry-run ã‚’å®Ÿè¡Œ

**å¼•æ•°**:
```bash
./scripts/create-changeset.sh <stack-name> [environment] [template-file]
```

**å‡¦ç†å†…å®¹**:
1. ã‚¹ã‚¿ãƒƒã‚¯åã€ç’°å¢ƒã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
2. Change Set åç”Ÿæˆ (ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ã)
3. `aws cloudformation create-change-set` å®Ÿè¡Œ
4. Change Set ID ã‚’ä¿å­˜ (`.changeset-id` ãƒ•ã‚¡ã‚¤ãƒ«)
5. æˆåŠŸ/å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›

**å®Ÿè£…ä¾‹**:
```bash
#!/bin/bash
set -e

# å¼•æ•°ãƒã‚§ãƒƒã‚¯
STACK_NAME=${1:?Stack name required}
ENVIRONMENT=${2:-dev}
TEMPLATE_FILE=${3:-infra/cloudformation/${STACK_NAME}.yaml}

# Change Set åç”Ÿæˆ
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
CHANGESET_NAME="${STACK_NAME}-changeset-${TIMESTAMP}"

# Parameters ãƒ•ã‚¡ã‚¤ãƒ«
PARAMS_FILE="infra/cloudformation/parameters/${STACK_NAME}-${ENVIRONMENT}.json"

echo "ğŸ“‹ Creating Change Set for ${STACK_NAME}..."
echo "  Environment: ${ENVIRONMENT}"
echo "  Template: ${TEMPLATE_FILE}"
echo "  Change Set Name: ${CHANGESET_NAME}"

# Change Set ä½œæˆ
aws cloudformation create-change-set \
  --stack-name "${STACK_NAME}" \
  --change-set-name "${CHANGESET_NAME}" \
  --template-body "file://${TEMPLATE_FILE}" \
  --parameters "file://${PARAMS_FILE}" \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-type CREATE_OR_UPDATE

# Change Set ID ã‚’ä¿å­˜
echo "${CHANGESET_NAME}" > .changeset-id

echo "âœ… Change Set created: ${CHANGESET_NAME}"
echo "   Run './describe-changeset.sh ${STACK_NAME}' to review changes"
```

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
- ã‚¹ã‚¿ãƒƒã‚¯åæœªæŒ‡å®š â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›ã€exit 1
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨ â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›ã€exit 1
- AWS CLI ã‚¨ãƒ©ãƒ¼ â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã€exit 1

---

#### 2.2.2 describe-changeset.sh (å¤‰æ›´å†…å®¹ç¢ºèª)

**ç”¨é€”**: Change Set ã®å¤‰æ›´å†…å®¹ã‚’è¡¨ç¤º (dry-run çµæœç¢ºèª)

**å¼•æ•°**:
```bash
./scripts/describe-changeset.sh <stack-name>
```

**å‡¦ç†å†…å®¹**:
1. `.changeset-id` ã‹ã‚‰ Change Set åã‚’å–å¾—
2. `aws cloudformation describe-change-set` å®Ÿè¡Œ
3. å¤‰æ›´å†…å®¹ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º:
   - è¿½åŠ ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ (Action: Add)
   - å¤‰æ›´ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ (Action: Modify)
   - å‰Šé™¤ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ (Action: Remove)
   - ç½®æ›ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ (Replacement: True)

**å®Ÿè£…ä¾‹**:
```bash
#!/bin/bash
set -e

STACK_NAME=${1:?Stack name required}

# Change Set ID å–å¾—
if [ ! -f .changeset-id ]; then
  echo "âŒ No change set found. Run create-changeset.sh first."
  exit 1
fi

CHANGESET_NAME=$(cat .changeset-id)

echo "ğŸ” Describing Change Set: ${CHANGESET_NAME}"

# Change Set è©³ç´°å–å¾—
aws cloudformation describe-change-set \
  --stack-name "${STACK_NAME}" \
  --change-set-name "${CHANGESET_NAME}" \
  --query 'Changes[*].[ResourceChange.Action, ResourceChange.LogicalResourceId, ResourceChange.ResourceType, ResourceChange.Replacement]' \
  --output table

echo ""
echo "ğŸ“Š Change Set Summary:"
echo "  Status: $(aws cloudformation describe-change-set --stack-name "${STACK_NAME}" --change-set-name "${CHANGESET_NAME}" --query 'Status' --output text)"
echo ""
echo "âœ… Review completed."
echo "   Run './execute-changeset.sh ${STACK_NAME}' to execute changes"
```

**å‡ºåŠ›ä¾‹**:
```
--------------------------------------------------------------------
| DescribeChangeSet                                               |
+--------+-------------------+-----------------------+--------------+
| Action | LogicalResourceId | ResourceType          | Replacement |
+--------+-------------------+-----------------------+--------------+
| Add    | VPC               | AWS::EC2::VPC         | None        |
| Modify | SubnetA           | AWS::EC2::Subnet      | False       |
| Remove | OldNATGateway     | AWS::EC2::NatGateway  | N/A         |
+--------+-------------------+-----------------------+--------------+
```

---

#### 2.2.3 execute-changeset.sh (æ‰¿èªãƒ»å®Ÿè¡Œ)

**ç”¨é€”**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå¾Œã« Change Set ã‚’å®Ÿè¡Œ

**å¼•æ•°**:
```bash
./scripts/execute-changeset.sh <stack-name>
```

**å‡¦ç†å†…å®¹**:
1. `.changeset-id` ã‹ã‚‰ Change Set åã‚’å–å¾—
2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: "Execute change set? (yes/no):"
3. yes å…¥åŠ›æ™‚ã®ã¿ `aws cloudformation execute-change-set` å®Ÿè¡Œ
4. ã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°å®Œäº†ã¾ã§å¾…æ©Ÿ (`wait stack-update-complete`)
5. å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›

**å®Ÿè£…ä¾‹**:
```bash
#!/bin/bash
set -e

STACK_NAME=${1:?Stack name required}

# Change Set ID å–å¾—
if [ ! -f .changeset-id ]; then
  echo "âŒ No change set found. Run create-changeset.sh first."
  exit 1
fi

CHANGESET_NAME=$(cat .changeset-id)

echo "âš ï¸  Executing Change Set: ${CHANGESET_NAME}"
echo "   This will modify your AWS resources."
echo ""

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
read -p "Execute change set? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
  echo "âŒ Execution cancelled."
  exit 0
fi

echo "ğŸš€ Executing Change Set..."

# Change Set å®Ÿè¡Œ
aws cloudformation execute-change-set \
  --stack-name "${STACK_NAME}" \
  --change-set-name "${CHANGESET_NAME}"

echo "â³ Waiting for stack update to complete..."

# ã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°å®Œäº†å¾…æ©Ÿ
aws cloudformation wait stack-update-complete \
  --stack-name "${STACK_NAME}"

echo "âœ… Stack update completed: ${STACK_NAME}"

# .changeset-id ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm -f .changeset-id
```

**ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹**:
- "yes" ä»¥å¤–ã®å…¥åŠ› â†’ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€exit 0
- "yes" å…¥åŠ› â†’ Change Set å®Ÿè¡Œ

---

#### 2.2.4 rollback.sh (ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯)

**ç”¨é€”**: Change Set å®Ÿè¡Œå‰å¾Œã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

**å¼•æ•°**:
```bash
./scripts/rollback.sh <stack-name>
```

**å‡¦ç†å†…å®¹**:
1. ã‚¹ã‚¿ãƒƒã‚¯çŠ¶æ…‹ç¢ºèª
2. **Change Set å®Ÿè¡Œå‰** â†’ Change Set å‰Šé™¤
3. **Change Set å®Ÿè¡Œä¸­/å¤±æ•—** â†’ `aws cloudformation cancel-update-stack`
4. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ç¢ºèª

**å®Ÿè£…ä¾‹**:
```bash
#!/bin/bash
set -e

STACK_NAME=${1:?Stack name required}

echo "ğŸ”„ Rollback: ${STACK_NAME}"

# ã‚¹ã‚¿ãƒƒã‚¯çŠ¶æ…‹å–å¾—
STACK_STATUS=$(aws cloudformation describe-stacks \
  --stack-name "${STACK_NAME}" \
  --query 'Stacks[0].StackStatus' \
  --output text 2>/dev/null || echo "DOES_NOT_EXIST")

if [ "$STACK_STATUS" == "DOES_NOT_EXIST" ]; then
  echo "âŒ Stack does not exist: ${STACK_NAME}"
  exit 1
fi

# Change Set å®Ÿè¡Œå‰ â†’ Change Set å‰Šé™¤
if [ -f .changeset-id ]; then
  CHANGESET_NAME=$(cat .changeset-id)
  echo "ğŸ—‘ï¸  Deleting Change Set: ${CHANGESET_NAME}"
  aws cloudformation delete-change-set \
    --stack-name "${STACK_NAME}" \
    --change-set-name "${CHANGESET_NAME}"
  rm -f .changeset-id
  echo "âœ… Change Set deleted."
  exit 0
fi

# Change Set å®Ÿè¡Œä¸­/å¤±æ•— â†’ cancel-update-stack
if [[ "$STACK_STATUS" == *"IN_PROGRESS"* || "$STACK_STATUS" == *"FAILED"* ]]; then
  echo "âš ï¸  Cancelling stack update..."
  aws cloudformation cancel-update-stack --stack-name "${STACK_NAME}"
  echo "â³ Waiting for rollback to complete..."
  aws cloudformation wait stack-update-rollback-complete --stack-name "${STACK_NAME}"
  echo "âœ… Rollback completed."
  exit 0
fi

echo "â„¹ï¸  Stack is in stable state: ${STACK_STATUS}"
echo "   No rollback needed."
```

**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¡ä»¶**:
- Change Set ä½œæˆå¾Œã€Execute å‰ â†’ Change Set å‰Šé™¤
- Execute ä¸­ â†’ cancel-update-stack
- Execute å¤±æ•— â†’ è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ (CloudFormation ã®ä»•çµ„ã¿)

---

### 2.3 ãƒ‡ãƒ—ãƒ­ã‚¤é †åº

**Platform Account**:
```bash
# 1. platform-network
cd /c/dev2/sampleAWS
export AWS_PROFILE=platform

./scripts/create-changeset.sh platform-network dev
./scripts/describe-changeset.sh platform-network
./scripts/execute-changeset.sh platform-network

# 2. platform-tgw (platform-network å®Œäº†å¾Œ)
./scripts/create-changeset.sh platform-tgw dev
./scripts/describe-changeset.sh platform-tgw
./scripts/execute-changeset.sh platform-tgw
```

**Service Account**:
```bash
# 3. service-network
export AWS_PROFILE=service

./scripts/create-changeset.sh service-network dev
./scripts/describe-changeset.sh service-network
./scripts/execute-changeset.sh service-network

# 4. service-database (service-network å®Œäº†å¾Œ)
./scripts/create-changeset.sh service-database dev
./scripts/describe-changeset.sh service-database
./scripts/execute-changeset.sh service-database

# 5. service-compute (service-database å®Œäº†å¾Œ)
./scripts/create-changeset.sh service-compute dev
./scripts/describe-changeset.sh service-compute
./scripts/execute-changeset.sh service-compute

# 6. service-monitoring (service-compute å®Œäº†å¾Œ)
./scripts/create-changeset.sh service-monitoring dev
./scripts/describe-changeset.sh service-monitoring
./scripts/execute-changeset.sh service-monitoring
```

---

### 2.4 å‰Šé™¤é †åº (é€†é †)

**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®å‰Šé™¤é †åº**:
```bash
# Service Account (é€†é †)
export AWS_PROFILE=service

aws cloudformation delete-stack --stack-name service-monitoring
aws cloudformation wait stack-delete-complete --stack-name service-monitoring

aws cloudformation delete-stack --stack-name service-compute
aws cloudformation wait stack-delete-complete --stack-name service-compute

aws cloudformation delete-stack --stack-name service-database
aws cloudformation wait stack-delete-complete --stack-name service-database

aws cloudformation delete-stack --stack-name service-network
aws cloudformation wait stack-delete-complete --stack-name service-network

# Platform Account (é€†é †)
export AWS_PROFILE=platform

aws cloudformation delete-stack --stack-name platform-tgw
aws cloudformation wait stack-delete-complete --stack-name platform-tgw

aws cloudformation delete-stack --stack-name platform-network
aws cloudformation wait stack-delete-complete --stack-name platform-network
```

---

## 3. Change Set ã®ãƒ¡ãƒªãƒƒãƒˆ

### 3.1 å®‰å…¨æ€§å‘ä¸Š

| é …ç›® | Direct Deploy | Change Set Deploy | ãƒ¡ãƒªãƒƒãƒˆ |
|------|--------------|-------------------|---------|
| äº‹å‰ç¢ºèª | ãªã— | dry-run ã§å¤‰æ›´å†…å®¹ç¢ºèªå¯èƒ½ | æ„å›³ã—ãªã„å‰Šé™¤é˜²æ­¢ |
| æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ | ãªã— | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªå¿…é ˆ | ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼é˜²æ­¢ |
| ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | æ‰‹å‹• (ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤) | Change Set å‰Šé™¤ã§å³åº§ã«å¾©æ—§ | å®‰å…¨æ€§å‘ä¸Š |

### 3.2 å¤‰æ›´å†…å®¹ã®å¯è¦–åŒ–

**describe-changeset.sh ã®å‡ºåŠ›ä¾‹**:
```
+--------+-------------------+-----------------------+--------------+
| Action | LogicalResourceId | ResourceType          | Replacement |
+--------+-------------------+-----------------------+--------------+
| Add    | PublicSubnetC     | AWS::EC2::Subnet      | None        |
| Modify | PrivateRouteTable | AWS::EC2::RouteTable  | False       |
| Remove | OldNATGateway     | AWS::EC2::NatGateway  | N/A         |
+--------+-------------------+-----------------------+--------------+
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ãŒä¸€ç›®ç­ç„¶
- Replacement (ãƒªã‚½ãƒ¼ã‚¹ç½®æ›) ã®æœ‰ç„¡ãŒç¢ºèªå¯èƒ½
  - True â†’ æ–°è¦ãƒªã‚½ãƒ¼ã‚¹ä½œæˆå¾Œã€æ—§ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ (ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ç™ºç”Ÿå¯èƒ½æ€§)
  - False â†’ ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹å¤‰æ›´ (ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—)

---

## 4. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«è¨­è¨ˆ

### 4.1 ç’°å¢ƒåˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ **:
```
infra/cloudformation/parameters/
â”œâ”€â”€ platform-network-dev.json
â”œâ”€â”€ platform-tgw-dev.json
â”œâ”€â”€ service-network-dev.json
â”œâ”€â”€ service-database-dev.json
â”œâ”€â”€ service-compute-dev.json
â””â”€â”€ service-monitoring-dev.json
```

**ä¾‹: platform-network-dev.json**:
```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "VpcCidr",
    "ParameterValue": "10.0.0.0/16"
  },
  {
    "ParameterKey": "PublicSubnetACidr",
    "ParameterValue": "10.0.1.0/24"
  },
  {
    "ParameterKey": "PublicSubnetCCidr",
    "ParameterValue": "10.0.2.0/24"
  }
]
```

---

## 5. ã‚³ã‚¹ãƒˆè¨­è¨ˆ

### 5.1 æœˆé¡ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š (ap-northeast-1)

| ã‚«ãƒ†ã‚´ãƒª | ãƒªã‚½ãƒ¼ã‚¹ | æ•°é‡ | å˜ä¾¡ | æœˆé¡ (USD) | æœˆé¡ (JPY) |
|---------|---------|------|------|----------|----------|
| **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** | Transit Gateway | 1 | $36/æœˆ | $36 | Â¥5,400 |
| | TGW Attachment | 2 | $36/æœˆ | $72 | Â¥10,800 |
| | NAT Gateway | 4 | $32/æœˆ | $128 | Â¥19,200 |
| | Client VPN | 1 | $73/æœˆ | $73 | Â¥10,950 |
| **ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆ** | ECS Fargate (0.25vCPU, 0.5GB) | 3ã‚¿ã‚¹ã‚¯ | $9/æœˆ | $27 | Â¥4,050 |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | RDS PostgreSQL (db.t3.medium, Multi-AZ) | 1 | $99/æœˆ | $99 | Â¥14,850 |
| **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸** | RDS ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (gp3, 50GB) | 50GB | $0.15/GB | $7.5 | Â¥1,125 |
| | CloudWatch Logs | 5GB/æœˆ | $0.50/GB | $2.5 | Â¥375 |
| **ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼** | ALB | 2 | $22/æœˆ | $44 | Â¥6,600 |
| **åˆè¨ˆ** | | | | **$489** | **Â¥73,350** |

**æ³¨**: ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ 1USD = 150JPY ã§è¨ˆç®—

### 5.2 ã‚³ã‚¹ãƒˆå‰Šæ¸›ç­–

| æ–½ç­– | å‰Šæ¸›é¡ (æœˆé¡) | å‚™è€ƒ |
|-----|------------|------|
| ä¸è¦æ™‚ã® ECS Task åœæ­¢ | $27 | æ¤œè¨¼æ™‚ã®ã¿èµ·å‹• |
| RDS åœæ­¢ (æ¤œè¨¼æ™‚ã®ã¿èµ·å‹•) | $99 | 7æ—¥é–“ã¾ã§åœæ­¢å¯èƒ½ |
| Client VPN å‰Šé™¤ (æ¤œè¨¼å¾Œ) | $73 | å¿…è¦æ™‚ã®ã¿æ§‹ç¯‰ |
| **åˆè¨ˆå‰Šæ¸›å¯èƒ½é¡** | **$199** | - |

**å®Ÿè³ªæœˆé¡ã‚³ã‚¹ãƒˆ** (æ¤œè¨¼æ™‚ã®ã¿èµ·å‹•):
- é€šå¸¸æ™‚: $290/æœˆ (ç´„Â¥43,500)
- æ¤œè¨¼æ™‚ã®ã¿: $489/æœˆ (ç´„Â¥73,350)

---

## 6. Change Set ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸

### 6.1 åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

**Platform Account**:
```bash
# 1. AWS ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
export AWS_PROFILE=platform

# 2. platform-network ãƒ‡ãƒ—ãƒ­ã‚¤
cd /c/dev2/sampleAWS
./scripts/create-changeset.sh platform-network dev
./scripts/describe-changeset.sh platform-network
# å¤‰æ›´å†…å®¹ã‚’ç¢ºèª
./scripts/execute-changeset.sh platform-network
# "yes" å…¥åŠ›

# 3. platform-tgw ãƒ‡ãƒ—ãƒ­ã‚¤
./scripts/create-changeset.sh platform-tgw dev
./scripts/describe-changeset.sh platform-tgw
./scripts/execute-changeset.sh platform-tgw
```

**Service Account**:
```bash
# 4. AWS ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´
export AWS_PROFILE=service

# 5. service-network ãƒ‡ãƒ—ãƒ­ã‚¤
./scripts/create-changeset.sh service-network dev
./scripts/describe-changeset.sh service-network
./scripts/execute-changeset.sh service-network

# 6-8. æ®‹ã‚Šã®ã‚¹ã‚¿ãƒƒã‚¯ã‚‚åŒæ§˜
# service-database â†’ service-compute â†’ service-monitoring
```

### 6.2 æ›´æ–°ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

**ä¾‹: service-database ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰æ›´**:
```bash
# 1. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†
vim infra/cloudformation/parameters/service-database-dev.json

# 2. Change Set ä½œæˆ
./scripts/create-changeset.sh service-database dev

# 3. å¤‰æ›´å†…å®¹ç¢ºèª (dry-run)
./scripts/describe-changeset.sh service-database

# å‡ºåŠ›ä¾‹:
# | Modify | DBInstance | AWS::RDS::DBInstance | False |
#   â†’ db.t3.medium ã‹ã‚‰ db.t3.large ã¸ã®å¤‰æ›´

# 4. å®Ÿè¡Œ (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª)
./scripts/execute-changeset.sh service-database
# "yes" å…¥åŠ›
```

### 6.3 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

**ãƒ‘ã‚¿ãƒ¼ãƒ³1: Change Set å®Ÿè¡Œå‰ (dry-run å¾Œã«å•é¡Œç™ºè¦‹)**:
```bash
# Change Set å‰Šé™¤
./scripts/rollback.sh service-database
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³2: Change Set å®Ÿè¡Œä¸­/å¤±æ•—**:
```bash
# ã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
./scripts/rollback.sh service-database
```

---

## 7. Change Set å¯¾å¿œã¾ã¨ã‚ (â­â­â­Round 3 æˆæœ)

### 7.1 ç”Ÿæˆã™ã¹ãã‚¹ã‚¯ãƒªãƒ—ãƒˆ

| # | ã‚¹ã‚¯ãƒªãƒ—ãƒˆå | ç”¨é€” | é‡è¦åº¦ |
|---|------------|------|--------|
| 1 | create-changeset.sh | Change Set ä½œæˆ (dry-run) | â­â­â­ |
| 2 | describe-changeset.sh | å¤‰æ›´å†…å®¹ç¢ºèª | â­â­â­ |
| 3 | execute-changeset.sh | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª + å®Ÿè¡Œ | â­â­â­ |
| 4 | rollback.sh | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | â­â­â­ |

**ã™ã¹ã¦ Round 3 ã§ç”Ÿæˆ** âœ…

### 7.2 CloudFormation 3 Principles é”æˆçŠ¶æ³

| åŸå‰‡ | å†…å®¹ | é”æˆçŠ¶æ³ |
|------|------|---------|
| åŸå‰‡1: è²¬ä»»åˆ†é›¢ | Platform / Service Account åˆ†é›¢ | âœ… é”æˆ |
| åŸå‰‡2: ã‚¹ã‚¿ãƒƒã‚¯åˆ†å‰² | Network / Database / Compute / Monitoring åˆ†é›¢ | âœ… é”æˆ |
| åŸå‰‡3: æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ | **Change Set ä½¿ç”¨** | âœ… **Round 3 ã§é”æˆ** â­â­â­ |

**å‚ç…§**: `.claude/docs/40_standards/45_cloudformation.md`

---

**å‰ç« **: [08_é‹ç”¨è¨­è¨ˆ.md](./08_é‹ç”¨è¨­è¨ˆ.md)
**æ¬¡ç« **: [10_é–‹ç™ºç’°å¢ƒãƒ»CI_CDè¨­è¨ˆ.md](./10_é–‹ç™ºç’°å¢ƒãƒ»CI_CDè¨­è¨ˆ.md)
