# 運用マニュアル

> AWS Multi-Account Sample Application

---

## 1. 日常運用

### 1.1 監視ダッシュボード確認（毎日）

**CloudWatch Dashboard**:
```
https://ap-northeast-1.console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#dashboards:name=sample-app-dev
```

**確認項目**:
- [ ] ECS CPU使用率 < 80%
- [ ] ECS メモリ使用率 < 80%
- [ ] RDS CPU使用率 < 80%
- [ ] ALB 5xxエラー < 10件/5分
- [ ] RDS 接続数 < 80件

### 1.2 ログ確認（毎日）

```bash
# Public Web ログ
aws logs tail /ecs/sample-app-dev/public-web --follow --profile service

# Admin Dashboard ログ
aws logs tail /ecs/sample-app-dev/admin-dashboard --follow --profile service

# Batch Processing ログ
aws logs tail /ecs/sample-app-dev/batch --follow --profile service
```

### 1.3 バックアップ確認（週次）

```bash
# RDS自動バックアップ確認
aws rds describe-db-snapshots \
  --db-instance-identifier sample-app-dev-db \
  --region ap-northeast-1 \
  --profile service
```

---

## 2. アプリケーションデプロイ

### 2.1 新バージョンデプロイ

```bash
# 1. Dockerイメージビルド
cd app/public
docker build -t sample-app/dev/public-web:v1.1 .

# 2. ECR push
docker tag sample-app/dev/public-web:v1.1 \
  <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/dev/public-web:v1.1
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/dev/public-web:v1.1

# 3. ECS Task Definition更新
aws ecs register-task-definition \
  --cli-input-json file://task-definition.json \
  --profile service

# 4. ECS Service更新
aws ecs update-service \
  --cluster sample-app-dev \
  --service sample-app-dev-public-web \
  --task-definition sample-app-dev-public-web:2 \
  --force-new-deployment \
  --profile service
```

### 2.2 ロールバック

```bash
# 前のTask Definitionに戻す
aws ecs update-service \
  --cluster sample-app-dev \
  --service sample-app-dev-public-web \
  --task-definition sample-app-dev-public-web:1 \
  --force-new-deployment \
  --profile service
```

---

## 3. データベース運用

### 3.1 手動バックアップ

```bash
aws rds create-db-snapshot \
  --db-instance-identifier sample-app-dev-db \
  --db-snapshot-identifier sample-app-dev-manual-$(date +%Y%m%d-%H%M%S) \
  --region ap-northeast-1 \
  --profile service
```

### 3.2 データベース接続

```bash
# Bastion経由で接続（VPN接続後）
psql -h <RDS_ENDPOINT> -U appuser -d myapp_db
```

---

## 4. スケーリング

### 4.1 ECS Task数変更

```bash
# Desired Count変更
aws ecs update-service \
  --cluster sample-app-dev \
  --service sample-app-dev-public-web \
  --desired-count 4 \
  --profile service
```

### 4.2 RDS インスタンスタイプ変更

```bash
# db.t3.medium → db.t3.large
aws rds modify-db-instance \
  --db-instance-identifier sample-app-dev-db \
  --db-instance-class db.t3.large \
  --apply-immediately \
  --profile service
```

---

## 5. アラート対応

### 5.1 ECS CPU高使用率アラート

**原因調査**:
```bash
# CloudWatch Metricsで確認
aws cloudwatch get-metric-statistics \
  --namespace AWS/ECS \
  --metric-name CPUUtilization \
  --dimensions Name=ServiceName,Value=sample-app-dev-public-web \
  --start-time 2025-10-22T00:00:00Z \
  --end-time 2025-10-22T23:59:59Z \
  --period 300 \
  --statistics Average \
  --profile service
```

**対処**:
- Task数を増やす（スケールアウト）
- Task定義のCPU/メモリを増やす

### 5.2 RDS接続数アラート

**対処**:
- アプリケーションの接続プール設定を見直す
- RDSインスタンスタイプを変更

---

## 変更履歴

| 日付 | 版数 | 変更内容 |
|------|------|----------|
| 2025-10-22 | 1.0 | 初版作成 |
