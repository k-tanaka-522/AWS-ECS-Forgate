# セットアップガイド

> AWS Multi-Account Sample Application

---

## 1. 前提条件

### 1.1 必要なツール

| ツール | バージョン | インストール確認 |
|-------|----------|---------------|
| AWS CLI | 2.x以上 | `aws --version` |
| Node.js | 20.x | `node --version` |
| Docker | 24.x以上 | `docker --version` |
| Git | 2.x以上 | `git --version` |

### 1.2 AWSアカウント

- **Platform Account**: Transit Gateway、VPN用
- **Service Account**: アプリケーション用

### 1.3 IAM権限

以下の権限が必要です：
- CloudFormation (Full Access)
- VPC (Full Access)
- EC2 (Full Access)
- RDS (Full Access)
- ECS (Full Access)
- ECR (Full Access)
- IAM (CreateRole, AttachPolicy)

---

## 2. セットアップ手順

### Step 1: リポジトリクローン

```bash
git clone https://github.com/your-organization/sample-aws-app.git
cd sample-aws-app
```

### Step 2: AWS CLI設定

**Platform Account**:
```bash
aws configure --profile platform
# AWS Access Key ID: (Platform Account)
# AWS Secret Access Key: (Platform Account)
# Default region: ap-northeast-1
```

**Service Account**:
```bash
aws configure --profile service
# AWS Access Key ID: (Service Account)
# AWS Secret Access Key: (Service Account)
# Default region: ap-northeast-1
```

### Step 3: Platform Account デプロイ

```bash
cd infra/cloudformation/platform

# 開発環境
export AWS_PROFILE=platform
./deploy.sh dev

# デプロイ完了後、Transit Gateway IDを確認
aws ec2 describe-transit-gateways --region ap-northeast-1
```

**デプロイ時間**: 約10-15分

### Step 4: Service Account デプロイ

Platform Account の **Transit Gateway ID** を Service Account のパラメータファイルに設定：

```bash
cd ../service

# parameters-dev.json を編集
# TransitGatewayId: "tgw-xxxxxxxxx" を設定

# デプロイ実行
export AWS_PROFILE=service
./deploy.sh dev
```

**デプロイ時間**: 約20-30分（RDS作成含む）

### Step 5: データベースマイグレーション

```bash
cd ../../../app/shared

# 依存関係インストール
npm install

# RDS Endpoint取得
DB_ENDPOINT=$(aws cloudformation describe-stacks \
  --stack-name sample-app-service-dev-database \
  --region ap-northeast-1 \
  --query 'Stacks[0].Outputs[?OutputKey==`DBEndpoint`].OutputValue' \
  --output text \
  --profile service)

# 環境変数設定
export DB_HOST=$DB_ENDPOINT
export DB_PORT=5432
export DB_NAME=myapp_db
export DB_USER=appuser
export DB_PASSWORD=$(aws secretsmanager get-secret-value \
  --secret-id sample-app-dev-db-secret \
  --query SecretString \
  --output text \
  --profile service | jq -r .password)

# マイグレーション実行
npm run migrate:latest
```

### Step 6: Dockerイメージビルド＆プッシュ

```bash
cd ../../

# ECRログイン
aws ecr get-login-password --region ap-northeast-1 --profile service | \
  docker login --username AWS --password-stdin \
  <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com

# Public Web
cd app/public
docker build -t sample-app/dev/public-web .
docker tag sample-app/dev/public-web:latest \
  <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/dev/public-web:latest
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/dev/public-web:latest

# Admin Dashboard
cd ../admin
docker build -t sample-app/dev/admin-dashboard .
docker tag sample-app/dev/admin-dashboard:latest \
  <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/dev/admin-dashboard:latest
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/dev/admin-dashboard:latest

# Batch Processing
cd ../batch
docker build -t sample-app/dev/batch-processing .
docker tag sample-app/dev/batch-processing:latest \
  <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/dev/batch-processing:latest
docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/dev/batch-processing:latest
```

### Step 7: ECS Service起動

```bash
# ECS Serviceを強制的に新しいデプロイに更新
aws ecs update-service \
  --cluster sample-app-dev \
  --service sample-app-dev-public-web \
  --force-new-deployment \
  --region ap-northeast-1 \
  --profile service

aws ecs update-service \
  --cluster sample-app-dev \
  --service sample-app-dev-admin-dashboard \
  --force-new-deployment \
  --region ap-northeast-1 \
  --profile service

aws ecs update-service \
  --cluster sample-app-dev \
  --service sample-app-dev-batch \
  --force-new-deployment \
  --region ap-northeast-1 \
  --profile service
```

### Step 8: 動作確認

**Public Web ALB取得**:
```bash
aws cloudformation describe-stacks \
  --stack-name sample-app-service-dev-compute \
  --region ap-northeast-1 \
  --query 'Stacks[0].Outputs[?OutputKey==`PublicWebALBDNS`].OutputValue' \
  --output text \
  --profile service
```

**疎通確認**:
```bash
curl http://<Public-ALB-DNS>/health
# Expected: {"status":"ok"}
```

---

## 3. トラブルシューティング

### 3.1 CloudFormation デプロイ失敗

**確認事項**:
- IAM権限が十分か
- パラメータファイルが正しいか
- リソース上限に達していないか

**対処**:
```bash
# スタック詳細確認
aws cloudformation describe-stack-events \
  --stack-name <STACK_NAME> \
  --region ap-northeast-1
```

### 3.2 ECS Task起動しない

**確認事項**:
- ECRにイメージがpushされているか
- Task Roleが正しいか
- Secrets Managerにシークレットが存在するか

**対処**:
```bash
# ECS Task失敗理由確認
aws ecs describe-tasks \
  --cluster sample-app-dev \
  --tasks <TASK_ARN> \
  --region ap-northeast-1
```

---

## 変更履歴

| 日付 | 版数 | 変更内容 |
|------|------|----------|
| 2025-10-22 | 1.0 | 初版作成 |
