# トラブルシューティング

> AWS Multi-Account Sample Application

---

## 1. インフラ関連

### 1.1 CloudFormation デプロイ失敗

**症状**: スタック作成が ROLLBACK_COMPLETE になる

**原因**:
- リソース上限到達
- IAM権限不足
- パラメータ設定ミス
- 依存リソース未作成

**対処**:
```bash
# スタックイベント確認
aws cloudformation describe-stack-events \
  --stack-name <STACK_NAME> \
  --region ap-northeast-1 | grep FAILED

# 失敗したリソースの詳細確認
aws cloudformation describe-stack-resources \
  --stack-name <STACK_NAME> \
  --region ap-northeast-1
```

### 1.2 Transit Gateway接続失敗

**症状**: Platform VPC ⇔ Service VPC 疎通不可

**確認項目**:
- [ ] TGW Attachment が available か
- [ ] Route Table に TGW ルートが設定されているか
- [ ] Security Group で通信が許可されているか

**対処**:
```bash
# TGW Attachment確認
aws ec2 describe-transit-gateway-attachments \
  --region ap-northeast-1

# Route Table確認
aws ec2 describe-route-tables \
  --region ap-northeast-1
```

---

## 2. ECS関連

### 2.1 ECS Task起動しない

**症状**: Task が PENDING のまま、または即座に STOPPED になる

**原因**:
- ECRイメージが存在しない
- Task Role/Execution Role の権限不足
- Secrets Manager のシークレットが存在しない
- ENI不足

**対処**:
```bash
# Task詳細確認
aws ecs describe-tasks \
  --cluster sample-app-dev \
  --tasks <TASK_ARN> \
  --region ap-northeast-1

# CloudWatch Logsで起動ログ確認
aws logs tail /ecs/sample-app-dev/public-web --since 10m
```

### 2.2 ECS Service Healthy にならない

**症状**: ALB Target Group で Unhealthy

**確認項目**:
- [ ] コンテナが正しくポート3000でリッスンしているか
- [ ] Health Check パスが正しいか（例: `/health`）
- [ ] Security Groupで ALB → ECS の通信が許可されているか

**対処**:
```bash
# Target Health確認
aws elbv2 describe-target-health \
  --target-group-arn <TARGET_GROUP_ARN> \
  --region ap-northeast-1

# ECS Task IPアドレス確認
aws ecs describe-tasks \
  --cluster sample-app-dev \
  --tasks <TASK_ARN> \
  --query 'tasks[0].attachments[0].details[?name==`privateIPv4Address`].value' \
  --output text
```

---

## 3. RDS関連

### 3.1 RDS接続エラー

**症状**: アプリケーションからRDSに接続できない

**原因**:
- Security Groupで5432ポートが開いていない
- RDS Endpoint設定ミス
- Secrets Manager のパスワード取得失敗
- RDSインスタンスが停止している

**対処**:
```bash
# RDS状態確認
aws rds describe-db-instances \
  --db-instance-identifier sample-app-dev-db \
  --query 'DBInstances[0].[DBInstanceStatus,Endpoint.Address,Endpoint.Port]' \
  --output table

# Security Group確認
aws ec2 describe-security-groups \
  --group-ids <RDS_SG_ID> \
  --region ap-northeast-1

# Secrets Manager確認
aws secretsmanager get-secret-value \
  --secret-id sample-app-dev-db-secret \
  --region ap-northeast-1
```

### 3.2 RDS CPU使用率が高い

**対処**:
```bash
# Slow Queryログ確認
aws logs tail /aws/rds/instance/sample-app-dev-db/slowquery --since 1h

# Performance Insights確認（AWS Console）
# https://console.aws.amazon.com/rds/home?region=ap-northeast-1#performance-insights:
```

**改善策**:
- インデックスの追加
- クエリの最適化
- 接続プール設定の見直し

---

## 4. ネットワーク関連

### 4.1 Client VPN接続できない

**症状**: VPNクライアントで接続エラー

**確認項目**:
- [ ] Client VPN Endpoint が available か
- [ ] クライアント証明書が正しいか
- [ ] Authorization Rule が設定されているか

**対処**:
```bash
# VPN Endpoint状態確認
aws ec2 describe-client-vpn-endpoints \
  --region ap-northeast-1

# Authorization Rule確認
aws ec2 describe-client-vpn-authorization-rules \
  --client-vpn-endpoint-id <ENDPOINT_ID> \
  --region ap-northeast-1
```

### 4.2 ALB 503エラー

**症状**: ALBにアクセスすると503エラー

**原因**:
- Target Groupに Healthy なターゲットがない
- ECS Taskが起動していない

**対処**:
```bash
# Target Group Healthy確認
aws elbv2 describe-target-health \
  --target-group-arn <TARGET_GROUP_ARN>

# ECS Service確認
aws ecs describe-services \
  --cluster sample-app-dev \
  --services sample-app-dev-public-web
```

---

## 5. アプリケーション関連

### 5.1 API 500エラー

**症状**: APIリクエストで500エラーが返る

**対処**:
```bash
# CloudWatch Logsでエラーログ確認
aws logs filter-log-events \
  --log-group-name /ecs/sample-app-dev/public-web \
  --filter-pattern "ERROR" \
  --start-time $(date -d '1 hour ago' +%s)000 \
  --region ap-northeast-1
```

### 5.2 バッチ処理が実行されない

**症状**: Batch Service が統計を集計していない

**確認項目**:
- [ ] ECS Scheduled Task が設定されているか
- [ ] Task Roleに必要な権限があるか
- [ ] データベース接続が可能か

**対処**:
```bash
# Batch ログ確認
aws logs tail /ecs/sample-app-dev/batch --since 1h --follow

# ECS Scheduled Task確認
aws events list-rules --name-prefix sample-app-dev-batch
```

---

## 6. 監視関連

### 6.1 CloudWatch Alarm発報しない

**症状**: メトリクスが閾値を超えてもAlarmが発報しない

**確認項目**:
- [ ] SNS Topicのサブスクリプションが確認済みか
- [ ] Alarm設定が正しいか
- [ ] メトリクスデータが送信されているか

**対処**:
```bash
# Alarm状態確認
aws cloudwatch describe-alarms \
  --alarm-names sample-app-dev-PublicWeb-CPU-High \
  --region ap-northeast-1

# SNS Topic確認
aws sns list-subscriptions-by-topic \
  --topic-arn <TOPIC_ARN> \
  --region ap-northeast-1
```

---

## 7. よくある質問（FAQ）

### Q1: デプロイにどれくらい時間がかかりますか？

**A**:
- Platform Account: 10-15分
- Service Account: 20-30分（RDS作成含む）

### Q2: コストはどれくらいかかりますか？

**A**: 検証環境で月額約$225
- ECS Fargate: $25
- RDS: $100
- ALB: $25
- Client VPN: $75

### Q3: 本番環境にスケールするには？

**A**:
- ECS Auto Scaling設定
- RDS Read Replica追加
- CloudFront導入
- Multi-AZ構成維持

---

## 8. サポート連絡先

| 項目 | 連絡先 |
|------|--------|
| 技術サポート | support@example.com |
| 緊急連絡 | +81-XX-XXXX-XXXX |
| ドキュメント | https://github.com/your-org/sample-aws-app |

---

## 変更履歴

| 日付 | 版数 | 変更内容 |
|------|------|----------|
| 2025-10-22 | 1.0 | 初版作成 |
