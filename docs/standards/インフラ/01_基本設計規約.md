# 基本設計規約（インフラ・プロジェクト固有）

## 1. インフラアーキテクチャ方針

### 1.1 採用アーキテクチャ
- **Hub-and-Spoke型ネットワーク構成**
  - Shared VPC: Transit Gateway、Client VPN配置
  - App VPC: アプリケーション本体
  - 接続: Transit Gateway経由

### 1.2 AWS構成

#### POC環境
- **VPC構成**: 2VPC
  - Shared VPC: 10.0.0.0/16
  - App VPC: 10.1.0.0/16
- **接続方式**: Client VPN
- **可用性**: Single-AZ
- **コンピューティング**: ECS Fargate
- **データベース**: RDS PostgreSQL（db.t3.micro Single-AZ）
- **ストレージ**: S3
- **認証**: Cognito User Pool

#### 本番環境（将来）
- **AWSアカウント**: 2アカウント（共有系+本番）
- **接続方式**: Direct Connect + Transit Gateway
- **可用性**: Multi-AZ
- **データベース**: RDS PostgreSQL（db.m5.large Multi-AZ）
- **セキュリティ**: WAF、GuardDuty、Config

### 1.3 技術選定の根拠

#### なぜCloudFormationか
- **要件**: 「IaCでインフラを管理したい」
- **対応**:
  - AWS特化のため、AWSサービスとの統合が最も緊密
  - ドリフト検出、変更セット機能で安全性確保
  - Cross-Stack Referencesで柔軟なスタック管理

#### なぜCross-Stack References方式か
- **要件**: 「スタックを独立して管理したい」「デプロイの柔軟性が欲しい」
- **対応**:
  - 各スタック（ネットワーク、DB、アプリ基盤）を独立管理
  - 必要なスタックのみを更新可能
  - Nested Stacksより柔軟性が高い

#### なぜECS Fargateか
- **要件**: 「運用負荷を最小化したい」「コンテナでアプリを動かしたい」
- **対応**:
  - サーバーレスコンテナで運用不要
  - Auto Scalingで負荷に応じた自動拡張
  - EC2管理不要

## 2. 非機能要件への対応方針

### 2.1 可用性要件
- **要件**: POC 95%以上、本番 99.5%以上
- **対応策**:
  - **POC**: Single-AZ（コスト優先）、定期バックアップ
  - **本番**: Multi-AZ構成（RDS、ECS Fargate）、ALB負荷分散

### 2.2 セキュリティ要件
- **要件**: 個人情報保護法対応、要配慮個人情報あり
- **対応策**:
  - **ネットワーク分離**: Public/Private Subnet分離、セキュリティグループで最小権限
  - **暗号化**: RDS暗号化、S3暗号化、TLS 1.2以上
  - **アクセス制御**:
    - POC: Client VPN経由でVPCアクセス
    - 本番: Direct Connect経由、WAF導入
  - **シークレット管理**: AWS Secrets Manager使用
  - **監査ログ**: CloudTrail、VPC Flow Logs、アプリログ7年保管

### 2.3 スケーラビリティ要件
- **要件**: 将来的に10倍の負荷に対応
- **対応策**:
  - **ECS Auto Scaling**: CPU 70%でスケールアウト
  - **RDS**: 垂直スケーリング可能、リードレプリカ追加可能
  - **ALB**: 自動的に負荷分散

### 2.4 バックアップ・DR
- **要件**: RPO 1時間、RTO 6時間
- **対応策**:
  - **RDS自動バックアップ**: POC 7日、本番 30日
  - **RDS手動スナップショット**: 週次、3ヶ月保管
  - **DR**: 本番のみ、大阪リージョンにスナップショットコピー

## 3. スタック分割方針

### 3.1 Cross-Stack References採用理由

**調査結果（2025年版ベストプラクティス）:**
- Cross-Stack References: 独立したスタック管理、柔軟な更新
- Nested Stacks: 集中管理、一括デプロイ

**本プロジェクトの選択: Cross-Stack References**

**理由:**
1. **独立管理の必要性**: ネットワーク、DB、アプリ基盤を別チームで管理する可能性
2. **柔軟な更新**: 一部スタックのみを更新可能（例: DBスペック変更時、他スタックは影響なし）
3. **障害範囲の限定**: スタック更新失敗時の影響を最小化

### 3.2 スタック分割

```
1. 共有系ネットワークスタック（SharedNetwork）
   - Shared VPC、Transit Gateway、Client VPN
   - 他スタックへの依存: なし
   - Exports: Transit Gateway ID、Shared VPC ID

2. アプリ系ネットワークスタック（AppNetwork）
   - App VPC、サブネット、ALB、セキュリティグループ
   - 依存: SharedNetwork（Transit Gateway ID）
   - Exports: VPC ID、Subnet IDs、ALB ARN、Security Group IDs

3. データベーススタック（Database）
   - RDS PostgreSQL、Secrets Manager（DB接続情報）
   - 依存: AppNetwork（VPC ID、Subnet IDs、Security Group ID）
   - Exports: RDS Endpoint、DB Name、Secret ARN

4. アプリ基盤スタック（AppPlatform）
   - ECS Cluster、ECR、Cognito、S3、IAMロール
   - 依存: AppNetwork（VPC ID、Subnet IDs、ALB ARN）、Database（RDS Endpoint）
   - Exports: ECS Cluster Name、ECR URI、Cognito Pool ID、S3 Bucket Name
```

### 3.3 デプロイ順序

```
SharedNetwork
    ↓
AppNetwork
    ↓
Database & AppPlatform（並列実行可能）
```

## 4. 命名規則

### 4.1 スタック名
```
形式: CareApp-{Environment}-{Component}

POC環境:
- CareApp-POC-SharedNetwork
- CareApp-POC-AppNetwork
- CareApp-POC-Database
- CareApp-POC-AppPlatform

本番環境:
- CareApp-Prod-SharedNetwork
- CareApp-Prod-AppNetwork
- CareApp-Prod-Database
- CareApp-Prod-AppPlatform
```

### 4.2 Export名
```
形式: CareApp-{Environment}-{Component}-{Resource}

例:
- CareApp-POC-SharedNetwork-TransitGatewayID
- CareApp-POC-AppNetwork-VPCID
- CareApp-POC-AppNetwork-ALBArn
- CareApp-POC-Database-RDSEndpoint
```

### 4.3 リソース名
```
形式: CareApp-{Environment}-{ResourceType}-{Name}

例:
- CareApp-POC-VPC-Shared
- CareApp-POC-VPC-App
- CareApp-POC-ECSCluster-Main
- CareApp-POC-RDS-Main
- CareApp-POC-ALB-App
```

### 4.4 タグ必須化
すべてのリソースに以下のタグを必須：
- `Project`: CareApp
- `Environment`: POC/Production
- `ManagedBy`: CloudFormation
- `Component`: SharedNetwork/AppNetwork/Database/AppPlatform

## 5. ネットワーク設計

### 5.1 VPC CIDR設計

| VPC | CIDR | 用途 |
|-----|------|------|
| Shared VPC (POC) | 10.0.0.0/16 | Transit Gateway、Client VPN |
| App VPC (POC) | 10.1.0.0/16 | アプリケーション |
| Shared VPC (本番) | 10.10.0.0/16 | Transit Gateway、Direct Connect |
| App VPC (本番) | 10.11.0.0/16 | アプリケーション |

### 5.2 サブネット分割（App VPC）

#### POC環境（Single-AZ: ap-northeast-1a）
```
Public Subnet:
- 10.1.0.0/24 (ap-northeast-1a) - ALB配置

Private Subnet (App):
- 10.1.1.0/24 (ap-northeast-1a) - ECS Fargate配置

Private Subnet (DB):
- 10.1.2.0/24 (ap-northeast-1a) - RDS配置
```

#### 本番環境（Multi-AZ: ap-northeast-1a, 1c）
```
Public Subnet:
- 10.11.0.0/24 (ap-northeast-1a) - ALB
- 10.11.1.0/24 (ap-northeast-1c) - ALB

Private Subnet (App):
- 10.11.10.0/24 (ap-northeast-1a) - ECS Fargate
- 10.11.11.0/24 (ap-northeast-1c) - ECS Fargate

Private Subnet (DB):
- 10.11.20.0/24 (ap-northeast-1a) - RDS Primary
- 10.11.21.0/24 (ap-northeast-1c) - RDS Standby
```

### 5.3 セキュリティグループ設計

```
1. ALB用セキュリティグループ
   - Ingress: 443 (HTTPS) ← 0.0.0.0/0（インターネット）
   - Egress: 8080 ← ECS Security Group

2. ECS用セキュリティグループ
   - Ingress: 8080 ← ALB Security Group
   - Egress: 443 ← 0.0.0.0/0（外部API通信）、5432 ← RDS Security Group

3. RDS用セキュリティグループ
   - Ingress: 5432 ← ECS Security Group
   - Egress: なし

4. Client VPN用セキュリティグループ（POC）
   - Ingress: 443 ← VPNクライアント
   - Egress: All ← App VPC
```

## 6. IAM設計

### 6.1 ECS タスクロール
```
権限:
- S3読み書き（申請書添付ファイル）
- Secrets Manager読み取り（DB接続情報）
- SES送信（メール通知）
- CloudWatch Logs書き込み
```

### 6.2 ECS タスク実行ロール
```
権限:
- ECRイメージプル
- CloudWatch Logs作成・書き込み
- Secrets Manager読み取り（環境変数注入用）
```

### 6.3 CI/CD用IAMユーザー
```
権限:
- ECR push
- ECS Service/Task Definition更新
- CloudFormation実行（変更セット作成・実行）
```

## 7. コスト見積もり

### 7.1 POC環境（月額）
```
- ECS Fargate (0.25vCPU, 0.5GB, 2タスク): 約2,000円
- RDS (db.t3.micro Single-AZ): 約2,000円
- ALB: 約2,500円
- Client VPN: 約5,000円
- NAT Gateway: 約3,500円
- その他（Cognito, CloudWatch, S3）: 約1,000円
合計: 約16,000円/月
```

### 7.2 本番環境（月額）
```
- ECS Fargate (0.5vCPU, 1GB, 4-8タスク Auto Scaling): 約15,000円
- RDS (db.m5.large Multi-AZ): 約30,000円
- ALB: 約2,500円
- Direct Connect按分: 約10,000円
- Transit Gateway: 約10,000円
- NAT Gateway (Multi-AZ): 約7,000円
- WAF: 約5,000円
- S3（バックアップ）: 約3,000円
- CloudWatch Logs: 約2,000円
- その他: 約2,000円
合計: 約86,500円/月
```

### 7.3 コスト最適化戦略
- **RDS**: 1年リザーブドインスタンス（約30%削減）
- **ECS Fargate**: Compute Savings Plans（約20%削減）
- **S3**: ライフサイクルポリシー（90日後Glacier移行）
- **POC環境**: 不要時に停止（RDS停止、ECS Desired Count 0）

---

**作成日**: 2025-10-03
**参考資料**:
- [AWS CloudFormation Best Practices](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/best-practices.html)
- [Cross-Stack References](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthrough-crossstackref.html)
