# 詳細設計規約（インフラ・プロジェクト固有）

## 1. ディレクトリ構造

### 1.1 CloudFormation プロジェクト構造

```
infra/
├── README.md                           # インフラ全体の説明
├── shared/                             # 共有系スタック
│   ├── network.yaml                    # Shared VPC、TGW、Client VPN
│   ├── parameters-poc.json             # POC環境パラメータ
│   └── parameters-prod.json            # 本番環境パラメータ（将来）
│
├── app/                                # アプリ系スタック
│   ├── network.yaml                    # App VPC、サブネット、ALB、SG
│   ├── database.yaml                   # RDS PostgreSQL
│   ├── platform.yaml                   # ECS、Cognito、S3、ECR
│   ├── parameters-poc.json             # POC環境パラメータ
│   └── parameters-prod.json            # 本番環境パラメータ（将来）
│
├── scripts/                            # デプロイスクリプト
│   ├── deploy-all.sh                   # 全スタック一括デプロイ
│   ├── deploy-stack.sh                 # 単一スタックデプロイ
│   ├── delete-all.sh                   # 全スタック削除
│   └── validate.sh                     # テンプレート検証
│
└── docs/                               # ドキュメント
    ├── deploy-guide.md                 # デプロイ手順書
    ├── architecture.md                 # アーキテクチャ図
    └── troubleshooting.md              # トラブルシューティング
```

**選定理由:**
- 共有系とアプリ系でディレクトリ分離（責任分解）
- スクリプトは別ディレクトリ（テンプレートと分離）
- 環境ごとのパラメータファイル（環境差分の見える化）

### 1.2 調査結果の反映

**2025年版ベストプラクティス:**
- ✅ テンプレートのモジュール化（スタック分割）
- ✅ パラメータファイルでの環境差分管理
- ✅ Gitリポジトリでのバージョン管理
- ✅ 自動デプロイスクリプト

## 2. CloudFormation テンプレート規約

### 2.1 ファイル命名規則
```
{component}.yaml

例:
- network.yaml（ネットワーク）
- database.yaml（データベース）
- platform.yaml（アプリ基盤）
```

### 2.2 テンプレート構成順序

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: |
  {スタックの説明}
  {作成日、管理者等}

# 1. Metadata（オプション）
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups: ...

# 2. Parameters
Parameters:
  Environment:
    Type: String
    Description: ...

  VpcCidr:
    Type: String
    Description: ...

# 3. Mappings（オプション）
Mappings:
  EnvironmentMap:
    POC:
      InstanceType: t3.micro
    Production:
      InstanceType: m5.large

# 4. Conditions（オプション）
Conditions:
  IsProduction: !Equals [!Ref Environment, Production]

# 5. Resources（依存関係順に記載）
Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties: ...

  # Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    DependsOn: VPC
    Properties: ...

  # ...（依存関係順）

# 6. Outputs（Export必須）
Outputs:
  VPCID:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub ${AWS::StackName}-VPCID
```

### 2.3 コメント規則

```yaml
# ファイルヘッダーコメント（必須）
# ファイル名: network.yaml
# 目的: アプリ系VPC、サブネット、ALB、セキュリティグループの定義
# 依存スタック: CareApp-POC-SharedNetwork（Transit Gateway ID）
# 作成日: 2025-10-03

# リソースの目的を説明（複雑なリソースのみ）
# ECS FargateタスクからRDSへの接続を許可
RDSSecurityGroupIngress:
  Type: AWS::EC2::SecurityGroupIngress
  Properties:
    GroupId: !Ref RDSSecurityGroup
    IpProtocol: tcp
    FromPort: 5432
    ToPort: 5432
    SourceSecurityGroupId: !Ref ECSSecurityGroup  # ECSタスクからの接続のみ許可
```

### 2.4 Parameter命名規則

**形式: パスカルケース**

```yaml
Parameters:
  Environment:         # 環境名
    Type: String

  VpcCidr:            # VPC CIDR
    Type: String

  DBInstanceClass:    # DBインスタンスクラス
    Type: String

  DBAllocatedStorage: # DB割り当てストレージ
    Type: Number
```

### 2.5 Resource命名規則（論理ID）

**形式: パスカルケース**

```yaml
Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC

  # Subnet
  PublicSubnet1:
    Type: AWS::EC2::Subnet

  PrivateSubnetApp1:
    Type: AWS::EC2::Subnet

  # Security Group
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup

  # RDS
  RDSInstance:
    Type: AWS::RDS::DBInstance
```

### 2.6 Tag必須化

すべてのリソースに以下のタグを必須：

```yaml
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      Tags:
        - Key: Name
          Value: !Sub CareApp-${Environment}-VPC-App
        - Key: Project
          Value: CareApp
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Component
          Value: AppNetwork
```

## 3. パラメータファイル規約

### 3.1 ファイル命名規則

```
parameters-{environment}.json

例:
- parameters-poc.json
- parameters-prod.json
```

### 3.2 パラメータファイル構成

```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "POC"
  },
  {
    "ParameterKey": "VpcCidr",
    "ParameterValue": "10.1.0.0/16"
  },
  {
    "ParameterKey": "DBInstanceClass",
    "ParameterValue": "db.t3.micro"
  },
  {
    "ParameterKey": "DBAllocatedStorage",
    "ParameterValue": "20"
  }
]
```

### 3.3 シークレット情報の扱い

**NG: パラメータファイルにハードコード**
```json
// ❌ 悪い例
{
  "ParameterKey": "DBPassword",
  "ParameterValue": "MyPassword123!"
}
```

**OK: AWS Secrets Managerで管理**
```yaml
# テンプレート内でSecrets Manager参照
Resources:
  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub CareApp-${Environment}-DB-Secret
      GenerateSecretString:
        SecretStringTemplate: '{"username": "admin"}'
        GenerateStringKey: password
        PasswordLength: 32
        ExcludeCharacters: '"@/\'

  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      MasterUsername: !Sub '{{resolve:secretsmanager:${DBSecret}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DBSecret}:SecretString:password}}'
```

## 4. Cross-Stack References規約

### 4.1 Export命名規則

```yaml
形式: ${AWS::StackName}-{Resource}

Outputs:
  VPCID:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub ${AWS::StackName}-VPCID

  ALBArn:
    Description: ALB ARN
    Value: !Ref ALB
    Export:
      Name: !Sub ${AWS::StackName}-ALBArn
```

### 4.2 Import方法

```yaml
# Fn::ImportValue関数で参照
Resources:
  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - Fn::ImportValue: !Sub CareApp-${Environment}-AppNetwork-RDSSecurityGroupID
```

### 4.3 Export削除時の注意

**重要：** Exportは他スタックがImportしている限り、削除・変更不可。

**削除手順：**
1. Import側のスタックを削除
2. Export側のスタックを更新してExport削除
3. 再度Import側のスタックを作成（必要に応じて）

## 5. デプロイスクリプト規約

### 5.1 スクリプト命名規則

```bash
deploy-{target}.sh

例:
- deploy-all.sh（全スタック）
- deploy-stack.sh（単一スタック）
- delete-all.sh（全削除）
- validate.sh（検証のみ）
```

### 5.2 スクリプト共通ヘッダー

```bash
#!/bin/bash
set -e  # エラー時は即座に終了

# スクリプト説明
# ファイル名: deploy-stack.sh
# 目的: 単一CloudFormationスタックのデプロイ
# 使用方法: ./deploy-stack.sh <stack-name> <template-file> <parameters-file>

# 色付きログ関数
log_info() {
  echo -e "\033[0;32m[INFO]\033[0m $1"
}

log_error() {
  echo -e "\033[0;31m[ERROR]\033[0m $1"
}

log_warning() {
  echo -e "\033[0;33m[WARNING]\033[0m $1"
}
```

### 5.3 dry-run機能必須

```bash
# dry-runフラグ
DRY_RUN=false
if [[ "$1" == "--dry-run" ]]; then
  DRY_RUN=true
  shift
fi

# 変更セット作成
if [ "$DRY_RUN" = true ]; then
  log_info "Dry-run mode: Creating change set..."
  aws cloudformation create-change-set \
    --stack-name "$STACK_NAME" \
    --change-set-name "dry-run-$(date +%Y%m%d-%H%M%S)" \
    --template-body "file://$TEMPLATE_FILE" \
    --parameters "file://$PARAMETERS_FILE" \
    --capabilities CAPABILITY_IAM
  exit 0
fi
```

## 6. エラーハンドリング規約

### 6.1 テンプレート検証

```yaml
# Conditions を活用したバリデーション
Conditions:
  IsValidEnvironment: !Or
    - !Equals [!Ref Environment, POC]
    - !Equals [!Ref Environment, Production]

# リソースでCondition使用
Resources:
  InvalidEnvironmentCheck:
    Type: AWS::CloudFormation::WaitConditionHandle
    Condition: IsValidEnvironment
```

### 6.2 DeletionPolicy設定

```yaml
# 本番環境のRDSは削除保護
Resources:
  RDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: !If [IsProduction, Snapshot, Delete]
    Properties:
      # ...
```

## 7. モニタリング・アラート設計

### 7.1 CloudWatch Alarms必須項目

```yaml
Resources:
  # RDS CPU使用率アラート
  RDSCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub CareApp-${Environment}-RDS-HighCPU
      MetricName: CPUUtilization
      Namespace: AWS/RDS
      Statistic: Average
      Period: 300
      EvaluationPeriods: 1
      Threshold: 80
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: DBInstanceIdentifier
          Value: !Ref RDSInstance
      AlarmActions:
        - !Ref SNSTopic
```

### 7.2 ログ設計

```yaml
# VPC Flow Logs
VPCFlowLog:
  Type: AWS::EC2::FlowLog
  Properties:
    ResourceType: VPC
    ResourceIds:
      - !Ref VPC
    TrafficType: ALL
    LogDestinationType: cloud-watch-logs
    LogGroupName: !Sub /aws/vpc/${AWS::StackName}
    DeliverLogsPermissionArn: !GetAtt VPCFlowLogRole.Arn

# CloudTrail（本番のみ）
CloudTrail:
  Type: AWS::CloudTrail::Trail
  Condition: IsProduction
  Properties:
    TrailName: !Sub CareApp-${Environment}-Trail
    S3BucketName: !Ref CloudTrailBucket
    IsLogging: true
    IncludeGlobalServiceEvents: true
```

---

**作成日**: 2025-10-03
**参考資料**:
- [CloudFormation Template Anatomy](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-anatomy.html)
- [CloudFormation Best Practices 2025](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/best-practices.html)
