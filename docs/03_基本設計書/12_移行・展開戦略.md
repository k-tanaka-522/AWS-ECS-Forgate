# 12. 移行・展開戦略

[← 前へ: 11_コスト設計](11_コスト設計.md) | [目次](00_目次.md)

---

## 12.1 デプロイ全体フロー

```
Phase 1: 準備
  ├─ AWSアカウント準備
  ├─ GitHub リポジトリ準備
  ├─ VPN証明書作成
  └─ Secrets Manager設定

Phase 2: Platform Account構築
  ├─ S3 Bucket作成（CloudFormationテンプレート用）
  ├─ Platform Stack デプロイ
  │   ├─ Shared VPC
  │   ├─ Transit Gateway
  │   └─ Client VPN
  └─ 疎通確認

Phase 3: Service Account構築
  ├─ ECR Repository作成
  ├─ Secrets Manager設定
  ├─ Network Stack デプロイ
  ├─ Database Stack デプロイ
  ├─ Compute Stack デプロイ
  └─ Monitoring Stack デプロイ

Phase 4: アプリケーションデプロイ
  ├─ Dockerイメージビルド
  ├─ ECR プッシュ
  ├─ ECS Service起動
  └─ 動作確認

Phase 5: CI/CD構築
  ├─ GitHub Actions Secrets設定
  ├─ Workflow動作確認
  └─ 自動デプロイテスト
```

---

## 12.2 Phase 1: 準備

### 12.2.1 AWSアカウント準備

| タスク | 実施内容 | 担当 |
|-------|---------|------|
| Platform Account準備 | AWSアカウント作成（ID: 123456789012） | インフラチーム |
| Service Account準備 | AWSアカウント作成（ID: 987654321098） | インフラチーム |
| IAM User作成 | AdministratorAccess権限付与 | インフラチーム |
| AWS CLI設定 | ~/.aws/credentials設定 | インフラチーム |

**AWS CLI Profile設定例**:
```ini
[platform]
aws_access_key_id = AKIAXXXXXXXX
aws_secret_access_key = XXXXXXXX
region = ap-northeast-1

[service]
aws_access_key_id = AKIAXXXXXXXX
aws_secret_access_key = XXXXXXXX
region = ap-northeast-1
```

### 12.2.2 VPN証明書作成

**手順**:
```bash
# 1. Easy-RSA ダウンロード
git clone https://github.com/OpenVPN/easy-rsa.git
cd easy-rsa/easyrsa3

# 2. PKI初期化
./easyrsa init-pki

# 3. CA証明書作成
./easyrsa build-ca nopass

# 4. サーバー証明書作成
./easyrsa build-server-full server nopass

# 5. クライアント証明書作成
./easyrsa build-client-full client1.domain.tld nopass

# 6. ACM インポート
aws acm import-certificate \
  --certificate fileb://pki/issued/server.crt \
  --private-key fileb://pki/private/server.key \
  --certificate-chain fileb://pki/ca.crt \
  --region ap-northeast-1 \
  --profile platform
```

### 12.2.3 GitHub リポジトリ準備

**リポジトリ作成**:
```bash
git init
git remote add origin https://github.com/your-org/sample-app.git
git branch -M main
```

**初期コミット**:
```bash
git add .
git commit -m "Initial commit: Project structure"
git push -u origin main
```

---

## 12.3 Phase 2: Platform Account構築

### 12.3.1 S3 Bucket作成（ネストテンプレート用）

```bash
aws s3 mb s3://sample-app-dev-cfn-templates \
  --region ap-northeast-1 \
  --profile platform

aws s3 cp infra/cloudformation/platform/nested/ \
  s3://sample-app-dev-cfn-templates/nested/ \
  --recursive \
  --profile platform
```

### 12.3.2 Platform Stack デプロイ

**Change Set作成**:
```bash
aws cloudformation create-change-set \
  --stack-name sample-app-platform \
  --template-body file://infra/cloudformation/platform/stacks/main/stack.yaml \
  --parameters file://infra/cloudformation/platform/parameters/dev.json \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile platform
```

**Change Set確認**:
```bash
aws cloudformation describe-change-set \
  --stack-name sample-app-platform \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile platform
```

**Change Set実行**:
```bash
aws cloudformation execute-change-set \
  --stack-name sample-app-platform \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile platform
```

**デプロイ完了待機**:
```bash
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-platform \
  --region ap-northeast-1 \
  --profile platform
```

**実行時間**: 約15-20分

### 12.3.3 Transit Gateway ID取得

```bash
aws ec2 describe-transit-gateways \
  --filters "Name=tag:Name,Values=sample-app-tgw" \
  --query 'TransitGateways[0].TransitGatewayId' \
  --output text \
  --region ap-northeast-1 \
  --profile platform
```

**出力例**: `tgw-0123456789abcdef0`

この値を Service Account の parameters/dev.json に設定

---

## 12.4 Phase 3: Service Account構築

### 12.4.1 ECR Repository作成

```bash
aws ecr create-repository \
  --repository-name sample-app/public \
  --region ap-northeast-1 \
  --profile service

aws ecr create-repository \
  --repository-name sample-app/admin \
  --region ap-northeast-1 \
  --profile service

aws ecr create-repository \
  --repository-name sample-app/batch \
  --region ap-northeast-1 \
  --profile service
```

### 12.4.2 Secrets Manager設定

**RDS Master Password作成**:
```bash
aws secretsmanager create-secret \
  --name sample-app/dev/db-master-password \
  --description "RDS Master Password" \
  --secret-string "$(openssl rand -base64 32)" \
  --region ap-northeast-1 \
  --profile service
```

### 12.4.3 Service Account Stack デプロイ

**デプロイ順序**:

#### 1. Network Stack
```bash
aws cloudformation create-change-set \
  --stack-name sample-app-dev-network \
  --template-body file://infra/cloudformation/service/stacks/network/main.yaml \
  --parameters "$(cat infra/cloudformation/service/parameters/dev.json | jq -c '.network')" \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service

aws cloudformation execute-change-set \
  --stack-name sample-app-dev-network \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service

aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-network \
  --region ap-northeast-1 \
  --profile service
```

**実行時間**: 約10分

#### 2. Database Stack
```bash
aws cloudformation create-change-set \
  --stack-name sample-app-dev-database \
  --template-body file://infra/cloudformation/service/stacks/database/main.yaml \
  --parameters "$(cat infra/cloudformation/service/parameters/dev.json | jq -c '.database')" \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service

aws cloudformation execute-change-set \
  --stack-name sample-app-dev-database \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service

aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-database \
  --region ap-northeast-1 \
  --profile service
```

**実行時間**: 約15-20分（RDS作成）

#### 3. Compute Stack
```bash
# 同様の手順で compute stack デプロイ
```

**実行時間**: 約10分

#### 4. Monitoring Stack
```bash
# 同様の手順で monitoring stack デプロイ
```

**実行時間**: 約5分

---

## 12.5 Phase 4: アプリケーションデプロイ

### 12.5.1 Dockerイメージビルド&プッシュ

```bash
# ECR ログイン
aws ecr get-login-password --region ap-northeast-1 --profile service | \
  docker login --username AWS --password-stdin \
  987654321098.dkr.ecr.ap-northeast-1.amazonaws.com

# Public Web
docker build -t sample-app/public:latest app/public/
docker tag sample-app/public:latest \
  987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/public:latest
docker push 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/public:latest

# Admin
docker build -t sample-app/admin:latest app/admin/
docker tag sample-app/admin:latest \
  987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/admin:latest
docker push 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/admin:latest

# Batch
docker build -t sample-app/batch:latest app/batch/
docker tag sample-app/batch:latest \
  987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/batch:latest
docker push 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/batch:latest
```

### 12.5.2 ECS Service起動確認

```bash
# ECS Service 状態確認
aws ecs describe-services \
  --cluster sample-app-cluster \
  --services public-web-service admin-service \
  --region ap-northeast-1 \
  --profile service
```

**期待結果**: `runningCount: 2`（Public Web）, `runningCount: 1`（Admin）

### 12.5.3 動作確認

**Public Web**:
```bash
# ALB DNS Name取得
ALB_DNS=$(aws elbv2 describe-load-balancers \
  --names sample-app-alb \
  --query 'LoadBalancers[0].DNSName' \
  --output text \
  --region ap-northeast-1 \
  --profile service)

# Health Check
curl http://${ALB_DNS}/health

# API Test
curl http://${ALB_DNS}/api/users
```

**Admin Dashboard**（VPN接続後）:
```bash
# ECS Task Private IP取得
TASK_IP=$(aws ecs list-tasks \
  --cluster sample-app-cluster \
  --service-name admin-service \
  --query 'taskArns[0]' \
  --output text \
  --region ap-northeast-1 \
  --profile service | xargs aws ecs describe-tasks \
  --cluster sample-app-cluster \
  --tasks \
  --query 'tasks[0].attachments[0].details[?name==`privateIPv4Address`].value' \
  --output text \
  --region ap-northeast-1 \
  --profile service)

# Health Check
curl http://${TASK_IP}:3000/health
```

---

## 12.6 Phase 5: CI/CD構築

### 12.6.1 GitHub Secrets設定

```bash
# GitHub CLI使用
gh secret set AWS_ACCOUNT_ID --body "987654321098"
gh secret set SERVICE_AWS_ACCESS_KEY_ID --body "AKIAXXXXXXXX"
gh secret set SERVICE_AWS_SECRET_ACCESS_KEY --body "XXXXXXXX"
```

### 12.6.2 GitHub Actions Workflow動作確認

**手動トリガーテスト**:
1. GitHub Actions タブを開く
2. `Application Deploy` ワークフローを選択
3. `Run workflow` ボタンをクリック
4. main ブランチを選択して実行

---

## 12.7 検証項目

### 12.7.1 機能検証

| 項目 | 検証方法 | 期待結果 |
|------|---------|---------|
| Public Web アクセス | curl http://${ALB_DNS}/api/users | 200 OK |
| Admin アクセス | VPN接続後、curl http://${TASK_IP}:3000 | 200 OK |
| RDS 接続 | ECS Task 内から psql 接続 | 接続成功 |
| Transit Gateway 通信 | VPN → Service VPC ping | 疎通成功 |
| CloudWatch Logs | CloudWatch Logs Console確認 | ログ出力確認 |

### 12.7.2 非機能検証

| 項目 | 検証方法 | 期待結果 |
|------|---------|---------|
| RDS Failover | 手動Failover実行 | 1-2分で復旧 |
| ECS Auto Healing | Task強制停止 | 1-2分で新Task起動 |
| CloudWatch Alarms | メトリクス閾値超過 | SNS通知受信 |

---

## 12.8 ロールバック手順

### 12.8.1 アプリケーションロールバック

```bash
# 前バージョンのTask Definition取得
aws ecs describe-task-definition \
  --task-definition sample-app-public:前バージョン \
  --region ap-northeast-1 \
  --profile service

# ロールバック
aws ecs update-service \
  --cluster sample-app-cluster \
  --service public-web-service \
  --task-definition sample-app-public:前バージョン \
  --region ap-northeast-1 \
  --profile service
```

### 12.8.2 インフラロールバック

```bash
# CloudFormation Stack削除
aws cloudformation delete-stack \
  --stack-name sample-app-dev-compute \
  --region ap-northeast-1 \
  --profile service

# または Change Set キャンセル
aws cloudformation cancel-update-stack \
  --stack-name sample-app-dev-compute \
  --region ap-northeast-1 \
  --profile service
```

---

## 12.9 削除手順

### 12.9.1 削除順序

**逆順で削除**:
1. ECS Service → ECS Task停止
2. Monitoring Stack削除
3. Compute Stack削除
4. Database Stack削除（⚠️ DeletionPolicy: Retain設定確認）
5. Network Stack削除
6. Platform Stack削除

### 12.9.2 削除コマンド

```bash
# Service Account Stacks削除
for stack in sample-app-dev-monitoring sample-app-dev-compute sample-app-dev-database sample-app-dev-network; do
  aws cloudformation delete-stack \
    --stack-name ${stack} \
    --region ap-northeast-1 \
    --profile service

  aws cloudformation wait stack-delete-complete \
    --stack-name ${stack} \
    --region ap-northeast-1 \
    --profile service
done

# Platform Account Stack削除
aws cloudformation delete-stack \
  --stack-name sample-app-platform \
  --region ap-northeast-1 \
  --profile platform
```

---

## 12.10 トラブルシューティング

### 12.10.1 よくある問題

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| CloudFormation CREATE_FAILED | パラメータ不正 | パラメータファイル確認 |
| ECS Task 起動失敗 | Secrets Manager参照エラー | IAM Role権限確認 |
| RDS 接続失敗 | Security Group設定 | Ingress Rule確認 |
| Transit Gateway 通信不可 | Route Table設定 | ルーティング確認 |

---

## 12.11 次フェーズへの引き継ぎ

### 12.11.1 詳細設計フェーズで実施すべき事項

- CloudFormation テンプレート詳細仕様作成
- ECS Task Definition 詳細設計
- RDS Parameter Group 詳細設計
- GitHub Actions Workflow 詳細実装

### 12.11.2 実装フェーズで作成すべき成果物

- CloudFormation テンプレート一式
- アプリケーションコード
- Dockerfile
- GitHub Actions Workflow YAML
- デプロイ手順書
- 運用手順書

---

**基本設計書完了**

本書で定義した設計をもとに、詳細設計・実装フェーズへ進んでください。

[← 目次に戻る](00_目次.md)
