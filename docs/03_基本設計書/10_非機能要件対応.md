# 10. 非機能要件対応

[← 前へ: 09_CICD設計](09_CICD設計.md) | [目次](00_目次.md) | [次へ: 11_コスト設計 →](11_コスト設計.md)

---

## 10.1 可用性

### 10.1.1 可用性目標

| 項目 | 目標 | 実装方法 |
|------|------|---------|
| **システム全体** | 99.9%（月間43分ダウンタイム許容） | Multi-AZ、Auto Healing |
| **計画停止** | 月1回、30分以内 | メンテナンスウィンドウ設定 |
| **障害復旧時間（RTO）** | 5分以内 | RDS Failover、ECS Auto Healing |
| **データ損失（RPO）** | 0秒 | RDS Multi-AZ同期レプリケーション |

### 10.1.2 Multi-AZ構成

| コンポーネント | AZ構成 | 障害時の動作 |
|-------------|--------|------------|
| **NAT Gateway** | Multi-AZ（1a, 1c） | 正常AZのみ使用、Private Subnet通信継続 |
| **RDS** | Multi-AZ（Primary: 1a, Standby: 1c） | 自動フェイルオーバー（1-2分） |
| **ECS Task** | Multi-AZ（1a, 1c） | 異常Task停止、新Task自動起動 |
| **ALB** | Multi-AZ（1a, 1c） | 正常AZのみトラフィック振り分け |

### 10.1.3 障害シミュレーション

| シナリオ | 影響範囲 | 復旧時間 | 検証方法 |
|---------|---------|---------|---------|
| ECS Task異常終了 | 該当Task | 1-2分 | Task強制停止 |
| RDS Primary障害 | DB接続一時断 | 1-2分 | RDS Failover実行 |
| AZ-1a障害 | AZ-1a配置リソース | 1-5分 | AZ障害シミュレーション（検証環境のみ） |

---

## 10.2 性能

### 10.2.1 性能目標

| 項目 | 目標値 | 測定方法 |
|------|--------|---------|
| **API Response Time（P95）** | < 500ms | CloudWatch Logs Insights |
| **API Response Time（P99）** | < 1秒 | CloudWatch Logs Insights |
| **DB Query Time（P95）** | < 100ms | RDS Performance Insights |
| **スループット** | 100 req/sec | 負荷試験（将来実施） |
| **同時接続数** | 100 concurrent users | 負荷試験（将来実施） |

### 10.2.2 パフォーマンスチューニング

#### ECS Task

| 項目 | 現状 | 最適化案 |
|------|------|---------|
| vCPU | 0.5 | 負荷状況に応じて1.0に増強 |
| Memory | 1GB | 負荷状況に応じて2GBに増強 |
| Task数 | 2 | Auto Scaling設定（2-4） |

#### RDS

| 項目 | 現状 | 最適化案 |
|------|------|---------|
| Instance Class | db.t3.medium | r6g.large（CPU安定化） |
| max_connections | 200 | 接続数監視し調整 |
| shared_buffers | 1GB | 2GB（メモリ増強時） |

#### Database Index

```sql
-- 頻繁に検索されるカラムにインデックス
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_stats_metric_name ON stats(metric_name);
CREATE INDEX idx_stats_recorded_at ON stats(recorded_at);
```

### 10.2.3 負荷試験計画（将来実施）

**ツール**: Apache JMeter, Gatling

**シナリオ**:
| シナリオ | 内容 | 目標 |
|---------|------|------|
| 通常負荷 | 50 req/sec, 10分間 | Response Time < 300ms |
| ピーク負荷 | 100 req/sec, 5分間 | Response Time < 500ms |
| 耐久試験 | 30 req/sec, 1時間 | メモリリーク確認 |
| スパイク試験 | 0 → 200 req/sec瞬時 | エラー率 < 1% |

---

## 10.3 セキュリティ

### 10.3.1 セキュリティ要件

| 要件 | 対応内容 | 実装状況 |
|------|---------|---------|
| **データ暗号化（保存時）** | RDS暗号化（KMS） | ✅ 実装済み |
| **データ暗号化（転送時）** | TLS 1.3（将来） | ⚠️ POC範囲外 |
| **認証・認可** | VPN経由アクセス制御 | ✅ 実装済み |
| **最小権限の原則** | IAM Role細粒度設定 | ✅ 実装済み |
| **シークレット管理** | Secrets Manager | ✅ 実装済み |
| **監査ログ** | CloudTrail | ✅ 実装済み |
| **脆弱性スキャン** | ECR Image Scanning | ⚠️ POC範囲外 |
| **WAF** | AWS WAF | ❌ POC範囲外 |

### 10.3.2 セキュリティ強化施策（本番化時）

| 施策 | 優先度 | 実装方法 |
|------|--------|---------|
| **WAF導入** | 高 | AWS WAF、SQLインジェクション対策 |
| **GuardDuty有効化** | 高 | 脅威検知、異常アクセス監視 |
| **TLS通信** | 中 | ALB HTTPS、RDS TLS接続 |
| **認証強化** | 中 | JWT Token、OAuth 2.0 |
| **ネットワークACL** | 低 | カスタムNACL設定 |

---

## 10.4 保守性

### 10.4.1 保守性向上施策

| 施策 | 実装内容 | メリット |
|------|---------|---------|
| **Infrastructure as Code** | CloudFormation | 再現性、バージョン管理 |
| **コンテナ化** | Docker | 環境差分排除 |
| **構造化ログ** | JSON形式、CloudWatch Logs | 検索・分析容易 |
| **モニタリング** | CloudWatch Dashboard | 一元可視化 |
| **ドキュメント化** | 設計書、手順書完備 | 属人化防止 |

### 10.4.2 運用負荷軽減

| 項目 | 自動化内容 |
|------|----------|
| **デプロイ** | GitHub Actions自動デプロイ |
| **バックアップ** | RDS自動バックアップ |
| **監視** | CloudWatch Alarms自動通知 |
| **ログ** | CloudWatch Logs自動収集 |
| **スケーリング** | ECS Auto Scaling（将来） |

---

## 10.5 拡張性

### 10.5.1 スケーラビリティ

**垂直スケーリング（Vertical Scaling）**:
| リソース | 現状 | 拡張上限 | 変更方法 |
|---------|------|---------|---------|
| ECS vCPU/Memory | 0.5/1GB | 16 vCPU/120GB | Task Definition更新 |
| RDS Instance | db.t3.medium | db.r6g.16xlarge | CloudFormation更新 |

**水平スケーリング（Horizontal Scaling）**:
| リソース | 現状 | 拡張方法 |
|---------|------|---------|
| ECS Task | 2固定 | Auto Scaling Policy追加 |
| RDS Read Replica | 0 | Read Replica作成 |

### 10.5.2 将来拡張シナリオ

| シナリオ | 実装方法 | 難易度 |
|---------|---------|--------|
| **新サービス追加** | ECS Task Definition追加 | 低 |
| **新拠点接続** | Transit Gateway Attachment追加 | 中 |
| **マルチリージョン** | Route 53、Aurora Global Database | 高 |
| **Read Replica追加** | RDS Read Replica作成 | 中 |

---

## 10.6 運用性

### 10.6.1 運用要件

| 要件 | 対応内容 |
|------|---------|
| **監視** | CloudWatch Dashboard、Alarms |
| **ログ管理** | CloudWatch Logs（7日保持） |
| **バックアップ** | RDS自動バックアップ（7日保持） |
| **障害復旧** | RDS Failover、ECS Auto Healing |
| **変更管理** | CloudFormation Change Sets |
| **デプロイ** | GitHub Actions自動デプロイ |

### 10.6.2 運用コスト削減

| 施策 | 削減効果 |
|------|---------|
| **Fargate使用** | EC2管理不要、Auto Scaling |
| **RDS Multi-AZ** | 自動バックアップ、Failover |
| **CloudWatch統合監視** | 監視ツール集約 |
| **Infrastructure as Code** | 手動作業削減 |

---

## 10.7 移植性

### 10.7.1 クラウドベンダー依存度

| コンポーネント | AWS依存度 | 移植難易度 | 代替サービス例 |
|-------------|----------|----------|--------------|
| **ECS Fargate** | 高 | 高 | GKE, AKS |
| **RDS PostgreSQL** | 中 | 中 | Cloud SQL, Azure Database |
| **CloudWatch** | 高 | 高 | Datadog, Prometheus |
| **Secrets Manager** | 高 | 中 | HashiCorp Vault |

**設計判断**:
- POC範囲ではAWSネイティブサービス優先
- 本番化時にマルチクラウド戦略検討

---

## 10.8 テスタビリティ

### 10.8.1 テスト環境

| 環境 | 用途 | 構成 |
|------|------|------|
| **ローカル** | 開発者PC | Docker Compose |
| **dev** | 開発環境 | AWS本番同等構成（スペック低） |
| **staging** | ステージング環境（将来） | AWS本番同等構成 |
| **prod** | 本番環境（将来） | 本設計書構成 |

### 10.8.2 テスト種別

| テスト種別 | 実施環境 | 自動化 |
|----------|---------|--------|
| **ユニットテスト** | ローカル、CI | Jest（将来） |
| **統合テスト** | ローカル、CI | Supertest（将来） |
| **E2Eテスト** | dev、staging | Playwright（将来） |
| **負荷試験** | staging | JMeter（将来） |
| **障害試験** | staging | Chaos Engineering（将来） |

---

## 10.9 コンプライアンス

### 10.9.1 データ保護

| 項目 | 対応内容 |
|------|---------|
| **個人情報保護** | POC範囲では本番データ未使用 |
| **データ暗号化** | RDS暗号化、Secrets Manager |
| **アクセスログ** | CloudTrail、VPC Flow Logs |
| **データ保持期間** | ログ7日、バックアップ7日 |

### 10.9.2 セキュリティ標準

| 標準 | 対応状況 |
|------|---------|
| **CIS Benchmarks** | 部分的対応（POC範囲） |
| **OWASP Top 10** | SQL Injection対策（Prepared Statement） |
| **AWS Well-Architected** | セキュリティの柱に準拠 |

---

**次へ**: [11_コスト設計](11_コスト設計.md)
