# 03. インフラ設計

> AWS Multi-Account Sample Application - 基本設計書

[← 前へ: アーキテクチャ設計](02_アーキテクチャ設計.md) | [目次に戻る](00_目次.md) | [次へ: アプリケーション設計 →](04_アプリケーション設計.md)

---

## 1. 全体構成図

```
┌──────────────────────────────────────────────────────────────────┐
│                         AWS Cloud                                │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────── Platform Account ─────────────┐ │
│  │                                                              │ │
│  │  Shared VPC (10.0.0.0/16)                                   │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │ Public Subnet (AZ-1a, 1c)                            │  │ │
│  │  │  - NAT Gateway x2                                    │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │ Private Subnet (AZ-1a, 1c)                           │  │ │
│  │  │  - Client VPN Endpoint                               │  │ │
│  │  │  - Transit Gateway Attachment                        │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │                                                              │ │
│  │  Transit Gateway (Hub)                                      │ │
│  │  - RAM共有でService Accountに共有                           │ │
│  └──────────────────┬───────────────────────────────────────────┘ │
│                     │                                             │
│  ┌─────────────────┴────────────── Service Account ──────────┐  │
│  │                                                             │  │
│  │  Service VPC (10.1.0.0/16)                                 │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ Public Subnet (AZ-1a, 1c)                           │  │  │
│  │  │  - ALB (Public Web)                                 │  │  │
│  │  │  - ALB (Admin)                                      │  │  │
│  │  │  - NAT Gateway x2                                   │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ Private Subnet (AZ-1a, 1c)                          │  │  │
│  │  │  - ECS Fargate (Public/Admin/Batch)                 │  │  │
│  │  │  - RDS PostgreSQL (Multi-AZ)                        │  │  │
│  │  │  - Transit Gateway Attachment                       │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                             │  │
│  │  CloudWatch (統合監視)                                      │  │
│  │  - Alarms (CPU, Memory, RDS, ALB)                          │  │
│  │  - Dashboard (全リソース可視化)                             │  │
│  │  - SNS Topics (Critical/Warning)                           │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

External:
- Internet → Public Web (ALB Public)
- VPN Client → Client VPN → Transit Gateway → Service VPC → Admin ALB
```

---

## 2. ネットワーク設計

### 2.1 VPC CIDR割り当て

| VPC | CIDR | Account | 用途 |
|-----|------|---------|------|
| Shared VPC | 10.0.0.0/16 | Platform | 共通ネットワーク基盤 |
| Service VPC | 10.1.0.0/16 | Service | アプリケーション基盤 |
| Client VPN | 172.16.0.0/22 | Platform | VPNクライアント用 |

### 2.2 Subnet構成 (Platform Account - Shared VPC)

| Subnet | CIDR | AZ | 種別 | 用途 |
|--------|------|----|----|------|
| Public Subnet 1a | 10.0.1.0/24 | ap-northeast-1a | Public | NAT Gateway |
| Public Subnet 1c | 10.0.2.0/24 | ap-northeast-1c | Public | NAT Gateway |
| Private Subnet 1a | 10.0.11.0/24 | ap-northeast-1a | Private | Transit Gateway, Client VPN |
| Private Subnet 1c | 10.0.12.0/24 | ap-northeast-1c | Private | Transit Gateway, Client VPN |

### 2.3 Subnet構成 (Service Account - Service VPC)

| Subnet | CIDR | AZ | 種別 | 用途 |
|--------|------|----|----|------|
| Public Subnet 1a | 10.1.1.0/24 | ap-northeast-1a | Public | ALB, NAT Gateway |
| Public Subnet 1c | 10.1.2.0/24 | ap-northeast-1c | Public | ALB, NAT Gateway |
| Private Subnet 1a | 10.1.11.0/24 | ap-northeast-1a | Private | ECS, RDS, Transit Gateway |
| Private Subnet 1c | 10.1.12.0/24 | ap-northeast-1c | Private | ECS, RDS, Transit Gateway |

### 2.4 ルーティング設計

| Source | Destination | Next Hop |
|--------|-------------|----------|
| Platform VPC Private Subnet | 10.1.0.0/16 | Transit Gateway |
| Platform VPC Private Subnet | 0.0.0.0/0 | NAT Gateway |
| Service VPC Private Subnet | 10.0.0.0/16 | Transit Gateway |
| Service VPC Private Subnet | 0.0.0.0/0 | NAT Gateway |
| Client VPN | 10.0.0.0/16 | Local (Shared VPC) |
| Client VPN | 10.1.0.0/16 | Transit Gateway |

---

## 3. コンポーネント配置図

### 3.1 Platform Account

```
Shared VPC (10.0.0.0/16)
├── Public Subnet (AZ-1a)
│   └── NAT Gateway 1a
├── Public Subnet (AZ-1c)
│   └── NAT Gateway 1c
├── Private Subnet (AZ-1a)
│   ├── Client VPN Endpoint (Target Network Association)
│   └── Transit Gateway Attachment
└── Private Subnet (AZ-1c)
    ├── Client VPN Endpoint (Target Network Association)
    └── Transit Gateway Attachment

Transit Gateway
├── Route Table (Platform)
│   └── Route: 10.1.0.0/16 → Service VPC Attachment
└── Route Table (Service)
    └── Route: 10.0.0.0/16 → Platform VPC Attachment

Client VPN Endpoint
├── Authorization Rule: 10.0.0.0/16 (Shared VPC)
├── Authorization Rule: 10.1.0.0/16 (Service VPC via TGW)
└── Route: 10.1.0.0/16 → Transit Gateway
```

### 3.2 Service Account

```
Service VPC (10.1.0.0/16)
├── Public Subnet (AZ-1a)
│   ├── ALB (Public Web)
│   ├── ALB (Admin)
│   └── NAT Gateway 1a
├── Public Subnet (AZ-1c)
│   ├── ALB (Public Web) - Multi-AZ
│   ├── ALB (Admin) - Multi-AZ
│   └── NAT Gateway 1c
├── Private Subnet (AZ-1a)
│   ├── ECS Fargate (Public Web) x N
│   ├── ECS Fargate (Admin) x N
│   ├── ECS Fargate (Batch) - Scheduled
│   ├── RDS PostgreSQL (Primary)
│   └── Transit Gateway Attachment
└── Private Subnet (AZ-1c)
    ├── ECS Fargate (Public Web) x N
    ├── ECS Fargate (Admin) x N
    ├── RDS PostgreSQL (Standby - Multi-AZ)
    └── Transit Gateway Attachment

CloudWatch
├── Alarms
│   ├── ECS CPU/Memory (Public/Admin/Batch)
│   ├── RDS CPU/Connections/Storage
│   └── ALB TargetHealth/5xxErrors/ResponseTime
├── Dashboard
│   └── Integrated View (ECS/RDS/ALB)
└── SNS Topics
    ├── CriticalAlerts
    └── WarningAlerts
```

---

## 4. セキュリティグループ設計

| SecurityGroup | Ingress | Egress | 用途 |
|--------------|---------|--------|------|
| ALB Public | 0.0.0.0/0:443 | All | Public Web用 |
| ALB Admin | 10.0.0.0/16:443 | All | Admin用（VPN経由のみ） |
| ECS Public | ALB Public SG:8080 | All | Public Web ECS |
| ECS Admin | ALB Admin SG:8080 | All | Admin ECS |
| RDS | ECS SG:5432 | - | PostgreSQL |
| Client VPN | 172.16.0.0/22:All | All | VPN Endpoint |

---

## 5. コンピューティング設計

### 5.1 ECS Fargate設計

| サービス | CPU | Memory | Desired Count | Auto Scaling |
|---------|-----|--------|--------------|-------------|
| Public Web | 512 (0.5 vCPU) | 1024 MB | 2 | CPU 70%でスケール（Max 10） |
| Admin | 512 (0.5 vCPU) | 1024 MB | 2 | CPU 70%でスケール（Max 5） |
| Batch | 512 (0.5 vCPU) | 1024 MB | 0（Scheduled） | - |

**選定理由:**
- サーバーレス（EC2管理不要）
- Auto Scaling容易
- 検証用のため最小構成（0.5 vCPU）

---

## 6. ストレージ設計

### 6.1 RDS PostgreSQL

| 項目 | 設定値 | 理由 |
|------|--------|------|
| Instance Class | db.t3.medium | 検証用、コスト重視 |
| Allocated Storage | 100 GB | 検証用データ量（10万レコード想定） |
| Max Allocated Storage | 200 GB | Auto Scaling対応 |
| Storage Type | gp3 | 最新、コスト効率良 |
| Multi-AZ | 有効 | 高可用性確保 |
| Backup Retention | 7日間 | 標準的な設定 |

### 6.2 S3

| 用途 | バケット名 | ストレージクラス | ライフサイクル |
|------|-----------|----------------|--------------|
| ALBログ | `${ProjectName}-${Environment}-alb-logs` | Standard | 90日後削除 |
| CloudFormationテンプレート | `${ProjectName}-cfn-templates` | Standard | 無期限 |

---

## 7. CloudFormation規約準拠確認

**参照標準**: `.claude/docs/40_standards/45_cloudformation.md`

**チェックリスト:**

### 7.1 必須要件準拠

- [x] Change Sets必須 → デプロイスクリプトで実装
- [x] スタック分割 → Platform/Service、Network/Database/Compute/Monitoring
- [x] パラメータ駆動 → Environment、ProjectName、VpcCidr等
- [x] Outputs/Export → VPC ID、Subnet IDs等
- [x] ファイル分割方針 → 詳細設計書で明記予定
- [x] Well-Architected Framework → セキュリティ、信頼性、パフォーマンス対応

### 7.2 命名規則準拠

| リソース種別 | 命名規則 | 実装例 |
|-----------|---------|--------|
| スタック名 | `${ProjectName}-${Environment}-${Component}` | `sample-app-dev-network` |
| VPC | `${ProjectName}-${Environment}-vpc` | `sample-app-dev-vpc` |
| Subnet | `${ProjectName}-${Environment}-${Type}-subnet-${AZ}` | `sample-app-dev-public-subnet-1a` |
| SecurityGroup | `${ProjectName}-${Environment}-${Service}-sg` | `sample-app-dev-alb-sg` |
| ECS Cluster | `${ProjectName}-${Environment}` | `sample-app-dev` |
| RDS Instance | `${ProjectName}-${Environment}-db` | `sample-app-dev-db` |

### 7.3 タグ戦略準拠

すべてのリソースに以下のタグを付与：

| タグキー | 値 | 用途 |
|---------|-----|------|
| Project | sample-app | プロジェクト識別 |
| Environment | dev/staging/prod | 環境識別 |
| ManagedBy | CloudFormation | 管理方法 |
| CostCenter | tech-poc | コスト配賦 |

### 7.4 インフラ設計標準準拠

**参照標準**: `.claude/docs/40_standards/46_infrastructure.md`

- [x] Multi-AZ構成 → RDS Multi-AZ、ALB複数AZ配置
- [x] NAT Gateway冗長化 → 各AZに1つずつ配置
- [x] セキュリティグループ最小権限 → 必要なポートのみ開放
- [x] プライベートサブネット配置 → ECS、RDSはPrivate Subnet
- [x] Transit Gateway共有 → RAM経由でクロスアカウント共有

---

## 8. 次のステップ

インフラ設計を理解したら、次はアプリケーション設計（データベース、API）を確認します。

**次のドキュメント**: [04_アプリケーション設計.md](04_アプリケーション設計.md)

---

**ドキュメントナビゲーション**:
- [← 前へ: アーキテクチャ設計](02_アーキテクチャ設計.md)
- [目次に戻る](00_目次.md)
- [次へ: アプリケーション設計 →](04_アプリケーション設計.md)
