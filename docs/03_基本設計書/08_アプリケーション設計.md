# 08. アプリケーション設計

[← 前へ: 07_監視・運用設計](07_監視・運用設計.md) | [目次](00_目次.md) | [次へ: 09_CICD設計 →](09_CICD設計.md)

---

## 8.1 アプリケーション構成

### 8.1.1 モノレポ構成

```
sample-app/
├── app/
│   ├── public/               # Public Webサービス
│   │   ├── src/
│   │   │   ├── app.js       # Expressアプリケーション
│   │   │   ├── routes/      # APIルート定義
│   │   │   └── db.js        # DB接続
│   │   ├── Dockerfile
│   │   └── package.json
│   ├── admin/                # Admin Dashboardサービス
│   │   ├── src/
│   │   │   ├── app.js
│   │   │   ├── routes/
│   │   │   └── db.js
│   │   ├── Dockerfile
│   │   └── package.json
│   ├── batch/                # Batch Processingサービス
│   │   ├── src/
│   │   │   ├── index.js     # Batchメイン処理
│   │   │   ├── tasks/       # 各種バッチタスク
│   │   │   └── db.js
│   │   ├── Dockerfile
│   │   └── package.json
│   └── shared/               # 共通ライブラリ
│       ├── db.js             # DB接続共通モジュール
│       ├── logger.js         # ロギング共通モジュール
│       └── package.json
├── infra/                    # CloudFormationテンプレート
├── .github/workflows/        # GitHub Actions
└── package.json              # ルートパッケージ（workspaces）
```

### 8.1.2 技術スタック

| レイヤー | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| Runtime | Node.js | 20 LTS | JavaScriptランタイム |
| Framework | Express.js | 4.x | Webフレームワーク |
| Database Client | pg (node-postgres) | 8.x | PostgreSQL接続 |
| Logger | Winston | 3.x | 構造化ログ |
| Test | Jest | 29.x | ユニットテスト（将来） |
| Lint | ESLint | 8.x | コード品質（将来） |

---

## 8.2 Public Web Service設計

### 8.2.1 API仕様

#### GET /health

**用途**: ヘルスチェックエンドポイント（ALB, ECS Service）

**レスポンス**:
```json
{
  "status": "healthy",
  "timestamp": "2025-10-24T12:34:56.789Z",
  "database": "connected",
  "uptime": 3600
}
```

**Status Code**:
- `200 OK`: 正常
- `503 Service Unavailable`: DB接続不可

#### GET /api/users

**用途**: ユーザー一覧取得

**レスポンス**:
```json
{
  "users": [
    {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "created_at": "2025-10-24T00:00:00.000Z"
    }
  ],
  "count": 1
}
```

**Status Code**:
- `200 OK`: 成功
- `500 Internal Server Error`: DBエラー

#### POST /api/users

**用途**: ユーザー作成

**Request Body**:
```json
{
  "username": "newuser",
  "email": "newuser@example.com"
}
```

**Response**:
```json
{
  "id": 2,
  "username": "newuser",
  "email": "newuser@example.com",
  "created_at": "2025-10-24T12:34:56.789Z"
}
```

**Status Code**:
- `201 Created`: 成功
- `400 Bad Request`: バリデーションエラー
- `409 Conflict`: ユーザー名/メール重複
- `500 Internal Server Error`: DBエラー

#### GET /api/stats

**用途**: 統計情報取得

**Response**:
```json
{
  "stats": [
    {
      "metric_name": "daily_active_users",
      "metric_value": 150,
      "recorded_at": "2025-10-24T00:00:00.000Z"
    }
  ],
  "count": 1
}
```

### 8.2.2 エラーハンドリング

**エラーレスポンス形式**:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Username is required",
    "details": {
      "field": "username"
    }
  }
}
```

**エラーコード一覧**:
| Code | HTTP Status | 説明 |
|------|------------|------|
| VALIDATION_ERROR | 400 | リクエストバリデーションエラー |
| NOT_FOUND | 404 | リソース未存在 |
| CONFLICT | 409 | データ重複 |
| DATABASE_ERROR | 500 | DB接続・クエリエラー |
| INTERNAL_ERROR | 500 | その他の内部エラー |

---

## 8.3 Admin Dashboard Service設計

### 8.3.1 API仕様

#### GET /admin/users

**用途**: 管理者用ユーザー一覧（詳細情報含む）

**Response**:
```json
{
  "users": [
    {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "created_at": "2025-10-24T00:00:00.000Z",
      "updated_at": "2025-10-24T00:00:00.000Z",
      "last_login": "2025-10-24T12:00:00.000Z"
    }
  ],
  "total": 1,
  "page": 1
}
```

#### DELETE /admin/users/:id

**用途**: ユーザー削除（管理者のみ）

**Response**:
```json
{
  "message": "User deleted successfully",
  "deleted_user_id": 5
}
```

**Status Code**:
- `200 OK`: 成功
- `404 Not Found`: ユーザー未存在
- `500 Internal Server Error`: DBエラー

#### GET /admin/stats/summary

**用途**: システム統計サマリー

**Response**:
```json
{
  "summary": {
    "total_users": 150,
    "active_users_today": 45,
    "total_requests_today": 5000,
    "avg_response_time": 250
  },
  "timestamp": "2025-10-24T12:34:56.789Z"
}
```

### 8.3.2 アクセス制御

**設計方針**:
- VPN経由のみアクセス可能（Security Group制御）
- POC範囲では Basic Auth 未実装
- 本番環境では認証実装必須

---

## 8.4 Batch Processing Service設計

### 8.4.1 バッチタスク一覧

| タスク名 | 処理内容 | スケジュール | 実行時間 |
|---------|---------|------------|---------|
| daily-stats | 日次統計集計 | cron(0 18 * * ? *) | 〜5分 |
| data-cleanup | 古いデータ削除 | cron(0 19 ? * SUN *) | 〜10分 |

### 8.4.2 daily-stats バッチ処理

**処理フロー**:
```
1. 前日分のユーザーアクセスログ集計
2. 統計テーブルに挿入
3. CloudWatch Logsに処理結果出力
```

**実装例**:
```javascript
// src/tasks/daily-stats.js
async function runDailyStats() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);

  // ユーザー数集計
  const userCount = await db.query(
    'SELECT COUNT(*) FROM users WHERE created_at::date = $1',
    [yesterday.toISOString().split('T')[0]]
  );

  // 統計テーブルに保存
  await db.query(
    'INSERT INTO stats (metric_name, metric_value) VALUES ($1, $2)',
    ['daily_new_users', userCount.rows[0].count]
  );

  console.log('Daily stats completed:', { date: yesterday, count: userCount.rows[0].count });
}
```

### 8.4.3 data-cleanup バッチ処理

**処理内容**:
- 90日以前のstatsテーブルデータを削除

**実装例**:
```javascript
// src/tasks/data-cleanup.js
async function runDataCleanup() {
  const result = await db.query(
    'DELETE FROM stats WHERE recorded_at < NOW() - INTERVAL \'90 days\' RETURNING id'
  );

  console.log('Data cleanup completed:', { deleted_count: result.rowCount });
}
```

---

## 8.5 共通ライブラリ設計

### 8.5.1 DB接続モジュール（shared/db.js）

**機能**:
- Connection Pool管理
- Secrets Manager からの認証情報取得
- エラーハンドリング

**実装例**:
```javascript
const { Pool } = require('pg');

const pool = new Pool({
  host: process.env.DB_HOST,
  port: process.env.DB_PORT || 5432,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

pool.on('error', (err) => {
  console.error('Unexpected DB error:', err);
});

module.exports = {
  query: (text, params) => pool.query(text, params),
  pool,
};
```

### 8.5.2 ロギングモジュール（shared/logger.js）

**機能**:
- JSON構造化ログ
- ログレベル管理（ERROR, WARN, INFO, DEBUG）
- CloudWatch Logs連携

**実装例**:
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  defaultMeta: { service: process.env.SERVICE_NAME || 'unknown' },
  transports: [
    new winston.transports.Console()
  ],
});

module.exports = logger;
```

**使用例**:
```javascript
const logger = require('./shared/logger');

logger.info('User created', { userId: 123, username: 'newuser' });
logger.error('Database connection failed', { error: err.message });
```

---

## 8.6 Docker設計

### 8.6.1 Dockerfile（Public Web例）

```dockerfile
FROM node:20-alpine

WORKDIR /app

# 依存関係インストール
COPY package*.json ./
RUN npm ci --only=production

# アプリケーションコピー
COPY src/ ./src/

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); });"

# 非rootユーザーで実行
USER node

EXPOSE 3000

CMD ["node", "src/app.js"]
```

### 8.6.2 .dockerignore

```
node_modules
npm-debug.log
.git
.gitignore
README.md
.env
*.test.js
coverage/
```

---

## 8.7 環境変数設計

### 8.7.1 環境変数一覧

| 変数名 | 取得元 | 必須 | 例 |
|-------|-------|------|-----|
| NODE_ENV | ECS Task Definition | ✅ | production |
| PORT | ECS Task Definition | ✅ | 3000 |
| SERVICE_NAME | ECS Task Definition | ✅ | public-web |
| LOG_LEVEL | ECS Task Definition | ❌ | info |
| DB_HOST | Secrets Manager | ✅ | sample-app-db.xxxxx.rds |
| DB_PORT | Secrets Manager | ✅ | 5432 |
| DB_NAME | Secrets Manager | ✅ | sampledb |
| DB_USER | Secrets Manager | ✅ | app_user |
| DB_PASSWORD | Secrets Manager | ✅ | [Secrets Manager] |

---

## 8.8 パフォーマンス最適化

### 8.8.1 Connection Pool最適化

| 設定項目 | 値 | 理由 |
|---------|-----|------|
| max | 20 | Task数×Pool Size < RDS max_connections |
| idleTimeoutMillis | 30000 | アイドル接続を30秒で解放 |
| connectionTimeoutMillis | 2000 | 接続タイムアウト2秒 |

### 8.8.2 クエリ最適化

**インデックス活用**:
```sql
-- usersテーブル
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);

-- statsテーブル
CREATE INDEX idx_stats_metric_name ON stats(metric_name);
CREATE INDEX idx_stats_recorded_at ON stats(recorded_at);
```

**Prepared Statement使用**:
```javascript
// ✅ Good (Prepared Statement)
const result = await db.query('SELECT * FROM users WHERE email = $1', [email]);

// ❌ Bad (SQL Injection Risk)
const result = await db.query(`SELECT * FROM users WHERE email = '${email}'`);
```

---

**次へ**: [09_CICD設計](09_CICD設計.md)
