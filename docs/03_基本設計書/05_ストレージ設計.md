# 05. ストレージ設計

[← 前へ: 04_コンピュート設計](04_コンピュート設計.md) | [目次](00_目次.md) | [次へ: 06_セキュリティ設計 →](06_セキュリティ設計.md)

---

## 5.1 RDS PostgreSQL設計

### 5.1.1 RDS基本構成

| 項目 | 設定値 | 説明 |
|------|--------|------|
| **Engine** | PostgreSQL | 16.x |
| **Instance Class** | db.t3.medium | 2 vCPU, 4 GB RAM（POC用） |
| **Multi-AZ** | Enabled | 高可用性、自動フェイルオーバー |
| **Storage Type** | General Purpose SSD (gp3) | コスト効率的 |
| **Allocated Storage** | 100 GB | 初期容量 |
| **Max Allocated Storage** | 200 GB | Auto Scaling上限 |
| **IOPS** | 3000 | gp3デフォルト |
| **Throughput** | 125 MB/s | gp3デフォルト |
| **DB Subnet Group** | sample-app-db-subnet-group | Database-1a, Database-1c |
| **Security Group** | rds-sg | ECS、VPNからのアクセス許可 |
| **Publicly Accessible** | false | Private Subnetのみ |
| **DB Name** | sampledb | アプリケーションDB |
| **Master Username** | postgres | 管理者ユーザー |
| **Master Password** | Secrets Manager | 自動生成、自動ローテーション |
| **Port** | 5432 | PostgreSQLデフォルト |

### 5.1.2 バックアップ設定

| 項目 | 設定値 |
|------|--------|
| **Automated Backup** | Enabled |
| **Backup Retention Period** | 7日間 |
| **Backup Window** | 17:00-18:00 UTC（JST 02:00-03:00） |
| **Copy Tags to Snapshots** | true |
| **Delete Automated Backups** | true（インスタンス削除時） |

**設計判断**:
- 7日間保持: POC範囲、本番では30日検討
- バックアップウィンドウ: 低トラフィック時間帯（深夜）

### 5.1.3 メンテナンス設定

| 項目 | 設定値 |
|------|--------|
| **Auto Minor Version Upgrade** | Enabled |
| **Maintenance Window** | sun:18:00-sun:19:00 UTC（JST 日曜03:00-04:00） |

**設計判断**:
- 日曜深夜: 利用者が少ない時間帯
- マイナーバージョン自動適用: セキュリティパッチ適用

### 5.1.4 パラメータグループ設定

**Custom Parameter Group**: `sample-app-pg16`

| パラメータ | デフォルト | 設定値 | 理由 |
|----------|----------|--------|------|
| **max_connections** | 100 | 200 | ECS Task増加に対応 |
| **shared_buffers** | {DBInstanceClassMemory/10922} | {DBInstanceClassMemory/4} | パフォーマンス向上 |
| **work_mem** | 4MB | 16MB | ソート・集計処理高速化 |
| **maintenance_work_mem** | 64MB | 256MB | VACUUM高速化 |
| **effective_cache_size** | {DBInstanceClassMemory*3/4} | {DBInstanceClassMemory*3/4} | デフォルト維持 |
| **log_statement** | none | all | 全SQL記録（開発用） |
| **log_min_duration_statement** | -1 | 1000 | 1秒以上のSlow Query記録 |

**本番環境への注意**:
- `log_statement = all` は本番では`ddl`または`mod`に変更（ログ量削減）

### 5.1.5 Multi-AZ構成

```
┌─────────────────────────────────────────────────────┐
│ ap-northeast-1a                                     │
│  ┌───────────────────────────────────────────────┐  │
│  │ Database Subnet (10.1.21.0/24)                │  │
│  │                                               │  │
│  │  ┌─────────────────────────────────────────┐  │  │
│  │  │ RDS Primary Instance                    │  │  │
│  │  │ - Read/Write                            │  │  │
│  │  │ - Endpoint: sample-app-db.xxxxx.rds     │  │  │
│  │  └─────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
                    ↓ (Synchronous Replication)
┌─────────────────────────────────────────────────────┐
│ ap-northeast-1c                                     │
│  ┌───────────────────────────────────────────────┐  │
│  │ Database Subnet (10.1.22.0/24)                │  │
│  │                                               │  │
│  │  ┌─────────────────────────────────────────┐  │  │
│  │  │ RDS Standby Instance                    │  │  │
│  │  │ - Read Only (Passive)                   │  │  │
│  │  │ - Auto Failover Target                  │  │  │
│  │  └─────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

**Failover動作**:
1. Primary障害検知（1-2分）
2. Standby → Primary昇格
3. DNSエンドポイント自動切り替え
4. アプリケーション再接続

**RPO/RTO目標**:
- **RPO**: 0秒（同期レプリケーション）
- **RTO**: 1-2分（自動フェイルオーバー）

---

## 5.2 データベーススキーマ設計

### 5.2.1 テーブル設計

#### users テーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | ユーザーID（自動採番） |
| username | VARCHAR(100) | NOT NULL, UNIQUE | ユーザー名 |
| email | VARCHAR(255) | NOT NULL, UNIQUE | メールアドレス |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 更新日時 |

**DDL**:
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(100) NOT NULL UNIQUE,
  email VARCHAR(255) NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
```

#### stats テーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | 統計ID（自動採番） |
| metric_name | VARCHAR(100) | NOT NULL | メトリクス名 |
| metric_value | NUMERIC | NOT NULL | メトリクス値 |
| recorded_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 記録日時 |

**DDL**:
```sql
CREATE TABLE stats (
  id SERIAL PRIMARY KEY,
  metric_name VARCHAR(100) NOT NULL,
  metric_value NUMERIC NOT NULL,
  recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_stats_metric_name ON stats(metric_name);
CREATE INDEX idx_stats_recorded_at ON stats(recorded_at);
```

### 5.2.2 初期データ投入

**サンプルデータ**:
```sql
INSERT INTO users (username, email) VALUES
  ('admin', 'admin@example.com'),
  ('user1', 'user1@example.com'),
  ('user2', 'user2@example.com');

INSERT INTO stats (metric_name, metric_value) VALUES
  ('daily_active_users', 150),
  ('total_requests', 10000),
  ('avg_response_time', 0.25);
```

---

## 5.3 Secrets Manager設計

### 5.3.1 シークレット構成

| シークレット名 | 用途 | ローテーション |
|-------------|------|-------------|
| sample-app/dev/db-master-password | RDS Masterパスワード | 手動 |
| sample-app/dev/db-app-credentials | アプリケーション用DB認証情報 | 30日自動 |

### 5.3.2 シークレット構造

**sample-app/dev/db-app-credentials**:
```json
{
  "username": "app_user",
  "password": "[自動生成32文字]",
  "engine": "postgres",
  "host": "sample-app-db.xxxxx.ap-northeast-1.rds.amazonaws.com",
  "port": 5432,
  "dbname": "sampledb"
}
```

### 5.3.3 アプリケーションからの取得

**ECS Task Definition（Secrets参照）**:
```json
{
  "secrets": [
    {
      "name": "DB_USER",
      "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/dev/db-app-credentials:username::"
    },
    {
      "name": "DB_PASSWORD",
      "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/dev/db-app-credentials:password::"
    }
  ]
}
```

---

## 5.4 Parameter Store設計

### 5.4.1 パラメータ一覧

| パラメータ名 | タイプ | 値 | 用途 |
|------------|-------|-----|------|
| /sample-app/dev/db-endpoint | String | sample-app-db.xxxxx.rds.amazonaws.com | RDSエンドポイント |
| /sample-app/dev/db-port | String | 5432 | RDSポート |
| /sample-app/dev/db-name | String | sampledb | データベース名 |
| /sample-app/dev/app-version | String | 1.0.0 | アプリケーションバージョン |

**設計判断**:
- 非機密情報のみParameter Store使用
- 機密情報（パスワード）はSecrets Manager使用

---

## 5.5 暗号化設計

### 5.5.1 RDS暗号化

| 項目 | 設定値 |
|------|--------|
| **Storage Encryption** | Enabled |
| **KMS Key** | AWS Managed Key（aws/rds） |
| **Encryption Algorithm** | AES-256 |

**暗号化対象**:
- DBインスタンスストレージ
- 自動バックアップ
- Read Replica（将来実装時）
- スナップショット

### 5.5.2 Secrets Manager暗号化

| 項目 | 設定値 |
|------|--------|
| **Encryption** | Enabled（デフォルト） |
| **KMS Key** | AWS Managed Key（aws/secretsmanager） |

---

## 5.6 接続管理設計

### 5.6.1 Connection Pooling

**Node.js (pg) Connection Pool設定**:
```javascript
const { Pool } = require('pg');

const pool = new Pool({
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  max: 20,                    // 最大接続数
  idleTimeoutMillis: 30000,   // アイドルタイムアウト
  connectionTimeoutMillis: 2000, // 接続タイムアウト
});
```

### 5.6.2 接続数設計

| サービス | Task数 | Pool Size/Task | 合計接続数 |
|---------|-------|---------------|-----------|
| Public Web | 2 | 20 | 40 |
| Admin | 1 | 10 | 10 |
| Batch | 1 | 10 | 10 |
| **合計** | | | **60** |

**RDS max_connections**: 200（余裕あり）

---

## 5.7 データライフサイクル管理

### 5.7.1 データ保持ポリシー

| テーブル | 保持期間 | 削除方法 |
|---------|---------|---------|
| users | 無期限 | 手動削除のみ |
| stats | 90日間 | Batch処理で自動削除 |

**古いデータ削除（Batch処理）**:
```sql
DELETE FROM stats
WHERE recorded_at < NOW() - INTERVAL '90 days';
```

---

## 5.8 ストレージコスト見積もり

### 5.8.1 RDSコスト（月額・USD）

| 項目 | 仕様 | 月額 |
|------|------|------|
| **Instance** | db.t3.medium Multi-AZ | $120 |
| **Storage** | 100 GB gp3 | $23 |
| **Backup Storage** | 100 GB（7日分想定） | $10 |
| **Data Transfer** | 10 GB/月 | $1 |
| **合計** | | **$154** |

---

**次へ**: [06_セキュリティ設計](06_セキュリティ設計.md)
