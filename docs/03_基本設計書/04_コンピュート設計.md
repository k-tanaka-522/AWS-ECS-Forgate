# 04. コンピュート設計

[← 前へ: 03_ネットワーク設計](03_ネットワーク設計.md) | [目次](00_目次.md) | [次へ: 05_ストレージ設計 →](05_ストレージ設計.md)

---

## 4.1 ECS Fargate構成設計

### 4.1.1 ECS Cluster構成

| 項目 | 設定値 | 説明 |
|------|--------|------|
| **Cluster名** | sample-app-cluster | プロジェクト識別用 |
| **起動タイプ** | Fargate | サーバーレス、EC2管理不要 |
| **Container Insights** | Enabled | メトリクス詳細監視 |
| **VPC** | Service VPC (10.1.0.0/16) | アプリケーション実行環境 |

**設計判断**:
- Fargate採用理由: サーバー管理不要、Auto Scaling容易、POC範囲で最適
- EC2起動タイプ不採用: 管理負荷、コスト最適化の観点

---

## 4.2 サービス別設計

### 4.2.1 Public Web Service

#### Task Definition

| 項目 | 設定値 |
|------|--------|
| **Family** | sample-app-public |
| **Task Role** | ecsTaskRole-public |
| **Execution Role** | ecsTaskExecutionRole |
| **Network Mode** | awsvpc |
| **CPU** | 512 (.5 vCPU) |
| **Memory** | 1024 MB (1 GB) |
| **Container名** | public-web |
| **Image** | {account-id}.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/public:latest |
| **Port Mapping** | 3000 (HTTP) |
| **Log Driver** | awslogs |
| **Log Group** | /ecs/sample-app/public |

#### 環境変数

| 変数名 | 取得方法 | 例 |
|-------|---------|-----|
| NODE_ENV | 環境変数 | production |
| PORT | 環境変数 | 3000 |
| DB_HOST | Parameter Store | sample-app-db.xxxxx.rds.amazonaws.com |
| DB_PORT | Parameter Store | 5432 |
| DB_NAME | Parameter Store | sampledb |
| DB_USER | Secrets Manager | postgres |
| DB_PASSWORD | Secrets Manager | [自動生成パスワード] |

**Secrets Manager参照例**:
```json
{
  "secrets": [
    {
      "name": "DB_USER",
      "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/dev/db-credentials:username::"
    },
    {
      "name": "DB_PASSWORD",
      "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/dev/db-credentials:password::"
    }
  ]
}
```

#### ECS Service設定

| 項目 | 設定値 |
|------|--------|
| **Service名** | public-web-service |
| **Task数** | Desired: 2, Min: 2, Max: 4 |
| **Deployment Type** | Rolling Update |
| **Min Healthy Percent** | 50% |
| **Max Percent** | 200% |
| **Subnet** | Private-1a, Private-1c |
| **Security Group** | ecs-public-sg |
| **Load Balancer** | sample-app-alb |
| **Target Group** | public-web-tg |
| **Health Check Grace Period** | 60秒 |

#### Health Check設定

| 項目 | 設定値 |
|------|--------|
| **Protocol** | HTTP |
| **Path** | /health |
| **Port** | 3000 |
| **Interval** | 30秒 |
| **Timeout** | 5秒 |
| **Healthy Threshold** | 2 |
| **Unhealthy Threshold** | 3 |
| **Success Codes** | 200 |

**ヘルスチェックエンドポイント実装**:
```javascript
// GET /health
{
  "status": "healthy",
  "timestamp": "2025-10-24T00:00:00Z",
  "database": "connected",
  "uptime": 3600
}
```

---

### 4.2.2 Admin Dashboard Service

#### Task Definition

| 項目 | 設定値 |
|------|--------|
| **Family** | sample-app-admin |
| **Task Role** | ecsTaskRole-admin |
| **Execution Role** | ecsTaskExecutionRole |
| **Network Mode** | awsvpc |
| **CPU** | 512 (.5 vCPU) |
| **Memory** | 1024 MB (1 GB) |
| **Container名** | admin-dashboard |
| **Image** | {account-id}.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/admin:latest |
| **Port Mapping** | 3000 (HTTP) |
| **Log Driver** | awslogs |
| **Log Group** | /ecs/sample-app/admin |

#### 環境変数

| 変数名 | 取得方法 | 値 |
|-------|---------|-----|
| NODE_ENV | 環境変数 | production |
| PORT | 環境変数 | 3000 |
| ADMIN_MODE | 環境変数 | true |
| DB_HOST | Parameter Store | sample-app-db.xxxxx.rds.amazonaws.com |
| DB_PORT | Parameter Store | 5432 |
| DB_NAME | Parameter Store | sampledb |
| DB_USER | Secrets Manager | postgres |
| DB_PASSWORD | Secrets Manager | [自動生成パスワード] |

#### ECS Service設定

| 項目 | 設定値 |
|------|--------|
| **Service名** | admin-service |
| **Task数** | Desired: 1, Min: 1, Max: 1 |
| **Deployment Type** | Rolling Update |
| **Subnet** | Private-1a, Private-1c |
| **Security Group** | ecs-admin-sg |
| **Load Balancer** | なし（Direct IP Access via VPN） |

**アクセス方法**:
```
VPN接続後:
http://[ECS Task Private IP]:3000
```

**Service Discovery設定（将来実装）**:
```
admin.internal.sample-app.local → ECS Task Private IP（自動DNS登録）
```

---

### 4.2.3 Batch Processing Service

#### Task Definition

| 項目 | 設定値 |
|------|--------|
| **Family** | sample-app-batch |
| **Task Role** | ecsTaskRole-batch |
| **Execution Role** | ecsTaskExecutionRole |
| **Network Mode** | awsvpc |
| **CPU** | 1024 (1 vCPU) |
| **Memory** | 2048 MB (2 GB) |
| **Container名** | batch-processing |
| **Image** | {account-id}.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/batch:latest |
| **Log Driver** | awslogs |
| **Log Group** | /ecs/sample-app/batch |

**CPU/Memory増強理由**: データ処理・集計処理のため高リソース割り当て

#### 環境変数

| 変数名 | 取得方法 | 値 |
|-------|---------|-----|
| NODE_ENV | 環境変数 | production |
| BATCH_MODE | 環境変数 | true |
| DB_HOST | Parameter Store | sample-app-db.xxxxx.rds.amazonaws.com |
| DB_PORT | Parameter Store | 5432 |
| DB_NAME | Parameter Store | sampledb |
| DB_USER | Secrets Manager | postgres |
| DB_PASSWORD | Secrets Manager | [自動生成パスワード] |

#### EventBridge Scheduled Rule

| 項目 | 設定値 |
|------|--------|
| **Rule名** | sample-app-daily-batch |
| **Schedule** | cron(0 18 * * ? *) ※UTC |
| **Target** | ECS Task (Batch) |
| **Task Count** | 1 |
| **Subnet** | Private-1a, Private-1c |
| **Security Group** | ecs-batch-sg |
| **Assign Public IP** | Disabled |

**スケジュール例**:
| 処理 | cron式（UTC） | 実行時刻（JST） |
|------|-------------|--------------|
| 日次集計 | cron(0 18 * * ? *) | 毎日 03:00 |
| 週次レポート | cron(0 19 ? * SUN *) | 毎週日曜 04:00 |

---

## 4.3 Application Load Balancer設計

### 4.3.1 ALB基本構成

| 項目 | 設定値 |
|------|--------|
| **Name** | sample-app-alb |
| **Scheme** | Internet-facing |
| **IP Address Type** | IPv4 |
| **VPC** | Service VPC (10.1.0.0/16) |
| **Subnets** | Public-1a, Public-1c |
| **Security Group** | alb-sg |
| **Access Logs** | Enabled（S3: sample-app-alb-logs） |
| **Deletion Protection** | Disabled（POC用） |

### 4.3.2 Listener設定

#### HTTP Listener (Port 80)

| 項目 | 設定値 |
|------|--------|
| **Protocol** | HTTP |
| **Port** | 80 |
| **Default Action** | Forward to public-web-tg |

**将来実装: HTTPS Redirect**:
```
HTTP:80 → HTTPS:443 (301 Redirect)
```

#### HTTPS Listener (Port 443) - 将来実装

| 項目 | 設定値 |
|------|--------|
| **Protocol** | HTTPS |
| **Port** | 443 |
| **Certificate** | ACM証明書 |
| **Security Policy** | ELBSecurityPolicy-TLS13-1-2-2021-06 |
| **Default Action** | Forward to public-web-tg |

### 4.3.3 Target Group設定

#### Public Web Target Group

| 項目 | 設定値 |
|------|--------|
| **Name** | public-web-tg |
| **Target Type** | IP |
| **Protocol** | HTTP |
| **Port** | 3000 |
| **VPC** | Service VPC |
| **Health Check Protocol** | HTTP |
| **Health Check Path** | /health |
| **Health Check Interval** | 30秒 |
| **Health Check Timeout** | 5秒 |
| **Healthy Threshold** | 2 |
| **Unhealthy Threshold** | 3 |
| **Success Codes** | 200 |
| **Deregistration Delay** | 30秒 |

**Target登録**:
- ECS Serviceが自動登録
- ターゲット: ECS Task Private IP:3000

---

## 4.4 Auto Scaling設計（将来実装）

### 4.4.1 ECS Service Auto Scaling

#### Target Tracking Policy

| メトリクス | ターゲット値 | スケールアウト | スケールイン |
|----------|-----------|------------|------------|
| **ECS Service Average CPU** | 70% | +1 Task | -1 Task |
| **ECS Service Average Memory** | 80% | +1 Task | -1 Task |
| **ALB Request Count per Target** | 1000 req/min | +1 Task | -1 Task |

#### Scaling設定

| 項目 | 設定値 |
|------|--------|
| **Min Capacity** | 2 |
| **Max Capacity** | 4 |
| **Scale Out Cooldown** | 60秒 |
| **Scale In Cooldown** | 180秒 |

**設計判断**:
- POC範囲では固定2タスク
- 本番化時にAuto Scaling有効化

---

## 4.5 ECS Exec設定（トラブルシューティング用）

### 4.5.1 ECS Exec有効化

| 項目 | 設定値 |
|------|--------|
| **Enable Execute Command** | true |
| **Session Logging** | CloudWatch Logs |
| **Log Group** | /ecs/exec/sample-app |

**使用方法**:
```bash
# ECS Taskへのシェルアクセス
aws ecs execute-command \
  --cluster sample-app-cluster \
  --task [task-id] \
  --container public-web \
  --interactive \
  --command "/bin/sh"
```

---

## 4.6 ECR設計

### 4.6.1 ECRリポジトリ構成

| リポジトリ名 | 用途 | イメージスキャン | ライフサイクルポリシー |
|------------|------|-------------|-------------------|
| sample-app/public | Public Webイメージ | On Push | 最新10個保持 |
| sample-app/admin | Admin Dashboardイメージ | On Push | 最新10個保持 |
| sample-app/batch | Batch Processingイメージ | On Push | 最新10個保持 |

### 4.6.2 イメージタグ戦略

| タグ | 用途 | 例 |
|------|------|-----|
| **latest** | 最新開発版 | sample-app/public:latest |
| **git-sha** | コミットハッシュ | sample-app/public:abc123 |
| **version** | バージョンタグ | sample-app/public:v1.0.0 |

### 4.6.3 ライフサイクルポリシー

```json
{
  "rules": [
    {
      "rulePriority": 1,
      "description": "Keep last 10 images",
      "selection": {
        "tagStatus": "any",
        "countType": "imageCountMoreThan",
        "countNumber": 10
      },
      "action": {
        "type": "expire"
      }
    }
  ]
}
```

---

## 4.7 IAM Role設計

### 4.7.1 ECS Task Execution Role

**Role名**: `ecsTaskExecutionRole`

**用途**: ECS Taskの起動に必要な権限（ECR Pull、CloudWatch Logs、Secrets Manager）

**Managed Policy**:
- `AmazonECSTaskExecutionRolePolicy`

**Inline Policy（Secrets Manager）**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/*"
    }
  ]
}
```

### 4.7.2 ECS Task Role

#### Public Web Task Role

**Role名**: `ecsTaskRole-public`

**用途**: アプリケーション実行時の権限

**Policy**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ssm:GetParameter"
      ],
      "Resource": "arn:aws:ssm:ap-northeast-1:987654321098:parameter/sample-app/dev/*"
    }
  ]
}
```

#### Admin Task Role

**Role名**: `ecsTaskRole-admin`

**追加権限**: RDS管理操作用（将来実装）

#### Batch Task Role

**Role名**: `ecsTaskRole-batch`

**追加権限**: S3書き込み権限（レポート出力用、将来実装）

---

## 4.8 コンピュートリソース最適化

### 4.8.1 リソースサイジング根拠

| サービス | vCPU | Memory | 根拠 |
|---------|------|--------|------|
| Public Web | 0.5 | 1GB | Node.js軽量API、同時接続100程度想定 |
| Admin | 0.5 | 1GB | 管理者数名のアクセス、負荷低い |
| Batch | 1.0 | 2GB | データ処理、メモリ使用多い |

### 4.8.2 コスト見積もり（月額）

| サービス | Task数 | vCPU | Memory | 稼働時間 | 月額（USD） |
|---------|-------|------|--------|---------|-----------|
| Public Web | 2 | 0.5 | 1GB | 24h/day | $30 |
| Admin | 1 | 0.5 | 1GB | 24h/day | $15 |
| Batch | 1 | 1.0 | 2GB | 1h/day | $2 |
| **合計** | | | | | **$47** |

---

**次へ**: [05_ストレージ設計](05_ストレージ設計.md)
