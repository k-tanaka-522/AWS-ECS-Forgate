# 03. ネットワーク設計

[← 前へ: 02_アーキテクチャ設計](02_アーキテクチャ設計.md) | [目次](00_目次.md) | [次へ: 04_コンピュート設計 →](04_コンピュート設計.md)

---

## 3.1 CIDR設計

### 3.1.1 全体CIDR構成

| VPC | Account | CIDR | サブネット数 | 用途 |
|-----|---------|------|------------|------|
| Shared VPC | Platform | 10.0.0.0/16 | 6 | 共通ネットワーク基盤 |
| Service VPC | Service | 10.1.0.0/16 | 6 | アプリケーション実行環境 |

**設計根拠**:
- RFC1918プライベートアドレス範囲（10.0.0.0/8）を使用
- /16サブネット: 各VPCで65,536アドレス確保（将来拡張に対応）
- CIDR重複回避: 既存VPCとの重複確認済み

### 3.1.2 サブネット分割設計

#### Platform Account - Shared VPC (10.0.0.0/16)

| サブネット名 | CIDR | AZ | タイプ | 用途 | アドレス数 |
|-------------|------|----|--------|------|-----------|
| Public-1a | 10.0.1.0/24 | ap-northeast-1a | Public | NAT Gateway, VPN Endpoint | 256 |
| Public-1c | 10.0.2.0/24 | ap-northeast-1c | Public | NAT Gateway, VPN Endpoint | 256 |
| Private-1a | 10.0.11.0/24 | ap-northeast-1a | Private | 共有サービス用（将来） | 256 |
| Private-1c | 10.0.12.0/24 | ap-northeast-1c | Private | 共有サービス用（将来） | 256 |
| TGW-1a | 10.0.21.0/24 | ap-northeast-1a | Private | Transit Gateway Attachment | 256 |
| TGW-1c | 10.0.22.0/24 | ap-northeast-1c | Private | Transit Gateway Attachment | 256 |

**サブネット分割ルール**:
- Public Subnet: 10.0.1.0 ~ 10.0.10.0/24 範囲
- Private Subnet: 10.0.11.0 ~ 10.0.20.0/24 範囲
- TGW Subnet: 10.0.21.0 ~ 10.0.30.0/24 範囲

#### Service Account - Service VPC (10.1.0.0/16)

| サブネット名 | CIDR | AZ | タイプ | 用途 | アドレス数 |
|-------------|------|----|--------|------|-----------|
| Public-1a | 10.1.1.0/24 | ap-northeast-1a | Public | ALB（Public Web用） | 256 |
| Public-1c | 10.1.2.0/24 | ap-northeast-1c | Public | ALB（Public Web用） | 256 |
| Private-1a | 10.1.11.0/24 | ap-northeast-1a | Private | ECS Tasks（全3サービス） | 256 |
| Private-1c | 10.1.12.0/24 | ap-northeast-1c | Private | ECS Tasks（全3サービス） | 256 |
| Database-1a | 10.1.21.0/24 | ap-northeast-1a | Private | RDS Primary | 256 |
| Database-1c | 10.1.22.0/24 | ap-northeast-1c | Private | RDS Standby | 256 |

**サブネット分割ルール**:
- Public Subnet: 10.1.1.0 ~ 10.1.10.0/24 範囲
- Private Subnet: 10.1.11.0 ~ 10.1.20.0/24 範囲
- Database Subnet: 10.1.21.0 ~ 10.1.30.0/24 範囲

---

## 3.2 ルーティング設計

### 3.2.1 Platform Account - Shared VPC ルーティング

#### Public Subnet Route Table

| 宛先 | ターゲット | 用途 |
|------|----------|------|
| 10.0.0.0/16 | local | VPC内通信 |
| 0.0.0.0/0 | igw-xxxxxxxx | インターネット通信 |

**適用サブネット**: Public-1a, Public-1c

#### Private Subnet Route Table (AZ別)

**Private-1a Route Table**:
| 宛先 | ターゲット | 用途 |
|------|----------|------|
| 10.0.0.0/16 | local | VPC内通信 |
| 0.0.0.0/0 | nat-xxxxxxxx (AZ: 1a) | インターネット通信 |
| 10.1.0.0/16 | tgw-xxxxxxxx | Service VPC通信 |

**Private-1c Route Table**:
| 宛先 | ターゲット | 用途 |
|------|----------|------|
| 10.0.0.0/16 | local | VPC内通信 |
| 0.0.0.0/0 | nat-xxxxxxxx (AZ: 1c) | インターネット通信 |
| 10.1.0.0/16 | tgw-xxxxxxxx | Service VPC通信 |

**適用サブネット**: Private-1a, Private-1c

#### TGW Subnet Route Table

| 宛先 | ターゲット | 用途 |
|------|----------|------|
| 10.0.0.0/16 | local | VPC内通信 |
| 10.1.0.0/16 | tgw-xxxxxxxx | Service VPC通信 |

**適用サブネット**: TGW-1a, TGW-1c

### 3.2.2 Service Account - Service VPC ルーティング

#### Public Subnet Route Table

| 宛先 | ターゲット | 用途 |
|------|----------|------|
| 10.1.0.0/16 | local | VPC内通信 |
| 0.0.0.0/0 | igw-xxxxxxxx | インターネット通信 |

**適用サブネット**: Public-1a, Public-1c

#### Private Subnet Route Table (AZ別)

**Private-1a Route Table**:
| 宛先 | ターゲット | 用途 |
|------|----------|------|
| 10.1.0.0/16 | local | VPC内通信 |
| 0.0.0.0/0 | nat-xxxxxxxx (AZ: 1a) | インターネット通信（npm, AWS API） |
| 10.0.0.0/16 | tgw-xxxxxxxx | Shared VPC通信（VPN経由Admin） |

**Private-1c Route Table**:
| 宛先 | ターゲット | 用途 |
|------|----------|------|
| 10.1.0.0/16 | local | VPC内通信 |
| 0.0.0.0/0 | nat-xxxxxxxx (AZ: 1c) | インターネット通信（npm, AWS API） |
| 10.0.0.0/16 | tgw-xxxxxxxx | Shared VPC通信（VPN経由Admin） |

**適用サブネット**: Private-1a, Private-1c

#### Database Subnet Route Table

| 宛先 | ターゲット | 用途 |
|------|----------|------|
| 10.1.0.0/16 | local | VPC内通信（ECSからのDB接続） |
| 10.0.0.0/16 | tgw-xxxxxxxx | Shared VPC通信（VPN経由DB管理） |

**適用サブネット**: Database-1a, Database-1c

**設計判断**:
- Database SubnetからInternet Gatewayへのルートは不要（セキュリティ強化）
- NAT Gatewayへのルートも不要（RDSはインターネット通信不要）
- VPN経由のDB管理アクセスのみ許可

---

## 3.3 Transit Gateway設計

### 3.3.1 Transit Gateway基本構成

| 項目 | 設定値 | 説明 |
|------|--------|------|
| **Name** | sample-app-tgw | プロジェクト識別用 |
| **ASN** | 64512 | デフォルトASN（BGP未使用） |
| **DNS Support** | Enabled | VPC間のDNS名前解決を有効化 |
| **VPN ECMP Support** | Enabled | VPN接続の帯域拡張（将来用） |
| **Default Route Table Association** | Disabled | 明示的なルート管理 |
| **Default Route Table Propagation** | Disabled | 明示的なルート管理 |

**設計判断**:
- Default Route Table Associationを無効化: 意図しないルート伝播を防止
- DNS Supportを有効化: VPC間でプライベートDNS名を使用可能

### 3.3.2 Transit Gateway Attachments

| Attachment名 | VPC | Account | Subnet配置 |
|-------------|-----|---------|-----------|
| tgw-attach-shared | Shared VPC (10.0.0.0/16) | Platform | TGW-1a, TGW-1c |
| tgw-attach-service | Service VPC (10.1.0.0/16) | Service | Private-1a, Private-1c |

**Attachment設計ポイント**:
- 専用サブネット使用（Platform側）: TGW専用サブネットで管理を明確化
- Private Subnet使用（Service側）: ECS Tasksと同じサブネットで効率化

### 3.3.3 Transit Gateway Route Table

**単一ルートテーブル構成**:

| 宛先CIDR | Attachment | 説明 |
|---------|-----------|------|
| 10.0.0.0/16 | tgw-attach-shared | Shared VPC向けトラフィック |
| 10.1.0.0/16 | tgw-attach-service | Service VPC向けトラフィック |

**ルートテーブル設計判断**:
- ✅ **単一ルートテーブル採用**: シンプルな構成、全VPC間通信を許可
- ❌ **複数ルートテーブル不採用**: POC範囲では複雑性不要

**将来の拡張（本番環境）**:
```
├─ shared-rt       # 共通基盤用
│   ├─ 10.1.0.0/16 → service-vpc
│   └─ 10.2.0.0/16 → production-vpc
│
├─ service-rt      # サービス用
│   ├─ 10.0.0.0/16 → shared-vpc
│   └─ 192.168.0.0/16 → on-premises
│
└─ isolated-rt     # 隔離環境用
    └─ 10.0.0.0/16 → shared-vpc only
```

### 3.3.4 通信フロー例

#### VPN経由Admin接続フロー

```
[Admin PC - 192.168.1.100]
    ↓
[Client VPN - 10.0.0.0/16]
    ↓ Routing: 10.1.0.0/16 → TGW
[Transit Gateway]
    ↓ Route Table: 10.1.0.0/16 → tgw-attach-service
[Service VPC - Private Subnet]
    ↓
[ECS Task - Admin Dashboard - 10.1.11.x]
```

#### ECS → RDS接続フロー（同一VPC内）

```
[ECS Task - 10.1.11.x]
    ↓ VPC Local Routing
[RDS Primary - 10.1.21.x]
```

**設計ポイント**: Transit Gateway不経由（低レイテンシ、コスト削減）

---

## 3.4 NAT Gateway設計

### 3.4.1 NAT Gateway配置

| NAT Gateway | AZ | Subnet | Elastic IP | 用途 |
|------------|-----|--------|-----------|------|
| natgw-shared-1a | ap-northeast-1a | Public-1a | eipalloc-aaaa | Shared VPC Private通信 |
| natgw-shared-1c | ap-northeast-1c | Public-1c | eipalloc-bbbb | Shared VPC Private通信 |
| natgw-service-1a | ap-northeast-1a | Public-1a | eipalloc-cccc | Service VPC Private通信 |
| natgw-service-1c | ap-northeast-1c | Public-1c | eipalloc-dddd | Service VPC Private通信 |

**設計判断**:
- Multi-AZ構成: 単一AZ障害に対応
- AZ別Route Table: AZ障害時のクロスAZ通信回避（コスト削減）

### 3.4.2 NAT Gateway可用性設計

**通常時の通信フロー**:
```
Private-1a Subnet
  → NAT Gateway (1a)
  → Internet Gateway
  → Internet
```

**AZ-1a障害時の動作**:
```
Private-1a Subnet
  → [NAT Gateway (1a) - 利用不可]

→ Private-1c Subnet（別AZで代替処理）
  → NAT Gateway (1c)
  → Internet Gateway
  → Internet
```

**復旧手順**: ECS Taskは自動的に1cで再起動（ECS Service設定）

---

## 3.5 Internet Gateway設計

### 3.5.1 Internet Gateway配置

| VPC | Internet Gateway | 用途 |
|-----|-----------------|------|
| Shared VPC | igw-shared | Public Subnet ⇔ Internet |
| Service VPC | igw-service | Public Subnet ⇔ Internet, ALB公開 |

**アタッチメント**:
- 各VPCに1つのInternet Gatewayをアタッチ
- 高可用性: AWSマネージドサービス（Multi-AZ自動構成）

---

## 3.6 Client VPN設計

### 3.6.1 Client VPN Endpoint構成

| 項目 | 設定値 | 説明 |
|------|--------|------|
| **VPC** | Shared VPC | Platform Accountに配置 |
| **Associated Subnet** | Private-1a, Private-1c | Multi-AZ構成 |
| **Client CIDR** | 172.16.0.0/22 | VPN割り当てIP範囲（1,024アドレス） |
| **Authentication** | Mutual (Certificate) | サーバー証明書 + クライアント証明書 |
| **Split Tunnel** | Enabled | VPN経由は10.0.0.0/8のみ |
| **DNS Servers** | 10.0.0.2 | VPC DNS Resolver |

**設計判断**:
- Split Tunnel有効化: インターネット通信はローカル経由（帯域節約）
- 証明書認証: POC用途、本番ではAD連携やSAML検討

### 3.6.2 VPN Authorization Rules

| 宛先ネットワーク | アクセス許可グループ | 説明 |
|---------------|------------------|------|
| 10.0.0.0/16 | All | Shared VPC全体へのアクセス |
| 10.1.0.0/16 | All | Service VPC全体へのアクセス（TGW経由） |

### 3.6.3 VPN接続フロー

```
[Admin PC]
    ↓
    1. OpenVPN Client起動、証明書認証
    ↓
[Client VPN Endpoint - ENI: 10.0.11.x]
    ↓
    2. VPN Tunnel確立、IP割り当て (172.16.0.x)
    ↓
    3. ルーティング: 10.1.0.0/16 → TGW
    ↓
[Transit Gateway]
    ↓
    4. Route Table: 10.1.0.0/16 → Service VPC
    ↓
[Service VPC - Private Subnet]
    ↓
    5. Security Group確認（10.0.0.0/16許可）
    ↓
[ECS Task - Admin Dashboard]
```

---

## 3.7 VPC Flow Logs設計

### 3.7.1 Flow Logs設定

| VPC | Flow Log名 | 送信先 | トラフィックタイプ | 保持期間 |
|-----|-----------|--------|----------------|---------|
| Shared VPC | shared-vpc-flow-logs | CloudWatch Logs | ALL | 7日 |
| Service VPC | service-vpc-flow-logs | CloudWatch Logs | ALL | 7日 |

**ログフォーマット（デフォルト）**:
```
${version} ${account-id} ${interface-id} ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${start} ${end} ${action} ${log-status}
```

**用途**:
- セキュリティ監査: 不正アクセス検知
- トラブルシューティング: 通信不可の原因調査
- コスト分析: データ転送量の可視化

---

## 3.8 DNS設計

### 3.8.1 VPC DNS設定

| VPC | DNS Resolution | DNS Hostnames | 説明 |
|-----|---------------|---------------|------|
| Shared VPC | Enabled | Enabled | プライベートDNS名を有効化 |
| Service VPC | Enabled | Enabled | RDSエンドポイント名を使用 |

**VPC DNS Resolver**:
- Shared VPC: 10.0.0.2
- Service VPC: 10.1.0.2

### 3.8.2 プライベートホストゾーン（将来実装）

| ホストゾーン名 | VPC | レコード例 |
|-------------|-----|-----------|
| internal.sample-app.local | Service VPC | admin.internal.sample-app.local → ECS Private IP |

---

## 3.9 ネットワークACL設計

### 3.9.1 デフォルトNACL使用

**設計判断**:
- ✅ デフォルトNACL使用（All Allow）
- ✅ Security Groupで細かい制御実施
- ❌ カスタムNACL不採用（POC範囲では複雑性不要）

**理由**:
- Security Groupでステートフルな制御が可能
- NACLはステートレスで管理が複雑
- POC範囲ではSecurity Groupで十分

---

## 3.10 ネットワークパフォーマンス設計

### 3.10.1 レイテンシ目標

| 通信経路 | 目標レイテンシ | 測定方法 |
|---------|-------------|---------|
| ECS → RDS（同一VPC） | < 5ms | CloudWatch Insights |
| VPN → ECS（TGW経由） | < 50ms | ping疎通確認 |
| Internet → ALB | < 20ms | CloudWatch Metrics |

### 3.10.2 帯域設計

| リソース | 帯域 | 説明 |
|---------|------|------|
| NAT Gateway | 最大45Gbps | AWSマネージド、自動スケール |
| Transit Gateway | 最大50Gbps | AWSマネージド |
| ECS Task ENI | 最大10Gbps | Fargateタイプによる |

---

**次へ**: [04_コンピュート設計](04_コンピュート設計.md)
