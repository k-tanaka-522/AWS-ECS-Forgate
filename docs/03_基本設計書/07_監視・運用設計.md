# 07. 監視・運用設計

[← 前へ: 06_セキュリティ設計](06_セキュリティ設計.md) | [目次](00_目次.md) | [次へ: 08_アプリケーション設計 →](08_アプリケーション設計.md)

---

## 7.1 CloudWatch Alarms設計

### 7.1.1 ECS監視Alarms

#### Public Web Service

| Alarm名 | メトリクス | しきい値 | 期間 | アクション |
|---------|----------|---------|------|-----------|
| ECS-Public-CPU-High | CPUUtilization | > 80% | 5分間 | SNS通知（Warning） |
| ECS-Public-Memory-High | MemoryUtilization | > 80% | 5分間 | SNS通知（Warning） |
| ECS-Public-RunningTasks-Low | RunningTaskCount | < 1 | 1分間 | SNS通知（Critical） |

#### Admin Service

| Alarm名 | メトリクス | しきい値 | 期間 | アクション |
|---------|----------|---------|------|-----------|
| ECS-Admin-CPU-High | CPUUtilization | > 80% | 5分間 | SNS通知（Warning） |
| ECS-Admin-Memory-High | MemoryUtilization | > 80% | 5分間 | SNS通知（Warning） |
| ECS-Admin-RunningTasks-Low | RunningTaskCount | < 1 | 1分間 | SNS通知（Critical） |

#### Batch Service

| Alarm名 | メトリクス | しきい値 | 期間 | アクション |
|---------|----------|---------|------|-----------|
| ECS-Batch-Failed | TaskStoppedReason | Failed | 即時 | SNS通知（Critical） |

### 7.1.2 RDS監視Alarms

| Alarm名 | メトリクス | しきい値 | 期間 | アクション |
|---------|----------|---------|------|-----------|
| RDS-CPU-High | CPUUtilization | > 80% | 5分間 | SNS通知（Warning） |
| RDS-FreeableMemory-Low | FreeableMemory | < 512 MB | 5分間 | SNS通知（Warning） |
| RDS-FreeStorageSpace-Low | FreeStorageSpace | < 20% | 5分間 | SNS通知（Warning） |
| RDS-DatabaseConnections-High | DatabaseConnections | > 160（80%） | 5分間 | SNS通知（Warning） |
| RDS-ReadLatency-High | ReadLatency | > 50 ms | 5分間 | SNS通知（Warning） |
| RDS-WriteLatency-High | WriteLatency | > 100 ms | 5分間 | SNS通知（Warning） |
| RDS-ReplicationLag-High | ReplicaLag | > 30秒 | 1分間 | SNS通知（Critical） |

### 7.1.3 ALB監視Alarms

| Alarm名 | メトリクス | しきい値 | 期間 | アクション |
|---------|----------|---------|------|-----------|
| ALB-UnhealthyTargets | UnHealthyHostCount | > 0 | 3分間 | SNS通知（Critical） |
| ALB-5xxErrors-High | HTTPCode_Target_5XX_Count | > 10 req | 5分間 | SNS通知（Critical） |
| ALB-ResponseTime-Slow | TargetResponseTime | > 1秒（平均） | 5分間 | SNS通知（Warning） |
| ALB-RequestCount-Spike | RequestCount | > 1000 req/min | 5分間 | SNS通知（Info） |

---

## 7.2 CloudWatch Dashboard設計

### 7.2.1 統合監視ダッシュボード

**Dashboard名**: `sample-app-overview`

**レイアウト**:
```
┌──────────────────────────────────────────────────────────────┐
│ Sample App System Overview Dashboard                         │
├──────────────────────────────────────────────────────────────┤
│ [ECS Metrics]                                                │
│  ┌────────────┬────────────┬────────────┐                    │
│  │ Public Web │ Admin      │ Batch      │                    │
│  │ CPU: 45%   │ CPU: 20%   │ Status: OK │                    │
│  │ Memory:60% │ Memory:30% │ Last Run:  │                    │
│  │ Tasks: 2/2 │ Tasks: 1/1 │ 03:00 JST  │                    │
│  └────────────┴────────────┴────────────┘                    │
├──────────────────────────────────────────────────────────────┤
│ [RDS Metrics]                                                │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ CPU: 35% | Connections: 45/200 | Storage: 85% Free │     │
│  │ Read Latency: 5ms | Write Latency: 10ms            │     │
│  │ Replication Lag: 0s                                 │     │
│  └─────────────────────────────────────────────────────┘     │
├──────────────────────────────────────────────────────────────┤
│ [ALB Metrics]                                                │
│  ┌─────────────────────────────────────────────────────┐     │
│  │ Request Count: 150 req/min                          │     │
│  │ Target Response Time: 250ms (avg)                   │     │
│  │ 2xx: 148 | 4xx: 2 | 5xx: 0                         │     │
│  │ Healthy Targets: 2/2                                │     │
│  └─────────────────────────────────────────────────────┘     │
├──────────────────────────────────────────────────────────────┤
│ [Recent Alarms]                                              │
│  ✅ All systems operational                                  │
└──────────────────────────────────────────────────────────────┘
```

### 7.2.2 ウィジェット構成

| ウィジェット名 | タイプ | メトリクス |
|-------------|-------|-----------|
| ECS CPU Utilization | Line Graph | ECS Service CPU（3サービス） |
| ECS Memory Utilization | Line Graph | ECS Service Memory（3サービス） |
| ECS Running Tasks | Number | RunningTaskCount |
| RDS CPU Utilization | Line Graph | RDS CPUUtilization |
| RDS Connections | Number | DatabaseConnections |
| RDS Storage | Line Graph | FreeStorageSpace |
| ALB Request Count | Line Graph | RequestCount |
| ALB Response Time | Line Graph | TargetResponseTime |
| ALB Target Health | Number | HealthyHostCount |
| Recent Alarms | Alarm Status | 全Alarm |

---

## 7.3 CloudWatch Logs設計

### 7.3.1 Log Group構成

| Log Group | 保持期間 | 暗号化 | 用途 |
|-----------|---------|--------|------|
| /ecs/sample-app/public | 7日 | Enabled | Public Webログ |
| /ecs/sample-app/admin | 7日 | Enabled | Adminログ |
| /ecs/sample-app/batch | 7日 | Enabled | Batchログ |
| /aws/rds/instance/sample-app-db/postgresql | 7日 | Enabled | RDSログ |
| /aws/vpn/client | 7日 | Enabled | VPN接続ログ |
| /aws/lambda/... | 7日 | Enabled | Lambda実行ログ（将来） |

**設計判断**:
- POC範囲: 7日保持
- 本番環境: 30日〜90日検討
- コスト削減: 古いログは S3 Glacier へアーカイブ（将来実装）

### 7.3.2 アプリケーションログフォーマット

**JSON構造化ログ**:
```json
{
  "timestamp": "2025-10-24T12:34:56.789Z",
  "level": "INFO",
  "service": "public-web",
  "message": "User created successfully",
  "userId": "12345",
  "requestId": "abc-123-def",
  "duration": 125,
  "statusCode": 201
}
```

**ログレベル**:
| レベル | 用途 | 例 |
|-------|------|-----|
| ERROR | エラー、例外 | DB接続失敗、API呼び出しエラー |
| WARN | 警告 | Slow Query、リトライ発生 |
| INFO | 通常情報 | リクエスト受信、処理完了 |
| DEBUG | デバッグ情報 | 変数値、処理フロー（開発時のみ） |

---

## 7.4 SNS通知設計

### 7.4.1 SNS Topic構成

| Topic名 | 用途 | サブスクライバー |
|---------|------|--------------|
| sample-app-alerts-critical | Critical Alarm | Email: ops-team@example.com |
| sample-app-alerts-warning | Warning Alarm | Email: dev-team@example.com |
| sample-app-alerts-info | Info Alarm | Email: dev-team@example.com |

### 7.4.2 通知内容設計

**Alarm通知メッセージ例**:
```
【Critical】RDS Connection Count High

Service: RDS PostgreSQL
Alarm: RDS-DatabaseConnections-High
Status: ALARM
Current Value: 165 connections (82%)
Threshold: 160 connections (80%)
Timestamp: 2025-10-24 12:34:56 UTC

Action Required:
1. Check current connections: SELECT * FROM pg_stat_activity;
2. Kill idle connections if necessary
3. Investigate connection leak in application

CloudWatch Console:
https://console.aws.amazon.com/cloudwatch/...
```

### 7.4.3 通知先振り分け

| Alarm重要度 | Topic | 通知先 | 対応時間 |
|-----------|-------|--------|---------|
| Critical | sample-app-alerts-critical | 運用チーム | 即時対応 |
| Warning | sample-app-alerts-warning | 開発チーム | 営業時間内対応 |
| Info | sample-app-alerts-info | 開発チーム | 情報共有のみ |

---

## 7.5 運用手順設計

### 7.5.1 日次運用

| 項目 | 頻度 | 手順 | 担当 |
|------|------|------|------|
| ダッシュボード確認 | 毎朝9時 | CloudWatch Dashboard確認 | 開発チーム |
| Alarm履歴確認 | 毎朝9時 | CloudWatch Alarms履歴確認 | 開発チーム |
| コスト確認 | 毎朝9時 | AWS Cost Explorer確認 | PM |

### 7.5.2 週次運用

| 項目 | 頻度 | 手順 | 担当 |
|------|------|------|------|
| RDSバックアップ確認 | 毎週月曜 | Snapshot一覧確認 | 運用チーム |
| ログ確認 | 毎週月曜 | CloudWatch Logs Insightsでエラー集計 | 開発チーム |
| パフォーマンスレビュー | 毎週金曜 | メトリクス週次レポート | 開発チーム |

### 7.5.3 月次運用

| 項目 | 頻度 | 手順 | 担当 |
|------|------|------|------|
| コスト分析 | 毎月1日 | Cost Explorerで詳細分析 | PM |
| セキュリティ監査 | 毎月1日 | CloudTrailログレビュー | セキュリティチーム |
| パッチ適用計画 | 毎月15日 | RDS/ECS Agentバージョン確認 | 運用チーム |

---

## 7.6 障害対応手順

### 7.6.1 障害検知フロー

```
Alarm発火
  ↓
SNS通知（Email）
  ↓
運用チーム確認
  ↓
CloudWatch Dashboard確認
  ↓
CloudWatch Logs確認
  ↓
原因特定
  ↓
対応実施
  ↓
復旧確認
  ↓
報告書作成
```

### 7.6.2 主要障害シナリオと対応

#### ECS Task異常終了

**検知**: `ECS-Public-RunningTasks-Low` Alarm

**対応手順**:
1. ECS Consoleで stopped tasks確認
2. CloudWatch Logsでエラーログ確認
3. Task Definition設定確認（環境変数、Secrets Manager）
4. 必要に応じてTask Definition更新
5. ECS Serviceでdesired count再設定（自動再起動）

#### RDS接続数枯渇

**検知**: `RDS-DatabaseConnections-High` Alarm

**対応手順**:
1. psqlでRDS接続
   ```sql
   SELECT * FROM pg_stat_activity;
   ```
2. Idle接続を確認
   ```sql
   SELECT pg_terminate_backend(pid)
   FROM pg_stat_activity
   WHERE state = 'idle' AND state_change < NOW() - INTERVAL '10 minutes';
   ```
3. アプリケーション側のConnection Pool設定確認
4. 必要に応じてRDS max_connections増加

#### ALB 5xxエラー多発

**検知**: `ALB-5xxErrors-High` Alarm

**対応手順**:
1. ALB Target Health確認
2. ECS Task Health Check確認
3. CloudWatch Logsでアプリケーションエラー確認
4. 必要に応じてロールバック実施

---

## 7.7 バックアップ・リストア手順

### 7.7.1 RDSバックアップ

**自動バックアップ**:
- 実行時間: 17:00-18:00 UTC（JST 02:00-03:00）
- 保持期間: 7日間
- バックアップ先: AWSマネージド S3

**手動スナップショット**:
```bash
aws rds create-db-snapshot \
  --db-instance-identifier sample-app-db \
  --db-snapshot-identifier sample-app-db-manual-20251024
```

### 7.7.2 RDSリストア手順

**スナップショットからのリストア**:
```bash
# 1. 最新スナップショット確認
aws rds describe-db-snapshots \
  --db-instance-identifier sample-app-db

# 2. 新インスタンスとしてリストア
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier sample-app-db-restored \
  --db-snapshot-identifier rds:sample-app-db-2025-10-24-02-00

# 3. リストア完了後、エンドポイント更新
aws ssm put-parameter \
  --name /sample-app/dev/db-endpoint \
  --value sample-app-db-restored.xxxxx.rds.amazonaws.com \
  --overwrite
```

---

## 7.8 パフォーマンスチューニング

### 7.8.1 モニタリング指標

| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| API Response Time | P95 < 500ms | CloudWatch Logs Insights |
| DB Query Time | P95 < 100ms | RDS Performance Insights |
| ECS Task Startup Time | < 30秒 | CloudWatch Metrics |
| ALB Target Response Time | < 300ms | CloudWatch Metrics |

### 7.8.2 チューニング項目

| 項目 | 現状 | 改善案 |
|------|------|--------|
| ECS vCPU/Memory | 0.5/1GB | 負荷状況に応じて増強 |
| DB Connection Pool | max: 20 | 適切なサイズに調整 |
| RDS Instance Class | db.t3.medium | r6g系に変更（高性能） |
| CloudWatch Logs保持期間 | 7日 | コスト削減のため調整 |

---

**次へ**: [08_アプリケーション設計](08_アプリケーション設計.md)
