# 06. セキュリティ設計

[← 前へ: 05_ストレージ設計](05_ストレージ設計.md) | [目次](00_目次.md) | [次へ: 07_監視・運用設計 →](07_監視・運用設計.md)

---

## 6.1 Security Group設計

### 6.1.1 ALB Security Group

**Security Group名**: `alb-sg`

**Inbound Rules**:
| Type | Protocol | Port | Source | 用途 |
|------|----------|------|--------|------|
| HTTP | TCP | 80 | 0.0.0.0/0 | インターネットからのHTTPアクセス |
| HTTPS | TCP | 443 | 0.0.0.0/0 | インターネットからのHTTPSアクセス（将来） |

**Outbound Rules**:
| Type | Protocol | Port | Destination | 用途 |
|------|----------|------|-------------|------|
| Custom TCP | TCP | 3000 | ecs-public-sg | ECS Taskへの転送 |

### 6.1.2 ECS Public Web Security Group

**Security Group名**: `ecs-public-sg`

**Inbound Rules**:
| Type | Protocol | Port | Source | 用途 |
|------|----------|------|--------|------|
| Custom TCP | TCP | 3000 | alb-sg | ALBからのトラフィック |

**Outbound Rules**:
| Type | Protocol | Port | Destination | 用途 |
|------|----------|------|-------------|------|
| PostgreSQL | TCP | 5432 | rds-sg | RDS接続 |
| HTTPS | TCP | 443 | 0.0.0.0/0 | AWS API、npm registry |

### 6.1.3 ECS Admin Security Group

**Security Group名**: `ecs-admin-sg`

**Inbound Rules**:
| Type | Protocol | Port | Source | 用途 |
|------|----------|------|--------|------|
| Custom TCP | TCP | 3000 | 10.0.0.0/16 | VPN経由のアクセス（Shared VPC） |

**Outbound Rules**:
| Type | Protocol | Port | Destination | 用途 |
|------|----------|------|-------------|------|
| PostgreSQL | TCP | 5432 | rds-sg | RDS接続 |
| HTTPS | TCP | 443 | 0.0.0.0/0 | AWS API |

**セキュリティ設計ポイント**:
- インターネットからの直接アクセス不可
- VPN CIDR（10.0.0.0/16）のみ許可

### 6.1.4 ECS Batch Security Group

**Security Group名**: `ecs-batch-sg`

**Inbound Rules**:
| Type | Protocol | Port | Source | 用途 |
|------|----------|------|--------|------|
| なし | - | - | - | インバウンド不要 |

**Outbound Rules**:
| Type | Protocol | Port | Destination | 用途 |
|------|----------|------|-------------|------|
| PostgreSQL | TCP | 5432 | rds-sg | RDS接続 |
| HTTPS | TCP | 443 | 0.0.0.0/0 | AWS API |

### 6.1.5 RDS Security Group

**Security Group名**: `rds-sg`

**Inbound Rules**:
| Type | Protocol | Port | Source | 用途 |
|------|----------|------|--------|------|
| PostgreSQL | TCP | 5432 | ecs-public-sg | Public Webからの接続 |
| PostgreSQL | TCP | 5432 | ecs-admin-sg | Adminからの接続 |
| PostgreSQL | TCP | 5432 | ecs-batch-sg | Batchからの接続 |
| PostgreSQL | TCP | 5432 | 10.0.0.0/16 | VPN経由のDB管理アクセス |

**Outbound Rules**:
| Type | Protocol | Port | Destination | 用途 |
|------|----------|------|-------------|------|
| All | All | All | 0.0.0.0/0 | レスポンス返却 |

### 6.1.6 VPN Endpoint Security Group

**Security Group名**: `vpn-sg`

**Inbound Rules**:
| Type | Protocol | Port | Source | 用途 |
|------|----------|------|--------|------|
| Custom UDP | UDP | 1194 | 0.0.0.0/0 | OpenVPN接続 |

**Outbound Rules**:
| Type | Protocol | Port | Destination | 用途 |
|------|----------|------|-------------|------|
| All | All | All | 0.0.0.0/0 | VPNクライアントへのレスポンス |

---

## 6.2 IAM設計

### 6.2.1 ECS Task Execution Role

**Role名**: `ecsTaskExecutionRole`

**Trust Policy**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

**Attached Policies**:
- `arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy`

**Inline Policy（Secrets Manager Access）**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/dev/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "kms:Decrypt"
      ],
      "Resource": [
        "arn:aws:kms:ap-northeast-1:987654321098:key/*"
      ],
      "Condition": {
        "StringEquals": {
          "kms:ViaService": [
            "secretsmanager.ap-northeast-1.amazonaws.com"
          ]
        }
      }
    }
  ]
}
```

### 6.2.2 ECS Task Role（Public Web）

**Role名**: `ecsTaskRole-public`

**Trust Policy**: 同上

**Inline Policy（Parameter Store Access）**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ssm:GetParameter",
        "ssm:GetParameters"
      ],
      "Resource": [
        "arn:aws:ssm:ap-northeast-1:987654321098:parameter/sample-app/dev/*"
      ]
    }
  ]
}
```

### 6.2.3 ECS Task Role（Admin）

**Role名**: `ecsTaskRole-admin`

**追加権限**: Public Webと同等（将来的に管理操作用権限追加）

### 6.2.4 ECS Task Role（Batch）

**Role名**: `ecsTaskRole-batch`

**追加権限**: S3書き込み（レポート出力用、将来実装）

### 6.2.5 GitHub Actions Deployment Role

**Role名**: `GitHubActionsDeploymentRole`

**Trust Policy（OIDC）**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::987654321098:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "token.actions.githubusercontent.com:sub": "repo:your-org/sample-app:*"
        }
      }
    }
  ]
}
```

**Attached Policies**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecr:GetAuthorizationToken",
        "ecr:BatchCheckLayerAvailability",
        "ecr:GetDownloadUrlForLayer",
        "ecr:BatchGetImage",
        "ecr:PutImage",
        "ecr:InitiateLayerUpload",
        "ecr:UploadLayerPart",
        "ecr:CompleteLayerUpload"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "ecs:UpdateService",
        "ecs:DescribeServices",
        "ecs:DescribeTaskDefinition",
        "ecs:RegisterTaskDefinition"
      ],
      "Resource": "*"
    }
  ]
}
```

---

## 6.3 暗号化設計

### 6.3.1 データ暗号化

| データ種別 | 暗号化方式 | KMSキー |
|----------|----------|--------|
| **RDS Storage** | AES-256 | aws/rds（AWS Managed） |
| **RDS Snapshot** | AES-256 | aws/rds（AWS Managed） |
| **Secrets Manager** | AES-256 | aws/secretsmanager（AWS Managed） |
| **CloudWatch Logs** | AES-256 | aws/logs（AWS Managed） |
| **ECR Images** | AES-256 | aws/ecr（AWS Managed） |

**設計判断**:
- POC範囲ではAWS Managed Key使用（コスト削減）
- 本番環境ではCustomer Managed Key検討

### 6.3.2 通信暗号化

| 通信経路 | 暗号化方式 |
|---------|----------|
| **Internet → ALB** | TLS 1.3（将来実装） |
| **ALB → ECS** | HTTP（VPC内部） |
| **ECS → RDS** | PostgreSQL TLS（オプション） |
| **VPN Tunnel** | OpenVPN（AES-256-GCM） |

**設計判断**:
- ALB → ECS: VPC内部のためHTTP許容（本番ではTLS推奨）
- ECS → RDS: PostgreSQL TLS接続設定可能（本番推奨）

---

## 6.4 アクセス制御設計

### 6.4.1 ネットワークアクセス制御

| リソース | アクセス元 | アクセス方式 |
|---------|----------|------------|
| **Public Web** | Internet | ALB経由HTTP/HTTPS |
| **Admin** | VPN Client | Private IP直接アクセス |
| **Batch** | EventBridge | ECS Run Task API |
| **RDS** | ECS Tasks | PostgreSQL Protocol |
| **RDS（管理）** | VPN Client | psql等のDBクライアント |

### 6.4.2 API認証設計（将来実装）

| サービス | 認証方式 | 実装優先度 |
|---------|---------|-----------|
| Public Web | JWT Token | 低（POCでは未実装） |
| Admin | Basic Auth + VPN | 中（VPNのみ実装済み） |
| Batch | なし（内部処理） | - |

---

## 6.5 シークレット管理設計

### 6.5.1 シークレット種別

| シークレット | 管理方法 | ローテーション |
|------------|---------|-------------|
| **RDS Master Password** | Secrets Manager | 手動 |
| **RDS App User Password** | Secrets Manager | 30日自動 |
| **VPN Certificate** | ACM | 手動更新 |
| **GitHub Actions Secrets** | GitHub Secrets | 手動 |

### 6.5.2 シークレットアクセス制御

**IAM Policy（最小権限の原則）**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/dev/db-app-credentials-*"
      ]
    }
  ]
}
```

**設計ポイント**:
- TaskごとにIAM Roleを分離
- 必要最小限のSecretのみアクセス許可

---

## 6.6 監査ログ設計

### 6.6.1 CloudTrail設定

| 項目 | 設定値 |
|------|--------|
| **Trail名** | sample-app-trail |
| **対象** | Management Events（All） |
| **S3 Bucket** | sample-app-cloudtrail-logs |
| **Log File Validation** | Enabled |
| **Encryption** | Enabled（SSE-S3） |
| **Retention** | 90日（S3 Lifecycle Policy） |

**記録対象イベント**:
- IAM操作（Role/Policy変更）
- CloudFormation操作（Stack作成/更新/削除）
- Secrets Manager操作（シークレット参照）
- RDS操作（インスタンス変更）

### 6.6.2 VPC Flow Logs

**用途**:
- セキュリティ監査（不正アクセス検知）
- トラブルシューティング（通信不可調査）
- コスト分析（データ転送量可視化）

---

## 6.7 セキュリティベストプラクティス適用

### 6.7.1 最小権限の原則

| リソース | 適用内容 |
|---------|---------|
| **IAM Role** | Taskごとに必要最小限の権限のみ付与 |
| **Security Group** | 必要な通信のみ許可 |
| **Subnet** | Public/Private/Database分離 |

### 6.7.2 多層防御

```
Layer 1: Internet Gateway / ALB（外部アクセス制御）
Layer 2: Security Group（リソースレベル制御）
Layer 3: IAM Role（APIレベル制御）
Layer 4: Application Level（アプリケーション認証、将来実装）
```

### 6.7.3 シークレット分離

| 種別 | 保存場所 | コードへの埋め込み |
|------|---------|-----------------|
| **機密情報** | Secrets Manager | ❌ 禁止 |
| **設定情報** | Parameter Store | ❌ 禁止 |
| **公開情報** | 環境変数 | ✅ 許可 |

---

## 6.8 セキュリティチェックリスト

### 6.8.1 インフラセキュリティ

- [x] RDS暗号化有効
- [x] RDS Multi-AZ有効
- [x] RDS Publicly Accessible無効
- [x] Secrets Manager使用
- [x] IAM Role最小権限
- [x] Security Group最小許可
- [x] CloudTrail有効
- [x] VPC Flow Logs有効
- [ ] WAF設定（将来実装）
- [ ] GuardDuty有効化（将来実装）

### 6.8.2 アプリケーションセキュリティ

- [x] 環境変数で設定外部化
- [x] DB接続情報をSecrets Manager管理
- [ ] SQL Injection対策（Prepared Statement）
- [ ] XSS対策（Input Validation）
- [ ] CSRF対策（将来実装）
- [ ] Rate Limiting（将来実装）

---

**次へ**: [07_監視・運用設計](07_監視・運用設計.md)
