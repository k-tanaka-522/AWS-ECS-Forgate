# 02. アーキテクチャ設計

[← 前へ: 01_システム概要](01_システム概要.md) | [目次](00_目次.md) | [次へ: 03_ネットワーク設計 →](03_ネットワーク設計.md)

---

## 2.1 全体アーキテクチャ

### 2.1.1 システム構成図

```
                    ┌─────────────────────────────────────────────┐
                    │         Internet / On-Premises               │
                    └────────────┬──────────────────┬──────────────┘
                                 │                  │
                          (HTTPS/HTTP)        (Client VPN)
                                 │                  │
┌────────────────────────────────┼──────────────────┼──────────────────────────────┐
│                                │   Platform Account (123456789012)                │
│                                │                  │                               │
│  ┌─────────────────────────────┴──────────────────┴────────────────────────────┐ │
│  │  Shared VPC (10.0.0.0/16)                                                   │ │
│  │                                                                              │ │
│  │  ┌────────────────────────┐  ┌─────────────────────────────────────────┐   │ │
│  │  │ Public Subnet (Multi-AZ)│  │ Private Subnet (Multi-AZ)               │   │ │
│  │  │                         │  │                                         │   │ │
│  │  │ ┌─────────────────┐     │  │ ┌──────────────────┐                   │   │ │
│  │  │ │ NAT Gateway     │     │  │ │ Client VPN       │                   │   │ │
│  │  │ │ (1a, 1c)        │     │  │ │ Endpoint         │                   │   │ │
│  │  │ └─────────────────┘     │  │ └──────────────────┘                   │   │ │
│  │  │                         │  │                                         │   │ │
│  │  └────────────────────────┘  └─────────────────────────────────────────┘   │ │
│  │                                                                              │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐   │ │
│  │  │ TGW Subnet (Multi-AZ)                                                │   │ │
│  │  │                                                                      │   │ │
│  │  │            ┌─────────────────────────────────────┐                  │   │ │
│  │  │            │ Transit Gateway                     │                  │   │ │
│  │  │            │ - ID: tgw-xxxxxxxxxx                │                  │   │ │
│  │  │            │ - Route Table: single               │                  │   │ │
│  │  │            │ - RAM: Service Account共有          │                  │   │ │
│  │  │            └───────────────┬─────────────────────┘                  │   │ │
│  │  └────────────────────────────┼────────────────────────────────────────┘   │ │
│  └─────────────────────────────────┼──────────────────────────────────────────┘ │
└────────────────────────────────────┼────────────────────────────────────────────┘
                                     │ (Transit Gateway Attachment)
                                     │
┌────────────────────────────────────┼────────────────────────────────────────────┐
│                    Service Account (987654321098)       │                        │
│  ┌─────────────────────────────────┴────────────────────────────────────────┐   │
│  │  Service VPC (10.1.0.0/16)                                               │   │
│  │                                                                           │   │
│  │  ┌────────────────────────┐  ┌──────────────────────────────────────┐   │   │
│  │  │ Public Subnet          │  │ Private Subnet (Multi-AZ)            │   │   │
│  │  │ (Multi-AZ)             │  │                                      │   │   │
│  │  │                        │  │ ┌────────────────────────────────┐   │   │   │
│  │  │ ┌──────────────────┐   │  │ │ ECS Fargate Cluster           │   │   │   │
│  │  │ │ Application      │   │  │ │                               │   │   │   │
│  │  │ │ Load Balancer    │───┼──┼─│ ┌──────────┐ ┌──────────┐    │   │   │   │
│  │  │ │ (ALB)            │   │  │ │ │ Public   │ │ Admin    │    │   │   │   │
│  │  │ │                  │   │  │ │ │ Web      │ │ Dashboard│    │   │   │   │
│  │  │ │ Target Group:    │   │  │ │ │ (Task)   │ │ (Task)   │    │   │   │   │
│  │  │ │ - Public Web     │   │  │ │ └──────────┘ └──────────┘    │   │   │   │
│  │  │ └──────────────────┘   │  │ │                               │   │   │   │
│  │  │                        │  │ │ ┌──────────────────────────┐ │   │   │   │
│  │  └────────────────────────┘  │ │ │ Batch Processing         │ │   │   │   │
│  │                               │ │ │ (Scheduled Task)         │ │   │   │   │
│  │                               │ │ └──────────────────────────┘ │   │   │   │
│  │                               │ └──────────┬───────────────────┘   │   │   │
│  │                               │            │                       │   │   │
│  │                               └────────────┼───────────────────────┘   │   │
│  │                                            │                           │   │
│  │  ┌────────────────────────────────────────┼───────────────────────┐   │   │
│  │  │ Database Subnet (Multi-AZ)             │                       │   │   │
│  │  │                                        │                       │   │   │
│  │  │    ┌───────────────────────────────────┴─────────────────┐     │   │   │
│  │  │    │ RDS PostgreSQL (Multi-AZ)                           │     │   │   │
│  │  │    │ - Primary:  ap-northeast-1a                         │     │   │   │
│  │  │    │ - Standby:  ap-northeast-1c                         │     │   │   │
│  │  │    │ - Endpoint: sample-app-db.xxxxx.ap-northeast-1.rds  │     │   │   │
│  │  │    └─────────────────────────────────────────────────────┘     │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │ CloudWatch                                                            │   │
│  │ - Alarms: ECS, RDS, ALB (約20個)                                      │   │
│  │ - Dashboard: 統合監視ダッシュボード                                    │   │
│  │ - Logs: /ecs/sample-app/{service}                                     │   │
│  │ - SNS: アラート通知                                                    │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────────────────────┘
```

### 2.1.2 アーキテクチャ特性

| 特性 | 説明 | 実現方法 |
|------|------|---------|
| **Multi-Account分離** | 共通基盤とアプリケーションを分離 | Platform/Service Account構成 |
| **疎結合** | アカウント間はTransit Gateway経由のみ接続 | VPC Peering未使用、TGW集中管理 |
| **高可用性** | AZ障害に対応 | Multi-AZ構成（RDS、NAT Gateway、ECS Task配置） |
| **スケーラビリティ** | 将来的な拡張に対応 | Transit Gatewayによる拠点追加容易 |
| **セキュリティ** | 最小権限、暗号化、閉域接続 | Security Group、VPN、Secrets Manager |
| **運用性** | Infrastructure as Code | CloudFormation、GitHub Actions |

---

## 2.2 Multi-Account構成設計

### 2.2.1 アカウント役割定義

| アカウント | Account ID | 役割 | 管理対象リソース |
|-----------|-----------|------|---------------|
| **Platform Account** | 123456789012 | 共通ネットワーク基盤 | - Shared VPC<br>- Transit Gateway<br>- Client VPN<br>- NAT Gateway<br>- 共有サービス（将来） |
| **Service Account** | 987654321098 | アプリケーション基盤 | - Service VPC<br>- ECS Fargate<br>- RDS PostgreSQL<br>- ALB<br>- CloudWatch監視 |

### 2.2.2 アカウント分離の設計判断根拠

#### なぜPlatform/Serviceに分けるのか？

| 理由 | 詳細 | ビジネスメリット |
|------|------|----------------|
| **責務の分離** | ネットワーク基盤管理とアプリケーション管理の分離 | インフラチームと開発チームの並行作業が可能 |
| **セキュリティ境界** | アカウント境界でIAM権限が分離される | 権限の最小化、誤操作リスク低減 |
| **コスト可視化** | アカウント単位で課金が分離される | 共通基盤コストとアプリコストの分離集計 |
| **将来の拡張性** | Service Account を複数作成可能 | 新サービス追加時に既存環境に影響なし |
| **障害影響の局所化** | 一方のアカウント障害が他方に波及しにくい | 可用性向上 |

#### 代替案との比較

| パターン | メリット | デメリット | 採用判断 |
|---------|---------|-----------|---------|
| **Single Account** | シンプル、管理容易 | 責務混在、権限制御困難 | ❌ 不採用 |
| **3+ Accounts** | より細かい分離 | 管理複雑化、コスト増 | ❌ POC範囲外 |
| **Platform + Service (本採用)** | 適度な分離、拡張性確保 | 若干の複雑性 | ✅ 採用 |

### 2.2.3 アカウント間連携設計

#### Transit Gateway共有（RAM）

```yaml
# Platform Account側
TransitGatewayResourceShare:
  Type: AWS::RAM::ResourceShare
  Properties:
    Name: sample-app-tgw-share
    Principals:
      - arn:aws:iam::987654321098:root  # Service Account
    ResourceArns:
      - !Sub arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:transit-gateway/${TransitGateway}
    AllowExternalPrincipals: false
```

**設計ポイント**:
- RAM（Resource Access Manager）でTransit Gatewayを共有
- Service Accountは共有されたTGWにAttachment作成可能
- 権限は`AllowExternalPrincipals: false`で組織内に限定

#### クロスアカウント参照

| 参照元 | 参照先 | 方式 | 用途 |
|-------|-------|------|------|
| Service Account | Platform Account | Parameter Store | Transit Gateway ID取得 |
| Service Account | Platform Account | Parameter Store | Platform VPC CIDR取得（ルーティング用） |

**推奨方式**: CloudFormation ParametersでAccount IDとTransit Gateway IDを受け取る
- ❌ ハードコーディング（保守性低い）
- ✅ Parameters外部化（環境差分管理容易）

---

## 2.3 レイヤー構成設計

### 2.3.1 論理レイヤー構成

```
┌───────────────────────────────────────────────────────────┐
│  Presentation Layer (プレゼンテーション層)                  │
│  - Application Load Balancer (ALB)                        │
│  - Route 53 (将来実装)                                     │
│  - CloudFront (将来実装)                                   │
└───────────────────────────────────────────────────────────┘
                           ↓
┌───────────────────────────────────────────────────────────┐
│  Application Layer (アプリケーション層)                     │
│  - ECS Fargate Tasks (Public Web, Admin, Batch)          │
│  - ECR (Container Registry)                               │
│  - Secrets Manager (Application Secrets)                 │
└───────────────────────────────────────────────────────────┘
                           ↓
┌───────────────────────────────────────────────────────────┐
│  Data Layer (データ層)                                      │
│  - RDS PostgreSQL (Multi-AZ)                              │
│  - Parameter Store (Configuration)                        │
└───────────────────────────────────────────────────────────┘
                           ↓
┌───────────────────────────────────────────────────────────┐
│  Infrastructure Layer (インフラ層)                          │
│  - VPC (Shared / Service)                                 │
│  - Transit Gateway                                        │
│  - Client VPN                                             │
│  - NAT Gateway                                            │
└───────────────────────────────────────────────────────────┘
                           ↓
┌───────────────────────────────────────────────────────────┐
│  Monitoring & Operations Layer (監視・運用層)              │
│  - CloudWatch (Metrics, Logs, Alarms, Dashboard)         │
│  - SNS (Notifications)                                    │
│  - CloudTrail (Audit Logs)                                │
└───────────────────────────────────────────────────────────┘
```

### 2.3.2 物理配置設計（AZ構成）

#### Availability Zone配置

| リソース | AZ配置 | 理由 |
|---------|--------|------|
| **NAT Gateway** | Multi-AZ (1a, 1c) | 単一AZ障害時の可用性確保 |
| **RDS** | Multi-AZ (Primary: 1a, Standby: 1c) | 自動フェイルオーバー |
| **ECS Task** | Multi-AZ (1a, 1c) | ALBによる自動振り分け |
| **ALB** | Multi-AZ (1a, 1c) | ロードバランシング |
| **Transit Gateway** | Multi-AZ（自動） | AWSマネージドサービス |

#### 単一AZ障害時の動作

```
通常時:
  User → ALB (1a, 1c) → ECS Task (1a, 1c) → RDS Primary (1a)

AZ-1a 障害時:
  User → ALB (1c) → ECS Task (1c) → RDS Standby→Primary (1c)

  自動復旧内容:
  1. ALB が 1c のみ使用（ヘルスチェック失敗で自動除外）
  2. ECS Task は 1c で新規起動（Auto Healing）
  3. RDS は Standby が Primary に昇格（1-2分）
```

---

## 2.4 サービス構成設計

### 2.4.1 サービス一覧

| サービス名 | 用途 | アクセス経路 | 実行方式 |
|-----------|------|------------|---------|
| **Public Web** | 一般ユーザー向けWebアプリ | Internet → ALB → ECS | 常時起動 |
| **Admin Dashboard** | 管理者向けダッシュボード | VPN → ECS (Private IP) | 常時起動 |
| **Batch Processing** | データ処理・集計 | EventBridge Schedule → ECS | スケジュール実行 |

### 2.4.2 Public Web Service

**アーキテクチャ**:
```
Internet
   ↓ (HTTPS)
Application Load Balancer
   ↓ (HTTP)
ECS Fargate Task (複数)
   - Container: sample-app-public:latest
   - Port: 3000
   - Health Check: /health
   ↓ (PostgreSQL)
RDS PostgreSQL
```

**仕様**:
| 項目 | 仕様 |
|------|------|
| コンテナイメージ | sample-app/public:latest |
| vCPU | 0.5 |
| Memory | 1GB |
| 起動数 | 最小: 2, 最大: 4（将来Auto Scaling） |
| ヘルスチェック | GET /health (200 OK) |
| 環境変数 | DB_HOST, DB_PORT, DB_NAME, DB_USER (Secrets Manager) |

### 2.4.3 Admin Dashboard Service

**アーキテクチャ**:
```
On-Premises
   ↓ (Client VPN)
Transit Gateway
   ↓
Service VPC Private Subnet
   ↓ (HTTP, Private IP)
ECS Fargate Task
   - Container: sample-app-admin:latest
   - Port: 3000
   ↓ (PostgreSQL)
RDS PostgreSQL
```

**セキュリティ設計**:
- **インターネットアクセス不可**: ALB未接続
- **VPN経由のみアクセス可能**: Security GroupでVPN CIDR許可
- **内部IPアドレス**: Private Subnet配置

**仕様**:
| 項目 | 仕様 |
|------|------|
| コンテナイメージ | sample-app/admin:latest |
| vCPU | 0.5 |
| Memory | 1GB |
| 起動数 | 1（固定） |
| アクセス制御 | Security Group: 10.0.0.0/16のみ許可 |

### 2.4.4 Batch Processing Service

**アーキテクチャ**:
```
EventBridge Rule (Schedule)
   ↓ (Run Task)
ECS Fargate Task (Batch)
   - Container: sample-app-batch:latest
   - 実行後自動停止
   ↓ (PostgreSQL)
RDS PostgreSQL
   ↓ (処理結果)
CloudWatch Logs
```

**スケジュール**:
| 処理 | スケジュール | cron式 |
|------|------------|--------|
| 日次集計 | 毎日 AM 3:00 (JST) | cron(0 18 * * ? *) UTC |
| データクレンジング | 毎週日曜 AM 4:00 (JST) | cron(0 19 ? * SUN *) UTC |

**仕様**:
| 項目 | 仕様 |
|------|------|
| コンテナイメージ | sample-app/batch:latest |
| vCPU | 1.0 |
| Memory | 2GB |
| 起動数 | 0（スケジュール実行時のみ起動） |
| タイムアウト | 30分 |

---

## 2.5 データフロー設計

### 2.5.1 Public Webアクセスフロー

```
[User Browser]
    ↓
    1. HTTPS Request (GET /api/users)
    ↓
[Application Load Balancer]
    ↓
    2. Target Group ヘルスチェック確認
    ↓
[ECS Fargate Task - Public Web]
    ↓
    3. DB接続（connection pool）
    ↓
[RDS PostgreSQL]
    ↓
    4. SELECT * FROM users
    ↓
[ECS Fargate Task - Public Web]
    ↓
    5. JSON Response生成
    ↓
[Application Load Balancer]
    ↓
    6. HTTPS Response
    ↓
[User Browser]
```

**処理時間目標**:
- ALB → ECS: < 10ms
- ECS → RDS Query: < 50ms
- Total Response Time: < 500ms (P95)

### 2.5.2 Admin管理操作フロー

```
[Admin PC - On-Premises]
    ↓
    1. Client VPN接続
    ↓
[Platform Account - Client VPN Endpoint]
    ↓
    2. 認証・接続確立
    ↓
[Transit Gateway]
    ↓
    3. Shared VPC → Service VPC ルーティング
    ↓
[Service VPC - Private Subnet]
    ↓
    4. HTTP Request (Private IP)
    ↓
[ECS Fargate Task - Admin Dashboard]
    ↓
    5. 管理操作実行（ユーザー作成等）
    ↓
[RDS PostgreSQL]
    ↓
    6. INSERT/UPDATE/DELETE
    ↓
[ECS Fargate Task - Admin Dashboard]
    ↓
    7. 処理結果返却
    ↓
[Admin PC]
```

### 2.5.3 Batch処理フロー

```
[EventBridge Rule]
    ↓
    1. Schedule発火 (cron)
    ↓
[ECS Fargate - Run Task API]
    ↓
    2. Batch Task起動
    ↓
[ECS Fargate Task - Batch]
    ↓
    3. データ取得クエリ実行
    ↓
[RDS PostgreSQL]
    ↓
    4. 大量データ取得
    ↓
[ECS Fargate Task - Batch]
    ↓
    5. データ処理・集計
    ↓
    6. 結果書き込み
    ↓
[RDS PostgreSQL]
    ↓
    7. ログ出力
    ↓
[CloudWatch Logs]
    ↓
    8. Task自動停止
```

---

## 2.6 障害対応設計

### 2.6.1 障害シナリオと自動復旧

| 障害シナリオ | 検知方法 | 自動復旧 | 復旧時間 |
|------------|---------|---------|---------|
| **ECS Task異常終了** | ECS Service Health Check | 新Task自動起動 | 1-2分 |
| **ALB Target異常** | ALB Target Health Check | 異常Targetを除外 | 30秒 |
| **RDS Primary障害** | RDS Multi-AZ Failover | Standby→Primary昇格 | 1-2分 |
| **AZ障害** | 複数リソースの同時障害検知 | 正常AZのみ使用 | 自動（設計済み） |
| **NAT Gateway障害** | CloudWatch Metrics | Multi-AZ構成で影響局所化 | N/A |

### 2.6.2 手動対応が必要な障害

| 障害シナリオ | 検知方法 | 対応手順 |
|------------|---------|---------|
| **CloudFormationスタック更新失敗** | AWS Console / SNS通知 | Rollback実行 |
| **RDS接続数枯渇** | CloudWatch Alarm | Connection Pool設定見直し |
| **Dockerイメージビルド失敗** | GitHub Actions失敗 | ログ確認、修正、再実行 |
| **コスト超過** | AWS Budget Alert | リソース削減検討 |

---

## 2.7 拡張性設計

### 2.7.1 将来的な拡張シナリオ

| 拡張シナリオ | 現状設計での対応可否 | 必要な追加作業 |
|------------|----------------|--------------|
| **新サービス追加** | ✅ 対応可能 | ECS Task Definition追加、ALB Target Group追加 |
| **新拠点接続** | ✅ 対応可能 | Transit Gateway Attachment追加 |
| **本番/検証環境分離** | ✅ 対応可能 | Service Account追加、パラメータファイル追加 |
| **マルチリージョン** | ⚠️ 設計変更必要 | Global Accelerator、Aurora Global Database検討 |
| **Auto Scaling** | ✅ 対応可能 | ECS Service Auto Scaling設定追加 |

### 2.7.2 スケーラビリティ設計

**垂直スケーリング（Vertical Scaling）**:
| リソース | 現状 | 最大 | 変更方法 |
|---------|------|------|---------|
| ECS vCPU/Memory | 0.5 vCPU / 1GB | 4 vCPU / 30GB | Task Definition更新 |
| RDS Instance | db.t3.medium | db.r6g.4xlarge | CloudFormation更新 |

**水平スケーリング（Horizontal Scaling）**:
| リソース | 現状 | 拡張方法 |
|---------|------|---------|
| ECS Task数 | 固定2タスク | Auto Scaling Policy追加 |
| RDS Read Replica | 未実装 | Read Replica作成 |

---

**次へ**: [03_ネットワーク設計](03_ネットワーク設計.md)
