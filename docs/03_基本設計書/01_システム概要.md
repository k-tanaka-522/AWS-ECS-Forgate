# 01. システム概要

[← 目次に戻る](00_目次.md) | [次へ: 02_アーキテクチャ設計 →](02_アーキテクチャ設計.md)

---

## 1.1 プロジェクト背景

### 1.1.1 ビジネス背景

当社では、AWSを活用したシステム構築案件が増加しており、以下の技術的な課題が顕在化しています：

| 課題カテゴリ | 具体的な課題内容 | ビジネスインパクト |
|-----------|---------------|------------------|
| **Multi-Account構成** | 実装パターンが未確立 | 案件ごとに設計がバラつき、ナレッジ蓄積が困難 |
| **Transit Gateway** | 拠点間閉域接続の実装経験不足 | 顧客要件に対する技術的裏付けが弱い |
| **IaC (CloudFormation)** | スタック分割のベストプラクティス不明確 | 保守性・再利用性の低いコードが量産される |
| **コンテナ運用** | ECS Fargate の実装パターン未整備 | アプリケーションチームとの連携が非効率 |
| **統合監視** | CloudWatch 監視設計の標準化未実施 | 運用負荷が高く、障害検知が遅延 |

### 1.1.2 プロジェクト目的

本プロジェクトは、上記課題を解決するため、以下の目的で**技術検証・社内デモ用のリファレンスアーキテクチャ**を構築します：

#### 主要目的

1. **Transit Gatewayによる拠点間閉域接続の実装パターン確立**
   - Platform Account と Service Account の VPC 間接続を実現
   - Client VPN によるオンプレミス拠点を想定した閉域アクセスを実装
   - 将来的な拠点追加を考慮した拡張性のある設計を検証

2. **Multi-Account構成のベストプラクティス検証**
   - 共通基盤（Platform）とアプリケーション（Service）の責務分離を実現
   - Resource Access Manager (RAM) によるリソース共有パターンを確立
   - アカウント間のネットワーク接続・セキュリティ境界の設計を標準化

3. **CloudFormation実装パターンの確立**
   - ライフサイクル別スタック分割（Network/Storage/Compute/Monitoring）の実装
   - ネストスタックによる構造化手法の検証
   - Change Sets による安全なデプロイフローの確立

4. **3サービス構成の実装パターン確立**
   - Public Web（一般公開）、Admin（VPN経由）、Batch（スケジュール実行）の実装
   - ECS Fargate による サーバーレスコンテナ運用の標準化
   - マイクロサービス的なアーキテクチャパターンの検証

5. **CloudWatch統合監視パターンの確立**
   - ECS、RDS、ALB の統合監視ダッシュボード構築
   - SNS連携による異常検知アラートの実装
   - 運用を考慮したログ設計・保持ポリシーの標準化

#### 副次的目的

- 社内エンジニアの技術力向上（ハンズオン研修資料としての活用）
- 顧客提案時の技術デモ環境としての活用
- 新技術導入時の検証基盤としての活用

### 1.1.3 対象範囲

#### 対象範囲（In Scope）

| カテゴリ | 詳細内容 | 成果物 |
|---------|---------|--------|
| **インフラ基盤** | Platform Account: Shared VPC, Transit Gateway, Client VPN<br>Service Account: Service VPC, Transit Gateway Attachment | CloudFormationテンプレート一式 |
| **コンピュートリソース** | ECS Fargate Cluster, 3サービス (Public/Admin/Batch)<br>Application Load Balancer, Auto Scaling | CloudFormationテンプレート<br>Task Definition |
| **データストア** | RDS PostgreSQL Multi-AZ<br>Secrets Manager, Parameter Store | CloudFormationテンプレート<br>スキーマ定義 |
| **監視・ログ** | CloudWatch Alarms（約20個）<br>CloudWatch Dashboard<br>SNS Topic（通知用） | CloudFormationテンプレート |
| **アプリケーション** | Node.js 20 サンプルアプリ（モノレポ構成）<br>Dockerfile, Docker Compose | ソースコード一式 |
| **CI/CD** | GitHub Actions ワークフロー<br>ECR リポジトリ管理 | YAML定義ファイル |
| **ドキュメント** | 企画書、要件定義書、基本設計書<br>詳細設計書、運用手順書 | Markdownドキュメント |

#### 対象外範囲（Out of Scope）

| カテゴリ | 理由 | 将来的な対応 |
|---------|------|------------|
| **本番運用レベルのセキュリティ対策** | POC/デモ用途のため簡易実装 | 本番化時にWAF、GuardDuty等を追加 |
| **高度なCI/CDパイプライン** | 基本的なデプロイフローのみ実装 | Blue/Greenデプロイ、カナリアリリース等は将来検討 |
| **マルチリージョン構成** | コスト・複雑性を考慮し単一リージョン | グローバル展開時に検討 |
| **DR（災害対策）環境** | POC範囲外 | 本番運用時に別途設計 |
| **自動スケーリング詳細設計** | 基本設定のみ実装 | 本番運用時に負荷試験を実施して調整 |
| **コンテナイメージスキャン** | 基本的なセキュリティのみ実施 | ECR Image Scanningの詳細設定は将来検討 |

---

## 1.2 システム概要

### 1.2.1 システム構成概要

本システムは、AWS Multi-Account構成（Platform Account + Service Account）により、以下の構成を実現します：

```
┌───────────────────────────────────────────────────────────────┐
│                      Platform Account                          │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  Shared VPC (10.0.0.0/16)                                │ │
│  │  ┌────────────┐  ┌──────────────┐  ┌─────────────────┐  │ │
│  │  │ Transit    │  │ Client VPN   │  │ NAT Gateway     │  │ │
│  │  │ Gateway    │  │ Endpoint     │  │ (Multi-AZ)      │  │ │
│  │  └────────────┘  └──────────────┘  └─────────────────┘  │ │
│  └──────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘
                               ↕
                      Transit Gateway接続
                               ↕
┌───────────────────────────────────────────────────────────────┐
│                      Service Account                           │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  Service VPC (10.1.0.0/16)                               │ │
│  │  ┌────────────────────────────────────────────────────┐  │ │
│  │  │ Application Layer                                  │  │ │
│  │  │  ┌──────────┐  ┌──────────┐  ┌─────────────────┐  │  │ │
│  │  │  │ Public   │  │ Admin    │  │ Batch           │  │  │ │
│  │  │  │ Web      │  │ Dashboard│  │ Processing      │  │  │ │
│  │  │  │ (ECS)    │  │ (ECS)    │  │ (ECS)           │  │  │ │
│  │  │  │ Internet │  │ VPN Only │  │ Scheduled       │  │  │ │
│  │  │  └──────────┘  └──────────┘  └─────────────────┘  │  │ │
│  │  └────────────────────────────────────────────────────┘  │ │
│  │  ┌────────────────────────────────────────────────────┐  │ │
│  │  │ Data Layer                                         │  │ │
│  │  │  ┌─────────────────────────────────────────────┐   │  │ │
│  │  │  │ RDS PostgreSQL (Multi-AZ)                   │   │  │ │
│  │  │  │ - Primary (ap-northeast-1a)                 │   │  │ │
│  │  │  │ - Standby (ap-northeast-1c)                 │   │  │ │
│  │  │  └─────────────────────────────────────────────┘   │  │ │
│  │  └────────────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘
```

### 1.2.2 主要コンポーネント

#### Platform Account（共通基盤アカウント）

| コンポーネント | 役割 | 技術仕様 |
|-------------|------|---------|
| **Shared VPC** | 共通ネットワーク基盤 | CIDR: 10.0.0.0/16<br>Multi-AZ: ap-northeast-1a, 1c |
| **Transit Gateway** | VPC間接続ハブ | RAM共有でService Accountへ提供 |
| **Client VPN** | オンプレミス接続 | 管理者アクセス用（証明書認証） |
| **NAT Gateway** | インターネットアクセス | Multi-AZ構成（高可用性） |

#### Service Account（アプリケーションアカウント）

| コンポーネント | 役割 | 技術仕様 |
|-------------|------|---------|
| **Service VPC** | アプリケーションネットワーク | CIDR: 10.1.0.0/16<br>Multi-AZ: ap-northeast-1a, 1c |
| **ECS Fargate Cluster** | コンテナ実行基盤 | 3サービス（Public/Admin/Batch） |
| **Application Load Balancer** | L7ロードバランサー | Public Web用（HTTP/HTTPS） |
| **RDS PostgreSQL** | リレーショナルDB | Multi-AZ, 自動バックアップ有効 |
| **CloudWatch** | 統合監視 | Alarms + Dashboard + Logs |
| **ECR** | コンテナレジストリ | Private Repository（3サービス分） |

### 1.2.3 利用技術スタック

#### インフラストラクチャ

| レイヤー | 技術 | バージョン/仕様 | 選定理由 |
|---------|------|---------------|---------|
| **IaC** | AWS CloudFormation | - | AWSネイティブ、ネストスタック活用 |
| **ネットワーク** | AWS VPC, Transit Gateway | - | 拡張性・柔軟性が高い |
| **コンピュート** | Amazon ECS Fargate | - | サーバーレス、運用負荷低減 |
| **データベース** | Amazon RDS PostgreSQL | 16.x | オープンソース、実績豊富 |
| **ロードバランサー** | Application Load Balancer | - | HTTP/HTTPS対応、ECS統合 |
| **コンテナレジストリ** | Amazon ECR | - | ECS統合、スキャン機能あり |
| **シークレット管理** | AWS Secrets Manager | - | 自動ローテーション対応 |
| **パラメータ管理** | AWS Systems Manager Parameter Store | - | 非機密情報の管理 |

#### アプリケーション

| レイヤー | 技術 | バージョン | 選定理由 |
|---------|------|-----------|---------|
| **ランタイム** | Node.js | 20 LTS | 長期サポート、実績豊富 |
| **Webフレームワーク** | Express.js | 4.x | デファクトスタンダード |
| **DB接続** | node-postgres (pg) | 8.x | PostgreSQL公式推奨 |
| **コンテナ** | Docker | 24.x | 業界標準 |

#### CI/CD

| レイヤー | 技術 | 選定理由 |
|---------|------|---------|
| **CI/CD** | GitHub Actions | GitHub統合、設定が容易 |
| **バージョン管理** | Git (GitHub) | 業界標準 |

#### 監視・ログ

| レイヤー | 技術 | 用途 |
|---------|------|------|
| **メトリクス監視** | Amazon CloudWatch Metrics | リソース監視 |
| **アラート** | Amazon CloudWatch Alarms | 異常検知 |
| **ログ集約** | Amazon CloudWatch Logs | アプリケーション・システムログ |
| **ダッシュボード** | Amazon CloudWatch Dashboard | 可視化 |
| **通知** | Amazon SNS | メール・Slack通知 |

---

## 1.3 設計方針

### 1.3.1 アーキテクチャ設計方針

#### AWS Well-Architected Frameworkの適用

本システムは、AWS Well-Architected Frameworkの6つの柱に基づいて設計します：

| 柱 | 適用方針 | 具体的な実装 |
|----|---------|------------|
| **運用上の優秀性** | 自動化・コード化の徹底 | CloudFormation、GitHub Actions |
| **セキュリティ** | 最小権限の原則、暗号化 | IAM Role、Secrets Manager、KMS |
| **信頼性** | 障害自動復旧、Multi-AZ | RDS Multi-AZ、ECS Auto Healing |
| **パフォーマンス効率** | 適切なリソースサイジング | Fargate vCPU/Memory最適化 |
| **コスト最適化** | POC範囲での適切な選択 | t3インスタンス、Fargate Spot未使用 |
| **持続可能性** | リソース効率化 | オートスケーリング（将来実装） |

#### Multi-Account設計の基本原則

| 原則 | 説明 | 本プロジェクトでの適用 |
|------|------|-------------------|
| **責務の分離** | アカウントごとに役割を明確化 | Platform（共通基盤）/ Service（アプリ） |
| **セキュリティ境界** | アカウント境界でセキュリティ分離 | IAM、Security Group、NACLで多層防御 |
| **リソース分離** | 環境・用途ごとに分離 | 本番/検証は別アカウント（将来） |
| **コスト可視化** | アカウント単位で課金分離 | Cost Explorerでアカウント別分析可能 |

### 1.3.2 インフラ設計方針

| 方針 | 内容 | 根拠 |
|------|------|------|
| **Infrastructure as Code** | 全リソースをCloudFormationで管理 | 再現性・バージョン管理・レビュー可能性 |
| **スタック分割** | ライフサイクル別に分割 | 変更影響範囲の最小化、保守性向上 |
| **Change Sets必須** | 変更前に必ず差分確認 | 本番環境保護、予期せぬ変更防止 |
| **パラメータ外部化** | 環境差分をパラメータファイルで管理 | 環境ごとのテンプレート重複排除 |
| **Multi-AZ構成** | 単一AZ障害に対応 | 高可用性確保（RDS、NAT Gateway） |

### 1.3.3 セキュリティ設計方針

| 方針 | 内容 | 実装 |
|------|------|------|
| **最小権限の原則** | 必要最小限の権限のみ付与 | IAM Role/Policy細粒度設定 |
| **シークレット分離** | 機密情報をコードに含めない | Secrets Manager、Parameter Store |
| **暗号化** | データ保存時・転送時の暗号化 | RDS暗号化（KMS）、TLS通信 |
| **ネットワーク分離** | 公開/非公開リソースの分離 | Public/Private/Databaseサブネット |
| **アクセス制御** | 管理系は閉域接続のみ | Client VPN、Security Group |

### 1.3.4 運用設計方針

| 方針 | 内容 | 実装 |
|------|------|------|
| **監視の自動化** | 異常検知の自動化 | CloudWatch Alarms + SNS |
| **ログの集約** | ログ一元管理 | CloudWatch Logs、保持期間7日 |
| **バックアップ自動化** | データ損失対策 | RDS自動バックアップ（7日保持） |
| **デプロイ自動化** | 手動デプロイ廃止 | GitHub Actions CI/CD |
| **ロールバック対応** | 障害時の復旧手順確立 | CloudFormation Rollback |

### 1.3.5 アプリケーション設計方針

| 方針 | 内容 | 理由 |
|------|------|------|
| **モノレポ構成** | 3サービスを1リポジトリで管理 | コード共有、バージョン統一 |
| **コンテナ化** | Docker化、ECS Fargate実行 | 環境差分排除、スケーラビリティ |
| **12 Factor App** | クラウドネイティブ原則適用 | 環境変数設定、ステートレス |
| **ヘルスチェック実装** | ALB/ECS連携のヘルスチェック | 障害自動検知・復旧 |

---

## 1.4 成功基準

### 1.4.1 技術検証の成功基準

| 検証項目 | 成功基準 | 測定方法 |
|---------|---------|---------|
| **Transit Gateway接続** | Platform↔Service VPC間通信が成功する | ping疎通確認、レイテンシ < 50ms |
| **Client VPN接続** | VPN経由でAdmin Dashboardにアクセスできる | ブラウザアクセス確認 |
| **Multi-AZ構成** | AZ障害をシミュレートして自動復旧する | RDS Failover試験 |
| **CloudFormation** | 全スタックがエラーなくデプロイできる | Change Sets実行成功 |
| **ECS Fargate** | 3サービスが正常起動し、ヘルスチェックをパスする | ALB Target Health確認 |
| **CloudWatch監視** | 異常発生時にSNS通知が届く | 疑似障害でアラート発火確認 |
| **CI/CD** | GitHub ActionsでECSデプロイが成功する | ワークフロー実行成功 |

### 1.4.2 ドキュメント成果物の成功基準

| 成果物 | 完成基準 |
|-------|---------|
| **企画書** | 承認済み |
| **要件定義書** | 承認済み |
| **基本設計書** | 全12章完成、レビュー完了 |
| **詳細設計書** | CloudFormation仕様、デプロイ手順書完成 |
| **CloudFormationテンプレート** | 全スタック動作確認済み |
| **アプリケーションコード** | 3サービス実装完了、DB接続確認済み |
| **CI/CDワークフロー** | 自動デプロイ成功 |
| **運用手順書** | デプロイ手順、監視手順、障害対応手順記載 |

### 1.4.3 社内展開の成功基準

| 展開目的 | 成功基準 |
|---------|---------|
| **技術デモ** | 顧客向けデモンストレーションが実施できる |
| **ハンズオン研修** | 社内エンジニアがCloudFormationデプロイを体験できる |
| **ナレッジ共有** | 設計書が社内wikiに公開され、参照される |
| **プロジェクト適用** | 実案件でリファレンスとして参照される |

---

## 1.5 制約事項

### 1.5.1 技術的制約

| 制約項目 | 内容 | 対応方針 |
|---------|------|---------|
| **リージョン** | ap-northeast-1（東京）のみ | POC範囲、将来的にマルチリージョン検討 |
| **AWSアカウント** | 2アカウント（Platform/Service）のみ | 本番/検証環境は将来的に追加 |
| **CloudFormation制約** | 論理ID、パラメータ名は英数字のみ | 技術標準準拠、日本語コメントのみ使用 |
| **RDSインスタンスタイプ** | t3系（POC用） | 本番時にr6g等に変更 |
| **ECS vCPU/Memory** | 小規模構成（0.5vCPU/1GB） | 負荷試験後に調整 |

### 1.5.2 プロジェクト制約

| 制約項目 | 内容 | 影響 |
|---------|------|------|
| **予算** | 月額$500以内（POC期間） | 高性能インスタンス使用不可 |
| **期間** | 設計〜実装〜検証: 4週間 | 高度な機能は将来実装 |
| **人員** | 技術検証担当: 1名 | ペアレビュー等は社内協力 |

### 1.5.3 非機能制約

| 制約項目 | 内容 | 許容範囲 |
|---------|------|---------|
| **可用性** | POC環境のためSLA未設定 | 99.9%を目標 |
| **性能** | 負荷試験未実施 | レスポンスタイム1秒以内を目標 |
| **セキュリティ** | WAF、GuardDuty等は未導入 | 基本的なSecurity Group設定のみ |
| **バックアップ** | RDS 7日間保持のみ | 長期保存は未対応 |

---

## 1.6 前提条件

### 1.6.1 AWSアカウント

| 項目 | 前提条件 |
|------|---------|
| **アカウント数** | 2つのAWSアカウントが利用可能 |
| **Organizations** | AWS Organizations未使用（将来的に導入検討） |
| **RAM共有** | Platform AccountからService AccountへRAM共有が可能 |
| **権限** | AdministratorAccess相当の権限を保有 |

### 1.6.2 ネットワーク

| 項目 | 前提条件 |
|------|---------|
| **CIDR重複** | 10.0.0.0/16、10.1.0.0/16が他VPCと重複しない |
| **Transit Gateway Quota** | Attachment数の上限に達していない |
| **VPN証明書** | Client VPN用の証明書を事前作成 |

### 1.6.3 外部サービス

| 項目 | 前提条件 |
|------|---------|
| **GitHub** | GitHubリポジトリが利用可能 |
| **GitHub Actions** | Secrets設定が可能 |
| **Slack（オプション）** | SNS通知連携用（将来実装） |

---

## 1.7 リスクと対策

### 1.7.1 技術リスク

| リスク | 発生確率 | 影響度 | 対策 |
|-------|---------|--------|------|
| **Transit Gateway接続失敗** | 低 | 高 | 事前にAWS公式ドキュメント確認、検証環境で試行 |
| **CloudFormationスタック削除失敗** | 中 | 中 | DeletionPolicy設定、手動削除手順準備 |
| **RDS接続エラー** | 低 | 高 | Security Group設定レビュー、接続試験 |
| **ECS起動失敗** | 中 | 中 | Task Definition検証、ログ確認手順確立 |
| **コスト超過** | 中 | 中 | Cost Explorerで日次監視、予算アラート設定 |

### 1.7.2 プロジェクトリスク

| リスク | 発生確率 | 影響度 | 対策 |
|-------|---------|--------|------|
| **スケジュール遅延** | 中 | 中 | MVP範囲を明確化、優先順位付け |
| **要件変更** | 低 | 中 | POC範囲を厳格に管理 |
| **ナレッジ不足** | 中 | 低 | AWS公式ドキュメント参照、社内有識者相談 |

---

**次へ**: [02_アーキテクチャ設計](02_アーキテクチャ設計.md)
