# 07. 非機能要件対応

> AWS Multi-Account Sample Application - 基本設計書

[← 前へ: 監視・運用設計](06_監視・運用設計.md) | [目次に戻る](00_目次.md)

---

## 1. 非機能要件対応一覧

**参照**: `docs/02_要件定義書.md` - 非機能要件セクション

| 非機能要件カテゴリ | 要求レベル | 対応状況 | 備考 |
|----------------|----------|---------|------|
| **性能要件** | 中 | ✅ 対応済み | レスポンス3秒以内 |
| **可用性要件** | 高 | ✅ 対応済み | 99%以上（Multi-AZ） |
| **セキュリティ要件** | 高 | ✅ 対応済み | TLS、暗号化、VPN |
| **保守性要件** | 中 | ✅ 対応済み | CloudWatch監視 |
| **スケーラビリティ** | 低 | ⚠️ 部分対応 | 固定構成（将来対応） |

---

## 2. 性能要件への対応

### 2.1 要件

| 項目 | 要求値 | 現フェーズ目標 |
|-----|-------|--------------|
| **レスポンスタイム** | 3秒以内 | 1-2秒（軽量画面） |
| **同時接続数** | 100ユーザー | 10-20ユーザー（検証用） |
| **スループット** | 100 req/sec | 10 req/sec（検証用） |

### 2.2 設計での対応

#### 2.2.1 インフラ

| 対応策 | 効果 | 実装箇所 |
|-------|------|---------|
| **ALB による負荷分散** | リクエスト分散 | Public/Admin ALB |
| **ECS Fargate 複数Task** | 並列処理 | DesiredCount: 2 |
| **RDS Multi-AZ** | 高可用性 | RDS PostgreSQL |
| **CloudFront（将来）** | 静的コンテンツ高速化 | 未実装 |

#### 2.2.2 アプリケーション

| 対応策 | 効果 | 実装箇所 |
|-------|------|---------|
| **DB接続プーリング** | 接続オーバーヘッド削減 | `pg.Pool` 使用 |
| **非同期処理** | レスポンス時間短縮 | Batch処理分離 |
| **軽量フレームワーク** | 起動時間短縮 | Express.js |

**実装例**:

```javascript
// app/public/src/index.js
const { Pool } = require('pg');

// 接続プーリング
const pool = new Pool({
  max: 10,        // 最大接続数
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
```

### 2.3 性能測定

**ツール**: Apache Bench / JMeter（将来実装）

```bash
# レスポンスタイム測定例
ab -n 100 -c 10 https://your-alb-endpoint/
```

---

## 3. 可用性要件への対応

### 3.1 要件

| 項目 | 要求値 | 現フェーズ目標 |
|-----|-------|--------------|
| **稼働率** | 99%以上 | 99%（月次ダウンタイム7時間以内） |
| **RTO（復旧時間）** | 1時間以内 | 30分以内 |
| **RPO（データ損失）** | 24時間以内 | 24時間以内 |

### 3.2 設計での対応

#### 3.2.1 Multi-AZ構成

```
ap-northeast-1a          ap-northeast-1c
─────────────────────   ─────────────────────
  ECS Task (Public)       ECS Task (Public)
  ECS Task (Admin)        ECS Task (Admin)
  RDS Primary             RDS Standby
```

**効果**:
- 単一AZ障害時も継続稼働
- RDS自動フェイルオーバー（2-5分）
- ECS Taskは別AZで自動起動

#### 3.2.2 バックアップ・リストア

| バックアップ対象 | 頻度 | 保持期間 | リストア時間 |
|--------------|------|---------|------------|
| **RDS自動バックアップ** | 日次 | 7日 | 20-30分 |
| **RDSスナップショット** | 手動 | 無期限 | 20-30分 |

---

## 4. セキュリティ要件への対応

### 4.1 要件

| 項目 | 要求レベル | 対応状況 |
|-----|----------|---------|
| **通信暗号化** | 必須 | ✅ TLS 1.2以上 |
| **データ暗号化** | 必須 | ✅ AES-256（RDS/EBS/S3） |
| **認証・認可** | 必須 | ⚠️ 検証用簡易実装 |
| **監査ログ** | 推奨 | ✅ CloudWatch Logs |
| **アクセス制御** | 必須 | ✅ SecurityGroup/VPN |

### 4.2 設計での対応

**詳細**: [05_セキュリティ設計.md](05_セキュリティ設計.md) を参照

**主要対応**:
- ALB HTTPS Listener（TLS 1.2以上）
- RDS KMS暗号化
- Admin Dashboard VPN経由のみアクセス可
- Secrets Manager でシークレット管理
- VPCフローログ有効化

### 4.3 将来的な本番化対応

- [ ] AWS Cognito User Pools（認証）
- [ ] MFA（多要素認証）
- [ ] AWS IAM Identity Center（SSO）
- [ ] AWS CloudTrail（API監査）
- [ ] AWS Config（コンプライアンス監視）

---

## 5. 保守性要件への対応

### 5.1 要件

| 項目 | 要求内容 | 対応状況 |
|-----|---------|---------|
| **監視・アラート** | リアルタイム検知 | ✅ CloudWatch Alarms |
| **ログ保存** | 30日以上 | ✅ 30日（CW Logs）、90日（S3） |
| **ドキュメント** | 設計書・運用手順 | ✅ 本ドキュメント群 |
| **コード品質** | リーダブル・保守可能 | ✅ 技術標準適用 |

### 5.2 設計での対応

#### 5.2.1 監視

**詳細**: [06_監視・運用設計.md](06_監視・運用設計.md) を参照

- CloudWatch Dashboard（統合ビュー）
- CloudWatch Alarms（CPU/メモリ/エラー）
- 構造化ログ（JSON形式）

#### 5.2.2 IaC（Infrastructure as Code）

| IaCツール | 対象 | 効果 |
|----------|------|------|
| **CloudFormation** | インフラ全体 | 再現性・バージョン管理 |

**メリット**:
- 環境の再構築が容易
- 変更履歴の追跡
- 手動作業によるミス削減

#### 5.2.3 ドキュメント体系

```
docs/
├── 01_企画書.md
├── 02_要件定義書.md
├── 03_基本設計書/           # 本ドキュメント群
│   ├── 00_目次.md
│   ├── 01_システム概要.md
│   ├── 02_アーキテクチャ設計.md
│   ├── 03_インフラ設計.md
│   ├── 04_アプリケーション設計.md
│   ├── 05_セキュリティ設計.md
│   ├── 06_監視・運用設計.md
│   └── 07_非機能要件対応.md
└── 04_詳細設計書/
    ├── 01_CloudFormation詳細設計.md
    ├── 02_データベース詳細設計.md
    ├── 03_アプリケーション詳細設計.md
    └── 04_監視詳細設計.md
```

---

## 6. スケーラビリティ要件への対応

### 6.1 現フェーズ

**固定構成**（検証・デモ用）:
- ECS Task 固定（DesiredCount: 2）
- RDS 固定（db.t3.medium）
- Auto Scaling 未実装

### 6.2 将来的な本番化対応

#### 6.2.1 ECS Auto Scaling

```yaml
# Target Tracking Scaling（CPU使用率ベース）
ScalingPolicy:
  Type: AWS::ApplicationAutoScaling::ScalingPolicy
  Properties:
    PolicyType: TargetTrackingScaling
    TargetTrackingScalingPolicyConfiguration:
      TargetValue: 70.0
      PredefinedMetricSpecification:
        PredefinedMetricType: ECSServiceAverageCPUUtilization

ScalableTarget:
  Properties:
    MinCapacity: 2
    MaxCapacity: 10
```

**効果**:
- トラフィック増加時に自動スケールアウト
- トラフィック減少時に自動スケールイン
- コスト最適化

#### 6.2.2 RDS Read Replica

```yaml
# 読み取り負荷分散
ReadReplica:
  Type: AWS::RDS::DBInstance
  Properties:
    SourceDBInstanceIdentifier: !Ref DBInstance
    DBInstanceClass: db.t3.medium
```

**効果**:
- 読み取りクエリの負荷分散
- レポート処理の分離

---

## 7. 運用要件への対応

### 7.1 要件

| 項目 | 要求内容 | 対応状況 |
|-----|---------|---------|
| **デプロイ自動化** | CI/CD | ⚠️ 手動デプロイ（検証用） |
| **ロールバック** | 5分以内 | ✅ CloudFormation Rollback |
| **障害復旧手順** | ドキュメント化 | ✅ 本ドキュメント参照 |

### 7.2 将来的な本番化対応

#### 7.2.1 CI/CD パイプライン

```yaml
# .github/workflows/deploy.yml（案）
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy-infra:
    steps:
      - name: Deploy CloudFormation
        run: |
          aws cloudformation deploy \
            --template-file infra/cloudformation/service/01-network.yaml \
            --stack-name sample-service-network

  deploy-app:
    steps:
      - name: Build and Push Docker Image
        run: |
          docker build -t $ECR_REPO:$TAG .
          docker push $ECR_REPO:$TAG

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster sample-cluster \
            --service sample-public \
            --force-new-deployment
```

---

## 8. コンプライアンス要件への対応

### 8.1 現フェーズ

**検証・デモ用のため、コンプライアンス要件は最小限**。

### 8.2 将来的な本番化対応

| 要件 | 対応策 |
|-----|-------|
| **個人情報保護** | データ暗号化、アクセス制御、監査ログ |
| **GDPR対応** | データ削除機能、同意管理 |
| **SOC 2対応** | CloudTrail、AWS Config、定期監査 |

---

## 9. 非機能要件対応チェックリスト

### 9.1 現フェーズ（検証・デモ用）

- [x] **性能**: レスポンス3秒以内、同時接続10-20ユーザー
- [x] **可用性**: 99%以上、Multi-AZ構成、RTO 30分
- [x] **セキュリティ**: TLS 1.2+、暗号化、VPN、Secrets Manager
- [x] **保守性**: CloudWatch監視、構造化ログ、ドキュメント
- [ ] **スケーラビリティ**: 固定構成（Auto Scaling未実装）
- [ ] **運用**: 手動デプロイ（CI/CD未実装）

### 9.2 将来的な本番化対応チェックリスト

- [ ] ECS Auto Scaling 実装
- [ ] RDS Read Replica 実装
- [ ] CloudFront（CDN）導入
- [ ] AWS Cognito 認証実装
- [ ] CI/CD パイプライン構築
- [ ] AWS CloudTrail 有効化
- [ ] AWS Config ルール設定
- [ ] 負荷テスト実施

---

## 10. まとめ

本システムは、検証・デモ用として以下の非機能要件を満たしています：

| カテゴリ | 対応レベル | 備考 |
|---------|----------|------|
| **性能** | ✅ 十分 | 軽量構成、レスポンス良好 |
| **可用性** | ✅ 十分 | Multi-AZ、自動復旧 |
| **セキュリティ** | ✅ 十分 | 暗号化、VPN、Secrets Manager |
| **保守性** | ✅ 十分 | 監視、ログ、ドキュメント完備 |
| **スケーラビリティ** | ⚠️ 限定的 | 固定構成（将来拡張可能） |
| **運用** | ⚠️ 基本対応 | 手動デプロイ（CI/CD未実装） |

**本番化に向けた次のステップ**:
1. Auto Scaling 実装
2. CI/CD パイプライン構築
3. AWS Cognito 認証実装
4. 負荷テスト実施
5. CloudTrail・AWS Config 有効化

---

**ドキュメントナビゲーション**:
- [← 前へ: 監視・運用設計](06_監視・運用設計.md)
- [目次に戻る](00_目次.md)

---

**基本設計書の完了**

これで基本設計書のすべてのセクションを網羅しました。
次は、詳細設計書（`docs/04_詳細設計書/`）を参照して実装を進めます。
