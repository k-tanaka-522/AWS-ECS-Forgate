# 06. 監視・運用設計

> AWS Multi-Account Sample Application - 基本設計書

[← 前へ: セキュリティ設計](05_セキュリティ設計.md) | [目次に戻る](00_目次.md) | [次へ: 非機能要件対応 →](07_非機能要件対応.md)

---

## 1. 監視設計

### 1.1 監視項目

| カテゴリ | 監視項目 | ツール | アラート閾値 |
|---------|---------|--------|------------|
| **インフラ** | ECS CPU使用率 | CloudWatch | 80%以上 |
| **インフラ** | ECS メモリ使用率 | CloudWatch | 80%以上 |
| **インフラ** | RDS CPU使用率 | CloudWatch | 80%以上 |
| **インフラ** | RDS 接続数 | CloudWatch | 80件以上 |
| **インフラ** | RDS ストレージ残量 | CloudWatch | 20%未満 |
| **アプリ** | ALB 5xxエラー | CloudWatch | 10件/5分 |
| **アプリ** | ALB レイテンシ | CloudWatch | 3秒以上 |
| **アプリ** | ECS Task異常終了 | CloudWatch | 1件以上 |

### 1.2 CloudWatch Alarms

**参照**: `infra/cloudformation/service/04-monitoring.yaml`

#### 1.2.1 ECS監視

```yaml
# CPU使用率アラーム
ECSCpuAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub "${ProjectName}-${Environment}-ecs-cpu-high"
    MetricName: CPUUtilization
    Threshold: 80
    ComparisonOperator: GreaterThanThreshold
    EvaluationPeriods: 2
    Period: 300
```

#### 1.2.2 RDS監視

```yaml
# RDS CPU使用率アラーム
RDSCpuAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub "${ProjectName}-${Environment}-rds-cpu-high"
    MetricName: CPUUtilization
    Threshold: 80
    ComparisonOperator: GreaterThanThreshold
    EvaluationPeriods: 2
    Period: 300
```

#### 1.2.3 ALB監視

```yaml
# ALB 5xxエラーアラーム
ALB5xxAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub "${ProjectName}-${Environment}-alb-5xx-high"
    MetricName: HTTPCode_Target_5XX_Count
    Threshold: 10
    ComparisonOperator: GreaterThanThreshold
    EvaluationPeriods: 1
    Period: 300
```

### 1.3 CloudWatch Dashboard

**ダッシュボード構成**:

```
┌─────────────────────────────────────┐
│ AWS Multi-Account Sample Dashboard │
├─────────────────────────────────────┤
│ [ECS Metrics]                       │
│ - CPU使用率                          │
│ - メモリ使用率                        │
│ - Running Task数                     │
├─────────────────────────────────────┤
│ [RDS Metrics]                       │
│ - CPU使用率                          │
│ - 接続数                             │
│ - ストレージ使用率                     │
├─────────────────────────────────────┤
│ [ALB Metrics]                       │
│ - リクエスト数                        │
│ - レイテンシ                          │
│ - 5xx/4xxエラー数                     │
└─────────────────────────────────────┘
```

---

## 2. ログ設計

### 2.1 ログ種別と出力先

| ログ種別 | 出力先 | 保持期間 | フォーマット |
|---------|--------|---------|------------|
| **アプリケーションログ** | CloudWatch Logs | 30日 | JSON |
| **ALBアクセスログ** | S3 | 90日 | TSV（デフォルト） |
| **VPCフローログ** | CloudWatch Logs | 30日 | デフォルト形式 |
| **CloudTrail** | S3 | 1年 | JSON（将来実装） |

### 2.2 アプリケーションログフォーマット

**JSON形式（構造化ログ）**:

```json
{
  "timestamp": "2025-10-22T10:30:00.000Z",
  "level": "INFO",
  "service": "public-web",
  "message": "User accessed homepage",
  "userId": "user123",
  "requestId": "req-abc-123",
  "duration": 120,
  "statusCode": 200
}
```

**ログレベル**:
- `ERROR`: エラー発生時（即座に対応必要）
- `WARN`: 警告（監視必要）
- `INFO`: 重要な情報（ユーザーアクション等）
- `DEBUG`: デバッグ情報（開発環境のみ）

### 2.3 CloudWatch Logs ロググループ

| ロググループ | 内容 | 保持期間 |
|------------|------|---------|
| `/aws/ecs/sample-public` | Public Web ログ | 30日 |
| `/aws/ecs/sample-admin` | Admin Dashboard ログ | 30日 |
| `/aws/ecs/sample-batch` | Batch処理ログ | 30日 |
| `/aws/vpc/flowlogs` | VPCフローログ | 30日 |

---

## 3. バックアップ設計

### 3.1 RDS自動バックアップ

| 項目 | 設定値 | 備考 |
|-----|-------|------|
| **バックアップ保持期間** | 7日 | CloudFormationで設定 |
| **バックアップウィンドウ** | 03:00-04:00 JST | 利用者の少ない時間帯 |
| **スナップショット** | 自動（日次） | Multi-AZ有効時 |

**CloudFormation設定**:

```yaml
DBInstance:
  Type: AWS::RDS::DBInstance
  Properties:
    BackupRetentionPeriod: 7
    PreferredBackupWindow: "18:00-19:00"  # UTC（日本時間03:00-04:00）
    MultiAZ: true
```

### 3.2 リストア手順（概要）

1. AWS Console → RDS → Snapshots
2. 復元したいスナップショットを選択
3. "Restore Snapshot" をクリック
4. 新しいDBインスタンス名を指定
5. 復元完了後、アプリケーションの接続先を変更

---

## 4. 障害復旧設計

### 4.1 復旧目標

| 項目 | 目標値 | 備考 |
|-----|-------|------|
| **RTO（復旧時間目標）** | 30分以内 | データベース障害時 |
| **RPO（復旧ポイント目標）** | 24時間以内 | データ損失許容範囲 |

### 4.2 障害シナリオ別復旧手順

#### 4.2.1 ECS Task障害

**検知**: CloudWatch Alarm → ECS Task異常終了

**復旧手順**:
1. ECS Service の Auto Scaling が自動的に新しいTaskを起動
2. CloudWatch Logs でエラー原因を調査
3. 必要に応じてアプリケーションコード修正

**復旧時間**: 3-5分（自動）

#### 4.2.2 RDS障害（Multi-AZ切り替え）

**検知**: CloudWatch Alarm → RDS接続不可

**復旧手順**:
1. Multi-AZ構成により自動フェイルオーバー
2. 接続先エンドポイントは変わらず、アプリは自動再接続
3. CloudWatch Logs でフェイルオーバーログを確認

**復旧時間**: 2-5分（自動）

#### 4.2.3 AZ障害

**影響範囲**: 単一AZ内のリソース

**復旧手順**:
1. ECS Service が別AZでTaskを起動
2. Multi-AZ RDS が自動フェイルオーバー
3. ALBが正常なターゲットにのみルーティング

**復旧時間**: 5-10分（自動）

---

## 5. 運用手順

### 5.1 定常運用

| 運用項目 | 頻度 | 担当 | 内容 |
|---------|------|------|------|
| **監視ダッシュボード確認** | 毎日 | 運用担当 | CloudWatch Dashboard確認 |
| **アラート対応** | 随時 | 運用担当 | アラート発生時の調査・対応 |
| **ログ確認** | 週次 | 運用担当 | エラーログの傾向分析 |
| **バックアップ確認** | 週次 | 運用担当 | RDSバックアップ成功確認 |

### 5.2 保守作業

| 保守項目 | 頻度 | ダウンタイム | 内容 |
|---------|------|------------|------|
| **RDSメンテナンスウィンドウ** | 月次 | 数分 | パッチ適用 |
| **ECS Taskイメージ更新** | 随時 | なし | ローリングアップデート |
| **セキュリティパッチ適用** | 随時 | なし | Fargateは自動適用 |

---

## 6. スケーリング設計

### 6.1 ECS Auto Scaling

**現フェーズ**: 未実装（検証・デモ用のため固定タスク数）

**将来的な本番化対応**:

```yaml
# Target Tracking Scaling Policy
ScalingPolicy:
  Type: AWS::ApplicationAutoScaling::ScalingPolicy
  Properties:
    PolicyType: TargetTrackingScaling
    TargetTrackingScalingPolicyConfiguration:
      TargetValue: 70.0  # CPU使用率70%を目標
      PredefinedMetricSpecification:
        PredefinedMetricType: ECSServiceAverageCPUUtilization
```

### 6.2 RDSスケーリング

**垂直スケーリング（インスタンスタイプ変更）**:
- 手動操作（数分のダウンタイム発生）
- Multi-AZ構成により影響最小化

**水平スケーリング（Read Replica）**:
- 将来実装（読み取り負荷分散）

---

## 7. コスト管理

### 7.1 現フェーズのコスト（月額概算）

| サービス | 月額概算 | 備考 |
|---------|---------|------|
| ECS Fargate | $25 | 3サービス × 0.5vCPU × 1GB |
| RDS PostgreSQL | $100 | db.t3.medium Multi-AZ |
| ALB | $25 | 2個（Public + Admin） |
| Client VPN | $75 | エンドポイント時間課金 |
| **合計** | **$225** | 検証・デモ用最小構成 |

### 7.2 コスト最適化

- **検証終了後**: Client VPNエンドポイント削除（$75削減）
- **本番化時**: Reserved InstancesまたはSavings Plansの検討

---

## 8. 次のステップ

監視・運用設計を理解したら、次は非機能要件への対応を確認します。

**次のドキュメント**: [07_非機能要件対応.md](07_非機能要件対応.md)

---

**ドキュメントナビゲーション**:
- [← 前へ: セキュリティ設計](05_セキュリティ設計.md)
- [目次に戻る](00_目次.md)
- [次へ: 非機能要件対応 →](07_非機能要件対応.md)
