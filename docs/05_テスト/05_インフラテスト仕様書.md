# インフラテスト仕様書

> AWS Multi-Account Sample Application
> Infrastructure Test Specification

---

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | AWS Multi-Account Sample Application |
| 文書バージョン | 1.0 |
| 作成日 | 2025-10-22 |
| 最終更新日 | 2025-10-22 |
| 関連ドキュメント | テスト計画書、基本設計書 |

---

## 2. テスト概要

### 2.1 目的

CloudFormationによるインフラストラクチャのデプロイおよび構成が設計通りに実装されていることを検証する。

### 2.2 スコープ

- Platform Account インフラストラクチャ
- Service Account インフラストラクチャ
- Multi-Account間の接続性
- Transit Gateway構成
- VPN接続
- ネットワーク疎通性

### 2.3 テスト環境

| 項目 | 値 |
|------|-----|
| 環境 | dev |
| AWSリージョン | ap-northeast-1 |
| Platform Account | AWS Account 1 |
| Service Account | AWS Account 2 |

---

## 3. CloudFormationスタックデプロイテスト

### 3.1 Platform Accountデプロイテスト

| No | テスト項目 | テスト手順 | 期待結果 | 確認方法 |
|----|----------|----------|---------|---------|
| 1 | Shared VPC Stack作成 | `deploy.sh dev`実行 | スタック作成成功 | AWS Console確認、`aws cloudformation describe-stacks` |
| 2 | Transit Gateway Stack作成 | 自動デプロイ（ネストスタック） | スタック作成成功 | AWS Console確認、Transit Gateway IDが出力される |
| 3 | Client VPN Stack作成 | 自動デプロイ（ネストスタック） | スタック作成成功 | AWS Console確認、VPN Endpoint IDが出力される |
| 4 | スタック削除 | `aws cloudformation delete-stack` | スタック削除成功 | 依存関係エラーなく削除完了 |
| 5 | スタック再作成（冪等性） | `deploy.sh dev`再実行 | スタック作成成功 | 同じ構成で再作成される |

### 3.2 Service Accountデプロイテスト

| No | テスト項目 | テスト手順 | 期待結果 | 確認方法 |
|----|----------|----------|---------|---------|
| 6 | Network Stack作成 | `deploy.sh dev`実行 | スタック作成成功（VPC、Subnet、IGW、NAT） | AWS Console確認 |
| 7 | Database Stack作成 | Network完了後、自動デプロイ | RDS PostgreSQL作成成功（Multi-AZ） | RDS Console確認、エンドポイント出力 |
| 8 | Compute Stack作成 | Database完了後、自動デプロイ | ECS Cluster、ALB作成成功 | ECS Console確認、ALB DNS出力 |
| 9 | Monitoring Stack作成 | Compute完了後、自動デプロイ | CloudWatch Alarms作成成功 | CloudWatch Console確認 |
| 10 | スタック依存関係検証 | スタック削除時の順序 | 依存関係順に削除される（Monitoring→Compute→Database→Network） | エラーなく削除完了 |

---

## 4. Transit Gateway接続テスト

### 4.1 Transit Gateway Attachment検証

| No | テスト項目 | 検証内容 | 期待結果 | 確認コマンド |
|----|----------|---------|---------|-------------|
| 11 | TGW Attachment作成 | Platform VPC Attachmentが作成される | Status: available | `aws ec2 describe-transit-gateway-attachments` |
| 12 | TGW Attachment作成 | Service VPC Attachmentが作成される | Status: available | `aws ec2 describe-transit-gateway-attachments` |
| 13 | TGW Route Table | Platform VPC向けルートが登録される | 10.1.0.0/16 → Service VPC | `aws ec2 describe-transit-gateway-route-tables` |
| 14 | TGW Route Table | Service VPC向けルートが登録される | 10.0.0.0/16 → Platform VPC | `aws ec2 describe-transit-gateway-route-tables` |

### 4.2 Cross-Account接続検証

| No | テスト項目 | 検証内容 | 期待結果 | 確認方法 |
|----|----------|---------|---------|---------|
| 15 | Resource Share作成 | Platform AccountでResource Share作成 | 正常作成 | AWS RAM Console確認 |
| 16 | Resource Share受諾 | Service AccountでResource Share受諾 | 正常受諾 | AWS RAM Console確認 |
| 17 | TGW可視性 | Service AccountでTransit Gatewayが参照可能 | TGW IDが参照可能 | `aws ec2 describe-transit-gateways` |

---

## 5. ネットワーク疎通テスト

### 5.1 VPC間疎通テスト

| No | テスト項目 | 送信元 | 宛先 | 期待結果 | テスト方法 |
|----|----------|--------|------|---------|----------|
| 18 | Platform → Service | Platform VPC Private Subnet | Service VPC Private Subnet (10.1.10.0/24) | 疎通成功 | EC2インスタンス起動、`ping` / `telnet` |
| 19 | Service → Platform | Service VPC Private Subnet | Platform VPC Private Subnet (10.0.10.0/24) | 疎通成功 | EC2インスタンス起動、`ping` / `telnet` |
| 20 | Public → Internet | Service VPC Public Subnet | 8.8.8.8 | 疎通成功（IGW経由） | `curl https://www.google.com` |
| 21 | Private → Internet | Service VPC Private Subnet | 8.8.8.8 | 疎通成功（NAT Gateway経由） | `curl https://www.google.com` |

### 5.2 VPN接続テスト

| No | テスト項目 | 検証内容 | 期待結果 | 確認方法 |
|----|----------|---------|---------|---------|
| 22 | Client VPN Endpoint作成 | Platform AccountでVPN Endpoint作成 | Status: available | AWS Console確認 |
| 23 | VPN設定ファイルダウンロード | AWS Consoleから設定ファイル取得 | .ovpnファイル取得成功 | ダウンロード確認 |
| 24 | VPN接続 | OpenVPN Clientで接続 | 接続成功 | クライアントログ確認 |
| 25 | VPN経由疎通 | VPN接続後、Service VPC Private Subnetへping | 疎通成功 | `ping 10.1.10.10` |
| 26 | Admin Dashboard接続 | VPN経由でAdmin用ALBへHTTPアクセス | HTTP 200応答 | `curl http://<admin-alb-dns>` |

---

## 6. リソース構成検証テスト

### 6.1 VPC/Subnet構成検証

| No | テスト項目 | 検証内容 | 期待値 | 確認コマンド |
|----|----------|---------|--------|-------------|
| 27 | Platform VPC CIDR | Platform VPC CIDRブロック | 10.0.0.0/16 | `aws ec2 describe-vpcs --vpc-ids <vpc-id>` |
| 28 | Platform Public Subnet | Public Subnet CIDR（AZ-a） | 10.0.1.0/24 | `aws ec2 describe-subnets` |
| 29 | Platform Public Subnet | Public Subnet CIDR（AZ-c） | 10.0.2.0/24 | `aws ec2 describe-subnets` |
| 30 | Platform Private Subnet | Private Subnet CIDR（AZ-a） | 10.0.10.0/24 | `aws ec2 describe-subnets` |
| 31 | Platform Private Subnet | Private Subnet CIDR（AZ-c） | 10.0.20.0/24 | `aws ec2 describe-subnets` |
| 32 | Service VPC CIDR | Service VPC CIDRブロック | 10.1.0.0/16 | `aws ec2 describe-vpcs --vpc-ids <vpc-id>` |
| 33 | Service Public Subnet | Public Subnet CIDR（AZ-a） | 10.1.1.0/24 | `aws ec2 describe-subnets` |
| 34 | Service Public Subnet | Public Subnet CIDR（AZ-c） | 10.1.2.0/24 | `aws ec2 describe-subnets` |
| 35 | Service Private Subnet | Private Subnet CIDR（AZ-a） | 10.1.10.0/24 | `aws ec2 describe-subnets` |
| 36 | Service Private Subnet | Private Subnet CIDR（AZ-c） | 10.1.20.0/24 | `aws ec2 describe-subnets` |

### 6.2 RDS構成検証

| No | テスト項目 | 検証内容 | 期待値 | 確認コマンド |
|----|----------|---------|--------|-------------|
| 37 | RDSインスタンス作成 | DBインスタンス作成 | Status: available | `aws rds describe-db-instances` |
| 38 | RDSエンジン | PostgreSQLバージョン | 14.10 | RDS Console確認 |
| 39 | Multi-AZ構成 | Multi-AZ有効化 | true | `aws rds describe-db-instances` |
| 40 | DBサブネットグループ | Private Subnetに配置 | az-a, az-c | RDS Console確認 |
| 41 | セキュリティグループ | ECSからのPostgreSQL(5432)アクセス許可 | Ingress Rule存在 | `aws ec2 describe-security-groups` |
| 42 | 自動バックアップ | バックアップ有効化 | 保持期間7日 | RDS Console確認 |

### 6.3 ECS/ALB構成検証

| No | テスト項目 | 検証内容 | 期待値 | 確認コマンド |
|----|----------|---------|--------|-------------|
| 43 | ECS Cluster作成 | Fargateクラスター作成 | Status: ACTIVE | `aws ecs describe-clusters` |
| 44 | Public ALB作成 | Internet-facing ALB作成 | Scheme: internet-facing | `aws elbv2 describe-load-balancers` |
| 45 | Public ALB配置 | Public Subnetに配置 | AZ: a, c | ALB Console確認 |
| 46 | Admin ALB作成 | Internal ALB作成 | Scheme: internal | `aws elbv2 describe-load-balancers` |
| 47 | Admin ALB配置 | Private Subnetに配置 | AZ: a, c | ALB Console確認 |
| 48 | Target Group作成 | Public/Admin/Batch用TG作成 | 3個作成 | `aws elbv2 describe-target-groups` |

### 6.4 Monitoring構成検証

| No | テスト項目 | 検証内容 | 期待値 | 確認コマンド |
|----|----------|---------|--------|-------------|
| 49 | CloudWatch Alarms作成 | ECS CPUアラーム作成 | 閾値80% | `aws cloudwatch describe-alarms` |
| 50 | CloudWatch Alarms作成 | ECS Memoryアラーム作成 | 閾値80% | `aws cloudwatch describe-alarms` |
| 51 | CloudWatch Alarms作成 | RDS CPUアラーム作成 | 閾値80% | `aws cloudwatch describe-alarms` |
| 52 | CloudWatch Alarms作成 | ALB 5xxエラーアラーム作成 | 閾値10 | `aws cloudwatch describe-alarms` |
| 53 | SNS Topic作成 | アラート通知用Topic作成 | 正常作成 | `aws sns list-topics` |

---

## 7. セキュリティ検証テスト

### 7.1 セキュリティグループ検証

| No | テスト項目 | 検証内容 | 期待結果 | 確認方法 |
|----|----------|---------|---------|---------|
| 54 | Public ALB SG | HTTP(80)がインターネットから許可 | 0.0.0.0/0 → 80 | `aws ec2 describe-security-groups` |
| 55 | Public ALB SG | HTTPS(443)がインターネットから許可 | 0.0.0.0/0 → 443 | `aws ec2 describe-security-groups` |
| 56 | Admin ALB SG | HTTP(80)がPlatform VPCから許可 | 10.0.0.0/16 → 80 | `aws ec2 describe-security-groups` |
| 57 | Admin ALB SG | インターネットからアクセス不可 | 0.0.0.0/0ルールなし | Security Group確認 |
| 58 | ECS Task SG | ALBからのアクセスのみ許可 | ALB SG → 3000 | `aws ec2 describe-security-groups` |
| 59 | RDS SG | ECS Taskからのアクセスのみ許可 | ECS SG → 5432 | `aws ec2 describe-security-groups` |

### 7.2 IAMロール検証

| No | テスト項目 | 検証内容 | 期待結果 | 確認コマンド |
|----|----------|---------|---------|-------------|
| 60 | ECS Task Execution Role | ECR Pull権限 | AmazonECSTaskExecutionRolePolicy | `aws iam get-role` |
| 61 | ECS Task Execution Role | CloudWatch Logs書き込み権限 | logs:CreateLogStream, logs:PutLogEvents | IAM Policy確認 |
| 62 | ECS Task Execution Role | Secrets Manager読み取り権限 | secretsmanager:GetSecretValue | IAM Policy確認 |
| 63 | ECS Task Role | S3アクセス権限 | s3:GetObject, s3:PutObject | IAM Policy確認 |

---

## 8. スケーラビリティ検証テスト

### 8.1 Auto Scaling検証

| No | テスト項目 | 検証内容 | 期待結果 | テスト方法 |
|----|----------|---------|---------|----------|
| 64 | ECS Service Auto Scaling設定 | Target Tracking Policy設定 | CPU 70%でスケール | ECS Console確認 |
| 65 | Scale Out動作 | 負荷増加時にTask数増加 | 1→2→3 Tasksへ増加 | 負荷ツールで負荷発生、Task数監視 |
| 66 | Scale In動作 | 負荷減少時にTask数減少 | 3→2→1 Tasksへ減少 | 負荷停止、Task数監視 |
| 67 | RDS Storage Auto Scaling | ストレージ自動拡張設定 | 閾値90%で自動拡張 | RDS Console確認 |

---

## 9. 障害復旧テスト

### 9.1 Multi-AZ構成検証

| No | テスト項目 | 検証内容 | 期待結果 | テスト方法 |
|----|----------|---------|---------|----------|
| 68 | RDS自動フェイルオーバー | Primaryインスタンス停止 | Standbyへ自動切替（5分以内） | RDS強制フェイルオーバー実行 |
| 69 | ECS Task配置 | AZ障害時のTask再配置 | 他AZでTask起動 | Taskを強制停止、再起動確認 |
| 70 | ALBヘルスチェック | 異常Targetの自動除外 | Unhealthy Targetが除外される | Targetを停止、ヘルスチェック確認 |

---

## 10. パフォーマンステスト

### 10.1 ネットワークレイテンシ測定

| No | テスト項目 | 測定区間 | 目標値 | 測定方法 |
|----|----------|---------|--------|---------|
| 71 | Transit Gateway経由レイテンシ | Platform VPC → Service VPC | 50ms以内 | `ping`による100回測定、平均値 |
| 72 | VPN経由レイテンシ | VPNクライアント → Service VPC | 100ms以内 | `ping`による100回測定、平均値 |
| 73 | RDSレスポンスタイム | ECS Task → RDS | 10ms以内 | アプリケーションログ測定 |

### 10.2 スループット測定

| No | テスト項目 | 測定内容 | 目標値 | 測定方法 |
|----|----------|---------|--------|---------|
| 74 | ALBスループット | HTTP Requests/sec | 1000 req/s | Apache Bench / Locustで負荷測定 |
| 75 | NAT Gatewayスループット | Private Subnet → Internet | 5 Gbps | `iperf3`でスループット測定 |

---

## 11. コスト検証テスト

### 11.1 リソースコスト確認

| No | テスト項目 | 検証内容 | 確認方法 |
|----|----------|---------|---------|
| 76 | 日次コスト | デプロイ後24時間のコスト | AWS Cost Explorer確認 |
| 77 | リソース別コスト | ECS/RDS/ALB/TGW別コスト | AWS Cost Explorer、タグ別集計 |
| 78 | 予想月額コスト | 1ヶ月の推定コスト | Cost Explorer予測機能 |

---

## 12. テスト実行記録

### 12.1 テスト実施日

| テスト区分 | 実施日 | 担当者 | 結果 |
|----------|--------|--------|------|
| CloudFormationデプロイテスト | - | - | - |
| Transit Gateway接続テスト | - | - | - |
| ネットワーク疎通テスト | - | - | - |
| リソース構成検証テスト | - | - | - |
| セキュリティ検証テスト | - | - | - |
| スケーラビリティ検証テスト | - | - | - |
| 障害復旧テスト | - | - | - |
| パフォーマンステスト | - | - | - |
| コスト検証テスト | - | - | - |

### 12.2 不具合管理

| No | 検出日 | 不具合内容 | 重要度 | 状態 | 修正日 |
|----|--------|----------|--------|------|--------|
| - | - | - | - | - | - |

---

## 13. テスト完了基準

以下の条件をすべて満たした場合、インフラテストを完了とする：

- [ ] すべてのCloudFormationスタックが正常にデプロイされる
- [ ] Transit Gateway経由でVPC間疎通が確立する
- [ ] VPN接続が正常に動作する
- [ ] すべてのリソースが設計通りの構成で作成される
- [ ] セキュリティグループ/IAMロールが適切に設定される
- [ ] Multi-AZ構成が正常に動作する
- [ ] ネットワークレイテンシが目標値以内
- [ ] 重大な不具合（Critical/High）が0件

---

## 14. 参考情報

### 14.1 関連ドキュメント

- [テスト計画書](01_テスト計画書.md)
- [基本設計書](../03_基本設計書/)
- [詳細設計書](../04_詳細設計書/)

### 14.2 参考コマンド

```bash
# CloudFormationスタック一覧
aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE

# Transit Gateway確認
aws ec2 describe-transit-gateways

# VPC疎通テスト（EC2インスタンス起動）
aws ec2 run-instances \
  --image-id ami-xxxxxxxxx \
  --instance-type t3.micro \
  --subnet-id subnet-xxxxxxxx \
  --security-group-ids sg-xxxxxxxx

# RDS接続テスト
psql -h <rds-endpoint> -U postgres -d sampleapp

# ECS Task実行中確認
aws ecs list-tasks --cluster sample-app-dev

# CloudWatch Alarms確認
aws cloudwatch describe-alarms --alarm-names sample-app-dev-ecs-cpu-high
```

---

**備考:**
- 本テスト仕様書は、CloudFormationテンプレートの実装完了後に実施する
- テスト実施前に、必要なAWSアカウント権限・CLIツールの準備を行う
- VPN接続テストは、OpenVPN Clientのインストールが必要
