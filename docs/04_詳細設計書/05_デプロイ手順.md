# デプロイ手順

> AWS Multi-Account Sample Application
> Transit Gateway による拠点間閉域接続を実現する技術検証・社内デモ用サンプル

---

## ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | AWS Multi-Account Sample Application |
| 文書バージョン | 1.0 |
| 作成日 | 2025-10-21 |
| 最終更新日 | 2025-10-21 |
| 承認状態 | 承認待ち |

---

## 1. デプロイ全体フロー

### 1.1 デプロイ順序

```
1. 事前準備（両アカウント）
   ├── AWS CLI設定
   ├── 証明書生成（Client VPN用）
   └── パラメータファイル準備

2. Platform Account デプロイ
   ├── ネットワークスタック（VPC, Subnet）
   └── 接続スタック（Transit Gateway, Client VPN）

3. Service Account デプロイ
   ├── ネットワークスタック（VPC, Subnet）
   ├── データベーススタック（RDS）
   ├── コンピュートスタック（ECS, ALB）
   └── 監視スタック（CloudWatch）

4. 動作確認
   ├── VPN接続テスト
   ├── Transit Gateway疎通確認
   ├── アプリケーション動作確認
   └── 監視アラート動作確認
```

### 1.2 デプロイ所要時間（推定）

| フェーズ | 推定時間 |
|---------|---------|
| 事前準備 | 30分 |
| Platform Account デプロイ | 40分 |
| Service Account デプロイ | 60分 |
| 動作確認 | 30分 |
| **合計** | **約2.5時間** |

---

## 2. 事前準備

### 2.1 必要な権限

**Platform Account**:
- CloudFormation Full Access
- VPC Full Access
- EC2 Full Access（Transit Gateway, Client VPN）
- Certificate Manager Full Access
- Secrets Manager Full Access

**Service Account**:
- CloudFormation Full Access
- VPC Full Access
- ECS Full Access
- RDS Full Access
- ALB Full Access
- CloudWatch Full Access
- Secrets Manager Full Access
- IAM Role作成権限

### 2.2 AWS CLI設定

#### 2.2.1 AWS CLI インストール確認

```bash
aws --version
# aws-cli/2.x.x 以上が必要
```

#### 2.2.2 プロファイル設定

**~/.aws/credentials**:
```ini
[platform-account]
aws_access_key_id = AKIA...
aws_secret_access_key = ...

[service-account]
aws_access_key_id = AKIA...
aws_secret_access_key = ...
```

**~/.aws/config**:
```ini
[profile platform-account]
region = ap-northeast-1
output = json

[profile service-account]
region = ap-northeast-1
output = json
```

#### 2.2.3 プロファイル動作確認

```bash
# Platform Account確認
aws sts get-caller-identity --profile platform-account

# Service Account確認
aws sts get-caller-identity --profile service-account
```

### 2.3 証明書生成（Client VPN用）

#### 2.3.1 Easy-RSA インストール

```bash
# macOS
brew install easy-rsa

# Windows (Git Bash)
# https://github.com/OpenVPN/easy-rsa/releases からダウンロード

# Linux
sudo apt-get install easy-rsa
```

#### 2.3.2 証明書生成

```bash
# Easy-RSA初期化
mkdir -p ~/vpn-certs
cd ~/vpn-certs
easyrsa init-pki

# CA証明書生成
easyrsa build-ca nopass
# Common Name: SampleApp VPN CA

# サーバー証明書生成
easyrsa build-server-full server nopass

# クライアント証明書生成
easyrsa build-client-full client1.domain.tld nopass
```

#### 2.3.3 証明書を AWS Certificate Manager にインポート

```bash
# サーバー証明書インポート
aws acm import-certificate \
  --certificate fileb://pki/issued/server.crt \
  --private-key fileb://pki/private/server.key \
  --certificate-chain fileb://pki/ca.crt \
  --region ap-northeast-1 \
  --profile platform-account

# 出力されたARNをメモ: arn:aws:acm:ap-northeast-1:123456789012:certificate/...

# クライアント証明書インポート
aws acm import-certificate \
  --certificate fileb://pki/issued/client1.domain.tld.crt \
  --private-key fileb://pki/private/client1.domain.tld.key \
  --certificate-chain fileb://pki/ca.crt \
  --region ap-northeast-1 \
  --profile platform-account

# 出力されたARNをメモ: arn:aws:acm:ap-northeast-1:123456789012:certificate/...
```

### 2.4 Secrets Manager シークレット作成

#### 2.4.1 RDS マスターパスワード生成

```bash
# ランダムパスワード生成（16文字、英数字記号）
openssl rand -base64 16

# 出力例: Xy9@kL3#mN8qR2vT
```

#### 2.4.2 Secrets Manager に保存

```bash
# RDS Master Password
aws secretsmanager create-secret \
  --name sample-app/dev/db-master-password \
  --description "RDS PostgreSQL Master Password" \
  --secret-string '{"username":"postgres","password":"Xy9@kL3#mN8qR2vT"}' \
  --region ap-northeast-1 \
  --profile service-account

# 出力されたARNをメモ: arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/dev/db-master-password-AbCdEf

# JWT Secret
aws secretsmanager create-secret \
  --name sample-app/dev/jwt-secret \
  --description "JWT Secret Key" \
  --secret-string "$(openssl rand -base64 32)" \
  --region ap-northeast-1 \
  --profile service-account

# Admin Credentials
aws secretsmanager create-secret \
  --name sample-app/dev/admin-credentials \
  --description "Admin Dashboard Credentials" \
  --secret-string '{"username":"admin","password":"AdminPass123!"}' \
  --region ap-northeast-1 \
  --profile service-account
```

### 2.5 パラメータファイル準備

#### 2.5.1 Platform Account パラメータ

**infra/cloudformation/platform/parameters-dev.json**:
```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "ProjectName",
    "ParameterValue": "sample-app"
  },
  {
    "ParameterKey": "PlatformVPCCIDR",
    "ParameterValue": "10.0.0.0/16"
  },
  {
    "ParameterKey": "PublicSubnet1CIDR",
    "ParameterValue": "10.0.1.0/24"
  },
  {
    "ParameterKey": "PublicSubnet2CIDR",
    "ParameterValue": "10.0.2.0/24"
  },
  {
    "ParameterKey": "PrivateSubnet1CIDR",
    "ParameterValue": "10.0.11.0/24"
  },
  {
    "ParameterKey": "PrivateSubnet2CIDR",
    "ParameterValue": "10.0.12.0/24"
  },
  {
    "ParameterKey": "ClientVPNServerCertificateArn",
    "ParameterValue": "arn:aws:acm:ap-northeast-1:123456789012:certificate/..."
  },
  {
    "ParameterKey": "ClientVPNClientCertificateArn",
    "ParameterValue": "arn:aws:acm:ap-northeast-1:123456789012:certificate/..."
  },
  {
    "ParameterKey": "ClientVPNTargetCIDR",
    "ParameterValue": "10.100.0.0/22"
  },
  {
    "ParameterKey": "ServiceAccountId",
    "ParameterValue": "987654321098"
  }
]
```

#### 2.5.2 Service Account パラメータ

**infra/cloudformation/service/parameters-dev.json**:
```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "ProjectName",
    "ParameterValue": "sample-app"
  },
  {
    "ParameterKey": "ServiceVPCCIDR",
    "ParameterValue": "10.1.0.0/16"
  },
  {
    "ParameterKey": "PublicSubnet1CIDR",
    "ParameterValue": "10.1.1.0/24"
  },
  {
    "ParameterKey": "PublicSubnet2CIDR",
    "ParameterValue": "10.1.2.0/24"
  },
  {
    "ParameterKey": "PrivateSubnet1CIDR",
    "ParameterValue": "10.1.11.0/24"
  },
  {
    "ParameterKey": "PrivateSubnet2CIDR",
    "ParameterValue": "10.1.12.0/24"
  },
  {
    "ParameterKey": "DatabaseSubnet1CIDR",
    "ParameterValue": "10.1.21.0/24"
  },
  {
    "ParameterKey": "DatabaseSubnet2CIDR",
    "ParameterValue": "10.1.22.0/24"
  },
  {
    "ParameterKey": "DBMasterUsername",
    "ParameterValue": "postgres"
  },
  {
    "ParameterKey": "DBMasterPasswordSecretArn",
    "ParameterValue": "arn:aws:secretsmanager:ap-northeast-1:987654321098:secret:sample-app/dev/db-master-password-AbCdEf"
  },
  {
    "ParameterKey": "DBName",
    "ParameterValue": "sampledb"
  },
  {
    "ParameterKey": "PlatformAccountId",
    "ParameterValue": "123456789012"
  },
  {
    "ParameterKey": "TransitGatewayId",
    "ParameterValue": "tgw-xxxxx"
  }
]
```

---

## 3. Platform Account デプロイ

### 3.1 スタックデプロイ

#### 3.1.1 Change Set 作成（Dry-Run）

```bash
cd infra/cloudformation/platform

# Change Set作成
aws cloudformation create-change-set \
  --stack-name sample-app-dev-platform \
  --template-body file://stack.yaml \
  --parameters file://parameters-dev.json \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile platform-account

# Change Set確認
aws cloudformation describe-change-set \
  --stack-name sample-app-dev-platform \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile platform-account
```

#### 3.1.2 Change Set 実行

```bash
# Change Setを実行
aws cloudformation execute-change-set \
  --stack-name sample-app-dev-platform \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile platform-account

# デプロイ進捗確認（約40分）
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account

# 成功確認
aws cloudformation describe-stacks \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account \
  --query 'Stacks[0].StackStatus'
# 出力: "CREATE_COMPLETE"
```

### 3.2 Output 値取得

```bash
# Transit Gateway ID取得
aws cloudformation describe-stacks \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account \
  --query 'Stacks[0].Outputs[?OutputKey==`TransitGatewayId`].OutputValue' \
  --output text

# 出力例: tgw-0a1b2c3d4e5f6g7h8

# メモして、Service Account のパラメータファイルに反映
```

### 3.3 Client VPN 設定ファイル取得

```bash
# Client VPN Endpoint ID取得
CLIENT_VPN_ENDPOINT_ID=$(aws cloudformation describe-stacks \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account \
  --query 'Stacks[0].Outputs[?OutputKey==`ClientVpnEndpointId`].OutputValue' \
  --output text)

# VPN設定ファイルエクスポート
aws ec2 export-client-vpn-client-configuration \
  --client-vpn-endpoint-id $CLIENT_VPN_ENDPOINT_ID \
  --region ap-northeast-1 \
  --profile platform-account \
  --output text > ~/Downloads/sample-app-vpn-config.ovpn

echo "VPN設定ファイルを ~/Downloads/sample-app-vpn-config.ovpn に保存しました"
```

---

## 4. Service Account デプロイ

### 4.1 Transit Gateway 共有受け入れ

#### 4.1.1 Resource Share 招待確認

```bash
# Resource Access Manager招待確認
aws ram get-resource-share-invitations \
  --region ap-northeast-1 \
  --profile service-account

# 出力から resourceShareInvitationArn をメモ
```

#### 4.1.2 招待受け入れ

```bash
aws ram accept-resource-share-invitation \
  --resource-share-invitation-arn arn:aws:ram:ap-northeast-1:123456789012:resource-share-invitation/... \
  --region ap-northeast-1 \
  --profile service-account
```

### 4.2 ネットワークスタック デプロイ

```bash
cd infra/cloudformation/service

# Change Set作成
aws cloudformation create-change-set \
  --stack-name sample-app-dev-network \
  --template-body file://01-network.yaml \
  --parameters file://parameters-dev.json \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service-account

# Change Set実行
aws cloudformation execute-change-set \
  --stack-name sample-app-dev-network \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service-account

# デプロイ完了待機（約10分）
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-network \
  --region ap-northeast-1 \
  --profile service-account
```

### 4.3 データベーススタック デプロイ

```bash
# Change Set作成
aws cloudformation create-change-set \
  --stack-name sample-app-dev-database \
  --template-body file://02-database.yaml \
  --parameters file://parameters-dev.json \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service-account

# Change Set実行
aws cloudformation execute-change-set \
  --stack-name sample-app-dev-database \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service-account

# デプロイ完了待機（約20分）
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-database \
  --region ap-northeast-1 \
  --profile service-account
```

### 4.4 データベースマイグレーション実行

#### 4.4.1 RDS Endpoint 取得

```bash
DB_ENDPOINT=$(aws cloudformation describe-stacks \
  --stack-name sample-app-dev-database \
  --region ap-northeast-1 \
  --profile service-account \
  --query 'Stacks[0].Outputs[?OutputKey==`DBEndpoint`].OutputValue' \
  --output text)

echo "RDS Endpoint: $DB_ENDPOINT"
```

#### 4.4.2 VPN接続してマイグレーション実行

```bash
# VPN接続（別ターミナル）
# OpenVPN GUI または CLI で ~/Downloads/sample-app-vpn-config.ovpn を使用

# マイグレーション実行（プロジェクトルート）
cd packages/shared
npm install
npx knex migrate:latest --env production

# 出力:
# Batch 1 run: 4 migrations
# - 001_create_users_table.js
# - 002_create_products_table.js
# - 003_create_orders_table.js
# - 004_create_order_items_table.js
```

### 4.5 コンピュートスタック デプロイ

```bash
# Change Set作成
aws cloudformation create-change-set \
  --stack-name sample-app-dev-compute \
  --template-body file://03-compute.yaml \
  --parameters file://parameters-dev.json \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service-account

# Change Set実行
aws cloudformation execute-change-set \
  --stack-name sample-app-dev-compute \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service-account

# デプロイ完了待機（約20分）
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-compute \
  --region ap-northeast-1 \
  --profile service-account
```

### 4.6 監視スタック デプロイ

```bash
# Change Set作成
aws cloudformation create-change-set \
  --stack-name sample-app-dev-monitoring \
  --template-body file://04-monitoring.yaml \
  --parameters file://parameters-dev.json \
  --capabilities CAPABILITY_NAMED_IAM \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service-account

# Change Set実行
aws cloudformation execute-change-set \
  --stack-name sample-app-dev-monitoring \
  --change-set-name initial-deployment \
  --region ap-northeast-1 \
  --profile service-account

# デプロイ完了待機（約10分）
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-monitoring \
  --region ap-northeast-1 \
  --profile service-account
```

---

## 5. 動作確認

### 5.1 VPN接続テスト

#### 5.1.1 VPN接続

```bash
# macOS/Linux
sudo openvpn --config ~/Downloads/sample-app-vpn-config.ovpn

# Windows
# OpenVPN GUI でインポートして接続
```

#### 5.1.2 接続確認

```bash
# Platform VPC Private Subnet への疎通確認
ping 10.0.11.10

# Service VPC Private Subnet への疎通確認（Transit Gateway経由）
ping 10.1.11.10
```

### 5.2 Transit Gateway 疎通確認

```bash
# VPN接続済みの状態で

# RDSへの接続確認
psql -h $DB_ENDPOINT -U postgres -d sampledb

# パスワード入力（Secrets Manager の値）
# 接続成功: sampledb=#
```

### 5.3 アプリケーション動作確認

#### 5.3.1 ALB Endpoint 取得

```bash
ALB_ENDPOINT=$(aws cloudformation describe-stacks \
  --stack-name sample-app-dev-compute \
  --region ap-northeast-1 \
  --profile service-account \
  --query 'Stacks[0].Outputs[?OutputKey==`ALBEndpoint`].OutputValue' \
  --output text)

echo "ALB Endpoint: http://$ALB_ENDPOINT"
```

#### 5.3.2 Health Check

```bash
# Public Web Service Health Check
curl -X GET http://$ALB_ENDPOINT/health

# 期待する出力:
# {"status":"ok","timestamp":"2025-10-21T12:34:56.789Z"}
```

#### 5.3.3 ユーザー登録

```bash
curl -X POST http://$ALB_ENDPOINT/api/v1/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "name": "Test User",
    "password": "TestPass123!"
  }'

# 期待する出力:
# {
#   "userId": "550e8400-e29b-41d4-a716-446655440000",
#   "email": "test@example.com",
#   "name": "Test User",
#   "createdAt": "2025-10-21T12:34:56.789Z"
# }
```

#### 5.3.4 ログイン

```bash
curl -X POST http://$ALB_ENDPOINT/api/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "TestPass123!"
  }'

# 期待する出力:
# {
#   "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#   "expiresIn": 86400
# }
```

### 5.4 監視アラート動作確認

#### 5.4.1 SNS Topic購読確認

```bash
# メールボックスを確認
# Subject: AWS Notification - Subscription Confirmation

# メール内のリンクをクリックして購読確認
```

#### 5.4.2 CloudWatch Dashboard 確認

```bash
# AWSコンソールにログイン
# CloudWatch → Dashboards → sample-app-dev-MainDashboard

# 各ウィジェットにメトリクスが表示されていることを確認
```

#### 5.4.3 アラームテスト（任意）

```bash
# ECS タスクを停止してアラーム発火テスト
aws ecs update-service \
  --cluster sample-app-dev-cluster \
  --service sample-app-dev-public-web \
  --desired-count 0 \
  --region ap-northeast-1 \
  --profile service-account

# 数分後、メールでアラート受信を確認
# Subject: ALARM: "sample-app-dev-PublicWeb-TaskCount-Low" in AP-NORTHEAST-1

# タスク数を戻す
aws ecs update-service \
  --cluster sample-app-dev-cluster \
  --service sample-app-dev-public-web \
  --desired-count 2 \
  --region ap-northeast-1 \
  --profile service-account
```

---

## 6. トラブルシューティング

### 6.1 スタック作成失敗

#### 6.1.1 エラー確認

```bash
# スタックイベント確認
aws cloudformation describe-stack-events \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account \
  --max-items 20

# 失敗理由を特定
# 例: "Subnet CIDR block overlaps with existing subnet"
```

#### 6.1.2 ロールバック後の再デプロイ

```bash
# スタック削除
aws cloudformation delete-stack \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account

# 削除完了待機
aws cloudformation wait stack-delete-complete \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account

# パラメータ修正後、再デプロイ
```

### 6.2 VPN接続失敗

#### 6.2.1 証明書エラー

```
エラー: TLS: Initial packet from [IP]:443, sid=xxxxx... failed
```

**対処**:
1. 証明書ARNが正しいか確認（parameters-dev.json）
2. 証明書の有効期限確認
3. 証明書を再生成してACMに再インポート

#### 6.2.2 接続タイムアウト

```
エラー: Connection timeout
```

**対処**:
1. Client VPN セキュリティグループ確認
2. ターゲットネットワーク関連付け確認
3. Client VPN 承認ルール確認

```bash
# 承認ルール確認
aws ec2 describe-client-vpn-authorization-rules \
  --client-vpn-endpoint-id cvpn-endpoint-xxxxx \
  --region ap-northeast-1 \
  --profile platform-account
```

### 6.3 RDS接続失敗

#### 6.3.1 接続拒否エラー

```
エラー: could not connect to server: Connection refused
```

**対処**:
1. RDSセキュリティグループ確認（Port 5432開放）
2. RDS Endpoint確認
3. VPN経由でアクセスしているか確認

#### 6.3.2 認証失敗

```
エラー: FATAL: password authentication failed
```

**対処**:
1. Secrets Manager のパスワード確認
2. マスターユーザー名確認（デフォルト: postgres）

```bash
# Secrets Manager からパスワード取得
aws secretsmanager get-secret-value \
  --secret-id sample-app/dev/db-master-password \
  --region ap-northeast-1 \
  --profile service-account \
  --query 'SecretString' \
  --output text
```

### 6.4 ECS タスク起動失敗

#### 6.4.1 タスク停止理由確認

```bash
# 停止タスク一覧取得
aws ecs list-tasks \
  --cluster sample-app-dev-cluster \
  --desired-status STOPPED \
  --region ap-northeast-1 \
  --profile service-account

# タスク詳細確認
aws ecs describe-tasks \
  --cluster sample-app-dev-cluster \
  --tasks <task-arn> \
  --region ap-northeast-1 \
  --profile service-account \
  --query 'tasks[0].stoppedReason'
```

#### 6.4.2 よくあるエラー

**CannotPullContainerError**:
```
stopped reason: CannotPullContainerError: Error response from daemon: pull access denied
```

**対処**:
- ECRリポジトリが存在するか確認
- ECS Task Execution Role に ECR Pull 権限があるか確認

**Essential container in task exited**:
```
stopped reason: Essential container in task exited
```

**対処**:
- CloudWatch Logs でアプリケーションログ確認
- 環境変数設定確認（DB_HOST, DB_SECRET_ARN等）

```bash
# CloudWatch Logs確認
aws logs tail /ecs/sample-app/public-web \
  --follow \
  --region ap-northeast-1 \
  --profile service-account
```

### 6.5 アラーム通知が届かない

#### 6.5.1 SNS Topic 購読状態確認

```bash
aws sns list-subscriptions-by-topic \
  --topic-arn arn:aws:sns:ap-northeast-1:987654321098:sample-app-dev-CriticalAlert \
  --region ap-northeast-1 \
  --profile service-account

# 出力:
# "SubscriptionArn": "arn:aws:sns:..." → 購読確認済み
# "SubscriptionArn": "PendingConfirmation" → 購読未確認（メール確認必要）
```

#### 6.5.2 アラーム状態確認

```bash
aws cloudwatch describe-alarms \
  --alarm-names sample-app-dev-PublicWeb-CPU-High \
  --region ap-northeast-1 \
  --profile service-account \
  --query 'MetricAlarms[0].StateValue'

# 出力: "OK" / "ALARM" / "INSUFFICIENT_DATA"
```

---

## 7. スタック削除手順

### 7.1 削除順序

```
1. Service Account削除
   ├── 監視スタック
   ├── コンピュートスタック
   ├── データベーススタック
   └── ネットワークスタック

2. Platform Account削除
   └── プラットフォームスタック
```

### 7.2 Service Account スタック削除

```bash
# 監視スタック削除
aws cloudformation delete-stack \
  --stack-name sample-app-dev-monitoring \
  --region ap-northeast-1 \
  --profile service-account

aws cloudformation wait stack-delete-complete \
  --stack-name sample-app-dev-monitoring \
  --region ap-northeast-1 \
  --profile service-account

# コンピュートスタック削除
aws cloudformation delete-stack \
  --stack-name sample-app-dev-compute \
  --region ap-northeast-1 \
  --profile service-account

aws cloudformation wait stack-delete-complete \
  --stack-name sample-app-dev-compute \
  --region ap-northeast-1 \
  --profile service-account

# データベーススタック削除
aws cloudformation delete-stack \
  --stack-name sample-app-dev-database \
  --region ap-northeast-1 \
  --profile service-account

aws cloudformation wait stack-delete-complete \
  --stack-name sample-app-dev-database \
  --region ap-northeast-1 \
  --profile service-account

# ネットワークスタック削除
aws cloudformation delete-stack \
  --stack-name sample-app-dev-network \
  --region ap-northeast-1 \
  --profile service-account

aws cloudformation wait stack-delete-complete \
  --stack-name sample-app-dev-network \
  --region ap-northeast-1 \
  --profile service-account
```

### 7.3 Platform Account スタック削除

```bash
# プラットフォームスタック削除
aws cloudformation delete-stack \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account

aws cloudformation wait stack-delete-complete \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1 \
  --profile platform-account
```

### 7.4 手動削除が必要なリソース

**以下のリソースは自動削除されないため、手動削除が必要**:

1. **Secrets Manager シークレット**
```bash
aws secretsmanager delete-secret \
  --secret-id sample-app/dev/db-master-password \
  --force-delete-without-recovery \
  --region ap-northeast-1 \
  --profile service-account
```

2. **CloudWatch Logs ロググループ**（保持設定により残る場合）
```bash
aws logs delete-log-group \
  --log-group-name /ecs/sample-app/public-web \
  --region ap-northeast-1 \
  --profile service-account
```

3. **ACM証明書**
```bash
aws acm delete-certificate \
  --certificate-arn arn:aws:acm:ap-northeast-1:123456789012:certificate/... \
  --region ap-northeast-1 \
  --profile platform-account
```

---

## 8. 本番環境デプロイ時の注意事項

### 8.1 パラメータの違い

| パラメータ | dev環境 | prod環境 |
|----------|--------|---------|
| Environment | dev | prod |
| RDS Instance Class | db.t3.micro | db.r5.large 以上 |
| RDS Multi-AZ | false | true |
| RDS Backup Retention | 1日 | 7日以上 |
| ECS Task Count | 2 | 4以上（オートスケーリング） |
| CloudWatch Logs Retention | 30日 | 90日以上 |

### 8.2 本番環境固有の設定

#### 8.2.1 RDS スナップショット自動バックアップ

```yaml
# 本番環境ではバックアップウィンドウを設定
PreferredBackupWindow: "03:00-04:00"  # UTC (JST 12:00-13:00)
PreferredMaintenanceWindow: "sun:04:00-sun:05:00"  # UTC (JST 日曜 13:00-14:00)
```

#### 8.2.2 GuardDuty 有効化

```bash
# 本番環境では必ず有効化
aws guardduty create-detector \
  --enable \
  --finding-publishing-frequency FIFTEEN_MINUTES \
  --region ap-northeast-1 \
  --profile service-account
```

#### 8.2.3 ドメイン設定

```bash
# Route 53 ホストゾーン作成
aws route53 create-hosted-zone \
  --name example.com \
  --caller-reference $(date +%s) \
  --region ap-northeast-1 \
  --profile service-account

# ALB Alias レコード作成
# （CloudFormation テンプレートに追加推奨）
```

---

## 9. デプロイチェックリスト

### 9.1 デプロイ前チェック

- [ ] AWS CLI設定完了（プロファイル動作確認）
- [ ] 証明書生成・ACMインポート完了
- [ ] Secrets Manager シークレット作成完了
- [ ] パラメータファイル準備完了（ARN等すべて記入）
- [ ] 必要な権限確認（CloudFormation, VPC, ECS等）

### 9.2 Platform Account デプロイチェック

- [ ] Change Set レビュー実施
- [ ] スタック作成成功（StackStatus: CREATE_COMPLETE）
- [ ] Transit Gateway ID取得・メモ
- [ ] Client VPN設定ファイルダウンロード
- [ ] VPN接続テスト成功

### 9.3 Service Account デプロイチェック

- [ ] Transit Gateway 共有受け入れ完了
- [ ] ネットワークスタック作成成功
- [ ] データベーススタック作成成功
- [ ] マイグレーション実行成功（4テーブル作成確認）
- [ ] コンピュートスタック作成成功
- [ ] 監視スタック作成成功

### 9.4 動作確認チェック

- [ ] VPN接続成功
- [ ] Transit Gateway経由でService VPCへ疎通確認
- [ ] RDS接続成功
- [ ] ALB Health Check成功
- [ ] ユーザー登録API動作確認
- [ ] ログインAPI動作確認
- [ ] CloudWatch Dashboard表示確認
- [ ] SNS Topic購読確認（メール受信）

---

## 10. CI/CD自動デプロイ（本番化時の推奨事項）

### 10.1 現状と課題

**現フェーズ（検証・デモ用）**:
- ✅ GitHub Actions ワークフローは実装済み
- ✅ PR Validation（Lint、Test、CloudFormation検証）
- ✅ Infrastructure Deployment（Change Sets経由）
- ✅ Application Deployment（Docker Build & ECS Deploy）
- ⚠️ **デプロイ後の自動テストが未実装**

**課題**:
デプロイ後のヘルスチェック、スモークテストが自動化されていないため、デプロイ成功後も手動で動作確認が必要。

### 10.2 本番化時に追加すべき自動テスト

#### 10.2.1 Post-Deployment Tests（必須）

**1. Health Endpoint Check**

```yaml
# .github/workflows/deploy.yml に追加
- name: Health Check - Public Web
  run: |
    ALB_DNS=$(aws cloudformation describe-stacks \
      --stack-name ${PROJECT_NAME}-${ENVIRONMENT}-service-compute \
      --query 'Stacks[0].Outputs[?OutputKey==`PublicWebALBDnsName`].OutputValue' \
      --output text)

    echo "Testing health endpoint: http://${ALB_DNS}/health"

    # Retry with exponential backoff (max 5 minutes)
    for i in {1..10}; do
      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${ALB_DNS}/health || echo "000")

      if [ "$HTTP_CODE" == "200" ]; then
        echo "✅ Health check passed (HTTP $HTTP_CODE)"

        # Response body check
        RESPONSE=$(curl -s http://${ALB_DNS}/health)
        STATUS=$(echo $RESPONSE | jq -r '.status')

        if [ "$STATUS" == "healthy" ]; then
          echo "✅ Service is healthy"
          exit 0
        fi
      fi

      echo "⏳ Waiting for service to be ready... (attempt $i/10, HTTP $HTTP_CODE)"
      sleep 30
    done

    echo "❌ Health check failed after 5 minutes"
    exit 1
```

**2. Database Connectivity Check**

```yaml
- name: Database Connectivity Check
  run: |
    # ECS Exec経由でDB接続を試行
    TASK_ARN=$(aws ecs list-tasks \
      --cluster ${PROJECT_NAME}-${ENVIRONMENT}-cluster \
      --service-name ${PROJECT_NAME}-${ENVIRONMENT}-public-web \
      --query 'taskArns[0]' --output text)

    # DB接続テスト（psqlコマンド実行）
    aws ecs execute-command \
      --cluster ${PROJECT_NAME}-${ENVIRONMENT}-cluster \
      --task ${TASK_ARN} \
      --container public-web \
      --interactive \
      --command "psql -h \$DB_HOST -U \$DB_USER -d \$DB_NAME -c 'SELECT 1;'"

    if [ $? -eq 0 ]; then
      echo "✅ Database connectivity check passed"
    else
      echo "❌ Database connectivity check failed"
      exit 1
    fi
```

**3. CloudWatch Alarms Status Check**

```yaml
- name: Check CloudWatch Alarms
  run: |
    ALARM_COUNT=$(aws cloudwatch describe-alarms \
      --alarm-name-prefix "${PROJECT_NAME}-${ENVIRONMENT}" \
      --state-value ALARM \
      --query 'length(MetricAlarms)' \
      --output text)

    if [ "$ALARM_COUNT" -eq "0" ]; then
      echo "✅ No alarms in ALARM state"
    else
      echo "⚠️ Warning: ${ALARM_COUNT} alarms are in ALARM state"

      # アラーム一覧を表示
      aws cloudwatch describe-alarms \
        --alarm-name-prefix "${PROJECT_NAME}-${ENVIRONMENT}" \
        --state-value ALARM \
        --query 'MetricAlarms[*].[AlarmName,StateReason]' \
        --output table

      # デプロイ直後のアラームは許容する場合
      # exit 0

      # 厳格に管理する場合
      # exit 1
    fi
```

#### 10.2.2 Smoke Tests（推奨）

**4. Critical API Endpoints Test**

```yaml
- name: Smoke Test - Public Web API
  run: |
    ALB_DNS=$(aws cloudformation describe-stacks ...)
    BASE_URL="http://${ALB_DNS}"

    # Test 1: GET /api/users
    echo "Testing GET /api/users..."
    RESPONSE=$(curl -s ${BASE_URL}/api/users)
    SUCCESS=$(echo $RESPONSE | jq -r '.success')

    if [ "$SUCCESS" == "true" ]; then
      echo "✅ GET /api/users successful"
    else
      echo "❌ GET /api/users failed"
      exit 1
    fi

    # Test 2: POST /api/users
    echo "Testing POST /api/users..."
    RESPONSE=$(curl -s -X POST ${BASE_URL}/api/users \
      -H "Content-Type: application/json" \
      -d '{"username":"test-user-'$(date +%s)'","email":"test@example.com"}')
    SUCCESS=$(echo $RESPONSE | jq -r '.success')

    if [ "$SUCCESS" == "true" ]; then
      echo "✅ POST /api/users successful"
    else
      echo "❌ POST /api/users failed"
      exit 1
    fi

    # Test 3: GET /api/stats
    echo "Testing GET /api/stats..."
    RESPONSE=$(curl -s ${BASE_URL}/api/stats)
    SUCCESS=$(echo $RESPONSE | jq -r '.success')

    if [ "$SUCCESS" == "true" ]; then
      echo "✅ GET /api/stats successful"
    else
      echo "❌ GET /api/stats failed"
      exit 1
    fi
```

#### 10.2.3 Rollback Mechanism（必須）

**5. Automatic Rollback on Failure**

```yaml
- name: Rollback on failure
  if: failure()
  run: |
    echo "⚠️ Deployment validation failed, initiating rollback..."

    # 前回のタスク定義を取得
    PREVIOUS_TASK_DEF=$(aws ecs describe-services \
      --cluster ${PROJECT_NAME}-${ENVIRONMENT}-cluster \
      --services ${PROJECT_NAME}-${ENVIRONMENT}-public-web \
      --query 'services[0].deployments[1].taskDefinition' \
      --output text)

    if [ -n "$PREVIOUS_TASK_DEF" ]; then
      echo "Rolling back to: ${PREVIOUS_TASK_DEF}"

      # サービスを前回のタスク定義に戻す
      aws ecs update-service \
        --cluster ${PROJECT_NAME}-${ENVIRONMENT}-cluster \
        --service ${PROJECT_NAME}-${ENVIRONMENT}-public-web \
        --task-definition ${PREVIOUS_TASK_DEF} \
        --force-new-deployment

      # 安定化待機
      aws ecs wait services-stable \
        --cluster ${PROJECT_NAME}-${ENVIRONMENT}-cluster \
        --services ${PROJECT_NAME}-${ENVIRONMENT}-public-web

      echo "✅ Rollback completed"
    else
      echo "⚠️ No previous task definition found, rollback not possible"
    fi

    # Slack/Teams通知（オプション）
    # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
    #   -H 'Content-Type: application/json' \
    #   -d '{"text":"❌ Deployment failed and rolled back: '${{ github.repository }}'"}'
```

### 10.3 Infrastructure Deployment自動テスト

#### CloudFormation Stack Validation

```yaml
# .github/workflows/infrastructure.yml に追加
- name: Validate Stack Resources
  run: |
    STACK_NAME="${PROJECT_NAME}-${ENVIRONMENT}-service-network"

    # VPC作成確認
    VPC_ID=$(aws cloudformation describe-stacks \
      --stack-name ${STACK_NAME} \
      --query 'Stacks[0].Outputs[?OutputKey==`VPCId`].OutputValue' \
      --output text)

    if [ -n "$VPC_ID" ]; then
      echo "✅ VPC created: ${VPC_ID}"
    else
      echo "❌ VPC creation failed"
      exit 1
    fi

    # Transit Gateway Attachment確認
    TGW_ATTACHMENT=$(aws ec2 describe-transit-gateway-attachments \
      --filters "Name=vpc-id,Values=${VPC_ID}" \
      --query 'TransitGatewayAttachments[0].State' \
      --output text)

    if [ "$TGW_ATTACHMENT" == "available" ]; then
      echo "✅ Transit Gateway Attachment is available"
    else
      echo "❌ Transit Gateway Attachment is not available: ${TGW_ATTACHMENT}"
      exit 1
    fi
```

### 10.4 実装優先順位

| 優先度 | テスト項目 | 実装難易度 | 推定時間 |
|-------|----------|-----------|---------|
| **Critical** | Health Endpoint Check | 低 | 1時間 |
| **Critical** | Rollback Mechanism | 中 | 2時間 |
| **High** | Database Connectivity Check | 中 | 2時間 |
| **High** | CloudWatch Alarms Status Check | 低 | 1時間 |
| **Medium** | Smoke Tests (Critical APIs) | 中 | 3時間 |
| **Medium** | Infrastructure Stack Validation | 中 | 2時間 |
| **Low** | Performance Tests | 高 | 4時間 |

**合計推定時間**: 約15時間（2営業日）

### 10.5 テスト失敗時の通知

**Slack/Teams通知（推奨）**:

```yaml
- name: Notify deployment result
  if: always()
  uses: slackapi/slack-github-action@v1
  with:
    webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
    payload: |
      {
        "text": "${{ job.status == 'success' && '✅' || '❌' }} Deployment ${{ job.status }}",
        "blocks": [
          {
            "type": "section",
            "text": {
              "type": "mrkdwn",
              "text": "*Deployment Status*: ${{ job.status }}\n*Environment*: ${{ env.ENVIRONMENT }}\n*Commit*: ${{ github.sha }}"
            }
          }
        ]
      }
```

### 10.6 参考リンク

- [GitHub Actions - ECS デプロイ例](https://github.com/aws-actions/amazon-ecs-deploy-task-definition)
- [AWS ECS Blue/Green Deployment](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-type-bluegreen.html)
- [CloudFormation Change Sets](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html)

---

## 変更履歴

| 日付 | 版数 | 変更内容 | 承認者 |
|------|------|----------|--------|
| 2025-10-21 | 1.0 | 初版作成 | - |
| 2025-10-23 | 1.1 | CI/CD自動テスト設計追加（本番化時の推奨事項） | - |
