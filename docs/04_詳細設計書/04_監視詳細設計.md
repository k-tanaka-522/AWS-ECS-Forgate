# 監視詳細設計

> AWS Multi-Account Sample Application
> Transit Gateway による拠点間閉域接続を実現する技術検証・社内デモ用サンプル

---

## ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | AWS Multi-Account Sample Application |
| 文書バージョン | 1.0 |
| 作成日 | 2025-10-21 |
| 最終更新日 | 2025-10-21 |
| 承認状態 | 承認待ち |

---

## 1. 監視全体方針

### 1.1 監視目的

本プロジェクトの監視は、以下の目的で設計されています：

1. **可用性確保**: サービスダウンを早期検知し、迅速に復旧
2. **パフォーマンス最適化**: リソース使用状況を可視化し、ボトルネックを特定
3. **コスト最適化**: 過剰リソース割り当てを検知
4. **セキュリティ監視**: 異常なアクセスパターンを検知

### 1.2 監視レイヤー

```
┌─────────────────────────────────────────────┐
│ CloudWatch Dashboard（可視化）              │
└─────────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────────┐
│ CloudWatch Alarms（アラート）               │
│ → SNS Topic → Email通知                    │
└─────────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────────┐
│ CloudWatch Metrics（メトリクス収集）        │
│ - ECS, ALB, RDS, Transit Gateway, VPN       │
└─────────────────────────────────────────────┘
                    ↑
┌─────────────────────────────────────────────┐
│ CloudWatch Logs（ログ収集）                 │
│ - ECS Fargate, VPC Flow Logs                │
└─────────────────────────────────────────────┘
```

### 1.3 参照技術標準

- `.claude/docs/40_standards/41_common.md` - 共通標準（監視要件）
- `.claude/docs/40_standards/49_security.md` - セキュリティ監視

---

## 2. CloudWatch Alarms 詳細設計

### 2.1 アラーム設計方針

**基本原則**:
- **Critical**: 即時対応が必要（サービスダウン、DBダウン等）
- **Warning**: 監視が必要（CPU高使用率、ディスク容量逼迫等）
- **Info**: 参考情報（バッチ処理完了等）

**通知先**:
- Critical: SNS Topic → メール通知
- Warning: SNS Topic → メール通知
- Info: CloudWatch Dashboardのみ（通知なし）

### 2.2 ECS Fargate アラーム

#### 2.2.1 Public Web Service - CPU使用率

```yaml
PublicWebCPUAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-PublicWeb-CPU-High
    AlarmDescription: Public Web Service のCPU使用率が80%を超えています
    MetricName: CPUUtilization
    Namespace: AWS/ECS
    Statistic: Average
    Period: 300  # 5分間
    EvaluationPeriods: 2  # 2回連続
    Threshold: 80.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: ServiceName
        Value: !GetAtt PublicWebService.Name
      - Name: ClusterName
        Value: !Ref ECSCluster
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.2.2 Public Web Service - メモリ使用率

```yaml
PublicWebMemoryAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-PublicWeb-Memory-High
    AlarmDescription: Public Web Service のメモリ使用率が90%を超えています
    MetricName: MemoryUtilization
    Namespace: AWS/ECS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 90.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: ServiceName
        Value: !GetAtt PublicWebService.Name
      - Name: ClusterName
        Value: !Ref ECSCluster
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.2.3 Public Web Service - Running Task Count

```yaml
PublicWebTaskCountAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-PublicWeb-TaskCount-Low
    AlarmDescription: Public Web Service の稼働タスク数が希望数を下回っています
    MetricName: RunningTaskCount
    Namespace: ECS/ContainerInsights
    Statistic: Average
    Period: 60
    EvaluationPeriods: 1
    Threshold: 2  # 希望タスク数
    ComparisonOperator: LessThanThreshold
    Dimensions:
      - Name: ServiceName
        Value: !GetAtt PublicWebService.Name
      - Name: ClusterName
        Value: !Ref ECSCluster
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: breaching
```

**推定行数**: 約25行

#### 2.2.4 Admin Dashboard - CPU使用率

```yaml
AdminDashboardCPUAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-AdminDashboard-CPU-High
    AlarmDescription: Admin Dashboard のCPU使用率が80%を超えています
    MetricName: CPUUtilization
    Namespace: AWS/ECS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 80.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: ServiceName
        Value: !GetAtt AdminDashboardService.Name
      - Name: ClusterName
        Value: !Ref ECSCluster
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.2.5 Admin Dashboard - メモリ使用率

```yaml
AdminDashboardMemoryAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-AdminDashboard-Memory-High
    AlarmDescription: Admin Dashboard のメモリ使用率が90%を超えています
    MetricName: MemoryUtilization
    Namespace: AWS/ECS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 90.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: ServiceName
        Value: !GetAtt AdminDashboardService.Name
      - Name: ClusterName
        Value: !Ref ECSCluster
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

### 2.3 ALB アラーム

#### 2.3.1 Unhealthy Host Count

```yaml
ALBUnhealthyHostAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-ALB-UnhealthyHost
    AlarmDescription: ALB の異常なターゲットが検出されています
    MetricName: UnHealthyHostCount
    Namespace: AWS/ApplicationELB
    Statistic: Average
    Period: 60
    EvaluationPeriods: 2
    Threshold: 1.0
    ComparisonOperator: GreaterThanOrEqualToThreshold
    Dimensions:
      - Name: LoadBalancer
        Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
      - Name: TargetGroup
        Value: !GetAtt PublicWebTargetGroup.TargetGroupFullName
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.3.2 Target Response Time

```yaml
ALBResponseTimeAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-ALB-ResponseTime-High
    AlarmDescription: ALB のレスポンスタイムが3秒を超えています
    MetricName: TargetResponseTime
    Namespace: AWS/ApplicationELB
    Statistic: Average
    Period: 60
    EvaluationPeriods: 3
    Threshold: 3.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: LoadBalancer
        Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.3.3 HTTP 5xx Error Count

```yaml
ALB5xxErrorAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-ALB-5xxError
    AlarmDescription: ALB で5xxエラーが多発しています
    MetricName: HTTPCode_Target_5XX_Count
    Namespace: AWS/ApplicationELB
    Statistic: Sum
    Period: 60
    EvaluationPeriods: 2
    Threshold: 10.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: LoadBalancer
        Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.3.4 HTTP 4xx Error Count

```yaml
ALB4xxErrorAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-ALB-4xxError
    AlarmDescription: ALB で4xxエラーが多発しています
    MetricName: HTTPCode_Target_4XX_Count
    Namespace: AWS/ApplicationELB
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 2
    Threshold: 100.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: LoadBalancer
        Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

### 2.4 RDS アラーム

#### 2.4.1 CPU使用率

```yaml
RDSCPUAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-RDS-CPU-High
    AlarmDescription: RDS のCPU使用率が80%を超えています
    MetricName: CPUUtilization
    Namespace: AWS/RDS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 80.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: DBInstanceIdentifier
        Value: !Ref RDSInstance
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.4.2 FreeableMemory

```yaml
RDSMemoryAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-RDS-Memory-Low
    AlarmDescription: RDS の空きメモリが500MB未満です
    MetricName: FreeableMemory
    Namespace: AWS/RDS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 524288000  # 500MB (bytes)
    ComparisonOperator: LessThanThreshold
    Dimensions:
      - Name: DBInstanceIdentifier
        Value: !Ref RDSInstance
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.4.3 FreeStorageSpace

```yaml
RDSStorageAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-RDS-Storage-Low
    AlarmDescription: RDS の空きストレージが5GB未満です
    MetricName: FreeStorageSpace
    Namespace: AWS/RDS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 1
    Threshold: 5368709120  # 5GB (bytes)
    ComparisonOperator: LessThanThreshold
    Dimensions:
      - Name: DBInstanceIdentifier
        Value: !Ref RDSInstance
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.4.4 DatabaseConnections

```yaml
RDSConnectionsAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-RDS-Connections-High
    AlarmDescription: RDS の接続数が80を超えています
    MetricName: DatabaseConnections
    Namespace: AWS/RDS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 80.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: DBInstanceIdentifier
        Value: !Ref RDSInstance
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.4.5 ReadLatency / WriteLatency

```yaml
RDSReadLatencyAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-RDS-ReadLatency-High
    AlarmDescription: RDS の読み取りレイテンシが100msを超えています
    MetricName: ReadLatency
    Namespace: AWS/RDS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 0.1  # 100ms (秒)
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: DBInstanceIdentifier
        Value: !Ref RDSInstance
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching

RDSWriteLatencyAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-RDS-WriteLatency-High
    AlarmDescription: RDS の書き込みレイテンシが200msを超えています
    MetricName: WriteLatency
    Namespace: AWS/RDS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 0.2  # 200ms (秒)
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: DBInstanceIdentifier
        Value: !Ref RDSInstance
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約50行（2アラーム）

### 2.5 Transit Gateway アラーム

#### 2.5.1 BytesIn / BytesOut

```yaml
TGWBytesInAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-TGW-BytesIn-High
    AlarmDescription: Transit Gateway の受信バイト数が異常に高くなっています
    MetricName: BytesIn
    Namespace: AWS/TransitGateway
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 2
    Threshold: 10737418240  # 10GB (bytes)
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: TransitGateway
        Value: !Ref TransitGateway
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

#### 2.5.2 PacketDropCountNoRoute

```yaml
TGWPacketDropAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-TGW-PacketDrop
    AlarmDescription: Transit Gateway でルートなしによるパケットドロップが発生しています
    MetricName: PacketDropCountNoRoute
    Namespace: AWS/TransitGateway
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 100.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: TransitGateway
        Value: !Ref TransitGateway
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

### 2.6 Client VPN アラーム

#### 2.6.1 ActiveConnectionsCount

```yaml
VPNActiveConnectionsAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-VPN-ActiveConnections-High
    AlarmDescription: Client VPN の同時接続数が20を超えています
    MetricName: ActiveConnectionsCount
    Namespace: AWS/ClientVPN
    Statistic: Maximum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 20.0
    ComparisonOperator: GreaterThanThreshold
    Dimensions:
      - Name: Endpoint
        Value: !Ref ClientVpnEndpoint
    ActionsEnabled: true
    AlarmActions:
      - !Ref AlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約25行

### 2.7 CloudWatch Logs アラーム（メトリクスフィルター）

#### 2.7.1 アプリケーションエラーログ

```yaml
# メトリクスフィルター
AppErrorLogMetricFilter:
  Type: AWS::Logs::MetricFilter
  Properties:
    FilterPattern: '[timestamp, request_id, level = "ERROR", ...]'
    LogGroupName: /ecs/sample-app/public-web
    MetricTransformations:
      - MetricName: ApplicationErrorCount
        MetricNamespace: SampleApp/Logs
        MetricValue: "1"
        DefaultValue: 0

# アラーム
AppErrorLogAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-AppError-High
    AlarmDescription: アプリケーションエラーログが多発しています
    MetricName: ApplicationErrorCount
    Namespace: SampleApp/Logs
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 10.0
    ComparisonOperator: GreaterThanThreshold
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約40行（メトリクスフィルター + アラーム）

---

## 3. SNS Topics 詳細設計

### 3.1 SNS Topic 構成

```yaml
# Critical Alert用（即時対応必要）
CriticalAlertTopic:
  Type: AWS::SNS::Topic
  Properties:
    TopicName: !Sub ${ProjectName}-${Environment}-CriticalAlert
    DisplayName: Critical Alert Notification
    Subscription:
      - Endpoint: ops-team@example.com
        Protocol: email

# Warning Alert用（監視必要）
AlertTopic:
  Type: AWS::SNS::Topic
  Properties:
    TopicName: !Sub ${ProjectName}-${Environment}-Alert
    DisplayName: Alert Notification
    Subscription:
      - Endpoint: dev-team@example.com
        Protocol: email
```

**推定行数**: 約30行

### 3.2 アラーム重要度マッピング

| アラーム種別 | SNS Topic | 通知先 | 対応優先度 |
|------------|-----------|--------|----------|
| ECS Task Count Low | CriticalAlertTopic | ops-team | 即時 |
| ALB UnhealthyHost | CriticalAlertTopic | ops-team | 即時 |
| ALB 5xx Error | CriticalAlertTopic | ops-team | 即時 |
| RDS CPU High | CriticalAlertTopic | ops-team | 即時 |
| RDS Memory Low | CriticalAlertTopic | ops-team | 即時 |
| RDS Storage Low | CriticalAlertTopic | ops-team | 即時 |
| TGW PacketDrop | CriticalAlertTopic | ops-team | 即時 |
| App Error High | CriticalAlertTopic | ops-team | 即時 |
| ECS CPU High | AlertTopic | dev-team | 1時間以内 |
| ECS Memory High | AlertTopic | dev-team | 1時間以内 |
| ALB ResponseTime High | AlertTopic | dev-team | 1時間以内 |
| ALB 4xx Error | AlertTopic | dev-team | 1時間以内 |
| RDS Connections High | AlertTopic | dev-team | 1時間以内 |
| RDS Latency High | AlertTopic | dev-team | 1時間以内 |
| TGW Bytes High | AlertTopic | dev-team | 1時間以内 |
| VPN Connections High | AlertTopic | dev-team | 1時間以内 |

---

## 4. CloudWatch Dashboard 詳細設計

### 4.1 Dashboard 構成

```yaml
MainDashboard:
  Type: AWS::CloudWatch::Dashboard
  Properties:
    DashboardName: !Sub ${ProjectName}-${Environment}-MainDashboard
    DashboardBody: !Sub |
      {
        "widgets": [
          {
            "type": "metric",
            "properties": {
              "title": "ECS - CPU Utilization",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/ECS", "CPUUtilization", {"stat": "Average", "label": "Public Web"}],
                ["AWS/ECS", "CPUUtilization", {"stat": "Average", "label": "Admin Dashboard"}]
              ],
              "period": 300,
              "yAxis": {"left": {"min": 0, "max": 100}}
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "ECS - Memory Utilization",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/ECS", "MemoryUtilization", {"stat": "Average", "label": "Public Web"}],
                ["AWS/ECS", "MemoryUtilization", {"stat": "Average", "label": "Admin Dashboard"}]
              ],
              "period": 300,
              "yAxis": {"left": {"min": 0, "max": 100}}
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "ALB - Request Count",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/ApplicationELB", "RequestCount", {"stat": "Sum"}]
              ],
              "period": 60
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "ALB - Target Response Time",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/ApplicationELB", "TargetResponseTime", {"stat": "Average"}]
              ],
              "period": 60,
              "yAxis": {"left": {"min": 0}}
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "ALB - HTTP Status Codes",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/ApplicationELB", "HTTPCode_Target_2XX_Count", {"stat": "Sum", "label": "2xx"}],
                ["AWS/ApplicationELB", "HTTPCode_Target_4XX_Count", {"stat": "Sum", "label": "4xx"}],
                ["AWS/ApplicationELB", "HTTPCode_Target_5XX_Count", {"stat": "Sum", "label": "5xx"}]
              ],
              "period": 60
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "RDS - CPU Utilization",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/RDS", "CPUUtilization", {"stat": "Average"}]
              ],
              "period": 300,
              "yAxis": {"left": {"min": 0, "max": 100}}
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "RDS - Database Connections",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/RDS", "DatabaseConnections", {"stat": "Average"}]
              ],
              "period": 300,
              "yAxis": {"left": {"min": 0}}
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "RDS - Read/Write Latency",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/RDS", "ReadLatency", {"stat": "Average", "label": "Read"}],
                ["AWS/RDS", "WriteLatency", {"stat": "Average", "label": "Write"}]
              ],
              "period": 300,
              "yAxis": {"left": {"min": 0}}
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "Transit Gateway - Bytes In/Out",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/TransitGateway", "BytesIn", {"stat": "Sum", "label": "Bytes In"}],
                ["AWS/TransitGateway", "BytesOut", {"stat": "Sum", "label": "Bytes Out"}]
              ],
              "period": 300
            }
          },
          {
            "type": "metric",
            "properties": {
              "title": "Client VPN - Active Connections",
              "region": "${AWS::Region}",
              "metrics": [
                ["AWS/ClientVPN", "ActiveConnectionsCount", {"stat": "Maximum"}]
              ],
              "period": 300,
              "yAxis": {"left": {"min": 0}}
            }
          },
          {
            "type": "log",
            "properties": {
              "title": "Application Error Logs",
              "region": "${AWS::Region}",
              "query": "SOURCE '/ecs/sample-app/public-web' | fields @timestamp, @message | filter level = \"ERROR\" | sort @timestamp desc | limit 20"
            }
          }
        ]
      }
```

**推定行数**: 約200行

### 4.2 Dashboard ウィジェット一覧

| ウィジェット名 | 種別 | データソース | 説明 |
|--------------|------|-------------|------|
| ECS - CPU Utilization | Metric | AWS/ECS | ECSタスクのCPU使用率 |
| ECS - Memory Utilization | Metric | AWS/ECS | ECSタスクのメモリ使用率 |
| ALB - Request Count | Metric | AWS/ApplicationELB | ALBリクエスト数 |
| ALB - Target Response Time | Metric | AWS/ApplicationELB | ALBレスポンスタイム |
| ALB - HTTP Status Codes | Metric | AWS/ApplicationELB | HTTPステータスコード分布 |
| RDS - CPU Utilization | Metric | AWS/RDS | RDS CPU使用率 |
| RDS - Database Connections | Metric | AWS/RDS | RDS接続数 |
| RDS - Read/Write Latency | Metric | AWS/RDS | RDSレイテンシ |
| Transit Gateway - Bytes | Metric | AWS/TransitGateway | Transit Gateway通信量 |
| Client VPN - Connections | Metric | AWS/ClientVPN | VPN接続数 |
| Application Error Logs | Log | CloudWatch Logs | アプリケーションエラーログ |

---

## 5. CloudWatch Logs 詳細設計

### 5.1 ロググループ構成

```yaml
# Public Web Service
PublicWebLogGroup:
  Type: AWS::Logs::LogGroup
  Properties:
    LogGroupName: /ecs/sample-app/public-web
    RetentionInDays: 30

# Admin Dashboard
AdminDashboardLogGroup:
  Type: AWS::Logs::LogGroup
  Properties:
    LogGroupName: /ecs/sample-app/admin-dashboard
    RetentionInDays: 30

# Batch Processing
BatchProcessingLogGroup:
  Type: AWS::Logs::LogGroup
  Properties:
    LogGroupName: /ecs/sample-app/batch-processing
    RetentionInDays: 30

# VPC Flow Logs (Platform Account)
PlatformVPCFlowLogGroup:
  Type: AWS::Logs::LogGroup
  Properties:
    LogGroupName: /aws/vpc/platform-vpc-flow-logs
    RetentionInDays: 7

# VPC Flow Logs (Service Account)
ServiceVPCFlowLogGroup:
  Type: AWS::Logs::LogGroup
  Properties:
    LogGroupName: /aws/vpc/service-vpc-flow-logs
    RetentionInDays: 7
```

**推定行数**: 約50行

### 5.2 VPC Flow Logs 設計

**目的**: ネットワークトラフィックの可視化・セキュリティ監視

**フィルター**: すべてのトラフィック（ACCEPT + REJECT）

```yaml
# Platform VPC Flow Logs
PlatformVPCFlowLog:
  Type: AWS::EC2::FlowLog
  Properties:
    ResourceType: VPC
    ResourceIds:
      - !Ref PlatformVPC
    TrafficType: ALL
    LogDestinationType: cloud-watch-logs
    LogGroupName: !Ref PlatformVPCFlowLogGroup
    DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn

# Service VPC Flow Logs
ServiceVPCFlowLog:
  Type: AWS::EC2::FlowLog
  Properties:
    ResourceType: VPC
    ResourceIds:
      - !Ref ServiceVPC
    TrafficType: ALL
    LogDestinationType: cloud-watch-logs
    LogGroupName: !Ref ServiceVPCFlowLogGroup
    DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn

# IAM Role for VPC Flow Logs
VPCFlowLogsRole:
  Type: AWS::IAM::Role
  Properties:
    AssumeRolePolicyDocument:
      Version: "2012-10-17"
      Statement:
        - Effect: Allow
          Principal:
            Service: vpc-flow-logs.amazonaws.com
          Action: sts:AssumeRole
    Policies:
      - PolicyName: CloudWatchLogPolicy
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
                - logs:DescribeLogGroups
                - logs:DescribeLogStreams
              Resource: "*"
```

**推定行数**: 約70行

---

## 6. メトリクスフィルター設計

### 6.1 アプリケーションエラー検知

```yaml
AppErrorMetricFilter:
  Type: AWS::Logs::MetricFilter
  Properties:
    FilterPattern: '[timestamp, request_id, level = "ERROR", ...]'
    LogGroupName: !Ref PublicWebLogGroup
    MetricTransformations:
      - MetricName: ApplicationErrorCount
        MetricNamespace: SampleApp/Logs
        MetricValue: "1"
        DefaultValue: 0
```

**推定行数**: 約15行

### 6.2 401 Unauthorized エラー検知

```yaml
UnauthorizedMetricFilter:
  Type: AWS::Logs::MetricFilter
  Properties:
    FilterPattern: '[timestamp, request_id, level, message = "*401*Unauthorized*"]'
    LogGroupName: !Ref PublicWebLogGroup
    MetricTransformations:
      - MetricName: UnauthorizedErrorCount
        MetricNamespace: SampleApp/Logs
        MetricValue: "1"
        DefaultValue: 0
```

**推定行数**: 約15行

### 6.3 データベース接続エラー検知

```yaml
DBConnectionErrorMetricFilter:
  Type: AWS::Logs::MetricFilter
  Properties:
    FilterPattern: '[timestamp, request_id, level = "ERROR", message = "*database*connection*"]'
    LogGroupName: !Ref PublicWebLogGroup
    MetricTransformations:
      - MetricName: DBConnectionErrorCount
        MetricNamespace: SampleApp/Logs
        MetricValue: "1"
        DefaultValue: 0
```

**推定行数**: 約15行

---

## 7. コスト監視

### 7.1 AWS Cost Explorer アラート

**方式**: AWS Budgets を使用

```yaml
MonthlyCostBudget:
  Type: AWS::Budgets::Budget
  Properties:
    Budget:
      BudgetName: !Sub ${ProjectName}-${Environment}-MonthlyCost
      BudgetLimit:
        Amount: 100.0  # $100/月
        Unit: USD
      TimeUnit: MONTHLY
      BudgetType: COST
    NotificationsWithSubscribers:
      - Notification:
          NotificationType: ACTUAL
          ComparisonOperator: GREATER_THAN
          Threshold: 80.0  # 80%超過で通知
        Subscribers:
          - SubscriptionType: EMAIL
            Address: billing-alert@example.com
      - Notification:
          NotificationType: FORECASTED
          ComparisonOperator: GREATER_THAN
          Threshold: 100.0  # 予測が100%超過で通知
        Subscribers:
          - SubscriptionType: EMAIL
            Address: billing-alert@example.com
```

**推定行数**: 約30行

---

## 8. セキュリティ監視

### 8.1 GuardDuty 有効化（推奨）

**方式**: AWS GuardDuty を有効化し、脅威検知を実施

```yaml
GuardDutyDetector:
  Type: AWS::GuardDuty::Detector
  Properties:
    Enable: true
    FindingPublishingFrequency: FIFTEEN_MINUTES
```

**推定行数**: 約10行

### 8.2 VPC Flow Logs 異常検知

**メトリクスフィルター**: REJECT されたパケット数

```yaml
RejectedPacketsMetricFilter:
  Type: AWS::Logs::MetricFilter
  Properties:
    FilterPattern: '[version, account, eni, source, destination, srcport, destport, protocol, packets, bytes, windowstart, windowend, action = "REJECT", flowlogstatus]'
    LogGroupName: !Ref ServiceVPCFlowLogGroup
    MetricTransformations:
      - MetricName: RejectedPacketsCount
        MetricNamespace: SampleApp/Security
        MetricValue: "1"
        DefaultValue: 0

RejectedPacketsAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub ${ProjectName}-${Environment}-RejectedPackets-High
    AlarmDescription: 拒否されたパケット数が異常に高くなっています（セキュリティリスク）
    MetricName: RejectedPacketsCount
    Namespace: SampleApp/Security
    Statistic: Sum
    Period: 300
    EvaluationPeriods: 1
    Threshold: 1000.0
    ComparisonOperator: GreaterThanThreshold
    ActionsEnabled: true
    AlarmActions:
      - !Ref CriticalAlertTopic
    TreatMissingData: notBreaching
```

**推定行数**: 約35行

---

## 9. 監視運用フロー

### 9.1 アラート対応フロー

```
┌─────────────────────┐
│ CloudWatch Alarm    │
│ (閾値超過)          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ SNS Topic           │
│ (メール送信)        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 運用チーム          │
│ (メール受信)        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ CloudWatch Dashboard│
│ (詳細確認)          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ CloudWatch Logs     │
│ (ログ解析)          │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 対応実施            │
│ (スケールアウト等)  │
└─────────────────────┘
```

### 9.2 定期レビュー

**週次**:
- CloudWatch Dashboard 確認
- コスト推移確認（AWS Cost Explorer）
- アラーム発火履歴確認

**月次**:
- アラーム閾値見直し
- ログ保持期間見直し
- 不要なメトリクス削除

---

## 10. 実装方針

### 10.1 ファイル分割方針

**基本方針**: ライフサイクル別に分割

```
infra/cloudformation/service/
├── 04-monitoring.yaml           # 監視リソース親スタック（推定500行）
```

**分割理由**:
- 監視リソースは20以上のCloudWatch Alarmsを含むため、単体で500行超える
- 本来はネスト構成が望ましいが、PoC段階では1ファイルで管理
- 将来的には以下に分割推奨:
  - `nested/alarms-ecs.yaml` - ECS関連アラーム
  - `nested/alarms-alb.yaml` - ALB関連アラーム
  - `nested/alarms-rds.yaml` - RDS関連アラーム
  - `nested/dashboard.yaml` - CloudWatch Dashboard

### 10.2 推定行数

| リソース種別 | 数量 | 推定行数/個 | 合計行数 |
|------------|------|------------|---------|
| CloudWatch Alarms (ECS) | 6個 | 25行 | 150行 |
| CloudWatch Alarms (ALB) | 4個 | 25行 | 100行 |
| CloudWatch Alarms (RDS) | 6個 | 25-50行 | 200行 |
| CloudWatch Alarms (TGW) | 2個 | 25行 | 50行 |
| CloudWatch Alarms (VPN) | 1個 | 25行 | 25行 |
| CloudWatch Alarms (Logs) | 1個 | 40行 | 40行 |
| SNS Topics | 2個 | 15行 | 30行 |
| CloudWatch Dashboard | 1個 | 200行 | 200行 |
| CloudWatch Logs Groups | 5個 | 10行 | 50行 |
| VPC Flow Logs | 2個 + IAM | 70行 | 70行 |
| Metric Filters | 4個 | 15行 | 60行 |
| AWS Budget | 1個 | 30行 | 30行 |
| GuardDuty | 1個 | 10行 | 10行 |
| **合計** | **35リソース** | - | **1,015行** |

**300行超過の理由**:
- CloudWatch Alarms が20以上あり、構造上分割が難しい
- 各アラームは独立しているが、SNS Topicとの関連性が強いため1ファイル管理が適切
- PoC段階では1ファイルで運用し、本番環境ではネスト構成に移行予定

### 10.3 技術標準の適用

**参照技術標準**:
- `.claude/docs/40_standards/45_cloudformation.md` - CloudFormation規約
- `.claude/docs/40_standards/49_security.md` - セキュリティ監視要件

**プロジェクト固有の例外**:
- `04-monitoring.yaml` は1,015行（300行超え）だが、上記理由により許容

### 10.4 実装時の注意事項

1. **アラーム閾値の調整**:
   - 本設計書の閾値は初期値
   - 運用開始後、実際のメトリクスを見て調整が必要

2. **SNS Topic のメール購読確認**:
   - デプロイ後、各メールアドレスに確認メールが送信される
   - 必ず購読確認を実施すること

3. **CloudWatch Dashboard のカスタマイズ**:
   - 本設計書は基本的なウィジェットのみ
   - 運用ニーズに応じてウィジェット追加・変更

4. **VPC Flow Logs のコスト**:
   - トラフィック量が多い場合、ログ保存コストが増大
   - 保持期間を7日に設定（必要に応じて調整）

5. **GuardDuty の有効化**:
   - 本番環境では必ず有効化推奨
   - PoC段階では任意

---

## 変更履歴

| 日付 | 版数 | 変更内容 | 承認者 |
|------|------|----------|--------|
| 2025-10-21 | 1.0 | 初版作成 | - |
