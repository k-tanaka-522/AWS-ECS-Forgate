# デプロイ手順書

## 目次
1. [事前準備](#事前準備)
2. [手動デプロイ手順](#手動デプロイ手順)
3. [GitHub Actionsによる自動デプロイ](#github-actionsによる自動デプロイ)
4. [トラブルシューティング](#トラブルシューティング)

---

## 事前準備

### 1. AWSアカウントの準備

**必要なアカウント:**
- Platform Account (例: 123456789012)
- Service Account (例: 987654321098)

### 2. AWS CLIのインストールと認証設定

```bash
# AWS CLI インストール確認
aws --version

# 認証情報の設定 (Platform Account)
aws configure --profile platform
# AWS Access Key ID: YOUR_ACCESS_KEY
# AWS Secret Access Key: YOUR_SECRET_KEY
# Default region: ap-northeast-1
# Default output format: json

# 認証情報の設定 (Service Account)
aws configure --profile service
```

### 3. Client VPN証明書の準備

Client VPNに必要な証明書を事前に作成し、ACMにインポートします。

```bash
# Easy-RSAで証明書を生成
git clone https://github.com/OpenVPN/easy-rsa.git
cd easy-rsa/easyrsa3

# 初期化
./easyrsa init-pki

# CA証明書の作成
./easyrsa build-ca nopass

# サーバー証明書の作成
./easyrsa build-server-full server nopass

# クライアント証明書の作成
./easyrsa build-client-full client1.domain.tld nopass

# ACMにインポート (Platform Account)
aws acm import-certificate \
  --certificate fileb://pki/issued/server.crt \
  --private-key fileb://pki/private/server.key \
  --certificate-chain fileb://pki/ca.crt \
  --region ap-northeast-1 \
  --profile platform

# サーバー証明書ARNをメモ
# arn:aws:acm:ap-northeast-1:123456789012:certificate/xxxxx

aws acm import-certificate \
  --certificate fileb://pki/issued/client1.domain.tld.crt \
  --private-key fileb://pki/private/client1.domain.tld.key \
  --certificate-chain fileb://pki/ca.crt \
  --region ap-northeast-1 \
  --profile platform

# クライアント証明書ARNをメモ
# arn:aws:acm:ap-northeast-1:123456789012:certificate/yyyyy
```

### 4. ECRリポジトリの作成

```bash
# Service Accountでログイン
export AWS_PROFILE=service

# ECRリポジトリ作成 (3つのサービス用)
aws ecr create-repository \
  --repository-name sample-app/public \
  --region ap-northeast-1

aws ecr create-repository \
  --repository-name sample-app/admin \
  --region ap-northeast-1

aws ecr create-repository \
  --repository-name sample-app/batch \
  --region ap-northeast-1
```

### 5. GitHub Actions用のIAMロール作成 (OIDC)

**Service Accountで実行:**

```bash
# GitHub ActionsからAWSにアクセスするためのOIDCプロバイダーを作成
aws iam create-open-id-connect-provider \
  --url https://token.actions.githubusercontent.com \
  --client-id-list sts.amazonaws.com \
  --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1

# IAMロールを作成
cat > github-actions-trust-policy.json <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::987654321098:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "token.actions.githubusercontent.com:sub": "repo:k-tanaka-522/AWS-ECS-Forgate:*"
        }
      }
    }
  ]
}
EOF

aws iam create-role \
  --role-name GitHubActionsDeploymentRole \
  --assume-role-policy-document file://github-actions-trust-policy.json

# IAMポリシーをアタッチ
aws iam attach-role-policy \
  --role-name GitHubActionsDeploymentRole \
  --policy-arn arn:aws:iam::aws:policy/PowerUserAccess

# ロールARNをメモ
aws iam get-role --role-name GitHubActionsDeploymentRole --query 'Role.Arn' --output text
# arn:aws:iam::987654321098:role/GitHubActionsDeploymentRole
```

### 6. GitHub Secretsの設定

GitHubリポジトリの Settings > Secrets and variables > Actions で以下を設定:

```
AWS_ROLE_ARN=arn:aws:iam::987654321098:role/GitHubActionsDeploymentRole
```

---

## 手動デプロイ手順

GitHub Actionsを使わず、ローカルから手動でデプロイする手順です。

### Step 1: Platform Account - インフラデプロイ

```bash
# Platform Accountに切り替え
export AWS_PROFILE=platform
cd infra/cloudformation/platform

# パラメータファイルを編集
vi parameters/dev.json
# ServerCertificateArn, ClientRootCertificateArn を実際のARNに置き換え

# S3バケット作成 (ネストテンプレート格納用)
BUCKET_NAME="sample-app-dev-cfn-templates"
aws s3 mb s3://$BUCKET_NAME --region ap-northeast-1

# ネストテンプレートをS3にアップロード
aws s3 cp nested/network.yaml s3://$BUCKET_NAME/platform/nested/
aws s3 cp nested/connectivity.yaml s3://$BUCKET_NAME/platform/nested/

# CloudFormationスタックをデプロイ
aws cloudformation deploy \
  --stack-name sample-app-dev-platform \
  --template-file stacks/main/stack.yaml \
  --parameter-overrides file://parameters/dev.json \
  --capabilities CAPABILITY_IAM \
  --region ap-northeast-1

# デプロイ完了まで待機 (約10-15分)
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-platform \
  --region ap-northeast-1

# Transit Gateway IDを取得してメモ
aws cloudformation describe-stacks \
  --stack-name sample-app-dev-platform \
  --query 'Stacks[0].Outputs[?OutputKey==`TransitGatewayId`].OutputValue' \
  --output text
```

### Step 2: Service Account - ネットワークスタックのデプロイ

```bash
# Service Accountに切り替え
export AWS_PROFILE=service
cd infra/cloudformation/service

# パラメータファイルを編集
vi parameters/dev.json
# TransitGatewayId を実際の値に置き換え

# ネットワークスタックをデプロイ
aws cloudformation deploy \
  --stack-name sample-app-dev-service-network \
  --template-file stacks/network/main.yaml \
  --parameter-overrides $(jq -r '.network[] | "\(.ParameterKey)=\(.ParameterValue)"' parameters/dev.json) \
  --capabilities CAPABILITY_IAM \
  --region ap-northeast-1

# デプロイ完了まで待機 (約5-10分)
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-service-network \
  --region ap-northeast-1

# VPC IDとサブネットIDを取得
aws cloudformation describe-stacks \
  --stack-name sample-app-dev-service-network \
  --query 'Stacks[0].Outputs' \
  --output table
```

### Step 3: Service Account - データベーススタックのデプロイ

```bash
# パラメータファイルを編集 (VPC IDとサブネットIDを設定)
vi parameters/dev.json

# データベーススタックをデプロイ
aws cloudformation deploy \
  --stack-name sample-app-dev-service-database \
  --template-file stacks/database/main.yaml \
  --parameter-overrides $(jq -r '.database[] | "\(.ParameterKey)=\(.ParameterValue)"' parameters/dev.json) \
  --capabilities CAPABILITY_IAM \
  --region ap-northeast-1

# デプロイ完了まで待機 (約15-20分、RDS Multi-AZ作成に時間がかかります)
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-service-database \
  --region ap-northeast-1

# RDSエンドポイントを取得
aws cloudformation describe-stacks \
  --stack-name sample-app-dev-service-database \
  --query 'Stacks[0].Outputs[?OutputKey==`DBEndpointAddress`].OutputValue' \
  --output text
```

### Step 4: データベース初期化

```bash
# RDSエンドポイントとパスワードを取得
DB_ENDPOINT=$(aws cloudformation describe-stacks \
  --stack-name sample-app-dev-service-database \
  --query 'Stacks[0].Outputs[?OutputKey==`DBEndpointAddress`].OutputValue' \
  --output text)

DB_PASSWORD_ARN=$(aws cloudformation describe-stacks \
  --stack-name sample-app-dev-service-database \
  --query 'Stacks[0].Outputs[?OutputKey==`DBMasterPasswordSecretArn`].OutputValue' \
  --output text)

DB_PASSWORD=$(aws secretsmanager get-secret-value \
  --secret-id $DB_PASSWORD_ARN \
  --query 'SecretString' \
  --output text | jq -r '.password')

# Client VPN経由でRDSに接続してテーブル作成
# (または、踏み台EC2インスタンスから接続)

psql -h $DB_ENDPOINT -U postgres -d sampleappdb <<EOF
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(100) NOT NULL UNIQUE,
  email VARCHAR(255) NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE stats (
  id SERIAL PRIMARY KEY,
  metric_name VARCHAR(100) NOT NULL,
  metric_value NUMERIC NOT NULL,
  recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- インデックス作成
CREATE INDEX idx_stats_metric_name ON stats(metric_name);
CREATE INDEX idx_stats_recorded_at ON stats(recorded_at);
CREATE INDEX idx_users_created_at ON users(created_at);
EOF
```

### Step 5: Dockerイメージのビルドとプッシュ

```bash
# ECRにログイン
aws ecr get-login-password --region ap-northeast-1 | \
  docker login --username AWS --password-stdin 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com

# Public Web Service
cd app
docker build -t sample-app-public -f public/Dockerfile .
docker tag sample-app-public:latest 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/public:latest
docker push 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/public:latest

# Admin Service
docker build -t sample-app-admin -f admin/Dockerfile .
docker tag sample-app-admin:latest 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/admin:latest
docker push 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/admin:latest

# Batch Service
docker build -t sample-app-batch -f batch/Dockerfile .
docker tag sample-app-batch:latest 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/batch:latest
docker push 987654321098.dkr.ecr.ap-northeast-1.amazonaws.com/sample-app/batch:latest
```

### Step 6: Service Account - コンピュートスタックのデプロイ

```bash
# パラメータファイルを編集 (DB情報を設定)
vi parameters/dev.json

# コンピュートスタックをデプロイ
aws cloudformation deploy \
  --stack-name sample-app-dev-service-compute \
  --template-file stacks/compute/main.yaml \
  --parameter-overrides $(jq -r '.compute[] | "\(.ParameterKey)=\(.ParameterValue)"' parameters/dev.json) \
  --capabilities CAPABILITY_IAM \
  --region ap-northeast-1

# デプロイ完了まで待機 (約5-10分)
aws cloudformation wait stack-create-complete \
  --stack-name sample-app-dev-service-compute \
  --region ap-northeast-1

# ALB DNSを取得
aws cloudformation describe-stacks \
  --stack-name sample-app-dev-service-compute \
  --query 'Stacks[0].Outputs[?OutputKey==`ALBDNSName`].OutputValue' \
  --output text
```

### Step 7: Service Account - モニタリングスタックのデプロイ

```bash
# パラメータファイルを編集 (ECS情報を設定)
vi parameters/dev.json

# モニタリングスタックをデプロイ
aws cloudformation deploy \
  --stack-name sample-app-dev-service-monitoring \
  --template-file stacks/monitoring/main.yaml \
  --parameter-overrides $(jq -r '.monitoring[] | "\(.ParameterKey)=\(.ParameterValue)"' parameters/dev.json) \
  --capabilities CAPABILITY_IAM \
  --region ap-northeast-1
```

### Step 8: 動作確認

```bash
# ALB DNS名を取得
ALB_DNS=$(aws cloudformation describe-stacks \
  --stack-name sample-app-dev-service-compute \
  --query 'Stacks[0].Outputs[?OutputKey==`ALBDNSName`].OutputValue' \
  --output text)

# Health Checkエンドポイントをテスト
curl http://$ALB_DNS/health

# ユーザー作成をテスト
curl -X POST http://$ALB_DNS/api/users \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com"}'

# ユーザー一覧を取得
curl http://$ALB_DNS/api/users
```

---

## GitHub Actionsによる自動デプロイ

### Infrastructure Deployment

**手動トリガー:**

1. GitHubリポジトリ → Actions → "Deploy Infrastructure"
2. "Run workflow" をクリック
3. パラメータ選択:
   - Environment: `dev` or `prod`
   - Account: `platform` or `service`
4. "Run workflow" 実行

**自動トリガー:**
- `infra/cloudformation/` 配下のファイルを変更してmainブランチにpushすると自動実行

### Application Deployment

**手動トリガー:**

1. GitHubリポジトリ → Actions → "Deploy Application"
2. "Run workflow" をクリック
3. パラメータ選択:
   - Environment: `dev` or `prod`
   - Service: `public`, `admin`, `batch`, or `all`
4. "Run workflow" 実行

**自動トリガー:**
- `app/` 配下のファイルを変更してmainブランチにpushすると自動実行

---

## トラブルシューティング

### 問題: CloudFormationスタックの作成が失敗する

**原因と対処:**

1. **パラメータの設定ミス**
   ```bash
   # スタックイベントを確認
   aws cloudformation describe-stack-events \
     --stack-name sample-app-dev-service-network \
     --max-items 20
   ```

2. **リソースの依存関係エラー**
   - 前のスタックが完全にデプロイされているか確認
   - Export値が存在するか確認

3. **IAM権限不足**
   ```bash
   # 現在の認証情報を確認
   aws sts get-caller-identity
   ```

### 問題: ECSタスクが起動しない

**原因と対処:**

1. **Dockerイメージのプル失敗**
   ```bash
   # ECSタスクのログを確認
   aws ecs describe-tasks \
     --cluster sample-app-dev-cluster \
     --tasks <task-arn>
   ```

2. **環境変数の設定ミス**
   - Secrets Managerの値が正しいか確認

3. **ヘルスチェック失敗**
   - CloudWatch Logsでアプリケーションログを確認

### 問題: データベース接続エラー

**原因と対処:**

1. **Security Groupの設定ミス**
   ```bash
   # RDSのSecurity Groupを確認
   aws ec2 describe-security-groups \
     --group-ids <sg-id>
   ```

2. **Secrets Managerの値が取得できない**
   - IAMロールに `secretsmanager:GetSecretValue` 権限があるか確認

3. **ネットワーク疎通の問題**
   - ECSタスクがPrivate Subnetにあるか確認
   - NAT Gatewayが動作しているか確認

### 問題: GitHub Actionsが失敗する

**原因と対処:**

1. **AWS認証エラー**
   - GitHub SecretのAWS_ROLE_ARNが正しいか確認
   - IAMロールのTrust Policyが正しいか確認

2. **Change Set作成エラー**
   - テンプレートファイルのパスが正しいか確認
   - パラメータファイルの形式が正しいか確認

---

## まとめ

デプロイは以下の順序で実行します:

1. 事前準備 (証明書、ECR、IAMロール)
2. Platform Account インフラ
3. Service Account ネットワーク
4. Service Account データベース
5. データベース初期化
6. Dockerイメージビルド & プッシュ
7. Service Account コンピュート
8. Service Account モニタリング

すべて手動実行も可能ですが、GitHub Actionsを使うと自動化できます。
