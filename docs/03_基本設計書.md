# 基本設計書

> AWS Multi-Account Sample Application - 技術検証・社内デモ用サンプル

---

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | AWS Multi-Account Sample Application |
| 文書バージョン | 1.0 |
| 作成日 | 2025-10-24 |
| 最終更新日 | 2025-10-24 |
| 承認状態 | レビュー中 |
| 関連ドキュメント | [要件定義書](02_要件定義書.md) |

---

## 2. システム概要

### 2.1 システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Platform Account                          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Shared VPC (10.0.0.0/16)                               │ │
│  │  - Transit Gateway                                     │ │
│  │  - Client VPN Endpoint                                 │ │
│  │  - NAT Gateway (Multi-AZ)                              │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↕ (Transit Gateway)
┌─────────────────────────────────────────────────────────────┐
│                    Service Account                           │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Service VPC (10.1.0.0/16)                              │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │ │
│  │  │ Public Web   │  │ Admin        │  │ Batch       │  │ │
│  │  │ (ECS)        │  │ (ECS)        │  │ (ECS)       │  │ │
│  │  │ Internet公開 │  │ VPN経由のみ │  │ Schedule実行│  │ │
│  │  └──────────────┘  └──────────────┘  └─────────────┘  │ │
│  │           ↓                ↓                ↓           │ │
│  │  ┌─────────────────────────────────────────────────┐   │ │
│  │  │ RDS PostgreSQL (Multi-AZ)                       │   │ │
│  │  └─────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 設計方針

| 観点 | 方針 | 理由 |
|------|------|------|
| **アカウント分離** | Platform/Service の2アカウント構成 | 共通基盤とアプリケーションの責務分離 |
| **ネットワーク** | Transit Gateway による VPC 接続 | 拡張性・柔軟性の確保 |
| **IaC** | CloudFormation (ネストスタック) | AWS ネイティブ、段階的デプロイ可能 |
| **アプリケーション** | ECS Fargate (コンテナ) | サーバーレス、スケーラビリティ |
| **データベース** | RDS PostgreSQL Multi-AZ | 高可用性、自動バックアップ |
| **監視** | CloudWatch 統合監視 | AWS ネイティブ、低コスト |
| **セキュリティ** | VPN経由の管理アクセス | 閉域接続の実現 |

---

## 3. アーキテクチャ設計

### 3.1 Multi-Account 構成

#### Platform Account（共通基盤アカウント）

**責務**:
- 共通ネットワーク基盤の提供
- Transit Gateway によるアカウント間接続
- Client VPN によるオンプレミス接続
- 共有サービス（将来的な拡張）

**主要リソース**:
| リソース | 用途 | 備考 |
|---------|------|------|
| Shared VPC | 共通ネットワーク基盤 | 10.0.0.0/16 |
| Transit Gateway | VPC 間接続ハブ | Service Account と接続 |
| Client VPN | オンプレミス接続 | 管理者アクセス用 |
| NAT Gateway | インターネットアクセス | Multi-AZ 構成 |

#### Service Account（アプリケーションアカウント）

**責務**:
- アプリケーションサービスの実行
- データベース管理
- アプリケーション監視

**主要リソース**:
| リソース | 用途 | 備考 |
|---------|------|------|
| Service VPC | アプリケーションネットワーク | 10.1.0.0/16 |
| ECS Fargate Cluster | コンテナ実行環境 | 3サービス |
| RDS PostgreSQL | データベース | Multi-AZ |
| ALB | ロードバランサー | Public Web 用 |
| CloudWatch | 監視・ログ | Alarms + Dashboard |

### 3.2 ネットワーク設計

#### CIDR ブロック設計

| VPC | CIDR | 用途 |
|-----|------|------|
| Platform - Shared VPC | 10.0.0.0/16 | 共通基盤 |
| Service - App VPC | 10.1.0.0/16 | アプリケーション |

#### Platform Account - Shared VPC サブネット設計

| サブネット名 | CIDR | AZ | 用途 |
|-------------|------|-----|------|
| Public-1a | 10.0.1.0/24 | ap-northeast-1a | NAT Gateway, VPN Endpoint |
| Public-1c | 10.0.2.0/24 | ap-northeast-1c | NAT Gateway, VPN Endpoint |
| Private-1a | 10.0.11.0/24 | ap-northeast-1a | 共有サービス用（将来） |
| Private-1c | 10.0.12.0/24 | ap-northeast-1c | 共有サービス用（将来） |
| TGW-1a | 10.0.21.0/24 | ap-northeast-1a | Transit Gateway Attachment |
| TGW-1c | 10.0.22.0/24 | ap-northeast-1c | Transit Gateway Attachment |

#### Service Account - App VPC サブネット設計

| サブネット名 | CIDR | AZ | 用途 |
|-------------|------|-----|------|
| Public-1a | 10.1.1.0/24 | ap-northeast-1a | ALB（Public Web用） |
| Public-1c | 10.1.2.0/24 | ap-northeast-1c | ALB（Public Web用） |
| Private-1a | 10.1.11.0/24 | ap-northeast-1a | ECS Tasks（3サービス） |
| Private-1c | 10.1.12.0/24 | ap-northeast-1c | ECS Tasks（3サービス） |
| Database-1a | 10.1.21.0/24 | ap-northeast-1a | RDS Primary |
| Database-1c | 10.1.22.0/24 | ap-northeast-1c | RDS Standby |

#### ルーティング設計

**Platform Account - Shared VPC**:
```
Public Subnet → 0.0.0.0/0 → Internet Gateway
Private Subnet → 0.0.0.0/0 → NAT Gateway
Private Subnet → 10.1.0.0/16 → Transit Gateway
TGW Subnet → 10.1.0.0/16 → Transit Gateway
```

**Service Account - App VPC**:
```
Public Subnet → 0.0.0.0/0 → Internet Gateway
Private Subnet → 0.0.0.0/0 → NAT Gateway
Private Subnet → 10.0.0.0/16 → Transit Gateway (Admin アクセス用)
Database Subnet → 10.0.0.0/16 → Transit Gateway (バックアップ等)
```

### 3.3 Transit Gateway 設計

**Transit Gateway 構成**:
- **Account**: Platform Account に作成
- **RAM 共有**: Service Account に共有
- **ルートテーブル**: 単一ルートテーブル（シンプル構成）

**接続構成**:
```
Transit Gateway
 ├─ Attachment 1: Platform Account Shared VPC (10.0.0.0/16)
 └─ Attachment 2: Service Account App VPC (10.1.0.0/16)
```

**ルート設定**:
| 送信元 | 宛先 | ターゲット |
|-------|------|-----------|
| Shared VPC | 10.1.0.0/16 | App VPC Attachment |
| App VPC | 10.0.0.0/16 | Shared VPC Attachment |

---

## 4. アプリケーション設計

### 4.1 サービス構成

#### Public Web Service
- **用途**: 一般ユーザー向け Web アプリケーション
- **アクセス**: インターネット公開（ALB 経由）
- **実行環境**: ECS Fargate
- **機能**: ユーザー登録、データ参照、統計表示

#### Admin Service
- **用途**: 管理者向けダッシュボード
- **アクセス**: VPN 経由のみ（閉域接続）
- **実行環境**: ECS Fargate
- **機能**: ユーザー管理、システム設定、監視ダッシュボード

#### Batch Service
- **用途**: データ処理・集計バッチ
- **アクセス**: スケジュール実行（EventBridge）
- **実行環境**: ECS Fargate
- **機能**: 日次集計、データクレンジング、レポート生成

### 4.2 アプリケーション技術スタック

| レイヤー | 技術 | バージョン |
|---------|------|-----------|
| ランタイム | Node.js | 20 LTS |
| フレームワーク | Express.js | 4.x |
| データベース接続 | pg (node-postgres) | 8.x |
| コンテナ | Docker | 24.x |
| オーケストレーション | ECS Fargate | - |

### 4.3 データベース設計

**RDS PostgreSQL 構成**:
| 項目 | 設定値 |
|------|--------|
| エンジン | PostgreSQL 16 |
| インスタンスクラス | db.t3.medium（POC用） |
| Multi-AZ | 有効 |
| ストレージ | 100GB（汎用SSD） |
| 自動バックアップ | 7日間保持 |
| 暗号化 | 有効（AWS KMS） |

**テーブル設計** (POC 用シンプル構成):
```sql
-- ユーザーテーブル
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(100) NOT NULL UNIQUE,
  email VARCHAR(255) NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 統計テーブル
CREATE TABLE stats (
  id SERIAL PRIMARY KEY,
  metric_name VARCHAR(100) NOT NULL,
  metric_value NUMERIC NOT NULL,
  recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.4 コンテナイメージ管理

**ECR リポジトリ構成**:
| リポジトリ名 | 用途 |
|-------------|------|
| sample-app/public | Public Web Service イメージ |
| sample-app/admin | Admin Service イメージ |
| sample-app/batch | Batch Service イメージ |

**イメージタグ規則**:
- `latest`: 最新版（開発用）
- `v1.0.0`: バージョンタグ（本番用）
- `dev-{commit-sha}`: 開発ブランチ（検証用）

---

## 5. セキュリティ設計

### 5.1 セキュリティグループ設計

#### Platform Account

**VPN Endpoint Security Group**:
| 方向 | プロトコル | ポート | 送信元/宛先 | 用途 |
|------|----------|--------|------------|------|
| Inbound | UDP | 1194 | 0.0.0.0/0 | VPN 接続 |
| Outbound | All | All | 0.0.0.0/0 | レスポンス |

#### Service Account

**ALB Security Group** (Public Web 用):
| 方向 | プロトコル | ポート | 送信元/宛先 | 用途 |
|------|----------|--------|------------|------|
| Inbound | TCP | 80 | 0.0.0.0/0 | HTTP |
| Inbound | TCP | 443 | 0.0.0.0/0 | HTTPS（将来） |
| Outbound | TCP | 3000 | ECS SG | アプリケーション |

**ECS Security Group** (全サービス共通):
| 方向 | プロトコル | ポート | 送信元/宛先 | 用途 |
|------|----------|--------|------------|------|
| Inbound | TCP | 3000 | ALB SG | Public Web |
| Inbound | TCP | 3000 | 10.0.0.0/16 | Admin (VPN経由) |
| Outbound | TCP | 5432 | RDS SG | Database |
| Outbound | TCP | 443 | 0.0.0.0/0 | AWS API, npm |

**RDS Security Group**:
| 方向 | プロトコル | ポート | 送信元/宛先 | 用途 |
|------|----------|--------|------------|------|
| Inbound | TCP | 5432 | ECS SG | アプリケーション |
| Inbound | TCP | 5432 | 10.0.0.0/16 | 管理アクセス（VPN経由） |
| Outbound | All | All | 0.0.0.0/0 | レスポンス |

### 5.2 IAM 設計

**ECS Task Execution Role** (各サービス):
- CloudWatch Logs 書き込み権限
- ECR イメージ取得権限
- Secrets Manager 読み取り権限（DB認証情報）

**ECS Task Role** (各サービス):
- RDS 接続権限（IAM認証は不使用、Secrets Manager経由）
- S3 アクセス権限（Batch Service のみ、将来）

**GitHub Actions Deployment Role**:
- ECR プッシュ権限
- ECS サービス更新権限
- CloudFormation スタック操作権限

### 5.3 シークレット管理

**Secrets Manager 使用箇所**:
| シークレット名 | 用途 | アクセス元 |
|--------------|------|-----------|
| sample-app/dev/db-master-password | RDS マスターパスワード | CloudFormation |
| sample-app/dev/db-app-credentials | アプリケーション用DB認証情報 | ECS Tasks |

**パラメータストア使用箇所** (非機密情報):
| パラメータ名 | 用途 |
|-------------|------|
| /sample-app/dev/db-endpoint | RDS エンドポイント |
| /sample-app/dev/db-name | データベース名 |

---

## 6. 監視・運用設計

### 6.1 CloudWatch Alarms

#### ECS 監視
| メトリクス | しきい値 | アクション |
|----------|---------|-----------|
| CPU 使用率 | > 80% (5分間) | SNS 通知（Warning） |
| メモリ使用率 | > 80% (5分間) | SNS 通知（Warning） |
| Running Task Count | < 1 | SNS 通知（Critical） |

#### RDS 監視
| メトリクス | しきい値 | アクション |
|----------|---------|-----------|
| CPU 使用率 | > 80% (5分間) | SNS 通知（Warning） |
| 空きストレージ | < 20% | SNS 通知（Warning） |
| DB 接続数 | > 80% (max_connections) | SNS 通知（Critical） |
| レプリケーションラグ | > 30秒 | SNS 通知（Critical） |

#### ALB 監視
| メトリクス | しきい値 | アクション |
|----------|---------|-----------|
| 5xx エラー率 | > 5% (5分間) | SNS 通知（Critical） |
| ターゲット異常数 | > 0 | SNS 通知（Critical） |
| レスポンスタイム | > 1秒 (平均) | SNS 通知（Warning） |

### 6.2 CloudWatch Dashboard

**ダッシュボード構成**:
```
┌─────────────────────────────────────────┐
│ System Overview Dashboard               │
├─────────────────────────────────────────┤
│ [ECS Metrics]                           │
│  - CPU/Memory Usage (3 services)        │
│  - Task Count                           │
├─────────────────────────────────────────┤
│ [RDS Metrics]                           │
│  - CPU/Connections/Storage              │
│  - Replication Lag                      │
├─────────────────────────────────────────┤
│ [ALB Metrics]                           │
│  - Request Count/Error Rate             │
│  - Response Time                        │
├─────────────────────────────────────────┤
│ [Application Logs]                      │
│  - Recent Errors (CloudWatch Insights)  │
└─────────────────────────────────────────┘
```

### 6.3 ログ管理

**CloudWatch Logs ロググループ構成**:
| ロググループ | 保持期間 | 用途 |
|-------------|---------|------|
| /ecs/sample-app/public | 7日 | Public Web ログ |
| /ecs/sample-app/admin | 7日 | Admin ログ |
| /ecs/sample-app/batch | 7日 | Batch ログ |
| /aws/rds/instance/sample-app-db/postgresql | 7日 | RDS ログ |
| /aws/vpn/client | 7日 | VPN 接続ログ |

---

## 7. 非機能要件対応

### 7.1 可用性

| 要件 | 対応策 | 達成水準 |
|------|--------|---------|
| Multi-AZ 構成 | RDS Multi-AZ, ECS タスク分散配置 | 99.9% |
| 障害時の自動復旧 | ECS Auto Healing, RDS 自動フェイルオーバー | < 5分 |
| データバックアップ | RDS 自動バックアップ（7日間保持） | RPO: 24時間 |

### 7.2 性能

| 要件 | 対応策 | 目標値 |
|------|--------|--------|
| レスポンスタイム | ALB + ECS Fargate | < 500ms (P95) |
| スループット | ECS Auto Scaling | 100 req/sec |
| ネットワークレイテンシ | Transit Gateway 最適化 | < 50ms |

### 7.3 セキュリティ

| 要件 | 対応策 |
|------|--------|
| データ暗号化 | RDS 暗号化（KMS）、ECS タスク通信（TLS） |
| アクセス制御 | Security Group、IAM Role、VPN |
| シークレット管理 | Secrets Manager、Parameter Store |
| ログ監査 | CloudWatch Logs、CloudTrail |

### 7.4 運用性

| 要件 | 対応策 |
|------|--------|
| インフラコード化 | CloudFormation テンプレート |
| デプロイ自動化 | GitHub Actions CI/CD |
| 監視・アラート | CloudWatch Alarms + SNS |
| ログ集約 | CloudWatch Logs Insights |

---

## 8. デプロイ戦略

### 8.1 CloudFormation スタック構成

**Platform Account**:
```
platform-stack (親スタック)
 ├─ nested/network.yaml (VPC, Subnets, NAT Gateway)
 └─ nested/connectivity.yaml (Transit Gateway, Client VPN)
```

**Service Account**:
```
service-network-stack (Network)
service-database-stack (RDS, Secrets Manager)
service-compute-stack (ECS, ALB, Auto Scaling)
service-monitoring-stack (CloudWatch Alarms, Dashboard, SNS)
```

### 8.2 デプロイ順序

1. **Platform Account**: `platform-stack` デプロイ
2. **Service Account**:
   1. `service-network-stack`
   2. `service-database-stack`
   3. `service-compute-stack`
   4. `service-monitoring-stack`

### 8.3 CI/CD パイプライン設計

**GitHub Actions ワークフロー**:
```
.github/workflows/
 ├─ infrastructure.yml (CloudFormation デプロイ)
 ├─ application.yml (Docker Build & ECS Deploy)
 └─ pr-validation.yml (Lint, Test, Validation)
```

**デプロイフロー**:
1. PR マージ → main ブランチ
2. Docker イメージビルド → ECR プッシュ
3. ECS サービス更新（Blue/Green デプロイ）
4. ヘルスチェック → 成功/失敗通知

---

## 9. コスト見積もり

### 9.1 月額コスト見積もり（POC環境）

| サービス | 仕様 | 月額（USD） |
|---------|------|-----------|
| EC2 (NAT Gateway) | 2台 (Multi-AZ) | $90 |
| Transit Gateway | 2 Attachments | $73 |
| Client VPN | 1 Endpoint | $72 |
| RDS PostgreSQL | db.t3.medium Multi-AZ | $120 |
| ECS Fargate | 3 Tasks (0.5 vCPU, 1GB) | $60 |
| ALB | 1台 | $25 |
| CloudWatch | Logs + Metrics | $20 |
| **合計** | | **約 $460/月** |

※ データ転送料、S3 ストレージ等は除く

---

## 10. 次フェーズへの引き継ぎ

### 10.1 詳細設計フェーズで決定すべき事項

- CloudFormation テンプレート詳細仕様（Parameters, Resources, Outputs）
- ECS Task Definition 詳細（CPU/Memory 割り当て、環境変数）
- RDS パラメータグループ設定
- CloudWatch Alarms しきい値の最終調整
- GitHub Actions ワークフロー詳細実装

### 10.2 実装フェーズで作成すべき成果物

- CloudFormation テンプレート一式
- Dockerfile + アプリケーションコード
- GitHub Actions ワークフロー YAML
- デプロイ手順書
- 運用手順書

---

## 付録A: 用語集

| 用語 | 説明 |
|------|------|
| Multi-Account | 複数の AWS アカウントを使用する構成 |
| Transit Gateway | VPC 間接続を提供する AWS サービス |
| ECS Fargate | サーバーレスコンテナ実行環境 |
| Multi-AZ | 複数のアベイラビリティゾーンを使用する高可用性構成 |
| CloudFormation | AWS のインフラコード管理サービス |

---

**承認**:

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトマネージャー | | | |
| 技術リード | | | |

---

**変更履歴**:

| バージョン | 日付 | 変更者 | 変更内容 |
|----------|------|--------|---------|
| 1.0 | 2025-10-24 | AI | 初版作成 |
