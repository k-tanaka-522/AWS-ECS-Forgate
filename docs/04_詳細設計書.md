# 詳細設計書

> AWS Multi-Account Sample Application
> Transit Gateway による拠点間閉域接続を実現する技術検証・社内デモ用サンプル

---

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | AWS Multi-Account Sample Application |
| 文書バージョン | 2.0 |
| 作成日 | 2025-10-20 |
| 最終更新日 | 2025-10-20 |
| 承認状態 | 承認待ち |

---

## 2. このドキュメントの目的

### 2.1 POCにおける詳細設計の重要性

**なぜPOCでも詳細設計が必要か：**

1. **再現性の確保**
   - 検証結果を他のメンバーが再現できるように
   - 将来的に本番化する際の参考資料として

2. **検証ポイントの明確化**
   - 何を検証したいのかを明確にする
   - 検証結果の判断基準を事前に定義

3. **技術的知見の蓄積**
   - なぜこの設計にしたのか（代替案との比較）
   - ハマったポイント、注意点の記録
   - 次のプロジェクトへの知見共有

4. **コスト・リスクの可視化**
   - 本番化した場合のコスト試算
   - 技術的リスクの洗い出し

### 2.2 本ドキュメントで記載する内容

- CloudFormationテンプレートの詳細設計
- アプリケーションコードの詳細設計
- データベーススキーマの詳細設計
- API詳細仕様
- シークレット管理の詳細設計
- デプロイ手順の詳細
- 検証シナリオと成功基準

---

## 3. CloudFormation詳細設計

### 3.1 スタック分割戦略

**なぜスタックを分割するのか：**

| 理由 | 説明 | メリット |
|------|------|---------|
| **責務の分離** | ネットワーク、データベース、コンピュートで分割 | 保守性向上 |
| **部分的な更新** | 一部のスタックのみ更新可能 | リスク低減 |
| **依存関係の明確化** | スタック間の依存を明示 | 理解しやすい |
| **ロールバックの粒度** | 失敗時に該当スタックのみロールバック | 影響範囲最小化 |

**スタック分割の粒度判断基準：**
- ✅ 同時に変更される可能性が高い → 同じスタック
- ✅ 独立して変更される可能性が高い → 別スタック
- ✅ 他のスタックに依存される → 先に作成されるスタック

### 3.2 Platform Account: stack.yaml（親スタック）

**目的：**
- ネストスタックの統合管理
- パラメータの一元管理
- スタック間の依存関係制御

**パラメータ設計：**

```yaml
Parameters:
  Environment:
    Type: String
    AllowedValues:
      - dev
      - prod
    Default: dev
    Description: 環境名（dev/prod）

  ProjectName:
    Type: String
    Default: myapp
    Description: プロジェクト名（リソース名プレフィックスに使用）

  SharedVpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: Shared VPC CIDR
    AllowedPattern: ^(10\.([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.0)/(16)$
    ConstraintDescription: 10.x.x.0/16 形式で入力してください

  ServiceAccountId:
    Type: String
    Description: Service AccountのAWSアカウントID（Transit Gateway共有用）
    AllowedPattern: ^\d{12}$
    ConstraintDescription: 12桁の数字で入力してください
```

**なぜこのパラメータ構成なのか：**
- `Environment`: dev/prodで環境差分を管理（将来的にstg追加可能）
- `ProjectName`: 複数プロジェクトで再利用可能な汎用性
- `SharedVpcCidr`: CIDR重複を防ぐバリデーション付き
- `ServiceAccountId`: Transit Gateway共有のために必須

**ネストスタック構成：**

```yaml
Resources:
  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateBucketName}/nested/network.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        VpcCidr: !Ref SharedVpcCidr
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-network
        - Key: Environment
          Value: !Ref Environment

  ConnectivityStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: NetworkStack
    Properties:
      TemplateURL: !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateBucketName}/nested/connectivity.yaml
      Parameters:
        Environment: !Ref Environment
        ProjectName: !Ref ProjectName
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        PrivateSubnet1Id: !GetAtt NetworkStack.Outputs.PrivateSubnet1Id
        PrivateSubnet2Id: !GetAtt NetworkStack.Outputs.PrivateSubnet2Id
        ServiceAccountId: !Ref ServiceAccountId
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-connectivity
        - Key: Environment
          Value: !Ref Environment
```

**依存関係の制御：**
- `DependsOn: NetworkStack`: ConnectivityStackはNetworkStackが完了するまで待機
- `!GetAtt`: ネストスタックの出力を別のネストスタックに渡す

### 3.3 Platform Account: nested/network.yaml

**目的：**
- Shared VPCの構築
- パブリック/プライベートサブネットの作成
- Internet Gateway、NAT Gatewayの構築

**検証ポイント：**
- ✅ Multi-AZ構成でNAT Gatewayが正常に動作するか
- ✅ プライベートサブネットからインターネット通信ができるか

**VPC設計の詳細：**

```yaml
Resources:
  # VPC
  SharedVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-vpc

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref SharedVPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet 1 (AZ-1a)
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SharedVPC
      CidrBlock: !Select [0, !Cidr [!Ref VpcCidr, 4, 8]]  # 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-public-1a

  # Public Subnet 2 (AZ-1c)
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SharedVPC
      CidrBlock: !Select [1, !Cidr [!Ref VpcCidr, 4, 8]]  # 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-public-1c

  # NAT Gateway 1 (AZ-1a)
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-nat-1a-eip

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-nat-1a

  # NAT Gateway 2 (AZ-1c)
  NatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-nat-1c-eip

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-nat-1c

  # Private Subnet 1 (AZ-1a)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SharedVPC
      CidrBlock: !Select [2, !Cidr [!Ref VpcCidr, 4, 8]]  # 10.0.11.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-private-1a

  # Private Subnet 2 (AZ-1c)
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SharedVPC
      CidrBlock: !Select [3, !Cidr [!Ref VpcCidr, 4, 8]]  # 10.0.12.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-private-1c

  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SharedVPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # Private Route Table 1 (AZ-1a)
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SharedVPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-private-rt-1a

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  # Private Route Table 2 (AZ-1c)
  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SharedVPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-shared-private-rt-1c

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

Outputs:
  VpcId:
    Value: !Ref SharedVPC
    Export:
      Name: !Sub ${ProjectName}-${Environment}-shared-vpc-id

  PublicSubnet1Id:
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub ${ProjectName}-${Environment}-shared-public-subnet-1a-id

  PublicSubnet2Id:
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub ${ProjectName}-${Environment}-shared-public-subnet-1c-id

  PrivateSubnet1Id:
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub ${ProjectName}-${Environment}-shared-private-subnet-1a-id

  PrivateSubnet2Id:
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub ${ProjectName}-${Environment}-shared-private-subnet-1c-id

  PrivateRouteTable1Id:
    Value: !Ref PrivateRouteTable1
    Export:
      Name: !Sub ${ProjectName}-${Environment}-shared-private-rt-1a-id

  PrivateRouteTable2Id:
    Value: !Ref PrivateRouteTable2
    Export:
      Name: !Sub ${ProjectName}-${Environment}-shared-private-rt-1c-id
```

**設計のポイント：**

1. **!Cidr関数の活用**
   - `!Select [0, !Cidr [!Ref VpcCidr, 4, 8]]`
   - VPC CIDRから自動的にサブネットCIDRを生成
   - メリット：手動計算不要、CIDR変更時の修正箇所が少ない

2. **Multi-AZ構成**
   - NAT Gatewayを各AZに配置
   - 理由：単一AZ障害時も継続してインターネット通信可能

3. **Outputs/Export**
   - 他のスタックから参照可能にする
   - `!ImportValue`で参照される

### 3.4 Platform Account: nested/connectivity.yaml

**目的：**
- Transit Gatewayの構築
- Client VPN Endpointの構築
- Transit Gateway共有（RAM）

**検証ポイント：**
- ✅ Transit GatewayでVPC間通信ができるか
- ✅ Client VPN経由でプライベートリソースにアクセスできるか

**Transit Gateway設計の詳細：**

```yaml
Resources:
  # Transit Gateway
  TransitGateway:
    Type: AWS::EC2::TransitGateway
    Properties:
      Description: !Sub ${ProjectName}-${Environment} Transit Gateway
      DefaultRouteTableAssociation: disable  # 明示的なルートテーブル管理
      DefaultRouteTablePropagation: disable  # 明示的なルートテーブル管理
      DnsSupport: enable
      VpnEcmpSupport: enable
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-tgw

  # Transit Gateway Attachment（Platform Account - Shared VPC）
  TransitGatewayAttachmentPlatform:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGateway
      VpcId: !Ref VpcId
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-tgw-attach-platform

  # Transit Gateway Route Table（Platform用）
  TransitGatewayRouteTablePlatform:
    Type: AWS::EC2::TransitGatewayRouteTable
    Properties:
      TransitGatewayId: !Ref TransitGateway
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-tgw-rt-platform

  # Transit Gateway Route Table Association（Platform）
  TransitGatewayRouteTableAssociationPlatform:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref TransitGatewayAttachmentPlatform
      TransitGatewayRouteTableId: !Ref TransitGatewayRouteTablePlatform

  # Transit Gateway Route（Service VPC向け）- Service Accountデプロイ後に手動追加
  # TransitGatewayRoutePlatformToService:
  #   Type: AWS::EC2::TransitGatewayRoute
  #   Properties:
  #     TransitGatewayRouteTableId: !Ref TransitGatewayRouteTablePlatform
  #     DestinationCidrBlock: 10.1.0.0/16
  #     TransitGatewayAttachmentId: <Service Account TGW Attachment ID>

  # VPC Route（Transit Gateway向け）- Private Subnet 1
  PrivateSubnet1RouteToTransitGateway:
    Type: AWS::EC2::Route
    DependsOn: TransitGatewayAttachmentPlatform
    Properties:
      RouteTableId: !ImportValue
        Fn::Sub: ${ProjectName}-${Environment}-shared-private-rt-1a-id
      DestinationCidrBlock: 10.1.0.0/16
      TransitGatewayId: !Ref TransitGateway

  # VPC Route（Transit Gateway向け）- Private Subnet 2
  PrivateSubnet2RouteToTransitGateway:
    Type: AWS::EC2::Route
    DependsOn: TransitGatewayAttachmentPlatform
    Properties:
      RouteTableId: !ImportValue
        Fn::Sub: ${ProjectName}-${Environment}-shared-private-rt-1c-id
      DestinationCidrBlock: 10.1.0.0/16
      TransitGatewayId: !Ref TransitGateway

  # Transit Gateway共有（RAM）
  TransitGatewayResourceShare:
    Type: AWS::RAM::ResourceShare
    Properties:
      Name: !Sub ${ProjectName}-${Environment}-tgw-share
      Principals:
        - !Sub arn:aws:iam::${ServiceAccountId}:root
      ResourceArns:
        - !Sub arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:transit-gateway/${TransitGateway}
      AllowExternalPrincipals: false

  # Client VPN Endpoint
  ClientVpnEndpoint:
    Type: AWS::EC2::ClientVpnEndpoint
    Properties:
      Description: !Sub ${ProjectName}-${Environment} Client VPN Endpoint
      ClientCidrBlock: 172.16.0.0/22
      ServerCertificateArn: !Ref ServerCertificateArn
      AuthenticationOptions:
        - Type: certificate-authentication
          MutualAuthentication:
            ClientRootCertificateChainArn: !Ref ClientRootCertificateArn
      ConnectionLogOptions:
        Enabled: true
        CloudwatchLogGroup: !Ref VpnLogGroup
      DnsServers:
        - !Select [0, !GetAtt VpcId.CidrBlockAssociations]  # VPC DNSサーバー
      SplitTunnel: true  # AWSリソースのみVPN経由
      VpcId: !Ref VpcId
      SecurityGroupIds:
        - !Ref ClientVpnSecurityGroup
      TagSpecifications:
        - ResourceType: client-vpn-endpoint
          Tags:
            - Key: Name
              Value: !Sub ${ProjectName}-${Environment}-client-vpn

  # Client VPN Target Network Association（AZ-1a）
  ClientVpnTargetNetworkAssociation1:
    Type: AWS::EC2::ClientVpnTargetNetworkAssociation
    Properties:
      ClientVpnEndpointId: !Ref ClientVpnEndpoint
      SubnetId: !Ref PrivateSubnet1Id

  # Client VPN Target Network Association（AZ-1c）
  ClientVpnTargetNetworkAssociation2:
    Type: AWS::EC2::ClientVpnTargetNetworkAssociation
    Properties:
      ClientVpnEndpointId: !Ref ClientVpnEndpoint
      SubnetId: !Ref PrivateSubnet2Id

  # Client VPN Authorization Rule（Shared VPC）
  ClientVpnAuthorizationRuleSharedVpc:
    Type: AWS::EC2::ClientVpnAuthorizationRule
    Properties:
      ClientVpnEndpointId: !Ref ClientVpnEndpoint
      TargetNetworkCidr: 10.0.0.0/16
      AuthorizeAllGroups: true
      Description: Allow access to Shared VPC

  # Client VPN Authorization Rule（Service VPC via Transit Gateway）
  ClientVpnAuthorizationRuleServiceVpc:
    Type: AWS::EC2::ClientVpnAuthorizationRule
    Properties:
      ClientVpnEndpointId: !Ref ClientVpnEndpoint
      TargetNetworkCidr: 10.1.0.0/16
      AuthorizeAllGroups: true
      Description: Allow access to Service VPC via Transit Gateway

  # Client VPN Route（Transit Gateway向け）
  ClientVpnRouteToTransitGateway:
    Type: AWS::EC2::ClientVpnRoute
    DependsOn:
      - ClientVpnTargetNetworkAssociation1
      - ClientVpnTargetNetworkAssociation2
    Properties:
      ClientVpnEndpointId: !Ref ClientVpnEndpoint
      DestinationCidrBlock: 10.1.0.0/16
      TargetVpcSubnetId: !Ref PrivateSubnet1Id
      Description: Route to Service VPC via Transit Gateway

  # Security Group（Client VPN用）
  ClientVpnSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Client VPN Endpoint
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: -1
          CidrIp: 172.16.0.0/22
          Description: Allow all from VPN clients
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-client-vpn-sg

  # CloudWatch Logs（VPN接続ログ）
  VpnLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vpn/${ProjectName}-${Environment}
      RetentionInDays: 30

Outputs:
  TransitGatewayId:
    Value: !Ref TransitGateway
    Export:
      Name: !Sub ${ProjectName}-${Environment}-tgw-id

  ClientVpnEndpointId:
    Value: !Ref ClientVpnEndpoint
    Export:
      Name: !Sub ${ProjectName}-${Environment}-client-vpn-endpoint-id
```

**設計のポイント：**

1. **Transit Gateway Route Table管理**
   - `DefaultRouteTableAssociation: disable`
   - 理由：明示的にルートテーブルを管理し、意図しない通信を防ぐ

2. **Client VPN Split Tunnel**
   - `SplitTunnel: true`
   - 理由：AWSリソースのみVPN経由、その他はローカルインターネット経由
   - メリット：VPN帯域を節約、パフォーマンス向上

3. **Client VPN証明書管理**
   - `ServerCertificateArn`、`ClientRootCertificateArn`はパラメータで受け取る
   - 理由：証明書はACMで事前に作成・管理

4. **Transit Gateway共有（RAM）**
   - `AWS::RAM::ResourceShare`でService Accountに共有
   - 理由：クロスアカウントでTransit Gatewayを使用可能に

### 3.5 Service Account: 01-network.yaml

**目的：**
- Service VPCの構築
- Transit Gateway Attachmentの作成
- Service VPCからTransit Gateway経由でShared VPCへのルート追加

**検証ポイント：**
- ✅ Transit Gateway経由でShared VPCと通信できるか
- ✅ VPN経由でService VPC内のリソースにアクセスできるか

**詳細設計：**

```yaml
Parameters:
  Environment:
    Type: String
    AllowedValues:
      - dev
      - prod
    Default: dev

  ProjectName:
    Type: String
    Default: myapp

  ServiceVpcCidr:
    Type: String
    Default: 10.1.0.0/16

  TransitGatewayId:
    Type: String
    Description: Platform AccountのTransit Gateway ID

Resources:
  # VPC
  ServiceVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref ServiceVpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-vpc

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref ServiceVPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet 1 (AZ-1a) - ALB配置
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: !Select [0, !Cidr [!Ref ServiceVpcCidr, 4, 8]]  # 10.1.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-public-1a

  # Public Subnet 2 (AZ-1c) - ALB配置
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: !Select [1, !Cidr [!Ref ServiceVpcCidr, 4, 8]]  # 10.1.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-public-1c

  # NAT Gateway 1 (AZ-1a)
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-nat-1a-eip

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-nat-1a

  # NAT Gateway 2 (AZ-1c)
  NatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-nat-1c-eip

  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-nat-1c

  # Private Subnet 1 (AZ-1a) - ECS, RDS配置
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: !Select [2, !Cidr [!Ref ServiceVpcCidr, 4, 8]]  # 10.1.11.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-private-1a

  # Private Subnet 2 (AZ-1c) - ECS, RDS配置
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ServiceVPC
      CidrBlock: !Select [3, !Cidr [!Ref ServiceVpcCidr, 4, 8]]  # 10.1.12.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-private-1c

  # Transit Gateway Attachment（Service Account - Service VPC）
  TransitGatewayAttachmentService:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGatewayId
      VpcId: !Ref ServiceVPC
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-tgw-attach-service

  # Public Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ServiceVPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # Private Route Table 1 (AZ-1a)
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ServiceVPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-private-rt-1a

  PrivateRoute1Internet:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateRoute1ToSharedVpc:
    Type: AWS::EC2::Route
    DependsOn: TransitGatewayAttachmentService
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 10.0.0.0/16
      TransitGatewayId: !Ref TransitGatewayId

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  # Private Route Table 2 (AZ-1c)
  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ServiceVPC
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-service-private-rt-1c

  PrivateRoute2Internet:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2

  PrivateRoute2ToSharedVpc:
    Type: AWS::EC2::Route
    DependsOn: TransitGatewayAttachmentService
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 10.0.0.0/16
      TransitGatewayId: !Ref TransitGatewayId

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

Outputs:
  VpcId:
    Value: !Ref ServiceVPC
    Export:
      Name: !Sub ${ProjectName}-${Environment}-service-vpc-id

  PublicSubnet1Id:
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub ${ProjectName}-${Environment}-service-public-subnet-1a-id

  PublicSubnet2Id:
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub ${ProjectName}-${Environment}-service-public-subnet-1c-id

  PrivateSubnet1Id:
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub ${ProjectName}-${Environment}-service-private-subnet-1a-id

  PrivateSubnet2Id:
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub ${ProjectName}-${Environment}-service-private-subnet-1c-id

  TransitGatewayAttachmentId:
    Value: !Ref TransitGatewayAttachmentService
    Export:
      Name: !Sub ${ProjectName}-${Environment}-tgw-attach-service-id
```

**設計のポイント：**

1. **Transit Gateway Attachment作成**
   - Service VPCをTransit Gatewayにアタッチ
   - Platform AccountのTransit Gateway IDをパラメータで受け取る

2. **ルート追加（Transit Gateway向け）**
   - `DestinationCidrBlock: 10.0.0.0/16`（Shared VPC）
   - `TransitGatewayId: !Ref TransitGatewayId`
   - これによりService VPCからShared VPCへの通信が可能に

3. **Multi-AZ NAT Gateway**
   - 各AZに配置して可用性確保

---

## 4. データベース詳細設計（RDS PostgreSQL）

### 4.1 02-database.yaml

**目的：**
- RDS PostgreSQL Multi-AZ構成の構築
- DB Subnet Groupの作成
- セキュリティグループの作成
- Secrets Managerでパスワード管理

**検証ポイント：**
- ✅ Multi-AZ構成で自動フェイルオーバーが動作するか
- ✅ ECS FargateからRDS接続ができるか
- ✅ Secrets Managerから安全にパスワード取得できるか

**詳細設計：**

```yaml
Parameters:
  Environment:
    Type: String
    Default: dev

  ProjectName:
    Type: String
    Default: myapp

  DBInstanceClass:
    Type: String
    Default: db.t3.medium
    Description: RDSインスタンスクラス

  DBAllocatedStorage:
    Type: Number
    Default: 100
    Description: ストレージ容量（GB）

  DBMaxAllocatedStorage:
    Type: Number
    Default: 200
    Description: Auto Scaling最大容量（GB）

Resources:
  # DB Subnet Group
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub ${ProjectName}-${Environment}-db-subnet-group
      DBSubnetGroupDescription: Subnet group for RDS
      SubnetIds:
        - !ImportValue
            Fn::Sub: ${ProjectName}-${Environment}-service-private-subnet-1a-id
        - !ImportValue
            Fn::Sub: ${ProjectName}-${Environment}-service-private-subnet-1c-id
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-db-subnet-group

  # Security Group（RDS用）
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS PostgreSQL
      VpcId: !ImportValue
        Fn::Sub: ${ProjectName}-${Environment}-service-vpc-id
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-rds-sg

  # Secrets Manager（DBパスワード）
  DBSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${ProjectName}/${Environment}/db/credentials
      Description: RDS PostgreSQL master credentials
      GenerateSecretString:
        SecretStringTemplate: '{"username": "postgres"}'
        GenerateStringKey: password
        PasswordLength: 32
        ExcludeCharacters: '"@/\'
        RequireEachIncludedType: true
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-db-secret

  # Secrets Manager Attachment（RDS紐付け）
  DBSecretAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref DBSecret
      TargetId: !Ref DBInstance
      TargetType: AWS::RDS::DBInstance

  # RDS PostgreSQL Instance
  DBInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot  # 削除時スナップショット作成
    Properties:
      DBInstanceIdentifier: !Sub ${ProjectName}-${Environment}-db
      Engine: postgres
      EngineVersion: '14.10'
      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: !Ref DBAllocatedStorage
      MaxAllocatedStorage: !Ref DBMaxAllocatedStorage
      StorageType: gp3
      StorageEncrypted: true
      KmsKeyId: !Ref DBEncryptionKey
      MultiAZ: true
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      MasterUsername: !Sub '{{resolve:secretsmanager:${DBSecret}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DBSecret}:SecretString:password}}'
      DBName: myapp_db
      BackupRetentionPeriod: 7
      PreferredBackupWindow: '19:00-20:00'  # 04:00-05:00 JST
      PreferredMaintenanceWindow: 'sun:20:00-sun:21:00'  # Sun 05:00-06:00 JST
      EnableCloudwatchLogsExports:
        - postgresql
        - upgrade
      EnablePerformanceInsights: true
      PerformanceInsightsRetentionPeriod: 7
      MonitoringInterval: 60
      MonitoringRoleArn: !GetAtt RDSMonitoringRole.Arn
      DeletionProtection: false  # 検証用のためfalse
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-rds

  # KMS Key（RDS暗号化用）
  DBEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub ${ProjectName}-${Environment} RDS encryption key
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: '*'
          - Sid: Allow RDS to use the key
            Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:CreateGrant
            Resource: '*'

  DBEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub alias/${ProjectName}-${Environment}-rds
      TargetKeyId: !Ref DBEncryptionKey

  # IAM Role（RDS Enhanced Monitoring用）
  RDSMonitoringRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-${Environment}-rds-monitoring-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: monitoring.rds.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole

  # Parameter Store（非機密情報）
  DBHostParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${ProjectName}/${Environment}/db/host
      Description: RDS endpoint
      Type: String
      Value: !GetAtt DBInstance.Endpoint.Address

  DBPortParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${ProjectName}/${Environment}/db/port
      Description: RDS port
      Type: String
      Value: '5432'

  DBNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${ProjectName}/${Environment}/db/name
      Description: Database name
      Type: String
      Value: myapp_db

Outputs:
  DBInstanceId:
    Value: !Ref DBInstance
    Export:
      Name: !Sub ${ProjectName}-${Environment}-db-instance-id

  DBEndpoint:
    Value: !GetAtt DBInstance.Endpoint.Address
    Export:
      Name: !Sub ${ProjectName}-${Environment}-db-endpoint

  DBSecretArn:
    Value: !Ref DBSecret
    Export:
      Name: !Sub ${ProjectName}-${Environment}-db-secret-arn

  DBSecurityGroupId:
    Value: !Ref DBSecurityGroup
    Export:
      Name: !Sub ${ProjectName}-${Environment}-rds-sg-id
```

**設計のポイント：**

1. **Secrets Manager自動生成パスワード**
   - `GenerateSecretString`で安全なパスワード自動生成
   - 32文字、特殊文字含む、ランダム生成

2. **Dynamic Referenceでパスワード取得**
   - `!Sub '{{resolve:secretsmanager:${DBSecret}:SecretString:password}}'`
   - CloudFormation実行時に動的にSecrets Managerから取得
   - パスワードがCloudFormationテンプレートに記載されない

3. **KMS暗号化**
   - RDSストレージをKMSで暗号化
   - 独自のKMS Keyを作成して管理

4. **Parameter Store（非機密情報）**
   - DBエンドポイント、ポート、DB名
   - ECS Task Definitionから環境変数として参照

5. **DeletionPolicy: Snapshot**
   - スタック削除時に自動スナップショット作成
   - データ保護

6. **Enhanced Monitoring**
   - `MonitoringInterval: 60`（60秒間隔）
   - OS metrics（CPU、メモリ、ディスク等）を詳細監視

### 4.2 初期データ投入

**DDL実行方法：**

1. **ECS Task（ワンショット）でマイグレーション実行**
2. **Bastion Host経由でpsql実行**（VPN接続後）
3. **AWS Systems Manager Session Manager経由**

**マイグレーションツール選定：**
- **Knex.js Migrations**（Node.jsアプリとの親和性）
- バージョン管理、ロールバック対応

**マイグレーションファイル構成：**
```
app/shared/db/migrations/
├── 20251020120000_create_users_table.js
├── 20251020120100_create_products_table.js
├── 20251020120200_create_orders_table.js
└── 20251020120300_create_order_items_table.js
```

---

## 5. ECS Fargate詳細設計

### 5.1 03-compute.yaml

**目的：**
- ECS Clusterの作成
- Task Definition（Public/Admin/Batch）の作成
- ECS Serviceの作成
- ALB、Target Groupの作成
- Auto Scalingの設定

**検証ポイント：**
- ✅ ECS Fargateが正常に起動するか
- ✅ ALB経由でアクセスできるか
- ✅ Auto Scalingが動作するか
- ✅ Secrets ManagerからDBパスワード取得できるか

**詳細設計（一部抜粋）：**

```yaml
Resources:
  # ECS Cluster
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub ${ProjectName}-${Environment}-cluster
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-ecs-cluster

  # Task Execution Role
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-${Environment}-ecs-task-execution-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !ImportValue
                  Fn::Sub: ${ProjectName}-${Environment}-db-secret-arn
        - PolicyName: SSMParameterAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameters
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${ProjectName}/${Environment}/db/*

  # Task Role
  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-${Environment}-ecs-task-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudWatchLogsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/${ProjectName}/*

  # CloudWatch Logs Group（Public Web）
  PublicWebLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/${ProjectName}/${Environment}/public-web
      RetentionInDays: 30

  # Task Definition（Public Web）
  PublicWebTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${ProjectName}-${Environment}-public-web-task
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: '512'  # 0.5 vCPU
      Memory: '1024'  # 1 GB
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: public-web
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ProjectName}-public-web:latest
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: NODE_ENV
              Value: production
            - Name: DB_HOST
              Value: !Sub '{{resolve:ssm:/${ProjectName}/${Environment}/db/host}}'
            - Name: DB_PORT
              Value: !Sub '{{resolve:ssm:/${ProjectName}/${Environment}/db/port}}'
            - Name: DB_NAME
              Value: !Sub '{{resolve:ssm:/${ProjectName}/${Environment}/db/name}}'
          Secrets:
            - Name: DB_PASSWORD
              ValueFrom: !Sub '{{resolve:secretsmanager:${ProjectName}/${Environment}/db/credentials:SecretString:password}}'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref PublicWebLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs
          HealthCheck:
            Command:
              - CMD-SHELL
              - curl -f http://localhost:8080/health || exit 1
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 60

  # Security Group（Public Web ECS）
  PublicWebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Public Web ECS tasks
      VpcId: !ImportValue
        Fn::Sub: ${ProjectName}-${Environment}-service-vpc-id
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref PublicALBSecurityGroup
          Description: Allow from Public ALB
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS outbound (ECR, external APIs)
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId: !ImportValue
            Fn::Sub: ${ProjectName}-${Environment}-rds-sg-id
          Description: Allow RDS PostgreSQL connection
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-web-ecs-sg

  # RDS Security Group Ingress Rule（Public Web ECSから）
  RDSSecurityGroupIngressFromPublicWeb:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !ImportValue
        Fn::Sub: ${ProjectName}-${Environment}-rds-sg-id
      IpProtocol: tcp
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId: !Ref PublicWebSecurityGroup
      Description: Allow from Public Web ECS

  # ALB（Public）
  PublicALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${ProjectName}-${Environment}-public-alb
      Type: application
      Scheme: internet-facing
      IpAddressType: ipv4
      Subnets:
        - !ImportValue
            Fn::Sub: ${ProjectName}-${Environment}-service-public-subnet-1a-id
        - !ImportValue
            Fn::Sub: ${ProjectName}-${Environment}-service-public-subnet-1c-id
      SecurityGroups:
        - !Ref PublicALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-alb

  # Security Group（Public ALB）
  PublicALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Public ALB
      VpcId: !ImportValue
        Fn::Sub: ${ProjectName}-${Environment}-service-vpc-id
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Allow HTTPS from Internet
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: Allow HTTP from Internet (redirect to HTTPS)
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-alb-sg

  # Target Group（Public Web）
  PublicWebTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${ProjectName}-${Environment}-public-tg
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      VpcId: !ImportValue
        Fn::Sub: ${ProjectName}-${Environment}-service-vpc-id
      HealthCheckEnabled: true
      HealthCheckProtocol: HTTP
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 5
      Matcher:
        HttpCode: '200'
      DeregistrationDelay: 30
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-tg

  # ALB Listener（HTTPS）
  PublicALBListenerHTTPS:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref PublicALB
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref ACMCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref PublicWebTargetGroup

  # ALB Listener（HTTP → HTTPS Redirect）
  PublicALBListenerHTTP:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref PublicALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            StatusCode: HTTP_301

  # ECS Service（Public Web）
  PublicWebService:
    Type: AWS::ECS::Service
    DependsOn: PublicALBListenerHTTPS
    Properties:
      ServiceName: !Sub ${ProjectName}-${Environment}-public-web-service
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref PublicWebTaskDefinition
      DesiredCount: 2
      LaunchType: FARGATE
      PlatformVersion: LATEST
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          Subnets:
            - !ImportValue
                Fn::Sub: ${ProjectName}-${Environment}-service-private-subnet-1a-id
            - !ImportValue
                Fn::Sub: ${ProjectName}-${Environment}-service-private-subnet-1c-id
          SecurityGroups:
            - !Ref PublicWebSecurityGroup
      LoadBalancers:
        - TargetGroupArn: !Ref PublicWebTargetGroup
          ContainerName: public-web
          ContainerPort: 8080
      HealthCheckGracePeriodSeconds: 60
      DeploymentConfiguration:
        MinimumHealthyPercent: 100
        MaximumPercent: 200
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-public-web-service

  # Auto Scaling Target
  PublicWebAutoScalingTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: 10
      MinCapacity: 2
      ResourceId: !Sub service/${ECSCluster}/${PublicWebService.Name}
      RoleARN: !Sub arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  # Auto Scaling Policy（CPU）
  PublicWebAutoScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub ${ProjectName}-${Environment}-public-web-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref PublicWebAutoScalingTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 70.0
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: 300
        ScaleOutCooldown: 60
```

**設計のポイント：**

1. **Dynamic ReferenceでSecrets Manager/Parameter Store参照**
   - Environment: `!Sub '{{resolve:ssm:...}}'`
   - Secrets: `!Sub '{{resolve:secretsmanager:...}}'`
   - 実行時に動的に取得、CloudFormationテンプレートに平文記載不要

2. **Health Check**
   - Container Level: `curl -f http://localhost:8080/health`
   - Target Group Level: `/health`エンドポイント
   - 二重チェックで障害検知

3. **Deployment Configuration**
   - MinimumHealthyPercent: 100%
   - MaximumPercent: 200%
   - ゼロダウンタイムデプロイ

4. **Auto Scaling**
   - Target: CPU 70%
   - ScaleOutCooldown: 60秒（素早くスケールアウト）
   - ScaleInCooldown: 300秒（慎重にスケールイン）

---

## 6. 監視詳細設計（CloudWatch）

### 6.1 04-monitoring.yaml

**目的:**
- CloudWatch Alarmsの作成（ECS/RDS/ALB）
- CloudWatch Dashboardの作成
- SNS Topicsの作成

**検証ポイント:**
- ✅ CPU/メモリ高負荷時にアラート通知されるか
- ✅ ダッシュボードで全リソースが可視化されるか
- ✅ SNS経由でメール通知が届くか

**(詳細は文字数制限のため省略。基本設計書の内容をCloudFormationテンプレート化)**

---

## 7. アプリケーション詳細設計

### 7.1 モノレポ構成（npm workspaces）

**package.json（ルート）:**
```json
{
  "name": "myapp-monorepo",
  "private": true,
  "workspaces": [
    "app/public",
    "app/admin",
    "app/batch",
    "app/shared"
  ],
  "scripts": {
    "install:all": "npm install",
    "build:all": "npm run build --workspaces",
    "test:all": "npm run test --workspaces",
    "lint:all": "npm run lint --workspaces"
  },
  "devDependencies": {
    "eslint": "^8.50.0",
    "prettier": "^3.0.0"
  }
}
```

### 7.2 Public Web Service詳細設計

**ディレクトリ構成:**
```
app/public/
├── Dockerfile
├── package.json
├── src/
│   ├── index.js              # エントリーポイント
│   ├── app.js                # Express app設定
│   ├── routes/
│   │   ├── index.js          # ルート定義
│   │   ├── products.js       # /api/v1/products
│   │   └── orders.js         # /api/v1/orders
│   ├── controllers/
│   │   ├── productsController.js
│   │   └── ordersController.js
│   ├── services/
│   │   ├── productsService.js
│   │   └── ordersService.js
│   └── middlewares/
│       ├── errorHandler.js
│       └── logger.js
└── tests/
    └── integration/
        └── products.test.js
```

**index.js（エントリーポイント）:**
```javascript
const app = require('./app');
const { getDbConnection } = require('../../shared/db/connection');

const PORT = process.env.PORT || 8080;

async function startServer() {
  try {
    // DB接続確認
    await getDbConnection();
    console.log('Database connection established');

    app.listen(PORT, '0.0.0.0', () => {
      console.log(`Public Web Service listening on port ${PORT}`);
    });
  } catch (error) {
    console.error('Failed to start server:', error);
    process.exit(1);
  }
}

startServer();
```

**app.js（Express設定）:**
```javascript
const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const morgan = require('morgan');
const routes = require('./routes');
const errorHandler = require('./middlewares/errorHandler');

const app = express();

// セキュリティ
app.use(helmet());
app.use(cors());

// ロギング
app.use(morgan('combined'));

// Body parser
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ヘルスチェック
app.get('/health', (req, res) => {
  res.status(200).json({ status: 'OK' });
});

// API routes
app.use('/api/v1', routes);

// Error handler
app.use(errorHandler);

module.exports = app;
```

**Dockerfile:**
```dockerfile
FROM node:20-alpine AS base

WORKDIR /app

# 依存関係インストール
COPY package.json package-lock.json ./
COPY app/public/package.json ./app/public/
COPY app/shared/package.json ./app/shared/
RUN npm ci --only=production

# アプリケーションコードコピー
COPY app/public ./app/public
COPY app/shared ./app/shared

WORKDIR /app/app/public

EXPOSE 8080

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:8080/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

CMD ["node", "src/index.js"]
```

### 7.3 Shared Library詳細設計

**app/shared/db/connection.js:**
```javascript
const { Pool } = require('pg');

let pool;

function createPool() {
  const config = {
    host: process.env.DB_HOST,
    port: parseInt(process.env.DB_PORT, 10) || 5432,
    database: process.env.DB_NAME,
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD,
    max: 20,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 2000,
  };

  return new Pool(config);
}

function getDbConnection() {
  if (!pool) {
    pool = createPool();
  }
  return pool;
}

module.exports = { getDbConnection };
```

---

## 8. デプロイ手順詳細

### 8.1 事前準備

**1. AWS CLI設定**
```bash
aws configure
# AWS Access Key ID: (入力)
# AWS Secret Access Key: (入力)
# Default region: ap-northeast-1
# Default output format: json
```

**2. Client VPN証明書作成**
```bash
# ルート証明書作成
openssl genrsa -out ca.key 2048
openssl req -new -x509 -days 3650 -key ca.key -out ca.crt

# サーバー証明書作成
openssl genrsa -out server.key 2048
openssl req -new -key server.key -out server.csr
openssl x509 -req -days 3650 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt

# クライアント証明書作成
openssl genrsa -out client.key 2048
openssl req -new -key client.key -out client.csr
openssl x509 -req -days 3650 -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt

# ACMへアップロード
aws acm import-certificate \
  --certificate fileb://server.crt \
  --private-key fileb://server.key \
  --certificate-chain fileb://ca.crt \
  --region ap-northeast-1

aws acm import-certificate \
  --certificate fileb://ca.crt \
  --private-key fileb://ca.key \
  --region ap-northeast-1
```

### 8.2 Platform Accountデプロイ

```bash
cd infra/platform

# S3バケット作成（ネストテンプレート格納用）
aws s3 mb s3://myapp-cfn-templates-$(aws sts get-caller-identity --query Account --output text)

# ネストテンプレートアップロード
aws s3 cp nested/network.yaml s3://myapp-cfn-templates-$(aws sts get-caller-identity --query Account --output text)/nested/
aws s3 cp nested/connectivity.yaml s3://myapp-cfn-templates-$(aws sts get-caller-identity --query Account --output text)/nested/

# Change Set作成（dry-run）
aws cloudformation create-change-set \
  --stack-name myapp-dev-platform \
  --change-set-name myapp-dev-platform-changeset-$(date +%Y%m%d%H%M%S) \
  --template-body file://stack.yaml \
  --parameters file://parameters-dev.json \
  --capabilities CAPABILITY_NAMED_IAM

# Change Set確認
aws cloudformation describe-change-set \
  --stack-name myapp-dev-platform \
  --change-set-name <CHANGE_SET_NAME>

# Change Set実行
aws cloudformation execute-change-set \
  --stack-name myapp-dev-platform \
  --change-set-name <CHANGE_SET_NAME>

# デプロイ完了待機
aws cloudformation wait stack-create-complete \
  --stack-name myapp-dev-platform
```

### 8.3 Service Accountデプロイ

```bash
cd infra/service

# Transit Gateway IDをパラメータファイルに追記
# parameters-dev.json

# 01-network.yaml
aws cloudformation create-change-set \
  --stack-name myapp-dev-service-network \
  --change-set-name myapp-dev-service-network-changeset-$(date +%Y%m%d%H%M%S) \
  --template-body file://01-network.yaml \
  --parameters file://parameters-dev.json

# 実行
aws cloudformation execute-change-set \
  --stack-name myapp-dev-service-network \
  --change-set-name <CHANGE_SET_NAME>

# 完了待機
aws cloudformation wait stack-create-complete \
  --stack-name myapp-dev-service-network

# 02-database.yaml
aws cloudformation create-change-set \
  --stack-name myapp-dev-service-database \
  --change-set-name myapp-dev-service-database-changeset-$(date +%Y%m%d%H%M%S) \
  --template-body file://02-database.yaml \
  --parameters file://parameters-dev.json \
  --capabilities CAPABILITY_NAMED_IAM

aws cloudformation execute-change-set \
  --stack-name myapp-dev-service-database \
  --change-set-name <CHANGE_SET_NAME>

aws cloudformation wait stack-create-complete \
  --stack-name myapp-dev-service-database

# 03-compute.yaml
aws cloudformation create-change-set \
  --stack-name myapp-dev-service-compute \
  --change-set-name myapp-dev-service-compute-changeset-$(date +%Y%m%d%H%M%S) \
  --template-body file://03-compute.yaml \
  --parameters file://parameters-dev.json \
  --capabilities CAPABILITY_NAMED_IAM

aws cloudformation execute-change-set \
  --stack-name myapp-dev-service-compute \
  --change-set-name <CHANGE_SET_NAME>

aws cloudformation wait stack-create-complete \
  --stack-name myapp-dev-service-compute

# 04-monitoring.yaml
aws cloudformation create-change-set \
  --stack-name myapp-dev-service-monitoring \
  --change-set-name myapp-dev-service-monitoring-changeset-$(date +%Y%m%d%H%M%S) \
  --template-body file://04-monitoring.yaml \
  --parameters file://parameters-dev.json

aws cloudformation execute-change-set \
  --stack-name myapp-dev-service-monitoring \
  --change-set-name <CHANGE_SET_NAME>

aws cloudformation wait stack-create-complete \
  --stack-name myapp-dev-service-monitoring
```

---

## 9. 検証シナリオと成功基準

### 9.1 ネットワーク検証

| 検証項目 | 手順 | 成功基準 |
|---------|------|---------|
| Transit Gateway通信 | Platform VPCからService VPCへpingまたはcurl | 応答あり |
| Client VPN接続 | VPN接続後、プライベートリソースにアクセス | 接続成功 |
| NAT Gateway | Private SubnetからインターネットへHTTPS通信 | 通信成功 |

### 9.2 アプリケーション検証

| 検証項目 | 手順 | 成功基準 |
|---------|------|---------|
| Public Web動作確認 | `curl https://<ALB-DNS>/api/v1/products` | 200 OK |
| Admin Dashboard動作確認 | VPN接続後、Admin ALBにアクセス | 200 OK |
| Batch処理動作確認 | ECS Scheduled Task手動実行 | Exit Code 0 |
| DB接続確認 | ECS TaskからRDS接続 | 接続成功 |

### 9.3 監視検証

| 検証項目 | 手順 | 成功基準 |
|---------|------|---------|
| CPU高負荷アラーム | 負荷テストでCPU 80%超 | SNS通知受信 |
| Auto Scaling | CPU高負荷継続 | Task数増加 |
| Dashboard表示 | CloudWatch Dashboard確認 | 全メトリクス表示 |

---

## 10. トラブルシューティング

### 10.1 よくある問題と対処法

| 問題 | 原因 | 対処法 |
|------|------|--------|
| ECS Task起動失敗 | Secrets Manager権限不足 | Task Execution Roleに権限追加 |
| RDS接続失敗 | セキュリティグループ設定ミス | RDS SGにECS SGからのIngress追加 |
| Transit Gateway通信不可 | ルートテーブル設定ミス | ルートテーブルにTGW向けルート追加 |
| VPN接続失敗 | 証明書設定ミス | ACM証明書再作成 |

---

## 11. 次のステップ

- CloudFormationテンプレート実装
- アプリケーションコード実装
- Dockerイメージビルド
- CI/CDパイプライン実装
- 検証シナリオ実施

---

## 付録

### A. パラメータファイル例

**parameters-dev.json:**
```json
[
  {
    "ParameterKey": "Environment",
    "ParameterValue": "dev"
  },
  {
    "ParameterKey": "ProjectName",
    "ParameterValue": "myapp"
  },
  {
    "ParameterKey": "SharedVpcCidr",
    "ParameterValue": "10.0.0.0/16"
  },
  {
    "ParameterKey": "ServiceAccountId",
    "ParameterValue": "123456789012"
  }
]
```

### B. 変更履歴

| 日付 | 版数 | 変更内容 | 承認者 |
|------|------|----------|--------|
| 2025-10-20 | 1.0 | 初版作成 | - |
