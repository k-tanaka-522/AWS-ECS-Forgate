# CareApp 要件定義書

## 1. 概要

### 1.1 背景
- **現状**: 市が介護事業者からの保険申請を管理する既存iPad版システムを運用中
- **課題**: 専用端末配布によるコスト負担、操作性の問題
- **目的**: PC Web版への改修により、利便性向上とコスト削減を実現

### 1.2 対象システム
**介護保険申請管理システム（PC Web版）- CareApp**

### 1.3 システム構成
- **Platform Account（共通基盤）**: Shared VPC、Transit Gateway、Client VPN
- **Service Account（業務システム）**: 3サービス構成
  - **Public Service**: 住民向けパブリックサービス（インターネット公開）
  - **Admin Service**: 自治体職員向け業務システム（VPN経由）
  - **Batch Service**: データ変換・バッチ処理

### 1.4 スコープ
- **Phase 1（本ドキュメント対象）**: POC環境構築（3サービスアーキテクチャ基盤）
- **Phase 2以降**: 各サービスのアプリケーション開発、本番環境構築

---

## 2. ステークホルダー

### 2.1 ユーザー

#### 市職員（管理者）
- **人数**: 10-50名
- **役割**: 申請の審査・承認、事業者管理
- **アクセス**: POCはClient VPN経由、本番はDirect Connect経由

#### 介護事業者（一般ユーザー）
- **事業者数**: 50-200社
- **役割**: 申請の作成・提出、審査状況確認
- **アクセス**: インターネット経由（HTTPS）

---

## 3. 機能要件

### 3.1 申請管理機能

#### 3.1.1 申請作成・編集
- 申請フォーム入力
  - サービス種別選択
  - 利用者情報入力（氏名、住所、郵便番号、要介護度）
  - サービス内容・期間・金額入力
- 下書き保存機能
- 添付ファイルアップロード（最大10MB）

#### 3.1.2 申請提出
- 入力内容の確認画面
- 申請番号の自動採番（APP-YYYYMMDD-XXXXX）
- 提出時の通知（市職員宛メール）

#### 3.1.3 申請一覧・検索
- **事業者**: 自社の申請のみ表示
- **市職員**: 全申請表示
- 絞り込み条件:
  - ステータス（下書き/提出済/審査中/承認/却下/差し戻し）
  - 提出日範囲
  - 申請番号
  - 事業者名
  - 利用者名

### 3.2 承認ワークフロー

#### 3.2.1 審査機能（市職員のみ）
- 申請詳細表示
- 承認・却下・差し戻しの選択
- 審査コメント入力

#### 3.2.2 ステータス遷移
```
下書き → 提出済 → 審査中 → 承認
                     ↓
                   却下
                     ↓
                 差し戻し → 提出済（再提出）
```

#### 3.2.3 通知機能
- 申請提出時: 市職員宛にメール通知
- 承認時: 事業者宛にメール通知
- 却下時: 事業者宛にメール通知（理由含む）
- 差し戻し時: 事業者宛にメール通知（修正依頼含む）

### 3.3 コメント機能
- 申請に対するコメント投稿
- 内部コメント（市職員のみ閲覧可）
- 外部コメント（事業者も閲覧可）
- コメント履歴表示

### 3.4 帳票出力

#### 3.4.1 PDF生成
- 申請書PDF（個別）
- 承認通知書PDF

#### 3.4.2 CSV出力
- 申請一覧CSV
- 月次集計CSV

### 3.5 マスタ管理（市職員のみ）

#### 3.5.1 事業者マスタ
- 事業者の登録・編集・無効化
- 事業者情報（名称、コード、住所、連絡先）

#### 3.5.2 サービス種別マスタ
- サービス種別の登録・編集・無効化
- サービス情報（コード、名称、単価）

#### 3.5.3 ユーザー管理
- ユーザーの登録・編集・無効化
- 権限管理（管理者/一般ユーザー）

### 3.6 認証・認可

#### 3.6.1 認証
- Amazon Cognito User Pool
- メールアドレス + パスワード認証
- パスワードポリシー:
  - 最小8文字以上
  - 大文字・小文字・数字・記号を含む
  - 90日ごとに変更推奨

#### 3.6.2 認可
- **市職員（Administrators）**:
  - 全申請の閲覧・審査
  - マスタ管理
  - ユーザー管理
- **事業者（BusinessUsers）**:
  - 自社申請の作成・編集・閲覧
  - 自社ユーザー管理（限定）

---

## 4. 非機能要件

### 4.1 可用性・信頼性

#### 4.1.1 稼働時間
- **重要稼働時間**: 平日+土曜日 8:30-17:30
- **推奨稼働時間**: 夜間・日曜日も極力アクセス可能
- **メンテナンス**: 日曜深夜または祝日

#### 4.1.2 目標稼働率
- **POC環境**: 95%以上
- **本番環境**: 99.5%以上（年間ダウンタイム約43.8時間）

#### 4.1.3 障害復旧
- **目標復旧時間（RTO）**: 6時間以内
- **データ損失許容（RPO）**: 1時間以内
- **構成**: 本番はMulti-AZ（RDS、ECS Fargate）

### 4.2 性能

#### 4.2.1 応答時間
- 画面遷移: 2秒以内
- 検索処理: 5秒以内
- PDF生成: 10秒以内
- バッチ処理: 夜間6時間以内に完了

#### 4.2.2 スループット
- **同時接続ユーザー数**: 最大250名
  - 市職員: 10-50名
  - 事業者: 50-200社
- **ピーク時トランザクション**: 500件/時
- **平均トランザクション**: 100件/時

#### 4.2.3 データ量
- **月間申請件数**: 2,000-5,000件
- **年間申請件数**: 30,000-60,000件
- **保管期間**: 5-7年
- **想定データ量**: 5年で200,000-300,000件

### 4.3 セキュリティ

#### 4.3.1 データ分類
- **個人情報**: あり
- **要配慮個人情報**: あり（介護情報、健康情報）
- **セキュリティレベル**: 高（行政システム相当）

#### 4.3.2 暗号化
- **転送時**: TLS 1.2以上（HTTPS通信）
- **保管時**:
  - RDS: 暗号化有効（AWS KMS）
  - EBS: 暗号化有効
  - S3: 暗号化有効

#### 4.3.3 アクセス制御

**市職員**:
- POC: Client VPN経由でVPCにアクセス
- 本番: Direct Connect → Transit Gateway → VPC

**事業者**:
- インターネット経由
- WAF（本番）でSQLインジェクション、XSS等を防御

**ネットワーク分離**:
- Public Subnet: ALBのみ
- Private Subnet (App): ECS Fargateタスク
- Private Subnet (DB): RDS

**セキュリティグループ**: 最小権限の原則（ALB→ECS→RDS）

#### 4.3.4 監査ログ
**記録対象**:
- ユーザーログイン・ログアウト
- 申請の作成・更新・削除
- 承認・却下・差し戻し操作
- マスタデータの変更
- システム設定変更

**ログ保管**:
- CloudWatch Logs: 90日
- S3アーカイブ: 7年

**AWS監査ログ**:
- CloudTrail: 有効（全API操作記録）
- VPC Flow Logs: 有効（ネットワークトラフィック記録）

#### 4.3.5 その他セキュリティ対策
- **Secrets Manager**: DB接続情報、APIキー管理
- **GuardDuty**: 脅威検知（本番環境）
- **Config**: コンプライアンスチェック（本番環境）
- **Session Manager**: 踏み台サーバー不要のセキュアアクセス

### 4.4 バックアップ・DR（災害復旧）

#### 4.4.1 バックアップ
**RDS自動バックアップ**:
- 頻度: 日次
- 保管期間: POC 7日、本番 30日
- バックアップウィンドウ: 深夜2:00-3:00

**RDS手動スナップショット**:
- 頻度: 週次（日曜深夜）
- 保管期間: 3ヶ月

**アプリケーションデータ**:
- S3バケットにエクスポート（週次）
- バージョニング有効

#### 4.4.2 DR（災害復旧）
- **プライマリリージョン**: ap-northeast-1（東京）
- **DRリージョン**: ap-northeast-3（大阪）
- **DR戦略**: Backup & Restore（本番のみ）
  - RDSスナップショットを大阪リージョンにコピー（日次）
  - 災害時は大阪リージョンで手動復旧
  - 復旧時間: 6時間以内（RTO）

### 4.5 運用・監視

#### 4.5.1 監視項目
**インフラメトリクス（サービス別）**:
- **Public Service**:
  - ECS: CPU使用率、メモリ使用率、タスク数
  - ALB: リクエスト数、レイテンシ、エラー率、ターゲット正常性
- **Admin Service**:
  - ECS: CPU使用率、メモリ使用率、タスク数
  - VPN接続状況
- **Batch Service**:
  - ECS: CPU使用率、メモリ使用率、タスク実行時間
  - 失敗タスク数
- **共通データベース**:
  - RDS: CPU使用率、接続数、ストレージ使用量、レプリケーションラグ

**アプリケーションメトリクス**:
- エラーログ
- レスポンスタイム
- トランザクション数

**セキュリティ**:
- WAFブロック数（本番）
- GuardDuty検知（本番）
- 不正ログイン試行

#### 4.5.2 アラート
**通知レベル**:
- **Critical**: SNS Topic（CriticalAlerts）→ Email/Slack（即時対応）
- **Warning**: SNS Topic（WarningAlerts）→ Email（監視）

**アラート条件**:
- **Critical**:
  - ECS CPU使用率 > 80%（5分継続）
  - ECS メモリ使用率 > 80%（5分継続）
  - RDS CPU使用率 > 80%（5分継続）
  - RDS 接続数 > 80%上限（5分継続）
  - RDS ストレージ容量 > 80%（5分継続）
  - ALB ターゲット異常検知（1分継続）
  - ALB 5xxエラー率 > 5%（5分継続）
- **Warning**:
  - ALB レスポンスタイム > 1秒（5分継続）
  - RDS レプリケーションラグ > 100ms（5分継続）

#### 4.5.3 CloudWatch Dashboard
**統合ダッシュボード**:
- サービス別メトリクスの一覧表示
- リアルタイムグラフ（CPU、メモリ、リクエスト数）
- アラーム状態の可視化

#### 4.5.4 ログ管理
**CloudWatch Logs**:
- ECSタスクログ
- RDSクエリログ（スロークエリのみ）
- WAFログ（本番）
- 保管期間: 90日

**S3アーカイブ**:
- 90日経過後、S3に移動
- 保管期間: 7年
- ストレージクラス: Glacier

#### 4.5.5 AI運用支援
**Amazon Bedrock**（将来対応）:
- 異常検知時の原因分析
- 対応策の提案
- ログ分析の自動化
- 予測分析

### 4.6 拡張性

#### 4.6.1 スケーラビリティ
**ECS Fargate Auto Scaling（サービス別）**:
- **Public Service**: 2-6タスク（CPU 70%でスケールアウト）
- **Admin Service**: 2-4タスク（CPU 70%でスケールアウト）
- **Batch Service**: 1-4タスク（オンデマンド実行）

**RDS（3サービス共有）**:
- 初期: POC db.t3.micro、本番 db.m5.large
- 拡張: 垂直スケーリング可能
- リードレプリカ追加可能

**利用者増加対応**: 500名まで対応可能

#### 4.6.2 機能拡張性
- メール通知カスタマイズ（テンプレートDBで管理）
- 帳票テンプレート（S3で管理）
- API拡張（RESTful API設計で将来の外部連携を考慮）

### 4.7 開発・デプロイ

#### 4.7.1 環境構成
**POC環境**:
- 1つのAWSアカウント
- Single-AZ構成（コスト優先）
- Client VPN経由でアクセス

**本番環境**:
- 別のAWSアカウント
- Multi-AZ構成（冗長化）
- Direct Connect + Transit Gateway経由

#### 4.7.2 CI/CD
**POC環境**:
- Git push/マージで自動デプロイ
- GitHub Actions
- テスト自動実行

**本番環境**:
- 手動承認フロー
- ステージングブランチからリリース
- デプロイ前にdry-run実施

#### 4.7.3 IaC（Infrastructure as Code）
- **ツール**: AWS CloudFormation（スタック分割構成）
- **スタック構成**:
  - **Platform Account**: network.yaml（Shared VPC、Transit Gateway、Client VPN）
  - **Service Account**:
    - 01-network.yaml（Service VPC、Subnets、Security Groups）
    - 02-database.yaml（RDS PostgreSQL）
    - 03-compute.yaml（ECS Fargate、ALB）
    - 04-monitoring.yaml（CloudWatch Alarms、Dashboard）
- **バージョン管理**: Git
- **環境差分管理**: パラメータファイル（POC/本番）
- **デプロイ**: PowerShellスクリプト（dry-run対応）

### 4.8 コスト

#### 4.8.1 月額コスト見積もり

**POC環境（最小構成）**:
- Platform Account:
  - Transit Gateway: 3,000円
  - Client VPN: 5,000円
- Service Account:
  - ECS Fargate (3サービス): 3,000円
  - RDS (db.t3.micro Single-AZ): 2,000円
  - ALB: 2,500円
  - CloudWatch: 1,000円
  - その他（Cognito等）: 1,000円
- **合計**: 約17,500円/月

**本番環境（大規模構成）**:
- Platform Account:
  - Transit Gateway: 10,000円
  - Direct Connect (共有按分): 10,000円
  - Client VPN: 5,000円
- Service Account:
  - ECS Fargate (3サービス、Auto Scaling): 20,000円
  - RDS (db.m5.large Multi-AZ): 30,000円
  - ALB: 2,500円
  - WAF: 5,000円
  - S3 (バックアップ): 3,000円
  - CloudWatch (Logs + Alarms + Dashboard): 3,000円
  - その他: 2,000円
- **合計**: 約90,500円/月

#### 4.8.2 コスト最適化
- リザーブドインスタンス: RDSで1年契約（約30%削減）
- Savings Plans: ECS Fargateで1年契約（約20%削減）
- S3ライフサイクル: 90日後にGlacierへ移行
- CloudWatch Logs: 不要なログは無効化

### 4.9 コンプライアンス

#### 4.9.1 個人情報保護
- **個人情報保護法**: 準拠
- **自治体個人情報保護条例**: 準拠
- **データ保管**: 日本国内のみ（東京・大阪リージョン）

#### 4.9.2 情報セキュリティ基準
- **政府情報システムのためのセキュリティ評価制度（ISMAP）**: 参考
- **自治体情報セキュリティクラウド**: 参考

---

## 5. 制約条件

### 5.1 POC段階の制約
- Direct Connect未構築（Client VPN代替）
- Single-AZ構成（コスト削減）
- 開発環境のみで動作確認

### 5.2 本番移行時の対応
- Client VPN → Direct Connect + Transit Gateway
- 共有系AWSアカウントの構築
- Transit Gateway Attachment設定
- Multi-AZ構成への移行

---

## 6. 成功基準

### 6.1 POC環境（Phase 1）
- Platform AccountとService AccountがTransit Gatewayで接続できること
- Client VPN経由でService VPCのリソースにアクセスできること
- 3サービス（Public/Admin/Batch）のECS基盤が構築されること
- Public ServiceでHello ECSデモアプリが動作すること
- RDS PostgreSQLに各サービスから接続できること
- CloudWatch監視（Alarms + Dashboard）が機能すること
- Cognito認証が機能すること

### 6.2 本番環境（Phase 4）
- 目標稼働率 99.5%以上を達成
- レスポンスタイム目標値を満たす
- セキュリティ監査に合格
- コスト見積もり内での運用

---

## 7. 関連ドキュメント

- [01_CareApp企画書.md](01_CareApp企画書.md) - プロジェクト概要
- [02_AWS構成図.md](02_AWS構成図.md) - AWS構成図（詳細）
- [03_CareApp設計書.md](03_CareApp設計書.md) - 設計書（詳細）
- [03_データモデル設計.md](03_データモデル設計.md) - データベース設計（詳細）
- [../DEPLOYMENT.md](../DEPLOYMENT.md) - デプロイ手順書
- [../REFACTORING.md](../REFACTORING.md) - リファクタリングレポート

---

**作成日**: 2025-10-01
**更新日**: 2025-10-08（3サービス構成、監視強化を反映）
**承認者**: （承認後に記入）
**承認日**: （承認後に記入）
